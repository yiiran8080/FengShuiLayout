import { NextResponse } from "next/server";
import { auth } from "@/auth";
import connectMongo from "@/lib/mongoose";
import SmartUserIntent from "@/models/SmartUserIntent";
import ChatHistory from "@/models/ChatHistory"; // ğŸ†• æ–°å¢ï¼šä½¿ç”¨æ–°çš„ChatHistoryæ¨¡å‹
import CoupleReportDoc from "@/models/CoupleReportDoc"; // ğŸ¯ æ–°å¢ï¼šåˆå©šå ±å‘Šæ¨¡å‹
import EnhancedConversationMemoryManager from "@/lib/enhancedConversationMemoryManager";

// ğŸ”§ ç”Ÿæ—¥è§£æå·¥å…·å‡½æ•¸ - è¤‡è£½è‡ª Smart-Chat
function parseFlexibleDate(dateString) {
	if (!dateString || typeof dateString !== "string") {
		return null;
	}

	// ç§»é™¤å¤šé¤˜å­—ç¬¦ï¼Œçµ±ä¸€æ ¼å¼
	let cleaned = dateString
		.replace(/[å¹´æœˆæ—¥]/g, "-")
		.replace(/[\/]/g, "-")
		.replace(/\s+/g, "")
		.replace(/-+/g, "-")
		.replace(/^-|-$/g, "");

	// å˜—è©¦å„ç¨®æ—¥æœŸæ ¼å¼
	const patterns = [
		/^(\d{4})-(\d{1,2})-(\d{1,2})$/,
		/^(\d{1,2})-(\d{1,2})-(\d{4})$/,
		/^(\d{4})(\d{2})(\d{2})$/,
	];

	for (const pattern of patterns) {
		const match = cleaned.match(pattern);
		if (match) {
			let year, month, day;

			if (pattern.source.includes("(\\d{4})-(\\d{1,2})-(\\d{1,2})")) {
				[, year, month, day] = match;
			} else if (
				pattern.source.includes("(\\d{1,2})-(\\d{1,2})-(\\d{4})")
			) {
				[, month, day, year] = match;
			} else {
				[, year, month, day] = match;
			}

			const date = new Date(
				parseInt(year),
				parseInt(month) - 1,
				parseInt(day)
			);

			if (
				!isNaN(date.getTime()) &&
				date.getFullYear() >= 1900 &&
				date.getFullYear() <= 2024
			) {
				return date;
			}
		}
	}

	return null;
}

// ğŸ”§ æª¢æ¸¬è¨Šæ¯ä¸­åŒæ™‚åŒ…å«ä¸»é¡Œå’Œç”Ÿæ—¥çš„å‡½æ•¸ - ä½¿ç”¨AIåˆ†æè€Œéé—œéµè©
async function detectTopicAndBirthday(message) {
	if (!message || typeof message !== "string") {
		return null;
	}

	// ç”Ÿæ—¥æ ¼å¼æ¨¡å¼ - æ”¯æŒå¤šç¨®æ ¼å¼
	const birthdayPatterns = [
		/(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)/g,
		/(\d{4}\-\d{1,2}\-\d{1,2})/g,
		/(\d{4}\/\d{1,2}\/\d{1,2})/g,
		/(\d{1,2}\/\d{1,2}\/\d{4})/g,
	];

	let detectedTopic = null;
	let detectedBirthday = null;

	// ğŸ¤– ä½¿ç”¨AIåˆ†æä¸»é¡Œ - æ›´æº–ç¢ºçš„ç†è§£ç”¨æˆ¶æ„åœ–
	try {
		// å‰µå»ºè‡¨æ™‚çš„AIåˆ†æå™¨å¯¦ä¾‹
		const tempClassifier = new AITopicClassifier();
		const aiAnalysis = await tempClassifier.analyzeMessage(message);

		// å¦‚æœAIæª¢æ¸¬åˆ°æœ‰æ•ˆä¸»é¡Œä¸”åœ¨æœå‹™ç¯„åœå…§
		if (
			aiAnalysis &&
			aiAnalysis.isWithinScope &&
			aiAnalysis.detectedTopic !== "å…¶ä»–"
		) {
			detectedTopic = aiAnalysis.detectedTopic;
			console.log(
				"ğŸ¤– AIæª¢æ¸¬åˆ°ä¸»é¡Œ:",
				detectedTopic,
				"ä¿¡å¿ƒåº¦:",
				aiAnalysis.confidence
			);
		}
	} catch (error) {
		console.error("ğŸš¨ AIä¸»é¡Œæª¢æ¸¬å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨é—œéµè©æª¢æ¸¬:", error);

		// ğŸ”„ å‚™ç”¨ï¼šé—œéµè©æª¢æ¸¬ï¼ˆåƒ…åœ¨AIå¤±æ•—æ™‚ä½¿ç”¨ï¼‰
		const topicKeywords = {
			æ„Ÿæƒ…: [
				"æ„Ÿæƒ…",
				"æ„›æƒ…",
				"æˆ€æ„›",
				"æ¡ƒèŠ±",
				"åˆ†æ‰‹",
				"å¾©åˆ",
				"å©šå§»",
				"å–®èº«",
				"æ¸¬æ„Ÿæƒ…",
			],
			å·¥ä½œ: [
				"å·¥ä½œ",
				"äº‹æ¥­",
				"è·å ´",
				"å‡è·",
				"è·³æ§½",
				"ç”Ÿæ„",
				"ç¶“ç‡Ÿ",
				"å‰µæ¥­",
				"å…¬å¸",
				"å•†æ¥­",
				"å·¥ä½œé‹å‹¢",
				"æ¸¬å·¥ä½œ",
			],
			è²¡é‹: [
				"è²¡é‹",
				"è²¡å¯Œ",
				"è³ºéŒ¢",
				"æŠ•è³‡",
				"ç†è²¡",
				"æ”¶å…¥",
				"é‡‘éŒ¢",
				"åè²¡",
				"æ­£è²¡",
				"æ©«è²¡",
				"æ¸¬è²¡é‹",
			],
			å¥åº·: [
				"å¥åº·",
				"èº«é«”",
				"ç–¾ç—…",
				"é¤Šç”Ÿ",
				"èª¿ç†",
				"æ¸¬å¥åº·",
				"ç™Œç—‡",
				"ç—…",
				"ç”Ÿç—…",
				"æ‰‹è¡“",
				"é†«ç”Ÿ",
				"é†«é™¢",
				"æ²»ç™‚",
			],
		};

		for (const [topic, keywords] of Object.entries(topicKeywords)) {
			if (keywords.some((keyword) => message.includes(keyword))) {
				detectedTopic = topic;
				console.log("ğŸ”„ å‚™ç”¨é—œéµè©æª¢æ¸¬åˆ°ä¸»é¡Œ:", detectedTopic);
				break;
			}
		}
	}

	// æª¢æ¸¬ç”Ÿæ—¥
	for (const pattern of birthdayPatterns) {
		const matches = message.matchAll(pattern);
		for (const match of matches) {
			const parsedDate = parseFlexibleDate(match[1]);
			if (parsedDate) {
				detectedBirthday = {
					original: match[1],
					parsed: parsedDate,
					standardFormat: `${parsedDate.getFullYear()}-${String(parsedDate.getMonth() + 1).padStart(2, "0")}-${String(parsedDate.getDate()).padStart(2, "0")}`,
				};
				console.log("ğŸ“… æª¢æ¸¬åˆ°ç”Ÿæ—¥:", detectedBirthday.standardFormat);
				break;
			}
		}
		if (detectedBirthday) break;
	}

	// å¦‚æœåŒæ™‚æª¢æ¸¬åˆ°ä¸»é¡Œå’Œç”Ÿæ—¥ï¼Œè¿”å›çµæœ
	if (detectedTopic && detectedBirthday) {
		console.log(
			"âœ… åŒæ™‚æª¢æ¸¬åˆ°ä¸»é¡Œå’Œç”Ÿæ—¥:",
			detectedTopic,
			"+",
			detectedBirthday.standardFormat
		);
		return {
			hasTopicAndBirthday: true,
			topic: detectedTopic,
			birthday: detectedBirthday,
			originalMessage: message,
		};
	}

	return null;
}

// ğŸ”§ é›™æ–¹ç”Ÿæ—¥è§£æå‡½æ•¸ - è¤‡è£½è‡ª Smart-Chat
function parseCouplesBirthdays(message) {
	if (!message || typeof message !== "string") {
		return null;
	}

	// æª¢æ¸¬åŒ…å«å…©å€‹ç”Ÿæ—¥çš„æ ¼å¼ï¼šæ”¯æŒæ‰€æœ‰æ€§åˆ¥çµ„åˆ
	const couplePatterns = [
		// æˆ‘XXXï¼Œå¥¹XXX (female user, female partner)
		/æˆ‘\s*(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)[ï¼Œ,\s]*å¥¹\s*(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)/,
		// æˆ‘XXXï¼Œä»–XXX (female user, male partner)
		/æˆ‘\s*(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)[ï¼Œ,\s]*ä»–\s*(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)/,
		// æˆ‘XXXï¼Œå°æ–¹XXX (gender neutral)
		/æˆ‘\s*(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)[ï¼Œ,\s]*å°æ–¹\s*(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)/,
		// æˆ‘çš„ç”Ÿæ—¥æ˜¯XXXï¼Œä»–çš„ç”Ÿæ—¥æ˜¯XXX (more natural format)
		/æˆ‘çš„ç”Ÿæ—¥æ˜¯\s*(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)[ï¼Œ,\s]*ä»–çš„ç”Ÿæ—¥æ˜¯\s*(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)/,
		// æˆ‘çš„ç”Ÿæ—¥æ˜¯XXXï¼Œå¥¹çš„ç”Ÿæ—¥æ˜¯XXX
		/æˆ‘çš„ç”Ÿæ—¥æ˜¯\s*(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)[ï¼Œ,\s]*å¥¹çš„ç”Ÿæ—¥æ˜¯\s*(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)/,
		// Standard date formats
		/æˆ‘\s*(\d{4}\-\d{1,2}\-\d{1,2})[ï¼Œ,\s]*[ä»–å¥¹å°æ–¹]\s*(\d{4}\-\d{1,2}\-\d{1,2})/,
		/æˆ‘\s*(\d{1,2}\/\d{1,2}\/\d{4})[ï¼Œ,\s]*[ä»–å¥¹å°æ–¹]\s*(\d{1,2}\/\d{1,2}\/\d{4})/,
		// Fallback: any two dates in one message
		/(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)[ï¼Œ,\s]*(\d{4}[å¹´\-\/]\d{1,2}[æœˆ\-\/]\d{1,2}[æ—¥]?)/,
		/(\d{4}\-\d{1,2}\-\d{1,2})[ï¼Œ,\s]*(\d{4}\-\d{1,2}\-\d{1,2})/,
	];

	for (const pattern of couplePatterns) {
		const match = message.match(pattern);
		if (match) {
			const userBirthday = parseFlexibleDate(match[1]);
			const partnerBirthday = parseFlexibleDate(match[2]);

			if (userBirthday && partnerBirthday) {
				return {
					hasCouplesBirthdays: true,
					userBirthday: userBirthday,
					partnerBirthday: partnerBirthday,
					rawText: match[0],
				};
			}
		}
	}

	return null;
}

// ğŸ”§ æ ¼å¼åŒ–åˆå©šåˆ†æå›æ‡‰ - å°‡çµæ§‹åŒ–å°è±¡è½‰æ›ç‚ºå­—ç¬¦ä¸²
function formatCoupleAnalysisResponse(analysisResult) {
	if (!analysisResult || typeof analysisResult !== "object") {
		return analysisResult;
	}

	let formattedResponse = "";

	// 1. é›™æ–¹åŸºç¤åˆ†æ
	if (analysisResult.basicAnalysis) {
		formattedResponse += analysisResult.basicAnalysis + "\n\n";
	}

	// 2. é‡å°å…·é«”å•é¡Œå›æ‡‰
	if (analysisResult.problemResponse) {
		formattedResponse += analysisResult.problemResponse + "\n\n";
	}

	// 3. é…å°åˆ†æ
	if (analysisResult.compatibilityAnalysis) {
		formattedResponse += analysisResult.compatibilityAnalysis + "\n\n";
	}

	// 4. å¯¦ç”¨è§£æ±ºæ–¹æ¡ˆ
	if (analysisResult.practicalSolutions) {
		formattedResponse += analysisResult.practicalSolutions + "\n\n";
	}

	// 5. å°ˆå±¬æ„Ÿæƒ…è§£æ
	if (analysisResult.exclusiveInsights) {
		formattedResponse += analysisResult.exclusiveInsights + "\n\n";
	}

	// 6. åˆå©šå ±å‘Šæ¨è–¦
	if (analysisResult.reportRecommendation) {
		const rec = analysisResult.reportRecommendation;
		formattedResponse += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ’ **æƒ³è¦æ›´æ·±å…¥çš„åˆ†æå—ï¼Ÿ**\næ ¹æ“šä½ å€‘çš„ç‹€æ³ï¼Œé¢¨éˆ´ç‚ºä½ å€‘æ¨è–¦ï¼š\n\n`;

		if (rec.options && rec.options.length > 0) {
			// è™•ç†å¤šé¸é …æ ¼å¼
			rec.options.forEach((option) => {
				formattedResponse += `**${option.number} ${option.title}** åƒ¹å€¼${option.originalPrice}ï¼Œé™æ™‚å„ªæƒ ${option.price}\n`;
				if (option.features && option.features.length > 0) {
					option.features.forEach((feature) => {
						formattedResponse += `- ${feature}\n`;
					});
				}
				formattedResponse += `\n`;
			});
			formattedResponse += `${rec.action}`;
		} else {
			// è™•ç†èˆŠçš„å–®é¸é …æ ¼å¼ (å‘å¾Œå…¼å®¹)
			formattedResponse += `**${rec.title}** åƒ¹å€¼${rec.originalPrice}ï¼Œé™æ™‚å„ªæƒ ${rec.price}\n`;
			if (rec.features && rec.features.length > 0) {
				rec.features.forEach((feature) => {
					formattedResponse += `- ${feature}\n`;
				});
			}
			formattedResponse += `\n${rec.action}`;
		}
	}

	return formattedResponse.trim();
}

// ğŸ¤– AI è©±é¡Œåˆ†é¡å’Œå•é¡Œæª¢æ¸¬ç³»çµ±
class AITopicClassifier {
	constructor() {
		// AI è©±é¡Œåˆ†é¡åˆå§‹åŒ–
		this.DEEPSEEK_API_KEY =
			process.env.DEEPSEEK_API_KEY || process.env.API_KEY;
		this.DEEPSEEK_API_URL = "https://api.deepseek.com/chat/completions";

		console.log("ğŸ”§ AITopicClassifier åˆå§‹åŒ–");
		console.log(
			"ğŸ“Š DEEPSEEK_API_KEY:",
			this.DEEPSEEK_API_KEY ? "å·²è¨­ç½®" : "æœªè¨­ç½®"
		);
		console.log("ğŸŒ DEEPSEEK_API_URL:", this.DEEPSEEK_API_URL);

		// ğŸ§  MINIMAL ENHANCEMENT: Add conversation memory and emotional detection
		this.conversationMemory = new Map();
		this.successPatterns = new Map();
		this.emotionalKeywords = {
			urgent: [
				"æ€¥",
				"é¦¬ä¸Š",
				"ç«‹åˆ»",
				"å¿«",
				"å€’é–‰",
				"å®Œè›‹",
				"æ•‘å‘½",
				"ç·Šæ€¥",
			],
			anxious: ["ç„¦æ…®", "æ“”å¿ƒ", "ç·Šå¼µ", "ä¸å®‰", "å®³æ€•", "ç…©æƒ±"],
			confused: ["è¿·èŒ«", "å›°æƒ‘", "ä¸çŸ¥é“", "ä¸æ‡‚", "æä¸æ¸…æ¥š", "ä¸æ˜ç™½"],
			desperate: ["æ²’è¾¦æ³•", "çµ•æœ›", "å®Œäº†", "æ•‘æ•‘æˆ‘", "èµ°æŠ•ç„¡è·¯"],
			repeated: ["é‚„æ˜¯", "ä¾ç„¶", "ä»ç„¶", "åˆ", "å†æ¬¡", "ç¹¼çºŒ"],
		};
		console.log("ğŸ§  Minimal Enhancement Initialized");

		// æˆ‘å€‘æä¾›çš„æ ¸å¿ƒæœå‹™é ˜åŸŸ
		this.supportedTopics = {
			æ„Ÿæƒ…: [
				"æˆ€æ„›",
				"åˆ†æ‰‹",
				"å¾©åˆ",
				"åˆå©š",
				"æ¡ƒèŠ±é‹",
				"å©šå§»",
				"æ„Ÿæƒ…é‹å‹¢",
				"æ„Ÿæƒ…",
				"æ„›æƒ…",
				"æ¸¬æ„Ÿæƒ…",
			],
			è²¡é‹: [
				"è³ºéŒ¢",
				"æŠ•è³‡",
				"ç†è²¡",
				"åè²¡é‹",
				"æ­£è²¡é‹",
				"ç ´è²¡",
				"è²¡é‹",
				"æ¸¬è²¡é‹",
				"è²¡å¯Œ",
				"é‡‘éŒ¢",
			],
			å·¥ä½œ: [
				"å‡è·",
				"è·³æ§½",
				"è·å ´é‹å‹¢",
				"äº‹æ¥­ç™¼å±•",
				"å·¥ä½œæ©Ÿæœƒ",
				"è·æ¥­è¦åŠƒ",
				"å·¥ä½œ",
				"äº‹æ¥­",
				"ç”Ÿæ„",
				"ç¶“ç‡Ÿ",
				"å‰µæ¥­",
				"æ¥­å‹™",
				"å…¬å¸",
				"è·å ´",
				"å·¥ä½œå•é¡Œ",
				"äº‹æ¥­å•é¡Œ",
				"ç”Ÿæ„å•é¡Œ",
				"ç¶“ç‡Ÿå›°é›£",
				"æ¥­ç¸¾",
				"ç‡Ÿæ”¶",
				"å•†æ¥­",
				"çµæŸç”Ÿæ„",
				"é—œé–‰å…¬å¸",
				"åœæ¥­",
				"è½‰è¡Œ",
				"å·¥ä½œé‹å‹¢",
				"æ¸¬å·¥ä½œ",
				"åŠ è–ª",
				"åŠ äººå·¥",
				"è–ªè³‡",
				"è–ªæ°´",
				"äººå·¥",
				"åŠ å·¥è³‡",
				"è–ªè³‡èª¿æ•´",
				"æ”¶å…¥æå‡",
				"è·å ´è¡¨ç¾",
				"å·¥ä½œå£“åŠ›",
				"è€é—†",
				"ä¸»ç®¡",
				"åŒäº‹é—œä¿‚",
				"è·æ¥­ç™¼å±•",
				"å·¥ä½œæ™‚æ©Ÿ",
			],
			å¥åº·: [
				"èº«é«”å¥åº·",
				"ç–¾ç—…",
				"é¤Šç”Ÿ",
				"å¥åº·é‹å‹¢",
				"èº«é«”èª¿ç†",
				"å¥åº·",
				"èº«é«”",
				"æ¸¬å¥åº·",
			],
			å‘½ç†: [
				"å‘½ç†",
				"å…«å­—",
				"ç´«å¾®æ–—æ•¸",
				"å‘½ç›¤",
				"æµå¹´",
				"å¤§é‹",
				"å‘½é‹",
				"ç®—å‘½",
				"å åœ",
				"é æ¸¬",
				"é‹å‹¢",
				"å‘½æ ¼",
				"äº”è¡Œ",
				"å¤©å¹²åœ°æ”¯",
				"å‘½ç†åˆ†æ",
				"æ¸¬å‘½ç†",
				"ç”Ÿè¾°å…«å­—",
				"å‘½ç†è«®è©¢",
			],
			å­å¥³: [
				"æ‡·å­•",
				"ç”Ÿè‚²",
				"å­å¥³é‹",
				"è¦ªå­é—œä¿‚",
				"æ•™è‚²",
				"å­å¥³",
				"å°å­©",
				"æ¸¬å­å¥³",
			],
			é¢¨æ°´ä½ˆå±€: [
				"é¢¨æ°´",
				"å±…å®¶é¢¨æ°´",
				"è¾¦å…¬å®¤é¢¨æ°´",
				"é¢¨æ°´æ¸¬é‡",
				"é¢¨æ°´èª¿æ•´",
				"æ–¹ä½åˆ†æ",
				"æ“ºè¨­å»ºè­°",
				"é¢¨æ°´åŸç†",
				"é¢¨æ°´çŸ¥è­˜",
				"ä½ˆå±€",
				"æ¸¬é¢¨æ°´",
				"é¢¨æ°´æ–¹æ³•",
			],
		};

		console.log(
			"ğŸ¯ supportedTopics è¨­ç½®å®Œæˆ:",
			Object.keys(this.supportedTopics)
		);
	}

	// ğŸ§  MINIMAL ENHANCEMENT: Emotional State Detection
	detectEmotionalState(message) {
		const emotions = {};

		Object.entries(this.emotionalKeywords).forEach(
			([emotion, keywords]) => {
				emotions[emotion] = keywords.some((keyword) =>
					message.includes(keyword)
				);
			}
		);

		console.log("ğŸ˜Š Emotional state detected:", emotions);
		return emotions;
	}

	// ğŸ§  MINIMAL ENHANCEMENT: Update Conversation History
	updateConversationHistory(sessionId, message, response, topic) {
		if (!sessionId) return;

		if (!this.conversationMemory.has(sessionId)) {
			this.conversationMemory.set(sessionId, {
				messages: [],
				successfulAdvice: [],
				preferredTopic: null,
				emotionalPattern: [],
				irrelevantCount: 0, // Track irrelevant questions
				lastRelevantTopic: null,
			});
		}

		const session = this.conversationMemory.get(sessionId);

		// Track irrelevant questions
		if (topic === "å…¶ä»–") {
			session.irrelevantCount++;
			console.log(
				`ğŸ“Š Irrelevant question count: ${session.irrelevantCount}`
			);
		} else {
			session.lastRelevantTopic = topic;
			// Reset counter on relevant question
			if (session.irrelevantCount > 0) {
				session.irrelevantCount = Math.max(
					0,
					session.irrelevantCount - 1
				);
			}
		}

		session.messages.push({
			message,
			response,
			topic,
			timestamp: new Date(),
			isRelevant: topic !== "å…¶ä»–",
		});

		// Keep only last 5 messages to avoid memory bloat
		if (session.messages.length > 5) {
			session.messages.shift();
		}

		console.log(
			`ğŸ’­ Conversation history updated for ${sessionId}: ${session.messages.length} messages, irrelevant: ${session.irrelevantCount}`
		);
	}

	// ğŸ§  MINIMAL ENHANCEMENT: Get Conversation Context
	getConversationContext(sessionId) {
		if (!sessionId || !this.conversationMemory.has(sessionId)) {
			return { hasHistory: false, irrelevantCount: 0 };
		}

		const session = this.conversationMemory.get(sessionId);
		return {
			hasHistory: true,
			messageCount: session.messages.length,
			recentMessages: session.messages.slice(-3),
			preferredTopic: session.preferredTopic,
			irrelevantCount: session.irrelevantCount || 0,
			lastRelevantTopic: session.lastRelevantTopic,
		};
	}

	// ğŸ¯ Determine redirect level based on conversation history
	determineRedirectLevel(context) {
		// Always use gentle approach - user prefers engaging, helpful responses
		// regardless of conversation history
		return "gentle"; // Always helpful answer + soft redirect
	}

	// ğŸ¯ æª¢æ¸¬ç”¨æˆ¶æ˜¯å¦è¼¸å…¥äº†å…·é«”çš„æœå‹™åç¨±
	detectSpecificServiceRequest(message) {
		const cleanMessage = message.trim();

		// ç²¾ç¢ºçš„æœå‹™åç¨±åŒ¹é…
		const serviceKeywords = {
			æµå¹´é‹å‹¢åˆ†æ: "å‘½ç†",
			å·¥ä½œäº‹æ¥­åˆ†æ: "å·¥ä½œ",
			æ„Ÿæƒ…é‹å‹¢åˆ†æ: "æ„Ÿæƒ…",
			æ„Ÿæƒ…åˆ†æ: "æ„Ÿæƒ…",
			å¥åº·é‹å‹¢: "å¥åº·",
			å¥åº·åˆ†æ: "å¥åº·",
			è²¡é‹åˆ†æ: "è²¡é‹",
			å‘½ç†åˆ†æ: "å‘½ç†",
			å…«å­—åˆ†æ: "å‘½ç†",
		};

		// æª¢æŸ¥æ˜¯å¦åŒ…å«å…·é«”æœå‹™åç¨±
		for (const [serviceName, topic] of Object.entries(serviceKeywords)) {
			if (cleanMessage.includes(serviceName)) {
				console.log(
					`âœ… æª¢æ¸¬åˆ°å…·é«”æœå‹™è¦æ±‚: ${serviceName} -> ${topic}`
				);
				return { serviceName, detectedTopic: topic };
			}
		}

		return null;
	}

	// ğŸ¯ ç”Ÿæˆå…·é«”æœå‹™é¸æ“‡å¼•å°
	generateSpecificServiceGuide(serviceName, detectedTopic) {
		const serviceGuides = {
			å‘½ç†: `å¤ªå¥½äº†ï¼é¢¨éˆ´æœ€æ“…é•·å‘½ç†åˆ†æå‘¢ï½âœ¨

ç‚ºäº†çµ¦ä½ æœ€æº–ç¢ºçš„åˆ†æï¼Œè«‹å‘Šè¨´é¢¨éˆ´ä½ çš„**ç”Ÿæ—¥**ï¼š

ğŸ“… **è«‹ç”¨ä»¥ä¸‹æ ¼å¼æä¾›ç”Ÿæ—¥ï¼š**
â€¢ 1999-03-15  
â€¢ 1999/3/15
â€¢ 1999å¹´3æœˆ15æ—¥

æˆ‘æœƒç‚ºä½ æä¾›å°ˆæ¥­çš„å…«å­—å‘½ç†åˆ†æï¼ŒåŒ…æ‹¬æµå¹´é‹å‹¢ã€äº”è¡Œç‰¹è³ªå’Œé–‹é‹å»ºè­°å–”ï½ğŸ’«`,

			æ„Ÿæƒ…: `å¤ªæ£’äº†ï¼æ„Ÿæƒ…åˆ†ææ˜¯é¢¨éˆ´çš„å°ˆæ¥­å¼·é …å‘¢ï½ğŸ’•

è«‹æä¾›ä½ çš„**ç”Ÿæ—¥**ï¼Œè®“æˆ‘å¹«ä½ åˆ†ææ„Ÿæƒ…é‹å‹¢ï¼š

ğŸ“… **è«‹ç”¨ä»¥ä¸‹æ ¼å¼æä¾›ç”Ÿæ—¥ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

æˆ‘æœƒå¹«ä½ åˆ†ææ¡ƒèŠ±é‹å‹¢ã€æ„Ÿæƒ…èµ°å‘å’Œæœ€ä½³æˆ€æ„›æ™‚æ©Ÿï½ğŸŒ¸`,

			å·¥ä½œ: `å¥½çš„ï¼å·¥ä½œäº‹æ¥­é‹å‹¢åˆ†æäº¤çµ¦é¢¨éˆ´å°±å°äº†ï½ğŸ’¼

è«‹å‘Šè¨´æˆ‘ä½ çš„**ç”Ÿæ—¥**ï¼Œè®“æˆ‘ç‚ºä½ åˆ†æäº‹æ¥­é‹ç¨‹ï¼š

ğŸ“… **è«‹ç”¨ä»¥ä¸‹æ ¼å¼æä¾›ç”Ÿæ—¥ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15
â€¢ 1999å¹´3æœˆ15æ—¥

æˆ‘æœƒåˆ†æä½ çš„è·å ´é‹å‹¢ã€äº‹æ¥­ç™¼å±•æ©Ÿæœƒå’Œæœ€ä½³è½‰è·æ™‚æ©Ÿå–”ï½âœ¨`,

			å¥åº·: `å¥åº·é‹å‹¢åˆ†æä¾†äº†ï¼é¢¨éˆ´æœƒç”¨å¿ƒç‚ºä½ è§£è®€ï½ğŸŒ¿

è«‹æä¾›ä½ çš„**ç”Ÿæ—¥**ï¼Œè®“æˆ‘åˆ†æä½ çš„å¥åº·é‹ç¨‹ï¼š

ğŸ“… **è«‹ç”¨ä»¥ä¸‹æ ¼å¼æä¾›ç”Ÿæ—¥ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15
â€¢ 1999å¹´3æœˆ15æ—¥

æˆ‘æœƒç‚ºä½ åˆ†æèº«å¿ƒå¥åº·ç‹€æ³ã€é¤Šç”Ÿå»ºè­°å’Œä¿å¥é‡é»ï½ğŸ’š`,

			è²¡é‹: `è²¡é‹åˆ†æï¼é¢¨éˆ´æœ€å–œæ­¡å¹«äººçœ‹è²¡é‹äº†ï½ğŸ’°

è«‹å‘Šè¨´æˆ‘ä½ çš„**ç”Ÿæ—¥**ï¼Œè®“æˆ‘åˆ†æä½ çš„è²¡å¯Œé‹å‹¢ï¼š

ğŸ“… **è«‹ç”¨ä»¥ä¸‹æ ¼å¼æä¾›ç”Ÿæ—¥ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15
â€¢ 1999å¹´3æœˆ15æ—¥

æˆ‘æœƒå¹«ä½ çœ‹æ­£è²¡åè²¡ã€æŠ•è³‡ç†è²¡å’Œæ‹›è²¡é–‹é‹æ–¹æ³•å–”ï½âœ¨`,
		};

		return serviceGuides[detectedTopic] || serviceGuides["å‘½ç†"];
	}

	// ğŸ¯ æ›´æ–°æœƒè©±è¨˜æ†¶
	updateConversationMemory(
		sessionId,
		userMessage,
		assistantResponse,
		metadata = {}
	) {
		if (!sessionId) return;

		if (!this.conversationMemory.has(sessionId)) {
			this.conversationMemory.set(sessionId, {
				messages: [],
				irrelevantCount: 0,
				preferredTopic: null,
				lastRelevantTopic: null,
			});
		}

		const session = this.conversationMemory.get(sessionId);

		// æ·»åŠ æ¶ˆæ¯åˆ°æ­·å²
		session.messages.push(
			{ role: "user", content: userMessage, timestamp: new Date() },
			{
				role: "assistant",
				content: assistantResponse,
				timestamp: new Date(),
			}
		);

		// æ›´æ–°å…ƒæ•¸æ“š
		if (metadata.isServiceConfirmation) {
			session.awaitingBirthday = true;
		}
		if (metadata.awaitingBirthday) {
			session.awaitingBirthday = metadata.awaitingBirthday;
		}

		// ä¿æŒæœ€è¿‘çš„20æ¢æ¶ˆæ¯
		if (session.messages.length > 20) {
			session.messages = session.messages.slice(-20);
		}

		this.conversationMemory.set(sessionId, session);
		console.log(`ğŸ’­ æœƒè©±è¨˜æ†¶å·²æ›´æ–° ${sessionId}:`, {
			messageCount: session.messages.length,
			awaitingBirthday: session.awaitingBirthday,
		});
	}

	// ğŸ¯ Build customized prompt based on redirect level
	buildRedirectPrompt(question, redirectLevel, context) {
		// Get current date for context
		const currentDate = new Date();
		const currentDateStr = currentDate.toLocaleDateString("zh-TW", {
			year: "numeric",
			month: "long",
			day: "numeric",
			weekday: "long",
		});

		const baseServices = `ç¾æœ‰æœå‹™ç¯„åœï¼š
- æ„Ÿæƒ…é‹å‹¢åˆ†æï¼ˆæ¡ƒèŠ±é‹ã€åˆå©šé…å°ï¼‰
- å·¥ä½œäº‹æ¥­åˆ†æï¼ˆè·å ´é‹å‹¢ã€äº‹æ¥­ç™¼å±•ï¼‰  
- è²¡é‹åˆ†æï¼ˆæŠ•è³‡ç†è²¡ã€æ”¶å…¥æå‡ï¼‰
- å¥åº·é‹å‹¢ï¼ˆèº«å¿ƒèª¿ç†ã€é¤Šç”Ÿå»ºè­°ï¼‰
- å‘½ç†åˆ†æï¼ˆå…«å­—è§£è®€ã€æµå¹´é‹å‹¢ï¼‰`;

		switch (redirectLevel) {
			case "firm":
				return `ç”¨æˆ¶å•é¡Œï¼š${question}

ç•¶å‰æ—¥æœŸï¼š${currentDateStr}ï¼ˆåƒ…ä½œç‚ºå…§éƒ¨åƒè€ƒï¼Œä¸éœ€è¦åœ¨å›æ‡‰ä¸­æåŠå…·é«”æ—¥æœŸï¼‰

ä½ æ˜¯é¢¨éˆ´ï¼Œç”¨æˆ¶å·²ç¶“é€£çºŒå•äº†å¤šå€‹èˆ‡é¢¨æ°´å‘½ç†ç„¡é—œçš„å•é¡Œã€‚éœ€è¦å‹å–„ä½†å …å®šåœ°å¼•å°ç”¨æˆ¶ä½¿ç”¨ä½ çš„å°ˆæ¥­æœå‹™ã€‚

é‡è¦æŒ‡ç¤ºï¼šå¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ï¼Œä¸è¦åŒ…å«å­—æ•¸çµ±è¨ˆæ¨™è¨˜ã€‚å¦‚æœéœ€è¦æåŠæ™‚é–“ï¼Œè«‹ç¢ºä¿æ˜¯ç•¶å‰çš„2025å¹´ï¼Œé¿å…æåŠ2024å¹´æˆ–éå»çš„æ™‚é–“ã€‚åªåœ¨çœŸæ­£éœ€è¦æ™‚é–“èƒŒæ™¯çš„æƒ…æ³ä¸‹æ‰æåŠæ—¥æœŸã€‚

å›æ‡‰é¢¨æ ¼ï¼š
- å…ˆç°¡çŸ­å›ç­”å•é¡Œï¼Œç„¶å¾Œè‡ªç„¶åœ°èªªæ˜é¢¨æ°´å‘½ç†åˆ†æèƒ½è§£æ±ºæ›´æ·±å±¤çš„å•é¡Œ
- ä¸»å‹•æ¨è–¦å…·é«”æœå‹™ä¸¦èªªæ˜åƒ¹å€¼ï¼Œå‰µé€ ç·Šè¿«æ„Ÿå’Œéœ€æ±‚æ„Ÿ
- ç”¨è‡ªç„¶å°è©±çš„æ–¹å¼ï¼Œé¿å…æ©Ÿæ¢°å¼çš„å›æ‡‰

èªæ°£è¦æ±‚ï¼šå‹å–„ä½†å …å®šï¼Œå°ˆæ³¨æ–¼æœå‹™éŠ·å”®
${baseServices}

é‡é»ï¼šä¸è¦åªæ˜¯ä»‹ç´¹æœå‹™ï¼Œè¦èªªæ˜ç‚ºä»€éº¼ç”¨æˆ¶éœ€è¦é€™äº›åˆ†æï¼Œå¼·èª¿èƒ½è§£æ±ºçš„å•é¡Œå’Œå¸¶ä¾†çš„å¥½è™•ã€‚

**å°ˆæ¥­è¡“èªé‹ç”¨ï¼š**
- å°æ–¼é£²é£Ÿç›¸é—œå•é¡Œï¼Œå¯é©ç•¶æåŠäº”è¡Œå…ƒç´ ï¼ˆé‡‘æœ¨æ°´ç«åœŸï¼‰èˆ‡é£Ÿæçš„å°æ‡‰é—œä¿‚
- å±•ç¾å°ˆæ¥­æ¬Šå¨æ€§ï¼Œå¢åŠ æœå‹™èªªæœåŠ›

**çµå°¾è¦æ±‚ï¼š**
- æ ¹æ“šç”¨æˆ¶å•é¡Œçš„å…§å®¹ï¼Œæ¨è–¦1-2å€‹æœ€ç›¸é—œçš„æœå‹™
- ä½¿ç”¨æ ¼å¼ï¼šæƒ³è¦é–‹å§‹åˆ†æçš„è©±ï¼Œè«‹è¼¸å…¥ï¼šã€ŒXXXåˆ†æã€
- åœ¨æœå‹™æ¨è–¦å¾Œæ·»åŠ ä¸€å¥å¼·èª¿ç·Šè¿«æ€§å’Œåƒ¹å€¼çš„çµèªï¼Œè¦æœ‰å¤šæ¨£åŒ–è¡¨é”
- æœ€å¾Œå¯é¸æ“‡æ·»åŠ å¤šæ¨£åŒ–çš„çµå°¾å¥ï¼Œé¿å…é‡è¤‡ä½¿ç”¨åŒä¸€å¥
- ä¸è¦åˆ—å‡ºæ‰€æœ‰5å€‹æœå‹™ï¼Œåªæ¨è–¦æœ€ç›¸é—œçš„`;

			case "moderate":
				return `ç”¨æˆ¶å•é¡Œï¼š${question}

ç•¶å‰æ—¥æœŸï¼š${currentDateStr}ï¼ˆåƒ…ä½œç‚ºå…§éƒ¨åƒè€ƒï¼Œä¸éœ€è¦åœ¨å›æ‡‰ä¸­æåŠå…·é«”æ—¥æœŸï¼‰

ä½ æ˜¯é¢¨éˆ´ï¼Œç”¨æˆ¶å•äº†ä¸€äº›èˆ‡é¢¨æ°´å‘½ç†ç„¡é—œçš„å•é¡Œã€‚éœ€è¦åœ¨å›ç­”çš„åŒæ™‚ç©æ¥µæ¨è–¦ä½ çš„å°ˆæ¥­æœå‹™ã€‚

é‡è¦æŒ‡ç¤ºï¼šå¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ï¼Œä¸è¦åŒ…å«å­—æ•¸çµ±è¨ˆæ¨™è¨˜ã€‚å¦‚æœéœ€è¦æåŠæ™‚é–“ï¼Œè«‹ç¢ºä¿æ˜¯ç•¶å‰çš„2025å¹´ï¼Œé¿å…æåŠ2024å¹´æˆ–éå»çš„æ™‚é–“ã€‚åªåœ¨çœŸæ­£éœ€è¦æ™‚é–“èƒŒæ™¯çš„æƒ…æ³ä¸‹æ‰æåŠæ—¥æœŸã€‚

å›æ‡‰é¢¨æ ¼ï¼š
- å…ˆçµ¦å‡ºå¯¦ç”¨ç­”æ¡ˆï¼Œç„¶å¾Œè‡ªç„¶åœ°é€£çµå•é¡Œèˆ‡é‹å‹¢å‘½ç†çš„é—œä¿‚
- èªªæ˜å°ˆæ¥­åˆ†æèƒ½æä¾›çš„å…·é«”å¹«åŠ©ï¼Œä¸»å‹•æ¨è–¦æœ€ç›¸é—œçš„æœå‹™ä¸¦å¼·èª¿æ•ˆæœ
- ç”¨è‡ªç„¶å°è©±çš„æ–¹å¼ï¼Œé¿å…æ©Ÿæ¢°å¼çš„å›æ‡‰

${baseServices}

é‡é»ï¼šè¦è®“ç”¨æˆ¶æ„Ÿè¦ºåˆ°ä»–å€‘çš„å•é¡Œå…¶å¯¦èˆ‡é‹å‹¢æœ‰é—œï¼Œä½ çš„å°ˆæ¥­åˆ†æèƒ½æä¾›æ›´æ·±å±¤çš„è§£ç­”ã€‚

**å°ˆæ¥­è¡“èªé‹ç”¨ï¼š**
- å°æ–¼é£²é£Ÿç›¸é—œå•é¡Œï¼Œå¯é©ç•¶æåŠäº”è¡Œå…ƒç´ ï¼ˆé‡‘æœ¨æ°´ç«åœŸï¼‰èˆ‡é£Ÿæçš„å°æ‡‰é—œä¿‚
- å°æ–¼é¡è‰²ã€æè³ªã€æ–¹ä½ç›¸é—œå•é¡Œï¼Œå¯å¼•ç”¨é¢¨æ°´äº”è¡Œç†è«–

**çµå°¾è¦æ±‚ï¼š**
- æ ¹æ“šç”¨æˆ¶å•é¡Œçš„å…§å®¹ï¼Œæ¨è–¦1-2å€‹æœ€ç›¸é—œçš„æœå‹™
- ä½¿ç”¨æ ¼å¼ï¼šæƒ³äº†è§£çš„è©±ï¼Œè«‹è¼¸å…¥ï¼šã€ŒXXXåˆ†æã€
- åœ¨æœå‹™æ¨è–¦å¾Œæ·»åŠ ä¸€å¥å¸å¼•äººçš„çµèªï¼Œå¯å¾ç›¸é—œé¡åˆ¥ä¸­é¸æ“‡å¤šæ¨£åŒ–è¡¨é”
- æœ€å¾Œå¯é¸æ“‡æ·»åŠ å¤šæ¨£åŒ–çš„çµå°¾å¥ï¼Œé¿å…é‡è¤‡ä½¿ç”¨åŒä¸€å¥
- ä¸è¦åˆ—å‡ºæ‰€æœ‰5å€‹æœå‹™ï¼Œåªæ¨è–¦æœ€ç›¸é—œçš„`;

			case "gentle":
			default:
				return `ç”¨æˆ¶å•é¡Œï¼š${question}

ç•¶å‰æ—¥æœŸï¼š${currentDateStr}ï¼ˆåƒ…ä½œç‚ºå…§éƒ¨åƒè€ƒï¼Œä¸éœ€è¦åœ¨å›æ‡‰ä¸­æåŠå…·é«”æ—¥æœŸï¼‰

ä½ æ˜¯å‹å–„çš„é¢¨éˆ´ï¼Œç”¨æˆ¶å•äº†ä¸€å€‹èˆ‡é¢¨æ°´å‘½ç†ç„¡é—œçš„å•é¡Œã€‚è«‹çµ¦ç”¨æˆ¶å¯¦ç”¨å›ç­”ï¼Œç„¶å¾Œç©æ¥µå¼•å°ä»–å€‘äº†è§£ä½ çš„å°ˆæ¥­æœå‹™ã€‚

é‡è¦æŒ‡ç¤ºï¼šå¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ï¼Œä¸è¦åŒ…å«å­—æ•¸çµ±è¨ˆæ¨™è¨˜ã€‚å¦‚æœéœ€è¦æåŠæ™‚é–“ï¼Œè«‹ç¢ºä¿æ˜¯ç•¶å‰çš„2025å¹´ï¼Œé¿å…æåŠ2024å¹´æˆ–éå»çš„æ™‚é–“ã€‚åªåœ¨çœŸæ­£éœ€è¦æ™‚é–“èƒŒæ™¯çš„æƒ…æ³ä¸‹æ‰æåŠæ—¥æœŸï¼Œä¸è¦å¼·åˆ¶åœ¨æ¯å€‹å›æ‡‰ä¸­éƒ½åŒ…å«ã€‚

å›æ‡‰é¢¨æ ¼ï¼š
- å…ˆçµ¦å‡ºå¯¦ç”¨çš„ç­”æ¡ˆæˆ–å»ºè­°ï¼ˆè¦å…·é«”æœ‰ç”¨ï¼‰ï¼Œç„¶å¾Œå·§å¦™é€£çµå•é¡Œèˆ‡å‘½ç†é‹å‹¢çš„é—œä¿‚
- èªªæ˜ä½ çš„å°ˆæ¥­åˆ†æèƒ½æä¾›æ›´æ·±å…¥çš„å¹«åŠ©ï¼Œæ¨è–¦æœ€ç›¸é—œçš„æœå‹™ä¸¦å¼·èª¿èƒ½è§£æ±ºçš„å•é¡Œ
- ç”¨é¢¨éˆ´çš„è¦ªåˆ‡èªæ°£ï¼Œä½†è¦å±•ç¾å°ˆæ¥­æ¬Šå¨æ€§
- ç”¨è‡ªç„¶å°è©±çš„æ–¹å¼ï¼Œé¿å…æ©Ÿæ¢°å¼åˆ—é»å›æ‡‰

${baseServices}

é‡é»ï¼šä¸åªæ˜¯å›ç­”è¡¨é¢å•é¡Œï¼Œè¦è®“ç”¨æˆ¶æ„è­˜åˆ°èƒŒå¾Œå¯èƒ½æœ‰é‹å‹¢å› ç´ ï¼Œä½ çš„å°ˆæ¥­åˆ†æèƒ½æä¾›æ ¹æœ¬è§£æ±ºæ–¹æ¡ˆã€‚ä¸»å‹•å‰µé€ éœ€æ±‚ï¼Œä¸è¦åªæ˜¯è¢«å‹•ä»‹ç´¹æœå‹™ã€‚

**å°ˆæ¥­è¡“èªé‹ç”¨ï¼š**
- å°æ–¼é£²é£Ÿç›¸é—œå•é¡Œï¼Œå¯é©ç•¶æåŠäº”è¡Œå…ƒç´ ï¼ˆé‡‘æœ¨æ°´ç«åœŸï¼‰èˆ‡é£Ÿæçš„å°æ‡‰é—œä¿‚
- å°æ–¼é¡è‰²ã€æè³ªã€æ–¹ä½ç›¸é—œå•é¡Œï¼Œå¯å¼•ç”¨é¢¨æ°´äº”è¡Œç†è«–
- ç”¨å°ˆæ¥­ä½†æ˜“æ‡‚çš„æ–¹å¼èªªæ˜äº”è¡Œèˆ‡æ—¥å¸¸ç”Ÿæ´»çš„é—œè¯

**çµå°¾è¦æ±‚ï¼š**
- æ ¹æ“šç”¨æˆ¶å•é¡Œï¼Œæ¨è–¦1-2å€‹æœ€ç›¸é—œçš„æœå‹™
- ä½¿ç”¨æ ¼å¼ï¼šæƒ³è¦é–‹å§‹åˆ†æçš„è©±ï¼Œè«‹è¼¸å…¥ï¼šã€ŒXXXåˆ†æã€
- åœ¨æœå‹™æ¨è–¦å¾Œæ·»åŠ ä¸€å¥å¸å¼•äººçš„çµèªï¼Œå¯å¾ä»¥ä¸‹é¸é …ä¸­é¸æ“‡ï¼š

**ç¦®ç‰©/è³¼ç‰©ç›¸é—œï¼š**
ã€Œè®“é¢¨éˆ´ç”¨å°ˆæ¥­è¦–è§’å¹«ä½ é¸å‡ºæœ€é–‹é‹çš„é¸æ“‡å§ï¼ã€
ã€Œä¸€èµ·ç‚ºä»–æŒ‘é¸å¸¶ä¾†å¥½é‹çš„å¿ƒæ„ç¦®ç‰©ï½ã€
ã€Œè®“æ¯ä»½ç¦®ç‰©éƒ½æˆç‚ºå¹¸é‹çš„é–‹å§‹ï¼ã€

**é£²é£Ÿ/å¥åº·ç›¸é—œï¼š**
ã€Œè®“æˆ‘ç‚ºä½ æ‰¾å‡ºæœ€é©åˆçš„é¤Šç”Ÿæ­é…ï¼Œæå‡æ•´é«”é‹å‹¢ï¼ã€
ã€Œä¸€èµ·ç”¨äº”è¡Œæ™ºæ…§æ‰“é€ å°ˆå±¬ä½ çš„å¥åº·é£Ÿè­œï½ã€
ã€Œè®“æ¯ä¸€é¤éƒ½æˆç‚ºæ»‹é¤Šé‹å‹¢çš„èƒ½é‡ä¾†æºï¼ã€

**å·¥ä½œ/äº‹æ¥­ç›¸é—œï¼š**
ã€ŒåŠ©ä½ æ‰¾åˆ°äº‹æ¥­ç™¼å±•çš„æœ€ä½³æ™‚æ©Ÿå’Œç­–ç•¥ï¼ã€
ã€Œè®“é¢¨éˆ´ç‚ºä½ çš„è·å ´è·¯æŒ‡å¼•æ˜ç‡ˆï½ã€
ã€Œä¸€èµ·é–‹å‰µå±¬æ–¼ä½ çš„æˆåŠŸé‹å‹¢ï¼ã€

**æ„Ÿæƒ…/é—œä¿‚ç›¸é—œï¼š**
ã€Œè®“é¢¨éˆ´å¹«ä½ è§£é–‹æ„Ÿæƒ…è¿·éœ§ï¼Œæ‰¾åˆ°çœŸæ„›æ–¹å‘ï¼ã€
ã€Œä¸€èµ·ç‚ºä½ çš„æ„›æƒ…é‹å‹¢æ³¨å…¥æ­£èƒ½é‡ï½ã€
ã€Œè®“æ¯æ®µç·£åˆ†éƒ½é–‹èŠ±çµæœï¼ã€

**å…¶ä»–ç”Ÿæ´»å•é¡Œï¼š**
ã€Œè®“å°ˆæ¥­å‘½ç†ç‚ºä½ çš„ç”Ÿæ´»å¸¶ä¾†æ›´å¤šå¥½é‹ï¼ã€
ã€Œä¸€èµ·ç”¨å¤è€æ™ºæ…§è§£æ±ºç¾ä»£ç…©æƒ±ï½ã€
ã€Œè®“é¢¨éˆ´æˆç‚ºä½ äººç”Ÿè·¯ä¸Šçš„è²´äººï¼ã€

- æœ€å¾Œå¯é¸æ“‡æ·»åŠ ä»¥ä¸‹å…¶ä¸­ä¸€å¥ï¼ˆé¿å…æ¯æ¬¡éƒ½é‡è¤‡ï¼‰ï¼š
ã€Œæˆ–æœ‰ä»»ä½•å…¶ä»–ç–‘å•ï¼Œéƒ½å¯ä»¥ç›´æ¥åŒæˆ‘è¬›ã€
ã€Œæœ‰ä»€éº¼æƒ³äº†è§£çš„ï¼Œéš¨æ™‚æ‰¾é¢¨éˆ´èŠèŠï½ã€
ã€ŒæœŸå¾…ç‚ºä½ è§£ç­”æ›´å¤šäººç”Ÿç–‘æƒ‘ï¼ã€
ã€Œé¢¨éˆ´éš¨æ™‚åœ¨é€™è£¡ç‚ºä½ æœå‹™å‘¢ï¼ã€
ã€Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥è·Ÿæˆ‘åˆ†äº«å…¶ä»–æƒ³æ³•ï½ã€

- ä¾‹å¦‚ï¼šé£Ÿç‰©ç›¸é—œæ¨è–¦ã€Œå¥åº·é‹å‹¢ã€ï¼Œå·¥ä½œç›¸é—œæ¨è–¦ã€Œå·¥ä½œäº‹æ¥­åˆ†æã€ï¼Œæ„Ÿæƒ…ç›¸é—œæ¨è–¦ã€Œæ„Ÿæƒ…åˆ†æã€ç­‰
- ä¸è¦åˆ—å‡ºæ‰€æœ‰5å€‹æœå‹™é¸é …`;
		}
	}

	// ğŸ’¼ å·¥ä½œåˆ†ææµç¨‹ - ä½¿ç”¨AIç”Ÿæˆcontextualå›æ‡‰
	async generateCareerFlow(analysis, originalMessage) {
		try {
			// ğŸ¤– ç¸½æ˜¯ç”Ÿæˆæ–°çš„è©³ç´°AIå›æ‡‰ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ¶é«”é©—
			const specificProblem = analysis.specificProblem || originalMessage;

			const aiResponse = await this.generateAIResponse(
				`ç”¨æˆ¶èªª: "${originalMessage}"
				
åˆ†æçµæœ: ${specificProblem}

è«‹ä»¥é¢¨éˆ´çš„èº«ä»½ï¼Œé‡å°é€™å€‹å…·é«”çš„å·¥ä½œå•é¡Œï¼Œæä¾›è‡ªç„¶å°è©±å¼çš„å›æ‡‰ã€‚

å›æ‡‰å…§å®¹è¦æ±‚:
- å›æ‡‰è¦è±å¯Œå……å¯¦ï¼Œè‡³å°‘3-4å€‹æ®µè½ï¼Œæä¾›æ·±åº¦å…§å®¹
- ç”¨è‡ªç„¶å°è©±çš„æ–¹å¼å›æ‡‰ï¼Œå°±åƒçŸ¥å¿ƒæœ‹å‹åœ¨æ·±åº¦èŠå¤©
- å…ˆæ·±åº¦è¡¨é”ç†è§£å’ŒåŒç†å¿ƒ
- æä¾›å¤šå€‹å±¤é¢çš„å¯¦ç”¨å»ºè­°ï¼Œè‡ªç„¶èå…¥å°è©±ä¸­
- å¯ä»¥åˆ†äº«è·å ´æ™ºæ…§ã€äººç”Ÿæ„Ÿæ‚Ÿ
- èªæ°£è¦æº«æš–è¦ªåˆ‡ä¸”æœ‰æ·±åº¦ï¼Œåƒé¢¨éˆ´åœ¨é¢å°é¢æ·±è«‡
- é©ç•¶ä½¿ç”¨emojiå¢åŠ è¦ªåˆ‡æ„Ÿ
- æœ€å¾Œè‡ªç„¶åœ°é‚€è«‹åˆ†äº«ç”Ÿæ—¥åšé€²ä¸€æ­¥åˆ†æ

å›æ‡‰é¢¨æ ¼:
- å…§å®¹è±å¯Œã€æœ‰æ·±åº¦ã€æº«æš–ä¸”å¯¦ç”¨
- åƒæœ‹å‹é–“çš„æ·±åº¦å°è©±ï¼Œä¸æ˜¯ç°¡çŸ­å›ç­”
- è¦æœ‰å±¤æ¬¡æ„Ÿå’Œæ·±åº¦

è«‹é¿å…:
- ç°¡çŸ­æˆ–è¡¨é¢çš„å›æ‡‰
- ç·¨è™Ÿåˆ—é»å¼å›æ‡‰
- æ©Ÿæ¢°å¼çš„ç”¨è©
- æˆ¿å±‹é¢¨æ°´ä½ˆå±€å»ºè­°

é‡é»é—œæ³¨: æ·±åº¦å¿ƒç†æ”¯æŒã€è·å ´æ™ºæ…§ã€äººç”Ÿç­–ç•¥ã€å¯¦ç”¨æºé€šæŠ€å·§`
			);

			// AIå›æ‡‰ + ç”Ÿæ—¥åˆ†æé‚€è«‹
			return (
				aiResponse +
				`

ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`
			);
		} catch (error) {
			console.error("AIç”Ÿæˆå·¥ä½œå›æ‡‰å¤±æ•—:", error);

			// å‚™ç”¨å›æ‡‰ - æ ¹æ“šé—œéµè©åˆ¤æ–·
			const lowerProblem = specificProblem.toLowerCase();
			let response = "";

			if (
				lowerProblem.includes("ç”Ÿæ„") ||
				lowerProblem.includes("ç¶“ç‡Ÿ") ||
				lowerProblem.includes("å‰µæ¥­")
			) {
				response = `è½åˆ°ä½ åœ¨ç”Ÿæ„ç¶“ç‡Ÿä¸Šé‡åˆ°å•é¡Œï¼Œæˆ‘å®Œå…¨ç†è§£é€™ç¨®å›°æ“¾ï¼ğŸ’¼

**ç”Ÿæ„é¢¨æ°´çš„é—œéµè¦ç´ ï¼š**
ğŸ¢ åº—é¢æˆ–è¾¦å…¬å®¤çš„ä½ç½®å’Œæœå‘å¾ˆé‡è¦
ğŸ’° æ”¶éŠ€å°è¦èƒŒé å¯¦ç‰†ï¼Œé¢å‘å¤§é–€
ğŸŒ± åœ¨è²¡ä½æ”¾ç½®ç¶ è‰²æ¤ç‰©èƒ½å‚¬æ—ºç”Ÿæ„
ğŸ”¥ é©ç•¶çš„ç…§æ˜å’Œé€šé¢¨è®“è²¡æ°£æµé€š

ç”Ÿæ„çš„æˆæ•—ä¸åªçœ‹åŠªåŠ›ï¼Œæ™‚æ©Ÿå’Œé¢¨æ°´ä½ˆå±€ä¹Ÿå¾ˆé—œéµï¼`;
			} else if (
				lowerProblem.includes("å‡è·") ||
				lowerProblem.includes("æ™‰å‡") ||
				lowerProblem.includes("è·å ´")
			) {
				response = `å“‡ï½æƒ³å‡è·å‘€ï¼é¢¨éˆ´çŸ¥é“ä¸€å€‹å°ç§˜å¯†å“¦ï¼âœ¨

è¾¦å…¬æ¡Œè¦å°è‘—é–€å£åï¼Œé€™æ¨£æ©Ÿæœƒæ‰æœƒçœ‹åˆ°ä½ ï½  
é‚„æœ‰ï¼å·¦é‚Šæ”¾ç¶ è‰²å°ç›†æ ½ï¼Œå³é‚Šæ”¾é»ƒè‰²å°æ±è¥¿ï¼Œé€™æ¨£è€é—†å°±æœƒæ³¨æ„åˆ°ä½ å•¦ï¼

æƒ³ä¸æƒ³çŸ¥é“æ›´å¤šå‡è·çš„å°é­”æ³•å‘€ï¼Ÿ`;
			} else {
				response = `äº†è§£åˆ°ä½ åœ¨å·¥ä½œä¸Šé‡åˆ°æŒ‘æˆ°ï¼Œè®“é¢¨éˆ´ä¾†å¹«ä½ åˆ†æä¸€ä¸‹ï¼ğŸ’ª

**å·¥ä½œé‹å‹¢æå‡å»ºè­°ï¼š**
ğŸ¯ ä¿æŒå·¥ä½œå€åŸŸæ•´æ½”æœ‰åº
ğŸŒŸ åœ¨è¾¦å…¬æ¡Œæ”¾ç½®å°å‹æ°´æ™¶å¢å¼·èƒ½é‡  
ğŸ“‹ å®šæœŸæª¢è¦–å’Œèª¿æ•´å·¥ä½œç›®æ¨™
ğŸ¤ ç¶­æŒè‰¯å¥½çš„äººéš›é—œä¿‚`;
			}

			response += `

å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹äº‹æ¥­é‹å‹¢å’Œæœ€ä½³ç™¼å±•æ™‚æ©Ÿï¼

ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`;

			return response;
		}
	}

	// ğŸ’° è²¡é‹åˆ†ææµç¨‹ - ä½¿ç”¨AIç”Ÿæˆcontextualå›æ‡‰
	async generateWealthFlow(analysis, originalMessage) {
		try {
			// ğŸ¤– ç¸½æ˜¯ç”Ÿæˆæ–°çš„è©³ç´°AIå›æ‡‰ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ¶é«”é©—
			const specificProblem = analysis.specificProblem || originalMessage;

			const aiResponse = await this.generateAIResponse(
				`ç”¨æˆ¶èªª: "${originalMessage}"
				
åˆ†æçµæœ: ${specificProblem}

è«‹ä»¥é¢¨éˆ´çš„èº«ä»½ï¼Œé‡å°é€™å€‹å…·é«”çš„è²¡é‹å•é¡Œï¼Œæä¾›è‡ªç„¶å°è©±å¼çš„å›æ‡‰ã€‚

å›æ‡‰å…§å®¹è¦æ±‚:
- å›æ‡‰è¦è±å¯Œå……å¯¦ï¼Œè‡³å°‘3-4å€‹æ®µè½ï¼Œæä¾›æ·±åº¦è²¡å‹™æ´å¯Ÿ
- ç”¨è‡ªç„¶å°è©±çš„æ–¹å¼å›æ‡‰ï¼Œå°±åƒç†è²¡é¡§å•æœ‹å‹åœ¨æ·±åº¦èŠå¤©
- å…ˆæ·±åº¦è¡¨é”ç†è§£ï¼Œå¯ä»¥åˆ†äº«ç†è²¡å¿ƒå¾—
- æä¾›å¤šå€‹å±¤é¢çš„ç†è²¡å»ºè­°ï¼Œè‡ªç„¶èå…¥å°è©±ä¸­
- å¯ä»¥åˆ†äº«æŠ•è³‡æ™ºæ…§ã€è²¡å‹™ç®¡ç†ç¶“é©—
- èªæ°£è¦æº«æš–è¦ªåˆ‡ä¸”å°ˆæ¥­ï¼Œåƒé¢¨éˆ´åœ¨é¢å°é¢æ·±è«‡ç†è²¡
- é©ç•¶ä½¿ç”¨emojiå¢åŠ è¦ªåˆ‡æ„Ÿ
- æœ€å¾Œè‡ªç„¶åœ°é‚€è«‹åˆ†äº«ç”Ÿæ—¥åšé€²ä¸€æ­¥åˆ†æ

å›æ‡‰é¢¨æ ¼:
- å…§å®¹è±å¯Œã€æœ‰æ·±åº¦ã€æº«æš–ä¸”å¯¦ç”¨
- åƒç†è²¡æœ‹å‹é–“çš„æ·±åº¦å°è©±ï¼Œä¸æ˜¯ç°¡çŸ­å›ç­”
- è¦æœ‰è²¡å‹™å±¤æ¬¡æ„Ÿå’Œæ·±åº¦

è«‹é¿å…:
- ç°¡çŸ­æˆ–è¡¨é¢çš„å›æ‡‰
- ç·¨è™Ÿåˆ—é»å¼å›æ‡‰
- æ©Ÿæ¢°å¼çš„ç”¨è©
- æˆ¿å±‹é¢¨æ°´ä½ˆå±€å»ºè­°

é‡é»é—œæ³¨: æ·±åº¦è²¡å‹™åˆ†æã€ç†è²¡æ™ºæ…§ã€æŠ•è³‡ç­–ç•¥ã€è²¡å‹™å¿ƒç†å­¸`
			);

			return (
				aiResponse +
				`

å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹è²¡é‹æ–¹é¢çš„é‹å‹¢å“¦ï¼

ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`
			);
		} catch (error) {
			console.error("AIç”Ÿæˆè²¡é‹å›æ‡‰å¤±æ•—:", error);
			return `å“‡ï½ä½ æƒ³äº†è§£è²¡é‹å‘€ï¼é¢¨éˆ´æœ€å–œæ­¡å¹«äººè§£æ±ºå•é¡Œå•¦ï¼âœ¨

æ¯å€‹äººçš„é‹å‹¢éƒ½ä¸ä¸€æ¨£å‘¢ï¼Œå°±åƒæ¯å€‹äººçš„ç”Ÿæ—¥ä¸ä¸€æ¨£ä¸€æ¨£ï¼

å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹è²¡é‹æ–¹é¢çš„é‹å‹¢å“¦ï¼

ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`;
		}
	}

	// ğŸŒ¿ å¥åº·åˆ†ææµç¨‹ - ä½¿ç”¨AIç”Ÿæˆcontextualå›æ‡‰
	async generateHealthFlow(analysis, originalMessage) {
		try {
			// ğŸ¤– ç¸½æ˜¯ç”Ÿæˆæ–°çš„è©³ç´°AIå›æ‡‰ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ¶é«”é©—
			const specificProblem = analysis.specificProblem || originalMessage;

			const aiResponse = await this.generateAIResponse(
				`ç”¨æˆ¶èªª: "${originalMessage}"
				
åˆ†æçµæœ: ${specificProblem}

è«‹ä»¥é¢¨éˆ´çš„èº«ä»½ï¼Œé‡å°é€™å€‹å…·é«”çš„å¥åº·å•é¡Œï¼Œæä¾›è‡ªç„¶å°è©±å¼çš„å›æ‡‰ã€‚

å›æ‡‰å…§å®¹è¦æ±‚:
- å›æ‡‰è¦è±å¯Œå……å¯¦ï¼Œè‡³å°‘3-4å€‹æ®µè½ï¼Œæä¾›æ·±åº¦å¥åº·é—œæ‡·
- ç”¨è‡ªç„¶å°è©±çš„æ–¹å¼å›æ‡‰ï¼Œå°±åƒé—œå¿ƒå¥åº·çš„çŸ¥å¿ƒæœ‹å‹åœ¨æ·±åº¦èŠå¤©
- å…ˆæ·±åº¦è¡¨é”é—œå¿ƒï¼Œå¯ä»¥åˆ†äº«é¤Šç”Ÿå¿ƒå¾—
- æä¾›å¤šå€‹å±¤é¢çš„å¥åº·å»ºè­°ï¼Œè‡ªç„¶èå…¥å°è©±ä¸­
- å¯ä»¥åˆ†äº«é¤Šç”Ÿæ™ºæ…§ã€å¥åº·ç®¡ç†ç¶“é©—
- èªæ°£è¦æº«æš–é—œæ‡·ä¸”æœ‰æ·±åº¦ï¼Œåƒé¢¨éˆ´åœ¨é¢å°é¢æ·±è«‡å¥åº·
- é©ç•¶ä½¿ç”¨emojiå¢åŠ é—œæ‡·æ„Ÿ
- æœ€å¾Œè‡ªç„¶åœ°é‚€è«‹åˆ†äº«ç”Ÿæ—¥åšé€²ä¸€æ­¥åˆ†æ

å›æ‡‰é¢¨æ ¼:
- å…§å®¹è±å¯Œã€æœ‰æ·±åº¦ã€æº«æš–ä¸”é—œæ‡·
- åƒå¥åº·æœ‹å‹é–“çš„æ·±åº¦å°è©±ï¼Œä¸æ˜¯ç°¡çŸ­å›ç­”
- è¦æœ‰å¥åº·å±¤æ¬¡æ„Ÿå’Œæ·±åº¦

è«‹é¿å…:
- ç°¡çŸ­æˆ–è¡¨é¢çš„å›æ‡‰
- ç·¨è™Ÿåˆ—é»å¼å›æ‡‰
- é†«ç™‚å»ºè­°æˆ–æ©Ÿæ¢°å¼ç”¨è©
- æˆ¿å±‹é¢¨æ°´ä½ˆå±€å»ºè­°

é‡é»é—œæ³¨: æ·±åº¦å¥åº·é—œæ‡·ã€é¤Šç”Ÿæ™ºæ…§ã€ç”Ÿæ´»å“è³ªæå‡ã€èº«å¿ƒå¹³è¡¡`
			);

			return (
				aiResponse +
				`

å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹å¥åº·æ–¹é¢çš„é‹å‹¢å“¦ï¼

ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`
			);
		} catch (error) {
			console.error("AIç”Ÿæˆå¥åº·å›æ‡‰å¤±æ•—:", error);
			return `å“‡ï½ä½ æƒ³äº†è§£å¥åº·å‘€ï¼é¢¨éˆ´æœ€å–œæ­¡å¹«äººè§£æ±ºå•é¡Œå•¦ï¼âœ¨

æ¯å€‹äººçš„é‹å‹¢éƒ½ä¸ä¸€æ¨£å‘¢ï¼Œå°±åƒæ¯å€‹äººçš„ç”Ÿæ—¥ä¸ä¸€æ¨£ä¸€æ¨£ï¼

å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹å¥åº·æ–¹é¢çš„é‹å‹¢å“¦ï¼

ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`;
		}
	}

	// ï¿½ å‘½ç†åˆ†ææµç¨‹
	async generateMingliFlow(analysis, originalMessage) {
		try {
			// ğŸ¤– ç¸½æ˜¯ç”Ÿæˆæ–°çš„è©³ç´°AIå›æ‡‰ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ¶é«”é©—
			const specificProblem = analysis.specificProblem || originalMessage;

			const aiResponse = await this.generateAIResponse(
				`ç”¨æˆ¶èªª: "${originalMessage}"
				
åˆ†æçµæœ: ${specificProblem}

è«‹ä»¥é¢¨éˆ´çš„èº«ä»½ï¼Œé‡å°é€™å€‹å…·é«”çš„å‘½ç†å•é¡Œï¼Œæä¾›è‡ªç„¶å°è©±å¼çš„å›æ‡‰ã€‚

å›æ‡‰å…§å®¹è¦æ±‚:
- å›æ‡‰è¦è±å¯Œå……å¯¦ï¼Œè‡³å°‘3-4å€‹æ®µè½ï¼Œæä¾›æ·±åº¦äººç”Ÿæ™ºæ…§
- ç”¨è‡ªç„¶å°è©±çš„æ–¹å¼å›æ‡‰ï¼Œå°±åƒäººç”Ÿå°å¸«æœ‹å‹åœ¨æ·±åº¦èŠå¤©
- å…ˆæ·±åº¦è¡¨é”ç†è§£ï¼Œå¯ä»¥åˆ†äº«å‘½ç†å¿ƒå¾—
- æä¾›å¤šå€‹å±¤é¢çš„äººç”Ÿå»ºè­°ï¼Œè‡ªç„¶èå…¥å°è©±ä¸­
- å¯ä»¥åˆ†äº«äººç”Ÿæ™ºæ…§ã€å‘½ç†ç¶“é©—
- èªæ°£è¦æº«æš–æœ‰æ™ºæ…§æ„Ÿä¸”æ·±åº¦ï¼Œåƒé¢¨éˆ´åœ¨é¢å°é¢æ·±è«‡äººç”Ÿ
- é©ç•¶ä½¿ç”¨emojiå¢åŠ æº«æš–æ„Ÿ
- æœ€å¾Œè‡ªç„¶åœ°é‚€è«‹åˆ†äº«ç”Ÿæ—¥åšé€²ä¸€æ­¥åˆ†æ

å›æ‡‰é¢¨æ ¼:
- å…§å®¹è±å¯Œã€æœ‰æ·±åº¦ã€æº«æš–ä¸”æœ‰æ™ºæ…§
- åƒäººç”Ÿå°å¸«é–“çš„æ·±åº¦å°è©±ï¼Œä¸æ˜¯ç°¡çŸ­å›ç­”
- è¦æœ‰äººç”Ÿå“²ç†å±¤æ¬¡æ„Ÿå’Œæ·±åº¦

è«‹é¿å…:
- ç°¡çŸ­æˆ–è¡¨é¢çš„å›æ‡‰
- ç·¨è™Ÿåˆ—é»å¼å›æ‡‰
- éæ–¼ç„å­¸çš„ç”¨èªæˆ–æ©Ÿæ¢°å¼ç”¨è©
- æˆ¿å±‹é¢¨æ°´ä½ˆå±€å»ºè­°

é‡é»é—œæ³¨: æ·±åº¦äººç”Ÿæ´å¯Ÿã€å‘½ç†æ™ºæ…§ã€æ€§æ ¼æˆé•·ã€äººç”Ÿè¦åŠƒ`
			);

			return (
				aiResponse +
				`

å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ åšå‘½ç†åˆ†æå“¦ï¼

ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„å‘½ç†åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å…«å­—å ±å‘Šå“¦ï½ğŸ”®ğŸ’•`
			);
		} catch (error) {
			console.error("AIç”Ÿæˆå‘½ç†å›æ‡‰å¤±æ•—:", error);
			return `å“‡ï½ä½ æƒ³äº†è§£å‘½ç†å‘€ï¼é¢¨éˆ´æœ€å–œæ­¡å¹«äººè§£æé‹å‹¢å•¦ï¼ğŸ”®âœ¨

æ¯å€‹äººçš„å‘½ç†æ ¼å±€éƒ½ä¸ä¸€æ¨£å‘¢ï¼Œå°±åƒæ¯é¡†æ˜Ÿæ˜Ÿçš„ä½ç½®éƒ½ç¨ä¸€ç„¡äºŒï¼

å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ åšå‘½ç†åˆ†æå“¦ï¼

ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„å‘½ç†åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å…«å­—å ±å‘Šå“¦ï½ğŸ”®ğŸ’•`;
		}
	}

	// ğŸ‘¶ å­å¥³åˆ†ææµç¨‹ - å·²åœç”¨ï¼ˆä¸å†æä¾›æ­¤æœå‹™ï¼‰
	// generateChildrenFlow(analysis, originalMessage) {
	// 	// ğŸ¤– å„ªå…ˆä½¿ç”¨å·²æœ‰çš„ AI åˆ†æçµæœ
	// 	if (analysis.aiResponse) {
	// 		console.log("âœ… ä½¿ç”¨å·²æœ‰çš„ AI å­å¥³åˆ†æçµæœ");
	// 		const fengShuiGreeting = `å“‡ï½ä½ æƒ³äº†è§£å­å¥³å‘€ï¼é¢¨éˆ´æœ€å–œæ­¡å¹«äººè§£æ±ºå•é¡Œå•¦ï¼âœ¨

	// `;

	// 		const fengShuiAdvice = `

	// å»ºè­°åœ¨å®¶ä¸­æ±æ–¹ï¼ˆæ–‡æ˜Œä½ï¼‰æ“ºæ”¾æ›¸ç±æˆ–æ–‡å…·ï¼Œä¿ƒé€²å­å¥³å­¸æ¥­é‹å‹¢ï¼ä¿æŒå­©å­æˆ¿é–“æ•´æ½”æ˜äº®ï¼ŒåºŠé ­é ç‰†æœ‰å®‰å…¨æ„Ÿï½ğŸ‘¶

	// å­å¥³æˆ¿é¿å…æ“ºæ”¾åˆ€åŠé¡è£é£¾ï¼Œå¤šç”¨æº«æš–è‰²èª¿ç‡Ÿé€ æº«é¦¨æ°›åœã€‚è¦ªå­æºé€šä¹Ÿå¾ˆé‡è¦ï¼Œè€å¿ƒé™ªä¼´æœ€çè²´ï¼ğŸ’•`;

	// 		// çµ„åˆï¼šå•å€™ + AIå›æ‡‰ + å»ºè­°
	// 		return (
	// 			fengShuiGreeting +
	// 			analysis.aiResponse +
	// 			fengShuiAdvice +
	// 			`

	// å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹å­å¥³æ–¹é¢çš„é‹å‹¢å“¦ï¼

	// ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
	// â€¢ 1999-03-15
	// â€¢ 1999/3/15
	// â€¢ 1999å¹´3æœˆ15æ—¥

	// é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`
	// 		);
	// 	}

	// 	// å‚™ç”¨æ¨¡æ¿å›æ‡‰
	// 	return `å“‡ï½ä½ æƒ³äº†è§£å­å¥³å‘€ï¼é¢¨éˆ´æœ€å–œæ­¡å¹«äººè§£æ±ºå•é¡Œå•¦ï¼âœ¨

	// æ¯å€‹äººçš„é‹å‹¢éƒ½ä¸ä¸€æ¨£å‘¢ï¼Œå°±åƒæ¯å€‹äººçš„ç”Ÿæ—¥ä¸ä¸€æ¨£ä¸€æ¨£ï¼

	// å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹å­å¥³æ–¹é¢çš„é‹å‹¢å“¦ï¼

	// ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
	// â€¢ 1999-03-15
	// â€¢ 1999/3/15
	// â€¢ 1999å¹´3æœˆ15æ—¥

	// é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`;
	// }

	// ğŸ”® å› ç·£åˆ†ææµç¨‹ - å·²åœç”¨ï¼ˆä¸å†æä¾›æ­¤æœå‹™ï¼‰
	// generateDestinyFlow(analysis, originalMessage) {
	// 	// ğŸ¤– å„ªå…ˆä½¿ç”¨å·²æœ‰çš„ AI åˆ†æçµæœ
	// 	if (analysis.aiResponse) {
	// 		console.log("âœ… ä½¿ç”¨å·²æœ‰çš„ AI å› ç·£åˆ†æçµæœ");
	// 		const fengShuiGreeting = `å“‡ï½ä½ æƒ³äº†è§£å› ç·£å‘€ï¼é¢¨éˆ´æœ€å–œæ­¡å¹«äººè§£æ±ºå•é¡Œå•¦ï¼âœ¨

	// `;

	// 		const fengShuiAdvice = `

	// å»ºè­°åœ¨å®¶ä¸­å—æ–¹æ“ºæ”¾ç´…è‰²ç‰©å“æˆ–ç‡ˆé£¾ï¼Œå¢å¼·æ©Ÿæœƒé‹å‹¢ï¼ä¿æŒé–‹æ”¾çš„å¿ƒæ…‹ï¼Œä¸»å‹•åƒèˆ‡ç¤¾äº¤æ´»å‹•ï¼Œå¥½æ©Ÿç·£æœƒè‡ªç„¶å‡ºç¾ï½ğŸ”®

	// è¨˜å¾—è¦ç›¸ä¿¡ç·£åˆ†ï¼ŒåŒæ™‚ä¹Ÿè¦ä¸»å‹•å‰µé€ æ©Ÿæœƒã€‚ç©¿æˆ´ç´«è‰²æˆ–é‡‘è‰²é£¾å“ï¼Œæœ‰åŠ©æå‡è²´äººé‹ï¼âœ¨`;

	// 		// çµ„åˆï¼šå•å€™ + AIå›æ‡‰ + å»ºè­°
	// 		return (
	// 			fengShuiGreeting +
	// 			analysis.aiResponse +
	// 			fengShuiAdvice +
	// 			`

	// å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹å› ç·£æ–¹é¢çš„é‹å‹¢å“¦ï¼

	// ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
	// â€¢ 1999-03-15
	// â€¢ 1999/3/15
	// â€¢ 1999å¹´3æœˆ15æ—¥

	// é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`
	// 		);
	// 	}

	// 	// å‚™ç”¨æ¨¡æ¿å›æ‡‰
	// 	return `å“‡ï½ä½ æƒ³äº†è§£å› ç·£å‘€ï¼é¢¨éˆ´æœ€å–œæ­¡å¹«äººè§£æ±ºå•é¡Œå•¦ï¼âœ¨

	// æ¯å€‹äººçš„é‹å‹¢éƒ½ä¸ä¸€æ¨£å‘¢ï¼Œå°±åƒæ¯å€‹äººçš„ç”Ÿæ—¥ä¸ä¸€æ¨£ä¸€æ¨£ï¼

	// å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹å› ç·£æ–¹é¢çš„é‹å‹¢å“¦ï¼

	// ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
	// â€¢ 1999-03-15
	// â€¢ 1999/3/15
	// â€¢ 1999å¹´3æœˆ15æ—¥

	// é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`;
	// }

	// ğŸ”„ é è¨­æµç¨‹ - ä½¿ç”¨AIç”Ÿæˆè©³ç´°å›æ‡‰
	async generateDefaultFlow(analysis, originalMessage) {
		try {
			// ğŸ¤– ç¸½æ˜¯ç”Ÿæˆæ–°çš„è©³ç´°AIå›æ‡‰ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ¶é«”é©—
			const specificProblem = analysis.specificProblem || originalMessage;
			const topic = analysis.detectedTopic || "é‹å‹¢";

			const aiResponse = await this.generateAIResponse(
				`ç”¨æˆ¶èªª: "${originalMessage}"
				
åˆ†æçµæœ: ${specificProblem}

è«‹ä»¥é¢¨éˆ´çš„èº«ä»½ï¼Œé‡å°é€™å€‹å…·é«”çš„${topic}å•é¡Œï¼Œæä¾›è‡ªç„¶å°è©±å¼çš„å›æ‡‰ã€‚

å›æ‡‰é¢¨æ ¼è¦æ±‚:
- ç”¨è‡ªç„¶å°è©±çš„æ–¹å¼å›æ‡‰ï¼Œå°±åƒæœ‹å‹èŠå¤©ä¸€æ¨£
- å…ˆè¡¨é”ç†è§£é—œå¿ƒï¼Œç„¶å¾Œè‡ªç„¶åœ°åˆ†äº«ä¸€äº›å»ºè­°
- èªæ°£è¦æº«æš–è¦ªåˆ‡ï¼Œåƒé¢¨éˆ´åœ¨é¢å°é¢èŠå¤©
- é¿å…åˆ—é»å¼ã€æ¢åˆ—å¼çš„æ©Ÿæ¢°åŒ–å›æ‡‰
- å»ºè­°è¦èå…¥åœ¨å°è©±ä¸­ï¼Œä¸è¦åˆ»æ„åˆ†æ®µç·¨è™Ÿ
- é©ç•¶ä½¿ç”¨emojiï¼Œä½†ä¸è¦éå¤š
- æœ€å¾Œè‡ªç„¶åœ°é‚€è«‹åˆ†äº«ç”Ÿæ—¥åšé€²ä¸€æ­¥åˆ†æ

è«‹é¿å…:
- ç·¨è™Ÿåˆ—é» (1. 2. 3. 4.)
- æ¨™é¡Œå¼åˆ†æ®µ (å¦‚ âœ¨å»ºè­°ã€ğŸ’«æ–¹æ³•ç­‰)
- éæ–¼çµæ§‹åŒ–çš„å›æ‡‰
- æ©Ÿæ¢°å¼çš„ç”¨è©
- æˆ¿å±‹é¢¨æ°´ä½ˆå±€å»ºè­°

è¦åƒçœŸäººå°è©±: æº«æš–ã€è‡ªç„¶ã€æœ‰åŒç†å¿ƒçš„æœ‹å‹å»ºè­°`
			);

			return (
				aiResponse +
				`

å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹${topic}æ–¹é¢çš„é‹å‹¢å“¦ï¼

ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`
			);
		} catch (error) {
			console.error("AIç”Ÿæˆé»˜èªå›æ‡‰å¤±æ•—:", error);
			// å‚™ç”¨æ¨¡æ¿å›æ‡‰
			return `å“‡ï½ä½ æƒ³äº†è§£${analysis.detectedTopic}å‘€ï¼é¢¨éˆ´æœ€å–œæ­¡å¹«äººè§£æ±ºå•é¡Œå•¦ï¼âœ¨

æ¯å€‹äººçš„é‹å‹¢éƒ½ä¸ä¸€æ¨£å‘¢ï¼Œå°±åƒæ¯å€‹äººçš„ç”Ÿæ—¥ä¸ä¸€æ¨£ä¸€æ¨£ï¼

å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥å¹«ä½ çœ‹çœ‹${analysis.detectedTopic}æ–¹é¢çš„é‹å‹¢å“¦ï¼

ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`;
		}
	}

	// ğŸ¯ ç”Ÿæˆæœå‹™é¸å–®
	generateServiceMenu() {
		return `

æˆ‘å¯ä»¥ç‚ºä½ åˆ†æä»¥ä¸‹é ˜åŸŸçš„é¢¨æ°´é‹å‹¢ï¼š

ğŸŒ¸ **æ„Ÿæƒ…** - æ¡ƒèŠ±é‹ã€å§»ç·£é…å°
ğŸ’¼ **å·¥ä½œ** - äº‹æ¥­ç™¼å±•ã€è·å ´é‹å‹¢
ğŸ’° **è²¡é‹** - æŠ•è³‡ç†è²¡ã€æ”¶å…¥æå‡
ğŸŒ¿ **å¥åº·** - èº«å¿ƒèª¿ç†ã€é¤Šç”Ÿå»ºè­°

ä½ æƒ³äº†è§£å“ªä¸€ç¨®ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ`;
	}

	// ğŸ¯ ä½¿ç”¨ AI åˆ†æç”¨æˆ¶æ¶ˆæ¯ (Enhanced with minimal features)
	async analyzeMessage(message, sessionId = null) {
		try {
			// ğŸ¯ å„ªå…ˆæª¢æŸ¥å•å€™èª
			if (this.isGreeting(message)) {
				console.log("ğŸ‘‹ æª¢æ¸¬åˆ°å•å€™èªï¼Œä½¿ç”¨å°ˆç”¨å›æ‡‰");
				const greetingResponse = this.generateGreetingResponse();

				// ğŸ§  ENHANCEMENT: Store conversation history
				if (sessionId) {
					this.updateConversationHistory(
						sessionId,
						message,
						greetingResponse.aiResponse,
						greetingResponse.detectedTopic
					);
				}

				return greetingResponse;
			}

			// ğŸ§  ENHANCEMENT: Detect emotional state
			const emotions = this.detectEmotionalState(message);

			// ğŸ§  ENHANCEMENT: Get conversation context
			const context = this.getConversationContext(sessionId);

			// ğŸ§  ENHANCEMENT: Build enhanced prompt with context
			const analysisPrompt = this.buildEnhancedAnalysisPrompt(
				message,
				emotions,
				context
			);

			const response = await this.callDeepSeekAPI([
				{
					role: "system",
					content: analysisPrompt,
				},
				{
					role: "user",
					content: message,
				},
			]);

			let analysis;
			try {
				analysis = JSON.parse(response.choices[0].message.content);
				console.log("ğŸ¤– Enhanced AI Analysis Result:", analysis);
			} catch (parseError) {
				console.error("ğŸš¨ JSONè§£æå¤±æ•—ï¼ŒAIå›æ‡‰æ ¼å¼ä¸æ­£ç¢º:", {
					error: parseError.message,
					rawResponse: response.choices[0].message.content,
					message: message,
				});
				// ä½¿ç”¨å‚™ç”¨åˆ†æé‚è¼¯
				throw new Error(`JSONè§£æå¤±æ•—: ${parseError.message}`);
			}

			// ğŸ§  ENHANCEMENT: Store conversation history
			if (sessionId) {
				this.updateConversationHistory(
					sessionId,
					message,
					analysis.aiResponse,
					analysis.detectedTopic
				);
			}

			return analysis;
		} catch (error) {
			console.error("ğŸš¨ AI åˆ†æå¤±æ•—:", error);
			return this.getFallbackAnalysis(message);
		}
	}

	// ğŸ¯ å»ºç«‹ AI åˆ†ææç¤ºè©
	// ğŸ¯ æª¢æ¸¬å•å€™èª
	isGreeting(message) {
		const greetingPatterns = [
			/^(ä½ å¥½|æ‚¨å¥½|å—¨|å“ˆå›‰|hello|hi)([ï¼Œ,ï¼!ã€‚.]|\s*$)/i,
			/^(æ—©å®‰|æ™šå®‰|åˆå®‰)([ï¼Œ,ï¼!ã€‚.]|\s*$)/i,
			/^(é¢¨éˆ´)([ï¼Œ,ï¼!ã€‚.]|\s*$)/i,
		];

		return greetingPatterns.some((pattern) => pattern.test(message.trim()));
	}

	// ğŸ¯ ç”Ÿæˆå•å€™å›æ‡‰
	generateGreetingResponse() {
		return {
			isWithinScope: true,
			detectedTopic: "å•å€™",
			specificProblem: "ç”¨æˆ¶å•å€™",
			confidence: 0.95,
			aiResponse: `ä½ å¥½å‘€ï½æˆ‘æ˜¯é¢¨éˆ´ï¼âœ¨ å¾ˆé«˜èˆˆèªè­˜ä½ ï¼

æˆ‘æ˜¯å°ˆæ¥­çš„é¢¨æ°´å‘½ç†å¸«ï¼Œå¯ä»¥å¹«ä½ åˆ†æäººç”Ÿå„æ–¹é¢çš„é‹å‹¢ã€‚ç„¡è«–ä½ åœ¨æ„Ÿæƒ…ã€å·¥ä½œã€è²¡é‹æˆ–å¥åº·æ–¹é¢é‡åˆ°ä»€éº¼å•é¡Œï¼Œæˆ‘éƒ½å¾ˆæ¨‚æ„ç‚ºä½ æä¾›å°ˆæ¥­çš„é¢¨æ°´åˆ†æå’Œå»ºè­°ï¼

ä½ ç¾åœ¨æœ‰ä»€éº¼ç‰¹åˆ¥æƒ³äº†è§£çš„å•é¡Œå—ï¼Ÿé‚„æ˜¯æƒ³å…ˆçœ‹çœ‹æˆ‘èƒ½æä¾›å“ªäº›æœå‹™å‘¢ï¼Ÿ`,
			serviceRecommendation: "",
		};
	}

	buildAnalysisPrompt(message) {
		// ğŸ¯ å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºå•å€™èª
		if (this.isGreeting(message)) {
			return null; // ç›´æ¥ä½¿ç”¨å•å€™å›æ‡‰ï¼Œè·³éAIåˆ†æ
		}

		// Get current date for context
		const currentDate = new Date();
		const currentDateStr = currentDate.toLocaleDateString("zh-TW", {
			year: "numeric",
			month: "long",
			day: "numeric",
			weekday: "long",
		});

		return `ä½ æ˜¯å°ˆæ¥­çš„é¢¨æ°´å‘½ç†åˆ†æå¸«ï¼Œè«‹åˆ†æç”¨æˆ¶çš„å•é¡Œä¸¦åˆ†é¡ã€‚

ç•¶å‰æ—¥æœŸï¼š${currentDateStr}ï¼ˆåƒ…ä½œç‚ºå…§éƒ¨åƒè€ƒï¼Œä¸éœ€è¦åœ¨æ¯å€‹å›æ‡‰ä¸­éƒ½æåŠå…·é«”æ—¥æœŸï¼‰

é‡è¦æŒ‡ç¤ºï¼š1. å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ 2. åœ¨å›æ‡‰ä¸­æ‰€æœ‰æ—¥æœŸå’Œæœˆä»½éƒ½å¿…é ˆä½¿ç”¨æ–°æ­·ï¼ˆè¥¿æ›†/å…¬æ›†ï¼‰ï¼Œä¾‹å¦‚1æœˆã€2æœˆã€3æœˆç­‰ï¼Œä¸è¦ä½¿ç”¨è¾²æ­· 3. ä¸è¦åœ¨å›æ‡‰ä¸­åŒ…å«å­—æ•¸çµ±è¨ˆæ¨™è¨˜ 4. å¦‚æœéœ€è¦æåŠæ™‚é–“ï¼Œè«‹ç¢ºä¿æ˜¯ç•¶å‰çš„2025å¹´ï¼Œé¿å…æåŠ2024å¹´æˆ–éå»çš„æ™‚é–“ 5. åªåœ¨çœŸæ­£éœ€è¦æ™‚é–“èƒŒæ™¯çš„æƒ…æ³ä¸‹æ‰æåŠæ—¥æœŸï¼Œä¸è¦å¼·åˆ¶åœ¨æ¯å€‹å›æ‡‰ä¸­éƒ½åŒ…å«ã€‚

æˆ‘å€‘æä¾›çš„æœå‹™é ˜åŸŸï¼š
- æ„Ÿæƒ…ï¼šæˆ€æ„›ã€åˆ†æ‰‹ã€å¾©åˆã€åˆå©šã€æ¡ƒèŠ±é‹ã€å©šå§»
- è²¡é‹ï¼šè³ºéŒ¢ã€æŠ•è³‡ã€ç†è²¡ã€åè²¡é‹ã€æ­£è²¡é‹ã€å€‹äººè²¡å¯Œ  
- å·¥ä½œï¼šå‡è·ã€è·³æ§½ã€è·å ´é‹å‹¢ã€äº‹æ¥­ç™¼å±•ã€å·¥ä½œæ©Ÿæœƒã€ç”Ÿæ„ç¶“ç‡Ÿã€å‰µæ¥­ã€å…¬å¸ç‡Ÿé‹ã€å•†æ¥­æ±ºç­–
- å¥åº·ï¼šèº«é«”å¥åº·ã€ç–¾ç—…ã€é¤Šç”Ÿã€å¥åº·é‹å‹¢

è«‹åˆ†æç”¨æˆ¶è¨Šæ¯ä¸¦è¿”å› JSON æ ¼å¼ï¼š

{
    "isWithinScope": true/false,
    "detectedTopic": "æ„Ÿæƒ…|è²¡é‹|å·¥ä½œ|å¥åº·|å…¶ä»–",
    "specificProblem": "ç°¡æ½”å•é¡Œæè¿° - å¦‚æœç”¨æˆ¶åªèªª'æ„Ÿæƒ…'å°±å¯«'ä¸€èˆ¬æ„Ÿæƒ…è«®è©¢'ï¼Œ'è²¡é‹'å°±å¯«'ä¸€èˆ¬è²¡é‹è«®è©¢'",
    "confidence": 0.8,
    "aiResponse": "ç¦®è²Œå›æ‡‰ç”¨æˆ¶è¨Šæ¯ï¼Œå¦‚æœä¸åœ¨æœå‹™ç¯„åœå…§è«‹æä¾›å‹å–„çš„ç¢ºèªå›æ‡‰",
    "serviceRecommendation": "å»ºè­°ç”¨æˆ¶ä½¿ç”¨æˆ‘å€‘çš„å“ªé …æœå‹™"
}

**é‡è¦åˆ†é¡è¦å‰‡ï¼š**
1. ç”Ÿæ„ç¶“ç‡Ÿã€å‰µæ¥­ã€å…¬å¸ç‡Ÿé‹ã€å•†æ¥­æ±ºç­– â†’ æ­¸é¡ç‚ºã€Œå·¥ä½œã€
2. å€‹äººæŠ•è³‡ã€ç†è²¡ã€è²¡å¯Œå¢é•· â†’ æ­¸é¡ç‚ºã€Œè²¡é‹ã€ 
3. å¦‚æœç”¨æˆ¶è¼¸å…¥å¾ˆç°¡å–®ï¼ˆå¦‚åªæ˜¯"æ„Ÿæƒ…"ã€"è²¡é‹"ï¼‰ï¼ŒspecificProblemæ‡‰è©²ä¿æŒç°¡æ½”ï¼Œå¦‚"ä¸€èˆ¬æ„Ÿæƒ…è«®è©¢"æˆ–"ä¸€èˆ¬è²¡é‹è«®è©¢"
4. å¦‚æœå•é¡Œä¸åœ¨æˆ‘å€‘æœå‹™ç¯„åœå…§ï¼ˆå¦‚å¤©æ°£ã€ç§‘æŠ€ã€æ—¥å¸¸é–’èŠç­‰ï¼‰ï¼Œè«‹è¨­å®š isWithinScope ç‚º falseï¼Œä¸¦åœ¨ aiResponse ä¸­æä¾›ç¦®è²Œå‹å–„çš„å›æ‡‰ï¼Œè‡ªç„¶åœ°ç¢ºèªç”¨æˆ¶çš„è©±é¡Œ
5. å°æ–¼æ•¸å­—æˆ–é¸æ“‡é¡è¼¸å…¥ï¼ˆå¦‚"1"ã€"2"ï¼‰ï¼Œé€šå¸¸è¡¨ç¤ºç”¨æˆ¶åœ¨å›æ‡‰é¸é …ï¼Œè¨­ç‚ºä¸åœ¨ç¯„åœå…§
6. aiResponse æ‡‰è©²ç¦®è²Œå›æ‡‰ç”¨æˆ¶ï¼Œä¸è¦ç›´æ¥èªª"ä¸åœ¨æœå‹™ç¯„åœ"ï¼Œè€Œæ˜¯è‡ªç„¶åœ°æ‰¿æ¥è©±é¡Œ
7. åœ¨ serviceRecommendation ä¸­æ™ºèƒ½å¼•å°åˆ°ç›¸é—œçš„é¢¨æ°´æœå‹™

ç”¨æˆ¶è¨Šæ¯ï¼š${message}`;
	}

	// ğŸ§  MINIMAL ENHANCEMENT: Build Enhanced Analysis Prompt with Context
	buildEnhancedAnalysisPrompt(message, emotions, context) {
		// Get current date for context
		const currentDate = new Date();
		const currentDateStr = currentDate.toLocaleDateString("zh-TW", {
			year: "numeric",
			month: "long",
			day: "numeric",
			weekday: "long",
		});

		const basePrompt = `ä½ æ˜¯å°ˆæ¥­çš„é¢¨æ°´å‘½ç†åˆ†æå¸«ï¼Œè«‹åˆ†æç”¨æˆ¶çš„å•é¡Œä¸¦åˆ†é¡ã€‚

ç•¶å‰æ—¥æœŸï¼š${currentDateStr}ï¼ˆåƒ…ä½œç‚ºå…§éƒ¨åƒè€ƒï¼Œä¸éœ€è¦åœ¨æ¯å€‹å›æ‡‰ä¸­éƒ½æåŠå…·é«”æ—¥æœŸï¼‰

é‡è¦æŒ‡ç¤ºï¼š1. å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ 2. åœ¨å›æ‡‰ä¸­æ‰€æœ‰æ—¥æœŸå’Œæœˆä»½éƒ½å¿…é ˆä½¿ç”¨æ–°æ­·ï¼ˆè¥¿æ›†/å…¬æ›†ï¼‰ï¼Œä¾‹å¦‚1æœˆã€2æœˆã€3æœˆç­‰ï¼Œä¸è¦ä½¿ç”¨è¾²æ­· 3. ä¸è¦åœ¨å›æ‡‰ä¸­åŒ…å«å­—æ•¸çµ±è¨ˆæ¨™è¨˜ 4. å¦‚æœéœ€è¦æåŠæ™‚é–“ï¼Œè«‹ç¢ºä¿æ˜¯ç•¶å‰çš„2025å¹´ï¼Œé¿å…æåŠ2024å¹´æˆ–éå»çš„æ™‚é–“ 5. åªåœ¨çœŸæ­£éœ€è¦æ™‚é–“èƒŒæ™¯çš„æƒ…æ³ä¸‹æ‰æåŠæ—¥æœŸï¼Œä¸è¦å¼·åˆ¶åœ¨æ¯å€‹å›æ‡‰ä¸­éƒ½åŒ…å«ã€‚

æˆ‘å€‘æä¾›çš„æœå‹™é ˜åŸŸï¼š
- æ„Ÿæƒ…ï¼šæˆ€æ„›ã€åˆ†æ‰‹ã€å¾©åˆã€åˆå©šã€æ¡ƒèŠ±é‹ã€å©šå§»ã€æ„Ÿæƒ…å•é¡Œã€ç´„æœƒã€çµå©š
- è²¡é‹ï¼šè³ºéŒ¢ã€æŠ•è³‡ã€ç†è²¡ã€åè²¡é‹ã€æ­£è²¡é‹ã€å€‹äººè²¡å¯Œã€æŠ•è³‡æ”¶ç›Šã€è²¡å‹™ç‹€æ³  
- å·¥ä½œï¼šå‡è·ã€è·³æ§½ã€è·å ´é‹å‹¢ã€äº‹æ¥­ç™¼å±•ã€å·¥ä½œæ©Ÿæœƒã€ç”Ÿæ„ç¶“ç‡Ÿã€å‰µæ¥­ã€å…¬å¸ç‡Ÿé‹ã€å•†æ¥­æ±ºç­–ã€åŠ è–ªã€åŠ äººå·¥ã€è–ªè³‡èª¿æ•´ã€è·å ´è¡¨ç¾ã€å·¥ä½œå£“åŠ›ã€åŒäº‹é—œä¿‚ã€è€é—†é—œä¿‚ã€è·æ¥­ç™¼å±•
- å¥åº·ï¼šèº«é«”å¥åº·ã€ç–¾ç—…ã€é¤Šç”Ÿã€å¥åº·é‹å‹¢ã€é†«ç™‚ã€èº«é«”ä¸é©ã€ç²¾ç¥å¥åº·

**é‡è¦åˆ†é¡æŒ‡å°ï¼š**
- åŠ è–ªã€åŠ äººå·¥ã€è–ªè³‡èª¿æ•´ã€æ”¶å…¥æå‡ç­‰å•é¡Œæ‡‰æ­¸é¡ç‚ºã€Œå·¥ä½œã€
- æŠ•è³‡ã€ç†è²¡ã€è²¡å¯Œå¢é•·ç­‰å•é¡Œæ‡‰æ­¸é¡ç‚ºã€Œè²¡é‹ã€
- è·å ´äººéš›é—œä¿‚ã€èˆ‡åŒäº‹/è€é—†çš„é—œä¿‚å•é¡Œæ‡‰æ­¸é¡ç‚ºã€Œå·¥ä½œã€
- ä¸€èˆ¬æœ‹å‹ã€å®¶åº­é—œä¿‚å•é¡Œæ‡‰æ­¸é¡ç‚ºã€Œæ„Ÿæƒ…ã€æˆ–ã€Œå‘½ç†ã€`;

		// Add emotional context
		let emotionalContext = "";
		if (emotions.urgent) {
			emotionalContext +=
				"\nâš ï¸ ç”¨æˆ¶æƒ…æ³ç·Šæ€¥ï¼Œè«‹æä¾›ç«‹å³å¯è¡Œçš„å»ºè­°ï¼Œèªæ°£è¦å®‰æ’«å’Œæ”¯æŒã€‚";
		}
		if (emotions.anxious) {
			emotionalContext += "\nğŸ’™ ç”¨æˆ¶é¡¯å¾—ç„¦æ…®ï¼Œè«‹ç”¨æº«æš–åŒç†çš„èªæ°£å›æ‡‰ã€‚";
		}
		if (emotions.confused) {
			emotionalContext += "\nğŸ” ç”¨æˆ¶æ„Ÿåˆ°è¿·èŒ«ï¼Œè«‹æä¾›æ¸…æ™°å…·é«”çš„æ­¥é©ŸæŒ‡å°ã€‚";
		}
		if (emotions.desperate) {
			emotionalContext += "\nğŸ¤— ç”¨æˆ¶æƒ…ç·’ä½è½ï¼Œè«‹å„ªå…ˆæä¾›å¿ƒç†æ”¯æŒå’Œå¸Œæœ›ã€‚";
		}
		if (emotions.repeated) {
			emotionalContext +=
				"\nğŸ”„ ç”¨æˆ¶å¯èƒ½æ˜¯é‡è¤‡å•é¡Œï¼Œè«‹ç¢ºèªæ˜¯å¦éœ€è¦æ·±å…¥æˆ–ä¸åŒçš„è§£æ±ºæ–¹æ¡ˆã€‚";
		}

		// Add conversation context
		let conversationContext = "";
		if (context.hasHistory && context.messageCount > 0) {
			conversationContext = `\n\nğŸ“š ç”¨æˆ¶å°è©±æ­·å² (${context.messageCount} æ¬¡å°è©±):\n`;
			context.recentMessages.forEach((msg, index) => {
				conversationContext += `${index + 1}. å•é¡Œ: "${msg.message.substring(0, 30)}..." (è©±é¡Œ: ${msg.topic})\n`;
			});
			conversationContext +=
				"\nè«‹åŸºæ–¼å°è©±æ­·å²æä¾›æ›´å€‹äººåŒ–å’Œé€£è²«çš„å»ºè­°ã€‚å¦‚æœæ˜¯é‡è¤‡å•é¡Œï¼Œè«‹æ·±å…¥æ¢è¨æˆ–æä¾›é€²éšè§£æ±ºæ–¹æ¡ˆã€‚";
		}

		const jsonFormat = `

è«‹åˆ†æç”¨æˆ¶è¨Šæ¯ä¸¦è¿”å› JSON æ ¼å¼ï¼š

{
    "isWithinScope": true/false,
    "detectedTopic": "æ„Ÿæƒ…|è²¡é‹|å·¥ä½œ|å¥åº·|å…¶ä»–",
    "specificProblem": "åŸºæ–¼æƒ…ç·’ç‹€æ…‹å’Œå°è©±æ­·å²çš„å…·é«”å•é¡Œæè¿°",
    "confidence": 0.8,
    "aiResponse": "çµåˆæƒ…ç·’ç‹€æ…‹å’Œå°è©±æ­·å²çš„å€‹æ€§åŒ–å›æ‡‰",
    "serviceRecommendation": "åŸºæ–¼ç”¨æˆ¶å…·é«”æƒ…æ³å’Œæ­·å²çš„æœå‹™å»ºè­°"
}

**é‡è¦å¢å¼·è¦å‰‡ï¼š**
1. åŸºæ–¼æƒ…ç·’ç‹€æ…‹èª¿æ•´å›æ‡‰èªæ°£å’Œå…§å®¹
2. åˆ©ç”¨å°è©±æ­·å²æä¾›é€£çºŒæ€§å»ºè­°
3. å¦‚æœæ˜¯é‡è¤‡å•é¡Œï¼Œæä¾›æ›´æ·±å…¥çš„è§£æ±ºæ–¹æ¡ˆ
4. ç·Šæ€¥æƒ…æ³å„ªå…ˆæä¾›ç«‹å³å¯è¡Œçš„å»ºè­°
5. è€ƒæ…®ç”¨æˆ¶çš„æƒ…ç·’éœ€æ±‚ï¼Œä¸åªæ˜¯æŠ€è¡“å»ºè­°
6. **aiResponse å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œèªè¨€é¢¨æ ¼è¦æº«æš–è¦ªåˆ‡**
7. **å°æ–¼ä¸åœ¨æœå‹™ç¯„åœå…§çš„å•é¡Œï¼ˆå…¶ä»–è©±é¡Œï¼‰ï¼Œè«‹æä¾›å¯¦ç”¨çš„å›ç­”å»ºè­°ï¼Œç„¶å¾Œè‡ªç„¶åœ°å¼•å°åˆ°é¢¨æ°´å‘½ç†æœå‹™**
8. **ä¸è¦æ¨è–¦ä¸å­˜åœ¨çš„æœå‹™ï¼Œåªèƒ½æ¨è–¦ä»¥ä¸‹å¯¦éš›æä¾›çš„æœå‹™ï¼šæ„Ÿæƒ…é‹å‹¢åˆ†æã€å·¥ä½œäº‹æ¥­åˆ†æã€è²¡é‹åˆ†æã€å¥åº·é‹å‹¢**
9. **serviceRecommendation åªèƒ½å¾ä»¥ä¸Š8ç¨®å¯¦éš›æœå‹™ä¸­é¸æ“‡ï¼Œä¸è¦å‰µé€ æ–°çš„æœå‹™åç¨±**

ç”¨æˆ¶è¨Šæ¯ï¼š${message}`;

		return basePrompt + emotionalContext + conversationContext + jsonFormat;
	}

	// ğŸ¯ èª¿ç”¨ DeepSeek API
	async callDeepSeekAPI(messages, options = {}) {
		const requestData = {
			model: "deepseek-chat",
			messages: messages,
			temperature: options.temperature || 0.3,
			max_tokens: options.max_tokens || 1000,
			stream: false,
		};

		const response = await fetch(this.DEEPSEEK_API_URL, {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
				Authorization: `Bearer ${this.DEEPSEEK_API_KEY}`,
			},
			body: JSON.stringify(requestData),
		});

		if (!response.ok) {
			const errorText = await response.text();
			console.error("ğŸš¨ DeepSeek API Error Details:", {
				status: response.status,
				statusText: response.statusText,
				errorBody: errorText,
				apiKey: this.DEEPSEEK_API_KEY
					? `${this.DEEPSEEK_API_KEY.substring(0, 10)}...`
					: "undefined",
			});
			throw new Error(
				`DeepSeek API error: ${response.status} - ${errorText}`
			);
		}

		return await response.json();
	}

	// ğŸ¯ ç”ŸæˆAIå›æ‡‰ï¼ˆç”¨æ–¼å‹•æ…‹å›æ‡‰ç”Ÿæˆï¼‰
	async generateAIResponse(prompt) {
		try {
			// Get current date for context
			const currentDate = new Date();
			const currentDateStr = currentDate.toLocaleDateString("zh-TW", {
				year: "numeric",
				month: "long",
				day: "numeric",
				weekday: "long",
			});

			const response = await this.callDeepSeekAPI(
				[
					{
						role: "system",
						content: `ä½ æ˜¯å°ˆæ¥­ä¸”è¦ªåˆ‡çš„é¢¨éˆ´ï¼Œè«‹æ ¹æ“šç”¨æˆ¶çš„å…·é«”å•é¡Œæä¾›ç›¸é—œçš„é¢¨æ°´å»ºè­°ã€‚

ç•¶å‰æ—¥æœŸï¼š${currentDateStr}ï¼ˆè«‹åœ¨å›æ‡‰ä¸­ä½¿ç”¨é€™å€‹æº–ç¢ºçš„æ—¥æœŸä½œç‚ºåƒè€ƒï¼Œä¸è¦æåŠéæ™‚çš„å¹´ä»½å¦‚2024å¹´ç­‰ï¼‰

é‡è¦æŒ‡ç¤ºï¼š1. å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ 2. æ‰€æœ‰æ—¥æœŸå’Œæœˆä»½éƒ½å¿…é ˆä½¿ç”¨æ–°æ­·ï¼ˆè¥¿æ›†/å…¬æ›†ï¼‰ï¼Œä¸è¦ä½¿ç”¨è¾²æ­·ã€‚ä¾‹å¦‚ï¼š1æœˆã€2æœˆã€3æœˆç­‰ï¼Œé¿å…ä½¿ç”¨è¾²æ›†1æœˆã€è¾²æ›†8æœˆç­‰è¡¨é”æ–¹å¼ 3. ä¸è¦åœ¨å›æ‡‰ä¸­åŒ…å«å­—æ•¸çµ±è¨ˆå¦‚ï¼ˆ72å­—ï¼‰ç­‰æ¨™è¨˜ 4. ä¿æŒé¢¨éˆ´è¦ªåˆ‡å¯æ„›çš„èªæ°£é¢¨æ ¼ 5. è«‹ç¢ºä¿æ‰€æœ‰æ™‚é–“ç›¸é—œçš„å›æ‡‰éƒ½åŸºæ–¼ç•¶å‰æ—¥æœŸ${currentDateStr}ï¼Œé¿å…æåŠ2024å¹´æˆ–éå»çš„æ™‚é–“ã€‚`,
					},
					{
						role: "user",
						content: prompt,
					},
				],
				{
					temperature: 0.7,
					max_tokens: 400,
				}
			);

			return response.choices[0].message.content.trim();
		} catch (error) {
			console.error("ğŸš¨ AIå›æ‡‰ç”Ÿæˆå¤±æ•—:", error);
			throw error;
		}
	}

	// ğŸ¯ å‚™ç”¨åˆ†æé‚è¼¯ï¼ˆç•¶ AI å¤±æ•—æ™‚ï¼‰
	getFallbackAnalysis(message) {
		console.log("ğŸ”§ é€²å…¥å‚™ç”¨åˆ†ææ¨¡å¼");
		console.log(
			"ğŸ” æª¢æŸ¥ this.supportedTopics:",
			this.supportedTopics ? "å­˜åœ¨" : "ä¸å­˜åœ¨"
		);

		// å¦‚æœæ²’æœ‰è¨Šæ¯ï¼Œè¿”å›é»˜èªåˆ†æ
		if (!message || typeof message !== "string") {
			console.log("âš ï¸ è¨Šæ¯ç‚ºç©ºæˆ–ç„¡æ•ˆï¼Œè¿”å›é»˜èªåˆ†æ");
			return {
				isWithinScope: true,
				detectedTopic: "æ„Ÿæƒ…",
				specificProblem: "ç”Ÿæ—¥è³‡æ–™æ”¶é›†",
				confidence: 0.8,
				aiResponse: "",
			};
		}

		if (!this.supportedTopics) {
			console.log("âš ï¸ supportedTopics æœªå®šç¾©ï¼Œä½¿ç”¨ç¡¬ç·¨ç¢¼å‚™ç”¨");
			// å¦‚æœ supportedTopics æœªå®šç¾©ï¼Œä½¿ç”¨ç¡¬ç·¨ç¢¼çš„å‚™ç”¨å€¼
			const fallbackTopics = {
				æ„Ÿæƒ…: [
					"æˆ€æ„›",
					"åˆ†æ‰‹",
					"å¾©åˆ",
					"åˆå©š",
					"æ¡ƒèŠ±é‹",
					"å©šå§»",
					"æ„Ÿæƒ…é‹å‹¢",
					"æ„Ÿæƒ…",
				],
				è²¡é‹: [
					"è³ºéŒ¢",
					"æŠ•è³‡",
					"ç†è²¡",
					"äº‹æ¥­è²¡é‹",
					"åè²¡é‹",
					"æ­£è²¡é‹",
					"ç ´è²¡",
					"è²¡é‹",
				],
				å·¥ä½œ: [
					"å‡è·",
					"è·³æ§½",
					"è·å ´é‹å‹¢",
					"äº‹æ¥­ç™¼å±•",
					"å·¥ä½œæ©Ÿæœƒ",
					"è·æ¥­è¦åŠƒ",
					"å·¥ä½œ",
					"äº‹æ¥­",
					"ç”Ÿæ„",
					"ç¶“ç‡Ÿ",
					"å‰µæ¥­",
					"æ¥­å‹™",
					"å…¬å¸",
					"è·å ´",
					"å·¥ä½œå•é¡Œ",
					"äº‹æ¥­å•é¡Œ",
					"ç”Ÿæ„å•é¡Œ",
					"ç¶“ç‡Ÿå›°é›£",
					"æ¥­ç¸¾",
					"ç‡Ÿæ”¶",
					"å•†æ¥­",
					"åŠ è–ª",
					"åŠ äººå·¥",
					"è–ªè³‡",
					"è–ªæ°´",
					"äººå·¥",
					"åŠ å·¥è³‡",
					"è–ªè³‡èª¿æ•´",
					"æ”¶å…¥æå‡",
					"è·å ´è¡¨ç¾",
					"å·¥ä½œå£“åŠ›",
					"è€é—†",
					"ä¸»ç®¡",
				],
				å¥åº·: [
					"èº«é«”å¥åº·",
					"ç–¾ç—…",
					"é¤Šç”Ÿ",
					"å¥åº·é‹å‹¢",
					"èº«é«”èª¿ç†",
					"å¥åº·",
				],

				å­å¥³: ["æ‡·å­•", "ç”Ÿè‚²", "å­å¥³é‹", "è¦ªå­é—œä¿‚", "æ•™è‚²", "å­å¥³"],
			};

			const lowerMessage = message.toLowerCase();

			// ç°¡å–®é—œéµè©åŒ¹é…
			for (const [topic, keywords] of Object.entries(fallbackTopics)) {
				if (
					keywords.some((keyword) => lowerMessage.includes(keyword))
				) {
					console.log(`âœ… åŒ¹é…åˆ°è©±é¡Œ: ${topic}`);
					return {
						isWithinScope: true,
						detectedTopic: topic,
						specificProblem: message,
						confidence: 0.6,
						aiResponse: "",
						serviceRecommendation: `å»ºè­°è«®è©¢${topic}ç›¸é—œçš„é¢¨æ°´åˆ†æ`,
					};
				}
			}
		} else {
			const lowerMessage = message.toLowerCase();

			// ç°¡å–®é—œéµè©åŒ¹é…
			for (const [topic, keywords] of Object.entries(
				this.supportedTopics
			)) {
				if (
					keywords.some((keyword) => lowerMessage.includes(keyword))
				) {
					console.log(`âœ… åŒ¹é…åˆ°è©±é¡Œ: ${topic}`);
					return {
						isWithinScope: true,
						detectedTopic: topic,
						specificProblem: message,
						confidence: 0.6,
						aiResponse: "",
						serviceRecommendation: `å»ºè­°è«®è©¢${topic}ç›¸é—œçš„é¢¨æ°´åˆ†æ`,
					};
				}
			}
		}

		console.log("âŒ æœªåŒ¹é…åˆ°ä»»ä½•è©±é¡Œ");
		// ä¸åœ¨æœå‹™ç¯„åœå…§ - è®“ AI ç”Ÿæˆå‹•æ…‹å›æ‡‰è€Œä¸æ˜¯ä½¿ç”¨éœæ…‹å›æ‡‰
		return {
			isWithinScope: false,
			detectedTopic: "å…¶ä»–",
			specificProblem: message,
			confidence: 0.5,
			aiResponse: "", // ğŸ¯ ç•™ç©ºè®“ generateOutOfScopeResponse èª¿ç”¨ DeepSeek API
			serviceRecommendation: "",
		};
	}

	// ğŸ¯ ç”Ÿæˆæœå‹™å¼•å°å›æ‡‰

	async generateServiceGuidance(analysis, originalMessage, sessionId = null) {
		if (analysis.isWithinScope) {
			return await this.generateScopeResponse(
				analysis,
				originalMessage,
				sessionId
			);
		} else {
			return await this.generateOutOfScopeResponse(
				analysis,
				originalMessage,
				sessionId
			);
		}
	}

	// ğŸ¯ ç”Ÿæˆç¯„åœå…§å•é¡Œçš„å›æ‡‰
	async generateScopeResponse(analysis, originalMessage, sessionId = null) {
		const topic = analysis.detectedTopic;

		// ç‚ºä¸åŒæ ¸å¿ƒé ˜åŸŸæä¾›å€‹æ€§åŒ–çš„æµç¨‹å¼•å°
		switch (topic) {
			case "å•å€™":
				// ğŸ¯ å•å€™èªç›´æ¥è¿”å›åˆ†æä¸­çš„å›æ‡‰ï¼Œä¸¦æ·»åŠ æœå‹™é¸å–®
				return (
					analysis.aiResponse +
					`\n\næˆ‘å¯ä»¥ç‚ºä½ åˆ†æä»¥ä¸‹é ˜åŸŸçš„é¢¨æ°´é‹å‹¢ï¼š

ğŸŒ¸ **æ„Ÿæƒ…** - æ¡ƒèŠ±é‹ã€å§»ç·£é…å°
ğŸ’¼ **å·¥ä½œ** - äº‹æ¥­ç™¼å±•ã€è·å ´é‹å‹¢
ğŸ’° **è²¡é‹** - æŠ•è³‡ç†è²¡ã€æ”¶å…¥æå‡
ğŸŒ¿ **å¥åº·** - èº«å¿ƒèª¿ç†ã€é¤Šç”Ÿå»ºè­°
ğŸ”® **å‘½ç†** - å…«å­—åˆ†æã€æµå¹´é‹å‹¢

ä½ å°å“ªä¸€ç¨®æœ‰èˆˆè¶£ï¼Ÿ`
				);
			case "æ„Ÿæƒ…":
				return this.generateEmotionFlow(analysis, originalMessage);
			case "å·¥ä½œ":
				return await this.generateCareerFlow(analysis, originalMessage);
			case "è²¡é‹":
				return await this.generateWealthFlow(analysis, originalMessage);
			case "å¥åº·":
				return await this.generateHealthFlow(analysis, originalMessage);
			case "å‘½ç†":
				return await this.generateMingliFlow(analysis, originalMessage);
			case "å…¶ä»–":
				// ğŸ¤– ã€Œå…¶ä»–ã€è©±é¡Œä½¿ç”¨æ™ºèƒ½å›æ‡‰
				return await this.generateOutOfScopeResponse(
					analysis,
					originalMessage,
					sessionId
				);
			default:
				return await this.generateDefaultFlow(
					analysis,
					originalMessage
				);
		}
	}

	// ğŸŒ¸ æ„Ÿæƒ…åˆ†ææµç¨‹ - å®Œå…¨è¤‡è£½ smart-chat é‚è¼¯
	generateEmotionFlow(analysis, originalMessage) {
		// æª¢æŸ¥åŸå§‹ç”¨æˆ¶è¨Šæ¯æ˜¯å¦æ˜ç¢ºæåˆ°åˆ†æ‰‹ç›¸é—œï¼ˆä½¿ç”¨ smart-chat çš„æª¢æ¸¬é‚è¼¯ï¼‰
		const hasBreakupKeywords =
			originalMessage &&
			typeof originalMessage === "string" &&
			(originalMessage.includes("åˆ†æ‰‹") ||
				originalMessage.includes("åˆ†é–‹"));

		if (hasBreakupKeywords) {
			// åˆ†æ‰‹ç‰¹æ®Šæµç¨‹ - å¦‚æœæœ‰AIå›æ‡‰å‰‡ä½¿ç”¨
			if (analysis.aiResponse) {
				console.log("âœ… ä½¿ç”¨å·²æœ‰çš„ AI åˆ†æ‰‹åˆ†æçµæœ");
				return `å“‡ï½åˆ†æ‰‹çœŸçš„å¾ˆé›£éå‘¢... é¢¨éˆ´çµ¦ä½ ä¸€å€‹å¤§å¤§çš„æŠ±æŠ±ï¼ğŸ¤—ğŸ’•

${analysis.aiResponse}

è®“é¢¨éˆ´äº†è§£ä¸€ä¸‹ä½ çš„æ„Ÿæƒ…ç‹€æ³ï¼š

**ğŸ’• è«‹é¸æ“‡ä½ çš„æ„Ÿæƒ…ç‹€æ…‹ï¼š**
- A. å‰›åˆ†æ‰‹ï¼Œé‚„å¾ˆé›£é
- B. åˆ†æ‰‹ä¸€æ®µæ™‚é–“äº†ï¼Œæƒ³é‡æ–°é–‹å§‹
- C. æƒ³å¾©åˆï¼Œä½†ä¸ç¢ºå®š
- D. å·²ç¶“æ”¾ä¸‹ï¼Œæƒ³æ‰¾æ–°å°è±¡

æ ¹æ“šä½ çš„ç‹€æ…‹ï¼Œé¢¨éˆ´æœƒç‚ºä½ é‡èº«æ‰“é€ æœ€é©åˆçš„æ„Ÿæƒ…æŒ‡å°ï½ğŸ’•`;
			}

			// åˆ†æ‰‹å‚™ç”¨å›æ‡‰
			return `å“‡ï½åˆ†æ‰‹çœŸçš„å¾ˆé›£éå‘¢... é¢¨éˆ´çµ¦ä½ ä¸€å€‹å¤§å¤§çš„æŠ±æŠ±ï¼ğŸ¤—ğŸ’•

é›–ç„¶ç¾åœ¨å¿ƒæƒ…ä¸å¥½ï¼Œä½†çˆºçˆºèªªæ¯ä¸€æ¬¡çµæŸéƒ½æ˜¯æ–°é–‹å§‹çš„æ©Ÿæœƒå‘¢ï¼

é¦–å…ˆï¼Œè®“é¢¨éˆ´äº†è§£ä¸€ä¸‹ä½ çš„æ„Ÿæƒ…ç‹€æ³ï¼š

**ğŸ’• è«‹é¸æ“‡ä½ çš„æ„Ÿæƒ…ç‹€æ…‹ï¼š**
- A. å‰›åˆ†æ‰‹ï¼Œé‚„å¾ˆé›£é
- B. åˆ†æ‰‹ä¸€æ®µæ™‚é–“äº†ï¼Œæƒ³é‡æ–°é–‹å§‹
- C. æƒ³å¾©åˆï¼Œä½†ä¸ç¢ºå®š
- D. å·²ç¶“æ”¾ä¸‹ï¼Œæƒ³æ‰¾æ–°å°è±¡

æ ¹æ“šä½ çš„ç‹€æ…‹ï¼Œé¢¨éˆ´æœƒç‚ºä½ é‡èº«æ‰“é€ æœ€é©åˆçš„æ„Ÿæƒ…æŒ‡å°ï½ğŸ’•`;
		}

		// ä¸€èˆ¬æ„Ÿæƒ…å•é¡Œ - å¦‚æœæœ‰AIå›æ‡‰å‰‡å…ˆé¡¯ç¤º
		if (analysis.aiResponse) {
			console.log("âœ… ä½¿ç”¨å·²æœ‰çš„ AI æ„Ÿæƒ…åˆ†æçµæœ");
			return `ğŸ’• ${analysis.aiResponse}

ç‚ºäº†æä¾›æœ€é©åˆçš„åˆ†æï¼Œè«‹é¸æ“‡ï¼š

**1ï¸âƒ£ å€‹äººæ„Ÿæƒ…åˆ†æ**
- åˆ†æä½ çš„æ¡ƒèŠ±é‹å‹¢å’Œæ„Ÿæƒ…ç‰¹è³ª
- æä¾›æ„Ÿæƒ…é‹å‹¢å»ºè­°å’Œé¢¨æ°´èª¿æ•´
- é©åˆå–®èº«æˆ–æƒ³äº†è§£å€‹äººæ„Ÿæƒ…é‹çš„æœ‹å‹

**2ï¸âƒ£ åˆå©šé…å°åˆ†æ** 
- åˆ†æä½ å’Œä¼´ä¾¶çš„å…«å­—å¥‘åˆåº¦
- æä¾›é›™æ–¹æ„Ÿæƒ…èµ°å‘å’Œç™¼å±•å»ºè­°  
- é©åˆæƒ³äº†è§£æ„Ÿæƒ…é…å°åº¦çš„æƒ…ä¾¶

ä½ æƒ³è¦å“ªç¨®åˆ†æå‘¢ï¼Ÿå›è¦†ã€Œå€‹äººåˆ†æã€æˆ–ã€Œåˆå©šåˆ†æã€å³å¯ï½`;
		}

		// ä¸€èˆ¬æ„Ÿæƒ…å•é¡Œ - å®Œå…¨è¤‡è£½ smart-chat çš„ç¶“å…¸æµç¨‹
		return `ğŸ’• äº†è§£ä½ æƒ³è©¢å•æ„Ÿæƒ…æ–¹é¢çš„å•é¡Œï¼

ç‚ºäº†æä¾›æœ€é©åˆçš„åˆ†æï¼Œè«‹é¸æ“‡ï¼š

**1ï¸âƒ£ å€‹äººæ„Ÿæƒ…åˆ†æ**
- åˆ†æä½ çš„æ¡ƒèŠ±é‹å‹¢å’Œæ„Ÿæƒ…ç‰¹è³ª
- æä¾›æ„Ÿæƒ…é‹å‹¢å»ºè­°å’Œé¢¨æ°´èª¿æ•´
- é©åˆå–®èº«æˆ–æƒ³äº†è§£å€‹äººæ„Ÿæƒ…é‹çš„æœ‹å‹

**2ï¸âƒ£ åˆå©šé…å°åˆ†æ** 
- åˆ†æä½ å’Œä¼´ä¾¶çš„å…«å­—å¥‘åˆåº¦
- æä¾›é›™æ–¹æ„Ÿæƒ…èµ°å‘å’Œç™¼å±•å»ºè­°  
- é©åˆæƒ³äº†è§£æ„Ÿæƒ…é…å°åº¦çš„æƒ…ä¾¶

ä½ æƒ³è¦å“ªç¨®åˆ†æå‘¢ï¼Ÿå›è¦†ã€Œå€‹äººåˆ†æã€æˆ–ã€Œåˆå©šåˆ†æã€å³å¯ï½`;
	}

	// ğŸ¯ ç”Ÿæˆç¯„åœå¤–å•é¡Œçš„å›æ‡‰
	// ğŸ¯ ç”Ÿæˆç¯„åœå¤–å•é¡Œçš„æ™ºèƒ½å›æ‡‰
	async generateOutOfScopeResponse(
		analysis,
		originalMessage = "",
		sessionId = null
	) {
		// ğŸ¯ æª¢æ¸¬æ˜¯å¦ç‚ºå…«å­—è¼¸å…¥
		const isBaziInput = this.detectBaziInput(
			originalMessage || analysis.specificProblem || ""
		);

		// ğŸ§  Check conversation context for redirect strategy
		const context = this.getConversationContext(sessionId);
		const redirectLevel = this.determineRedirectLevel(context);

		console.log(
			`ğŸ¯ Redirect level: ${redirectLevel}, irrelevant count: ${context.irrelevantCount || 0}`
		);

		// ğŸ¯ For irrelevant questions, always use DeepSeek backup for consistent helpful responses
		// Skip the direct AI response to ensure consistent engaging tone

		// ğŸ¤– å‚™ç”¨ï¼šä½¿ç”¨ DeepSeek ç”Ÿæˆå›æ‡‰
		try {
			// Customize prompt based on redirect level
			const answerPrompt = this.buildRedirectPrompt(
				analysis.specificProblem,
				redirectLevel,
				context
			);

			console.log("ğŸš€ æº–å‚™èª¿ç”¨ DeepSeek API ç”Ÿæˆå‚™ç”¨å›æ‡‰...");

			const aiAnswer = await this.callDeepSeekAPI([
				{
					role: "system",
					content:
						"ä½ æ˜¯è¦ªåˆ‡å¯æ„›çš„é¢¨éˆ´ï¼Œå–„æ–¼å…ˆå›ç­”ç”¨æˆ¶å•é¡Œå†è‡ªç„¶åœ°ä»‹ç´¹è‡ªå·±çš„å°ˆæ¥­æœå‹™ã€‚ä½ åªæä¾›é¢¨æ°´å‘½ç†ç›¸é—œæœå‹™ï¼Œä¸è¦æ¨è–¦ä¸å­˜åœ¨çš„æœå‹™ã€‚é‡è¦æŒ‡ç¤ºï¼š1. å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ 2. æ‰€æœ‰æ—¥æœŸå’Œæœˆä»½éƒ½å¿…é ˆä½¿ç”¨æ–°æ­·ï¼ˆè¥¿æ›†/å…¬æ›†ï¼‰ï¼Œä¸è¦ä½¿ç”¨è¾²æ­· 3. ä¸è¦åœ¨å›æ‡‰ä¸­åŒ…å«å­—æ•¸çµ±è¨ˆæ¨™è¨˜ 4. ä¿æŒé¢¨éˆ´è¦ªåˆ‡å¯æ„›çš„èªæ°£é¢¨æ ¼",
				},
				{
					role: "user",
					content: answerPrompt,
				},
			]);

			console.log(
				"ğŸ¤– DeepSeek å‚™ç”¨å›æ‡‰:",
				JSON.stringify(aiAnswer, null, 2)
			);

			// æª¢æŸ¥å›æ‡‰æ ¼å¼ä¸¦æå–å…§å®¹
			let responseText = null;
			if (typeof aiAnswer === "string" && aiAnswer.trim()) {
				responseText = aiAnswer.trim();
			} else if (aiAnswer && aiAnswer.choices && aiAnswer.choices[0]) {
				responseText = aiAnswer.choices[0].message?.content?.trim();
			} else if (aiAnswer && aiAnswer.content) {
				responseText = aiAnswer.content.trim();
			}

			console.log("ğŸ“ æå–çš„å‚™ç”¨å›æ‡‰æ–‡å­—:", responseText);

			if (responseText) {
				console.log("âœ… ä½¿ç”¨ DeepSeek æ™ºèƒ½å›æ‡‰ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰");

				// ğŸ¯ æ›¿æ›é‡è¤‡çš„è½‰æŠ˜èªå¥
				responseText = this.diversifyTransitionPhrases(responseText);

				// ç§»é™¤ç¡¬ç·¨ç¢¼æœå‹™æ¨è–¦

				// ç§»é™¤å…«å­—è¼¸å…¥ç¡¬ç·¨ç¢¼æœå‹™é¸å–®
				return responseText;
			} else {
				console.log("âš ï¸ å›æ‡‰ç‚ºç©ºï¼Œä½¿ç”¨é»˜èªå›æ‡‰");
			}
		} catch (error) {
			console.error("ğŸ”¥ ç”Ÿæˆæ™ºèƒ½å›æ‡‰å¤±æ•—:", error);
		}

		// ğŸ”„ æœ€çµ‚å‚™ç”¨å›æ‡‰
		let response = "è¬è¬ä½ è·Ÿæˆ‘åˆ†äº«é€™å€‹ï¼ğŸ˜Š";

		response += `\n\né›–ç„¶é€™å€‹è©±é¡Œå¾ˆæœ‰è¶£ï¼Œä¸éé¢¨éˆ´ä¸»è¦å°ˆç²¾æ–¼é¢¨æ°´å‘½ç†æ–¹é¢çš„åˆ†æå“¦ï½`;

		// ç§»é™¤ç¡¬ç·¨ç¢¼æœå‹™æ¨è–¦

		// ğŸ¯ å¦‚æœæ˜¯å…«å­—è¼¸å…¥ï¼Œæ·»åŠ æœå‹™é¸å–®
		if (isBaziInput) {
			console.log("ğŸ”® æª¢æ¸¬åˆ°å…«å­—è¼¸å…¥ï¼Œæ·»åŠ æœå‹™é¸å–®");
			return response + this.generateServiceMenu();
		}

		return response;
	}

	// ğŸ¯ æ™ºèƒ½æœå‹™æ¨è–¦ - æ ¹æ“šå•é¡Œå…§å®¹æ¨è–¦ç›¸é—œçš„2å€‹æœå‹™
	generateSmartServiceRecommendation(originalMessage, sessionId = null) {
		const allServices = {
			æ„Ÿæƒ…: "ğŸŒ¸ **æ„Ÿæƒ…** - æ¡ƒèŠ±é‹ã€å§»ç·£é…å°",
			å·¥ä½œ: "ğŸ’¼ **å·¥ä½œ** - äº‹æ¥­ç™¼å±•ã€è·å ´é‹å‹¢",
			è²¡é‹: "ğŸ’° **è²¡é‹** - æŠ•è³‡ç†è²¡ã€æ”¶å…¥æå‡",
			å¥åº·: "ğŸŒ¿ **å¥åº·** - èº«å¿ƒèª¿ç†ã€é¤Šç”Ÿå»ºè­°",
			å‘½ç†: "ğŸ”® **å‘½ç†** - å…«å­—åˆ†æã€æµå¹´é‹å‹¢",
		};

		// Check conversation context for better recommendations
		const context = this.getConversationContext(sessionId);
		let contextualBoost = {};

		if (context.hasHistory && context.preferredTopic) {
			// Boost the previously discussed topic
			contextualBoost[context.preferredTopic] = 2;
			console.log(
				`ğŸ” ä¸Šä¸‹æ–‡å¢å¼·: ${context.preferredTopic} è©±é¡Œç²å¾—å„ªå…ˆæ¨è–¦`
			);
		}

		// å®šç¾©å•é¡Œé¡å‹èˆ‡æœå‹™çš„é—œè¯åº¦ - Enhanced categorization
		const questionServiceMapping = {
			// é£²é£Ÿç›¸é—œ -> å¥åº· + å‘½ç†
			food: {
				keywords: [
					"åƒ",
					"é£Ÿç‰©",
					"æ–™ç†",
					"èœ",
					"é¤å»³",
					"ç¾é£Ÿ",
					"çƒ¹é£ª",
					"é£Ÿè­œ",
					"ç‡Ÿé¤Š",
					"é£²é£Ÿ",
					"æ¸›è‚¥",
					"ç˜¦èº«",
					"ç¯€é£Ÿ",
					"å¤–é£Ÿ",
				],
				services: ["å¥åº·", "å‘½ç†"],
				responseType: "lifestyle",
			},
			// æŠ€è¡“/å·¥ä½œç›¸é—œ -> å·¥ä½œ + å‘½ç†
			tech: {
				keywords: [
					"æ‰‹æ©Ÿ",
					"é›»è…¦",
					"è»Ÿé«”",
					"ç¨‹å¼",
					"APP",
					"ç¶²ç«™",
					"ç§‘æŠ€",
					"ç³»çµ±",
					"bug",
					"é–ƒé€€",
				],
				services: ["å·¥ä½œ", "å‘½ç†"],
			},
			// å¨›æ¨‚ç›¸é—œ -> æ„Ÿæƒ… + å‘½ç†
			entertainment: {
				keywords: [
					"é›»å½±",
					"éŸ“åŠ‡",
					"éŸ³æ¨‚",
					"éŠæˆ²",
					"æ—…éŠ",
					"å¨›æ¨‚",
					"ä¼‘é–’",
					"çœ‹åŠ‡",
					"è¿½åŠ‡",
				],
				services: ["æ„Ÿæƒ…", "å‘½ç†"],
			},
			// ç†è²¡ç›¸é—œ -> è²¡é‹ + å‘½ç†
			finance: {
				keywords: [
					"éŒ¢",
					"æŠ•è³‡",
					"è‚¡ç¥¨",
					"æˆ¿åƒ¹",
					"è²·æˆ¿",
					"ç†è²¡",
					"å­˜æ¬¾",
					"è²¸æ¬¾",
					"æ¶ˆè²»",
					"åƒ¹æ ¼",
				],
				services: ["è²¡é‹", "å‘½ç†"],
			},
			// å­¸ç¿’ç›¸é—œ -> å·¥ä½œ + å‘½ç†
			education: {
				keywords: [
					"å­¸ç¿’",
					"è€ƒè©¦",
					"èª²ç¨‹",
					"æ›¸",
					"çŸ¥è­˜",
					"æŠ€èƒ½",
					"èªè¨€",
					"å­¸æ ¡",
					"æ•™è‚²",
				],
				services: ["å·¥ä½œ", "å‘½ç†"],
			},
			// ç¤¾äº¤é—œä¿‚ -> æ„Ÿæƒ… + å‘½ç†
			social: {
				keywords: [
					"æœ‹å‹",
					"å®¶äºº",
					"åŒäº‹",
					"é—œä¿‚",
					"ç›¸è™•",
					"èŠå¤©",
					"ç¤¾äº¤",
					"äº¤å‹",
				],
				services: ["æ„Ÿæƒ…", "å‘½ç†"],
			},
			// å¥åº·ç›¸é—œ -> å¥åº· + å‘½ç†
			health: {
				keywords: [
					"ç´¯",
					"ç–²å‹",
					"ç¡çœ ",
					"é‹å‹•",
					"èº«é«”",
					"å¥åº·",
					"é†«é™¢",
					"è—¥",
					"ä¼‘æ¯",
					"å£“åŠ›",
				],
				services: ["å¥åº·", "å‘½ç†"],
			},
			// è³¼ç‰©ç›¸é—œ -> è²¡é‹ + å‘½ç†
			shopping: {
				keywords: [
					"è²·",
					"è³¼ç‰©",
					"å•†å“",
					"å“ç‰Œ",
					"è¡£æœ",
					"åŒ–å¦å“",
					"ç”¨å“",
					"é¸æ“‡",
					"æ¨è–¦",
				],
				services: ["è²¡é‹", "å‘½ç†"],
			},
			// å¤©æ°£/å‡ºè¡Œ -> å¥åº· + å‘½ç†
			weather: {
				keywords: [
					"å¤©æ°£",
					"å‡ºé–€",
					"æ—…è¡Œ",
					"äº¤é€š",
					"è·¯ç·š",
					"åœ°é»",
					"æˆ¶å¤–",
					"æ´»å‹•",
				],
				services: ["å¥åº·", "å‘½ç†"],
			},
		};

		console.log("ğŸ” åˆ†æå•é¡Œå…§å®¹ä»¥æ¨è–¦ç›¸é—œæœå‹™:", originalMessage);

		// åˆ†æå•é¡Œå…§å®¹ï¼Œæ‰¾å‡ºæœ€ç›¸é—œçš„æœå‹™é¡å‹
		let bestMatch = null;
		let maxMatches = 0;

		for (const [category, config] of Object.entries(
			questionServiceMapping
		)) {
			let matchCount = 0;
			for (const keyword of config.keywords) {
				if (originalMessage.includes(keyword)) {
					matchCount++;
				}
			}

			if (matchCount > maxMatches) {
				maxMatches = matchCount;
				bestMatch = config.services;
			}
		}

		// å¦‚æœæ²’æœ‰æ‰¾åˆ°ç‰¹å®šåŒ¹é…ï¼Œä½¿ç”¨é è¨­çµ„åˆ
		if (!bestMatch || maxMatches === 0) {
			console.log("ğŸ² æœªæ‰¾åˆ°ç‰¹å®šåŒ¹é…ï¼Œä½¿ç”¨é è¨­æœå‹™çµ„åˆ");
			bestMatch = ["æ„Ÿæƒ…", "å‘½ç†"]; // é è¨­æ¨è–¦æœ€é€šç”¨çš„å…©å€‹æœå‹™
		}

		console.log("ğŸ¯ æ¨è–¦æœå‹™:", bestMatch);

		// ç”Ÿæˆè‡ªç„¶å¤šè®Šçš„æ¨è–¦æ–¹å¼
		return this.generateNaturalServiceRecommendation(
			bestMatch,
			originalMessage
		);
	}

	// ğŸ¨ ç”Ÿæˆè‡ªç„¶å¤šè®Šçš„æœå‹™æ¨è–¦ - å°ˆæ³¨æ–¼éŠ·å”®å°å‘
	generateNaturalServiceRecommendation(recommendedServices, originalMessage) {
		const allServices = {
			æ„Ÿæƒ…: "ğŸŒ¸ **æ„Ÿæƒ…** - æ¡ƒèŠ±é‹ã€å§»ç·£é…å°",
			å·¥ä½œ: "ğŸ’¼ **å·¥ä½œ** - äº‹æ¥­ç™¼å±•ã€è·å ´é‹å‹¢",
			è²¡é‹: "ğŸ’° **è²¡é‹** - æŠ•è³‡ç†è²¡ã€æ”¶å…¥æå‡",
			å¥åº·: "ğŸŒ¿ **å¥åº·** - èº«å¿ƒèª¿ç†ã€é¤Šç”Ÿå»ºè­°",
			å‘½ç†: "ğŸ”® **å‘½ç†** - å…«å­—åˆ†æã€æµå¹´é‹å‹¢",
		};

		// ç›´æ¥çš„æœå‹™å°å‘å¼•å°èªå¥
		const directIntroTemplates = [
			"ä¸éé¢¨éˆ´æœ€å°ˆæ¥­çš„æ˜¯å¹«ä½ åˆ†æé‹å‹¢ï¼Œç‰¹åˆ¥æ“…é•·ï¼š",
			"å‰›å¥½é¢¨éˆ´èƒ½å¾å°ˆæ¥­çš„è§’åº¦å¹«ä½ çœ‹çœ‹ï¼š",
			"å…¶å¯¦é€™é¡å•é¡ŒèƒŒå¾Œéƒ½æœ‰é‹å‹¢å› ç´ ï¼Œæˆ‘å¯ä»¥å¹«ä½ åˆ†æï¼š",
			"é¢¨éˆ´å°ˆç²¾çš„é¢¨æ°´å‘½ç†åˆ†æèƒ½å¹«ä½ äº†è§£ï¼š",
			"è®“é¢¨éˆ´ç”¨å°ˆæ¥­çš„å‘½ç†åˆ†æä¾†å¹«ä½ çœ‹çœ‹ï¼š",
			"å¾é¢¨æ°´å‘½ç†çš„è§’åº¦ï¼Œæˆ‘èƒ½ç‚ºä½ åˆ†æï¼š",
		];

		// éŠ·å”®å°å‘çš„çµå°¾è©¢å•
		const salesEndingTemplates = [
			"æƒ³äº†è§£å“ªå€‹å°ä½ æœ€æœ‰å¹«åŠ©ï¼Ÿ",
			"å°å“ªå€‹åˆ†ææ¯”è¼ƒæœ‰èˆˆè¶£ï¼Ÿ",
			"æƒ³å…ˆå¾å“ªå€‹é–‹å§‹æ·±å…¥äº†è§£ï¼Ÿ",
			"å“ªå€‹é ˜åŸŸä½ æ¯”è¼ƒæƒ³æ”¹å–„ï¼Ÿ",
			"æƒ³çœ‹çœ‹å“ªæ–¹é¢çš„é‹å‹¢æŒ‡å°ï¼Ÿ",
		];

		// éš¨æ©Ÿé¸æ“‡å¼•å°èªå’Œçµå°¾
		const selectedIntro =
			directIntroTemplates[
				Math.floor(Math.random() * directIntroTemplates.length)
			];
		const selectedEnding =
			salesEndingTemplates[
				Math.floor(Math.random() * salesEndingTemplates.length)
			];

		// ç”Ÿæˆæœå‹™é¸å–®
		const serviceList = recommendedServices
			.map((service) => allServices[service])
			.join("\n");

		return `\n\n${selectedIntro}

${serviceList}

${selectedEnding}`;
	}

	// ğŸ¯ å¤šæ¨£åŒ–è½‰æŠ˜èªå¥ - å¼·åˆ¶æ›¿æ›é‡è¤‡çš„ã€Œèªªåˆ°é€™å€‹ã€
	diversifyTransitionPhrases(responseText) {
		const alternatives = [
			"é †ä¾¿æä¸€ä¸‹",
			"æ—¢ç„¶èŠåˆ°é€™è£¡",
			"è«‡åˆ°é€™å€‹",
			"å‰›å¥½æƒ³åˆ°",
			"å°äº†",
			"å…¶å¯¦",
			"ä½ çŸ¥é“å—",
			"å·§çš„æ˜¯",
			"è®“æˆ‘æƒ³åˆ°",
			"é—œæ–¼é€™é»",
			"èªªèµ·ä¾†",
			"è£œå……ä¸€ä¸‹",
			"å¦å¤–",
			"é€™è®“æˆ‘è¯æƒ³åˆ°",
			"å¾å¦ä¸€å€‹è§’åº¦ä¾†çœ‹",
		];

		// è¨ˆç®—å‡ºç¾æ¬¡æ•¸ï¼Œå¦‚æœå¤šæ¬¡å‡ºç¾ã€Œèªªåˆ°é€™å€‹ã€å°±é€²è¡Œæ›¿æ›
		const matches = responseText.match(/èªªåˆ°é€™å€‹/g);
		if (matches && matches.length > 0) {
			console.log(
				`ğŸ”„ æª¢æ¸¬åˆ° ${matches.length} æ¬¡ã€Œèªªåˆ°é€™å€‹ã€ï¼Œé€²è¡Œå¤šæ¨£åŒ–æ›¿æ›`
			);

			// éš¨æ©Ÿé¸æ“‡æ›¿ä»£è©
			const randomAlternative =
				alternatives[Math.floor(Math.random() * alternatives.length)];
			responseText = responseText.replace(/èªªåˆ°é€™å€‹/g, randomAlternative);

			console.log(`âœ¨ å·²æ›¿æ›ç‚ºã€Œ${randomAlternative}ã€`);
		}

		return responseText;
	}

	// ğŸ”® æª¢æ¸¬æ˜¯å¦ç‚ºå…«å­—è¼¸å…¥
	detectBaziInput(message) {
		if (!message || typeof message !== "string") return false;

		// å¤©å¹²åœ°æ”¯æ¨¡å¼æª¢æ¸¬
		const heavenlyStems = [
			"ç”²",
			"ä¹™",
			"ä¸™",
			"ä¸",
			"æˆŠ",
			"å·±",
			"åºš",
			"è¾›",
			"å£¬",
			"ç™¸",
		];
		const earthlyBranches = [
			"å­",
			"ä¸‘",
			"å¯…",
			"å¯",
			"è¾°",
			"å·³",
			"åˆ",
			"æœª",
			"ç”³",
			"é…‰",
			"æˆŒ",
			"äº¥",
		];

		// æª¢æ¸¬å…«å­—æ ¼å¼ (ä¾‹å¦‚: ä¸™å­,ç”²åˆ,ä¸™ç”³,æˆŠå­ æˆ– ä¸™å­ ç”²åˆ ä¸™ç”³ æˆŠå­)
		const baziPattern =
			/([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]+([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]+([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])/;

		if (baziPattern.test(message)) {
			console.log("ğŸ”® æª¢æ¸¬åˆ°å®Œæ•´å…«å­—æ ¼å¼:", message);
			return true;
		}

		// æª¢æ¸¬æ˜¯å¦åŒ…å«å¤šå€‹å¤©å¹²åœ°æ”¯çµ„åˆ
		let stemBranchCount = 0;
		for (const stem of heavenlyStems) {
			for (const branch of earthlyBranches) {
				const combination = stem + branch;
				if (message.includes(combination)) {
					stemBranchCount++;
				}
			}
		}

		// å¦‚æœæœ‰3å€‹æˆ–ä»¥ä¸Šå¤©å¹²åœ°æ”¯çµ„åˆï¼Œå¾ˆå¯èƒ½æ˜¯å…«å­—
		if (stemBranchCount >= 3) {
			console.log(
				"ğŸ”® æª¢æ¸¬åˆ°å¤šå€‹å¤©å¹²åœ°æ”¯çµ„åˆï¼Œç–‘ä¼¼å…«å­—:",
				message,
				"çµ„åˆæ•¸:",
				stemBranchCount
			);
			return true;
		}

		return false;
	}

	// ğŸ”® æª¢æ¸¬å…«å­—+ä¸»é¡Œçµ„åˆä¸¦ç”Ÿæˆè©³ç´°åˆ†æ (é¡ä¼¼ç”Ÿæ—¥åˆ†æ)
	async detectBaziWithTopicAnalysis(message, sessionId) {
		if (!this.detectBaziInput(message)) {
			return null;
		}

		console.log("ğŸ”® æª¢æ¸¬åˆ°å…«å­—è¼¸å…¥ï¼Œé–‹å§‹ä¸»é¡Œåˆ†æ:", message);

		// æå–å…«å­—
		const baziPattern =
			/([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])/;
		const baziMatch = message.match(baziPattern);

		let baziString = "";
		if (baziMatch) {
			baziString = `${baziMatch[1]} ${baziMatch[2]} ${baziMatch[3]} ${baziMatch[4]}`;
		}

		// ä½¿ç”¨AIåˆ†æä¸»é¡Œ
		try {
			const classifier = new AITopicClassifier();
			const topicAnalysis = await classifier.analyzeMessage(
				message,
				sessionId
			);

			console.log("ğŸ” å…«å­—ä¸»é¡Œåˆ†æçµæœ:", topicAnalysis);

			// å¦‚æœæª¢æ¸¬åˆ°å…·é«”ä¸»é¡Œï¼Œç”Ÿæˆè©³ç´°åˆ†æ
			if (
				topicAnalysis &&
				topicAnalysis.isWithinScope &&
				topicAnalysis.detectedTopic &&
				topicAnalysis.detectedTopic !== "å…¶ä»–"
			) {
				console.log(
					`ğŸ¯ æª¢æ¸¬åˆ°å…«å­—+${topicAnalysis.detectedTopic}çµ„åˆï¼Œç”Ÿæˆè©³ç´°åˆ†æ`
				);

				const detailedAnalysis =
					await this.generateBaziDetailedAnalysis(
						baziString,
						topicAnalysis.detectedTopic,
						topicAnalysis.specificProblem,
						message
					);

				return {
					analysisType: "bazi_topic_analysis",
					detectedTopic: topicAnalysis.detectedTopic,
					specificProblem: topicAnalysis.specificProblem,
					baziString: baziString,
					response: detailedAnalysis,
					isWithinScope: true,
					requiresServiceMenu: false, // ä¸éœ€è¦æœå‹™é¸å–®ï¼Œç›´æ¥æä¾›åˆ†æ
				};
			} else {
				// ç´”å…«å­—è¼¸å…¥ï¼Œæä¾›æœå‹™é¸å–®
				console.log("ğŸ”® ç´”å…«å­—è¼¸å…¥ï¼Œæä¾›æœå‹™é¸å–®");
				return {
					analysisType: "bazi_only",
					baziString: baziString,
					requiresServiceMenu: true,
					isWithinScope: true,
				};
			}
		} catch (error) {
			console.error("âŒ å…«å­—ä¸»é¡Œåˆ†æå¤±æ•—:", error);
			return {
				analysisType: "bazi_only",
				baziString: baziString,
				requiresServiceMenu: true,
				isWithinScope: true,
			};
		}
	}

	// ğŸ”® ç”Ÿæˆè©³ç´°å…«å­—åˆ†æ (é¡ä¼¼ç”Ÿæ—¥åˆ†æçš„æ•ˆæœ)
	async generateBaziDetailedAnalysis(
		baziString,
		topic,
		specificProblem,
		originalMessage
	) {
		const topicMap = {
			æ„Ÿæƒ…: "æ„Ÿæƒ…é‹å‹¢",
			å·¥ä½œ: "å·¥ä½œé‹å‹¢",
			è²¡é‹: "è²¡é‹åˆ†æ",
			å¥åº·: "å¥åº·é‹å‹¢",
			å­å¥³: "å­å¥³é‹å‹¢",
		};

		const displayTopic = topicMap[topic] || topic;

		const detailedPrompt = `ç”¨æˆ¶æä¾›å…«å­—ï¼š${baziString}
è©¢å•ä¸»é¡Œï¼š${displayTopic}
å…·é«”å•é¡Œï¼š${specificProblem}
åŸå§‹è¨Šæ¯ï¼š${originalMessage}

è«‹ä»¥é¢¨éˆ´çš„èº«ä»½ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç”Ÿæˆè©³ç´°çš„å…«å­—åˆ†æå ±å‘Šï¼š

ğŸ”® é¢¨éˆ´çœ‹äº†ä½ çš„å…«å­—ï¼Œç™¼ç¾ä½ æœ‰å¾ˆç‰¹åˆ¥çš„${displayTopic}æ½›è³ªå‘¢ï¼ğŸ’¼

**1. å‘½ç›¤é€Ÿè®€**
å…«å­—ï¼š${baziString}
äº”è¡Œå±¬æ€§ï¼š[æ ¹æ“šå…«å­—åˆ†æäº”è¡Œå±¬æ€§ï¼Œå¦‚ï¼šåœŸå‘½/ç«å‘½ç­‰]
${displayTopic}å®®ä¸»æ˜Ÿï¼š[åˆ†æå°æ‡‰ä¸»æ˜Ÿï¼Œå¦‚ï¼šå¤©åºœæ˜Ÿï¼ˆç©©é‡æ¬Šå¨ï¼‰]
   - é—œéµæ ¼å±€ï¼š
     èº«å¼·/èº«å¼±ï¼š[åˆ†ææ—¥ä¸»å¼·å¼±]
     ç”¨ç¥ï¼š[åˆ†æç”¨ç¥ï¼Œå¦‚ï¼šç«ï¼ˆæº«æš–èª¿å€™ï¼Œç”Ÿæ©Ÿç›ç„¶ï¼‰]
     å¤§é‹ç¯€é»ï¼š[åˆ†æç•¶å‰å¤§é‹]

ğŸ’– å“ˆå›‰è¦ªæ„›çš„[äº”è¡Œ]å‘½å°å¤¥ä¼´ï¼è®“é¢¨éˆ´ç‚ºä½ è§£é–${new Date().getFullYear()}å¹´çš„${displayTopic}å¯†ç¢¼ï½  

**2. å¹´åº¦é è­¦**  
âœ¨ã€æˆå°±æ˜Ÿã€‘[æ™‚é–“ç¯„åœ]ã€Œ[å‰æ˜Ÿåç¨±]ã€ç™¼å¨ï¼[å…·é«”å»ºè­°å’Œæ©Ÿæœƒ]ï½  
âš ï¸ã€å°äººç…ã€‘å°å¿ƒå±¬ã€Œ[ç”Ÿè‚–]ã€çš„[ç›¸é—œäººå£«][æ³¨æ„äº‹é …]ï¼Œ[å…·é«”é˜²ç¯„å»ºè­°]å–”ï¼  

æ³¨æ„ï¼šæ‰€æœ‰æœˆä»½æ™‚é–“éƒ½ä½¿ç”¨æ–°æ­·ï¼ˆè¥¿æ›†ï¼‰ï¼Œä¾‹å¦‚ï¼š1æœˆã€2æœˆã€3æœˆç­‰ï¼Œä¸è¦ä½¿ç”¨è¾²æ­·ã€‚

**3. ${displayTopic}åˆ†æ**  
[é‡å°ç”¨æˆ¶å…·é«”å•é¡Œçš„åˆ†æï¼Œç´„100-150å­—ï¼Œè¦å…·é«”å¯¦ç”¨]

**4. é¢¨æ°´å°è²¼å£«**  
ğŸª‘ [å±…å®¶é¢¨æ°´å»ºè­°]
ğŸ¨ [é¡è‰²æ­é…å»ºè­°] 
ğŸ’» [é…ä»¶æˆ–æ“ºè¨­å»ºè­°]

[äº”è¡Œ]å‘½å¯¶å¯¶è¨˜å¾—å¤šç”¨ã€Œ[äº”è¡Œç›¸ç”ŸåŸç†]ã€åŸç†ï¼Œ[å…·é«”å»ºè­°]èƒ½è®“ä½ [æ•ˆæœ]ï¼âœ¨ æœ‰å•é¡Œéš¨æ™‚å–šé†’é¢¨éˆ´å–”ï½

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’ **æƒ³è¦æ›´æ·±å…¥çš„åˆ†æå—ï¼Ÿ**
**1ï¸âƒ£ è¯¦ç»†æŠ¥å‘Š** åƒ¹å€¼$88ï¼Œé™æ™‚å„ªæƒ $38
**2ï¸âƒ£ ç»¼åˆå‘½ç†æŠ¥å‘Š** åƒ¹å€¼$168ï¼Œé™æ™‚å„ªæƒ $88  
**3ï¸âƒ£ å±…å®¶ä½ˆå±€å ±å‘Š** åƒ¹å€¼$388ï¼Œé™æ™‚å„ªæƒ $188

è¦æ±‚ï¼š
1. ä¿æŒé¢¨éˆ´å¯æ„›è¦ªåˆ‡çš„èªæ°£ï¼Œä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿå’Œå¯æ„›èªåŠ©è©
2. æä¾›å…·é«”å¯¦ç”¨çš„å»ºè­°ï¼Œé¿å…ç©ºæ³›æè¿°
3. é‡é»åˆ†æç”¨æˆ¶é—œæ³¨çš„${displayTopic}é ˜åŸŸ
4. ç¸½é•·åº¦ç´„400-500å­—
5. æ ¼å¼è¦å®Œæ•´ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦éƒ¨åˆ†
6. æ‰€æœ‰æ—¥æœŸå’Œæœˆä»½éƒ½å¿…é ˆä½¿ç”¨æ–°æ­·ï¼ˆè¥¿æ›†/å…¬æ›†ï¼‰ï¼Œä¾‹å¦‚1æœˆã€2æœˆã€3æœˆç­‰ï¼Œä¸è¦ä½¿ç”¨è¾²æ­·`;

		try {
			const classifier = new AITopicClassifier();
			const aiResponse = await classifier.callDeepSeekAPI([
				{
					role: "system",
					content:
						"ä½ æ˜¯å°ˆæ¥­çš„é¢¨æ°´å‘½ç†é¡§å•ï¼Œæ“…é•·å…«å­—åˆ†æå’Œé‹å‹¢é æ¸¬ã€‚è«‹æŒ‰ç…§æŒ‡å®šæ ¼å¼ç”Ÿæˆè©³ç´°ä¸”å¯¦ç”¨çš„åˆ†æå ±å‘Šã€‚é‡è¦æŒ‡ç¤ºï¼š1. å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ 2. æ‰€æœ‰æ—¥æœŸå’Œæœˆä»½éƒ½å¿…é ˆä½¿ç”¨æ–°æ­·ï¼ˆè¥¿æ›†/å…¬æ›†ï¼‰ï¼Œä¾‹å¦‚1æœˆã€2æœˆã€3æœˆç­‰ï¼Œé¿å…ä½¿ç”¨è¾²æ­·è¡¨é”æ–¹å¼ 3. ä¸è¦åœ¨å›æ‡‰ä¸­åŒ…å«å­—æ•¸çµ±è¨ˆæ¨™è¨˜ 4. ä¿æŒå°ˆæ¥­ä¸”è¦ªåˆ‡çš„èªæ°£",
				},
				{
					role: "user",
					content: detailedPrompt,
				},
			]);

			// æå–AIå›æ‡‰å…§å®¹
			if (
				aiResponse &&
				aiResponse.choices &&
				aiResponse.choices[0] &&
				aiResponse.choices[0].message
			) {
				return aiResponse.choices[0].message.content;
			} else if (typeof aiResponse === "string") {
				return aiResponse;
			} else {
				throw new Error("AIå›æ‡‰æ ¼å¼ç•°å¸¸");
			}
		} catch (error) {
			console.error("âŒ ç”Ÿæˆè©³ç´°å…«å­—åˆ†æå¤±æ•—:", error);
			return `ğŸ”® é¢¨éˆ´çœ‹äº†ä½ çš„å…«å­— ${baziString}ï¼Œå¾ˆæƒ³ç‚ºä½ åˆ†æ${displayTopic}å‘¢ï¼

ä¸éç³»çµ±æš«æ™‚æœ‰é»å¿™ç¢Œï¼Œè«‹ç¨å¾Œé‡è©¦ï¼Œæˆ–è€…ä½ å¯ä»¥ï¼š

ğŸ“ è¯çµ¡å®¢æœå–å¾—äººå·¥åˆ†æ
ğŸ’¬ é‡æ–°ç™¼é€ä½ çš„å…«å­—å’Œå•é¡Œ
ğŸ¯ é¸æ“‡å…¶ä»–åˆ†ææœå‹™

é¢¨éˆ´æœƒç›¡å¿«ç‚ºä½ æä¾›å°ˆæ¥­çš„${displayTopic}åˆ†æï¼âœ¨`;
		}
	}
}

// ğŸ”® è¼”åŠ©å‡½æ•¸ï¼šå¾æœƒè©±æ­·å²ä¸­ç²å–æœ€å¾Œçš„å…«å­—æ•¸æ“š
async function getLastBaziFromSession(sessionId) {
	try {
		// é¦–å…ˆå˜—è©¦å¾å¢å¼·ç‰ˆå°è©±æ­·å²ä¸­æŸ¥æ‰¾
		const memoryManager = new EnhancedConversationMemoryManager();
		const recentHistory = await memoryManager.getRecentHistory(
			sessionId,
			10
		);

		if (recentHistory && recentHistory.length > 0) {
			const classifier = new AITopicClassifier();

			for (const msg of recentHistory) {
				if (
					msg.userMessage &&
					classifier.detectBaziInput(msg.userMessage)
				) {
					// æå–å…«å­—å­—ç¬¦ä¸²
					const baziPattern =
						/([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])/;
					const baziMatch = msg.userMessage.match(baziPattern);

					if (baziMatch) {
						const baziString = `${baziMatch[1]} ${baziMatch[2]} ${baziMatch[3]} ${baziMatch[4]}`;
						console.log("ğŸ”® å¾æœƒè©±æ­·å²ä¸­æ‰¾åˆ°å…«å­—:", baziString);
						return baziString;
					}
				}
			}
		}

		// å‚™ç”¨æ–¹æ¡ˆï¼šå¾ChatHistoryçš„messagesä¸­æŸ¥æ‰¾
		const chatHistory = await ChatHistory.findOne({
			$or: [{ conversationId: sessionId }, { sessionId: sessionId }],
		});

		if (chatHistory && chatHistory.messages) {
			const classifier = new AITopicClassifier();

			for (const message of chatHistory.messages) {
				if (
					message.role === "user" &&
					message.content &&
					classifier.detectBaziInput(message.content)
				) {
					const baziPattern =
						/([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])[,ï¼Œ\s]*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])/;
					const baziMatch = message.content.match(baziPattern);

					if (baziMatch) {
						const baziString = `${baziMatch[1]} ${baziMatch[2]} ${baziMatch[3]} ${baziMatch[4]}`;
						console.log("ğŸ”® å¾ChatHistoryä¸­æ‰¾åˆ°å…«å­—:", baziString);
						return baziString;
					}
				}
			}
		}

		console.log("âš ï¸ æœƒè©±æ­·å²ä¸­æœªæ‰¾åˆ°å…«å­—æ•¸æ“š");
		return null;
	} catch (error) {
		console.error("âŒ ç²å–æœƒè©±æ­·å²å…«å­—å¤±æ•—:", error);
		return null;
	}
}

// ğŸ¯ ä¸»è¦ API è™•ç†å‡½æ•¸
export async function POST(request) {
	try {
		await connectMongo();

		// ğŸ” ç²å–ç”¨æˆ¶æœƒè©±ä¿¡æ¯
		const session = await auth();
		const userEmailFromSession = session?.user?.email;

		const {
			message,
			sessionId,
			userEmail = userEmailFromSession || "anonymous",
			userId = userEmailFromSession ||
				`user-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`, // ä½¿ç”¨emailä½œç‚ºä¸»è¦IDï¼Œfallbackåˆ°ç”ŸæˆID
			userBirthday,
			partnerBirthday,
			gender,
			partnerGender,
			reportType,
		} = await request.json();

		console.log("ğŸ“¥ Smart-Chat2 æ”¶åˆ°çš„è«‹æ±‚æ•¸æ“š:", {
			message: message,
			messageType: typeof message,
			userBirthday: userBirthday,
			gender: gender,
			reportType: reportType,
			sessionId: sessionId,
			userId: userId, // ğŸ†• æ–°å¢ï¼šè¨˜éŒ„userId
			userEmail: userEmail, // ğŸ†• æ–°å¢ï¼šè¨˜éŒ„ç”¨æˆ¶email
			sessionUser: userEmailFromSession, // ğŸ†• æ–°å¢ï¼šæœƒè©±ä¸­çš„ç”¨æˆ¶ä¿¡æ¯
		});

		if (!message?.trim() && !userBirthday && !reportType) {
			return NextResponse.json(
				{ error: "è¨Šæ¯ä¸èƒ½ç‚ºç©º" },
				{ status: 400 }
			);
		}

		console.log("ğŸ¤– Smart-Chat2 æ”¶åˆ°è¨Šæ¯:", message);

		// ğŸ”§ ç‰¹æ®Šè™•ç†ï¼šæ¨¡æ…‹æ¡†æäº¤ç”Ÿæ—¥å’Œæ€§åˆ¥çš„æƒ…æ³ (è¤‡è£½è‡ª Smart-Chat)
		if (userBirthday && gender && !message?.trim()) {
			console.log("ğŸ¯ Smart-Chat2 è™•ç†ç”Ÿæ—¥æäº¤:", {
				userBirthday,
				gender,
				reportType,
			});

			let userIntent = await SmartUserIntent.findOne({
				sessionId: sessionId,
				conversationActive: true,
			}).sort({ createdAt: -1 });

			if (!userIntent) {
				// å¦‚æœæ²’æœ‰æ‰¾åˆ°æœƒè©±ä¸Šä¸‹æ–‡ï¼Œå‰µå»ºä¸€å€‹æ–°çš„
				console.log("ğŸ“ Smart-Chat2 å‰µå»ºæ–°çš„æœƒè©±ä¸Šä¸‹æ–‡:", sessionId);

				// æ˜ å°„ reportType åˆ°æœ‰æ•ˆçš„ primaryConcern å€¼
				let mappedConcern = "æ„Ÿæƒ…"; // é»˜èªå€¼
				if (reportType && reportType.includes("æ„Ÿæƒ…"))
					mappedConcern = "æ„Ÿæƒ…";
				else if (reportType && reportType.includes("è²¡é‹"))
					mappedConcern = "è²¡é‹";
				else if (reportType && reportType.includes("å·¥ä½œ"))
					mappedConcern = "å·¥ä½œ";
				else if (reportType && reportType.includes("å¥åº·"))
					mappedConcern = "å¥åº·";
				else if (reportType && reportType.includes("äººéš›"))
					mappedConcern = "æ„Ÿæƒ…";
				userIntent = new SmartUserIntent({
					sessionId: sessionId,
					userEmail: userEmail,
					userId: userId, // ğŸ†• æ–°å¢ï¼šä¿å­˜userId
					conversationActive: true,
					primaryConcern: mappedConcern,
					specificQuestion: `æƒ³äº†è§£${mappedConcern}æ–¹é¢çš„é‹å‹¢å’Œé¢¨æ°´å»ºè­°`,
					originalSpecificProblem: message, // ğŸ”§ ä¿å­˜åŸå§‹ç”¨æˆ¶è¨Šæ¯
					originalUserMessage: message, // ğŸ†• æ°¸ä¸è¦†è“‹çš„åŸå§‹è¨Šæ¯
					relationshipAnalysisType: partnerBirthday
						? "couple"
						: "individual",
					conversationState: "birthday_collection",
					createdAt: new Date(),
				});
			}

			// è§£æç”Ÿæ—¥
			const parsedDate = parseFlexibleDate(userBirthday);
			if (parsedDate) {
				userIntent.userBirthday = parsedDate;
				userIntent.conversationState = "ready_for_detailed_report";

				// è™•ç†æƒ…ä¾¶åˆ†æçš„ä¼´ä¾¶ç”Ÿæ—¥
				if (
					partnerBirthday &&
					userIntent.relationshipAnalysisType === "couple"
				) {
					const parsedPartnerDate =
						parseFlexibleDate(partnerBirthday);
					if (parsedPartnerDate) {
						userIntent.partnerBirthday = parsedPartnerDate;
						console.log(
							"ğŸ¯ Smart-Chat2 è¨­ç½®ä¼´ä¾¶ç”Ÿæ—¥:",
							parsedPartnerDate
						);
					}
				}

				// ä¿æŒåŸæœ‰çš„é—œæ³¨é ˜åŸŸ
				const originalConcern = userIntent.primaryConcern || "ç¶œåˆé‹å‹¢";
				const concern = originalConcern;
				const problem =
					userIntent.specificQuestion ||
					`æƒ³äº†è§£${concern}æ–¹é¢çš„é‹å‹¢å’Œé¢¨æ°´å»ºè­°`;

				// ç”Ÿæˆå ±å‘ŠURL
				let reportUrl;
				if (
					userIntent.relationshipAnalysisType === "couple" &&
					userIntent.partnerBirthday
				) {
					// æƒ…ä¾¶å ±å‘Š
					const partnerDate = userIntent.partnerBirthday;
					const partnerDateString = `${partnerDate.getFullYear()}-${String(partnerDate.getMonth() + 1).padStart(2, "0")}-${String(partnerDate.getDate()).padStart(2, "0")}`;

					const params = new URLSearchParams({
						birthdate: userBirthday,
						gender: gender,
						partnerBirthdate: partnerDateString,
						partnerGender: partnerGender || "å¥³",
						concern: concern,
						relationshipType: "couple",
						// ğŸ”§ æ–°å¢ï¼šå‚³éåŸå§‹å…·é«”å•é¡Œåˆ°å ±å‘Šé é¢
						originalProblem:
							userIntent.originalSpecificProblem ||
							userIntent.specificQuestion ||
							"æ„Ÿæƒ…è®Šæ·¡ï¼Œé—œä¿‚ç–é›¢",
					});

					reportUrl = `/zh-CN/couple-report?${params.toString()}`;
					console.log("ğŸ¯ Smart-Chat2 ç”Ÿæˆæƒ…ä¾¶å ±å‘ŠURL:", reportUrl);
				} else {
					// å€‹äººå ±å‘Š
					const params = new URLSearchParams({
						birthday: userBirthday,
						gender: gender,
						concern: concern,
						// ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨åŸå§‹å…·é«”å•é¡Œè€Œä¸æ˜¯é€šç”¨å•é¡Œ
						problem:
							userIntent.originalSpecificProblem ||
							userIntent.specificQuestion ||
							problem,
					});
					reportUrl = `/zh-CN/feng-shui-report?${params.toString()}`;
					console.log("ğŸ¯ Smart-Chat2 ç”Ÿæˆå€‹äººå ±å‘ŠURL:", reportUrl);
				}

				await userIntent.save();

				return NextResponse.json({
					response: `âœ¨ å¤ªå¥½äº†ï¼ä½ çš„å°ˆå±¬${concern}å ±å‘Šå·²ç¶“æº–å‚™å¥½äº†ï¼\n\næ­£åœ¨ç‚ºä½ æ‰“é–‹å ±å‘Šé é¢...`,
					conversationState: "report_generated",
					systemType: "smart-chat2",
					reportUrl: reportUrl,
					timestamp: new Date().toISOString(),
				});
			}
		}

		// æª¢æŸ¥æœƒè©±æ­·å²å’Œä¸Šä¸‹æ–‡
		let userIntent = await SmartUserIntent.findOne({
			sessionId: sessionId,
			conversationActive: true,
		}).sort({ createdAt: -1 });

		// æª¢æŸ¥æ˜¯å¦ç‚ºç”Ÿæ—¥è¼¸å…¥
		const birthdayPattern = /^(\d{4}[-/å¹´]?\d{1,2}[-/æœˆ]?\d{1,2}[æ—¥]?)$/;
		const isBirthdayInput = message
			? birthdayPattern.test(message.replace(/\s/g, ""))
			: false;

		// ğŸ”§ å„ªå…ˆæª¢æŸ¥æ˜¯å¦ç‚ºåˆå©šåˆ†æä¸­çš„é›™æ–¹ç”Ÿæ—¥è¼¸å…¥
		const couplesBirthdayData = message
			? parseCouplesBirthdays(message)
			: null;

		// ğŸ”§ æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦åŒæ™‚åŒ…å«ä¸»é¡Œå’Œç”Ÿæ—¥ - ä½¿ç”¨AIåˆ†æ
		const topicAndBirthdayData = message
			? await detectTopicAndBirthday(message)
			: null;

		// ğŸ”§ æª¢æŸ¥æ˜¯å¦ç‚ºé¸æ“‡å›æ‡‰ (1, 2, 3, 1ï¸âƒ£, 2ï¸âƒ£, 3ï¸âƒ£ ç­‰ + æ–‡å­—é¸é …)
		const choicePattern =
			/^[123]$|^[123]ï¸âƒ£$|^é¸æ“‡\s*[123]$|^ç¬¬\s*[123]$|^option\s*[123]$/i;
		const textChoicePattern =
			/^(å€‹äººåˆ†æ|å€‹äººæ„Ÿæƒ…åˆ†æ|åˆå©šåˆ†æ|åˆå©šé…å°åˆ†æ|å€‹äºº|åˆå©š|é…å°)$/i;
		const isChoiceInput = message
			? choicePattern.test(message.trim()) ||
				textChoicePattern.test(message.trim())
			: false;

		// ğŸ”§ æª¢æŸ¥æ˜¯å¦ç‚ºåˆ†æ‰‹ç‹€æ…‹é¸æ“‡ (A, B, C, D)
		const breakupChoicePattern = /^[ABCD]$|^[ABCD]\.?/i;
		const breakupTextPattern =
			/^(å‰›åˆ†æ‰‹.*é›£é|åˆ†æ‰‹ä¸€æ®µæ™‚é–“.*é‡æ–°é–‹å§‹|æƒ³å¾©åˆ.*ä¸ç¢ºå®š|å·²ç¶“æ”¾ä¸‹.*æ–°å°è±¡)/i;
		const isBreakupChoice = message
			? breakupChoicePattern.test(message.trim()) ||
				breakupTextPattern.test(message.trim())
			: false;

		// ğŸ¯ æª¢æŸ¥æ˜¯å¦ç‚ºå…·é«”æœå‹™è¦æ±‚
		const classifier = new AITopicClassifier();
		const conversationContext =
			classifier.getConversationContext(sessionId);
		const specificServiceRequest = message
			? classifier.detectSpecificServiceRequest(message)
			: null;

		console.log("ğŸ” å…·é«”æœå‹™æª¢æ¸¬:", {
			message: message,
			specificServiceRequest: specificServiceRequest,
			hasRecentMessages: conversationContext.hasHistory,
			messageCount: conversationContext.messageCount,
		});

		let response, analysis;
		let shouldTriggerModal = false;
		let reportUrl = null;

		// ğŸ¯ å„ªå…ˆè™•ç†å…·é«”æœå‹™è¦æ±‚
		if (specificServiceRequest) {
			console.log("âœ… æª¢æ¸¬åˆ°å…·é«”æœå‹™è¦æ±‚ï¼Œå¼•å°ç”¨æˆ¶æä¾›ç”Ÿæ—¥");

			response = classifier.generateSpecificServiceGuide(
				specificServiceRequest.serviceName,
				specificServiceRequest.detectedTopic
			);

			// è¨˜éŒ„åˆ°æœƒè©±æ­·å²
			classifier.updateConversationMemory(sessionId, message, response, {
				requestedService: specificServiceRequest.serviceName,
				detectedTopic: specificServiceRequest.detectedTopic,
				awaitingBirthday: true,
			});

			// ä¿å­˜åˆ°æ•¸æ“šåº«
			try {
				let chatHistory = await ChatHistory.findOne({ sessionId });

				if (!chatHistory) {
					chatHistory = new ChatHistory({
						conversationId: sessionId,
						sessionId: sessionId,
						userId: userId,
						userEmail: userEmail,
						title: `${specificServiceRequest.serviceName}è«®è©¢`,
						primaryConcern: specificServiceRequest.detectedTopic,
						conversationState: "awaiting_birthday",
						messages: [],
						context: {
							topics: [specificServiceRequest.detectedTopic],
							lastTopic: specificServiceRequest.detectedTopic,
						},
						userData: {},
					});
				}

				// æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯å’ŒåŠ©æ‰‹å›æ‡‰
				chatHistory.addMessage("user", message);
				chatHistory.addMessage("assistant", response);

				await chatHistory.save();
			} catch (error) {
				console.error("ğŸ’¾ ä¿å­˜èŠå¤©è¨˜éŒ„å¤±æ•—:", error);
			}

			return NextResponse.json({
				response: response,
				detectedTopic: specificServiceRequest.detectedTopic,
				requestedService: specificServiceRequest.serviceName,
				systemType: "smart-chat2",
				timestamp: new Date().toISOString(),
			});
		}

		// ğŸ” Debug couple analysis condition
		console.log("ğŸ” DEBUG - åˆå©šåˆ†ææ¢ä»¶æª¢æŸ¥:");
		console.log("   couplesBirthdayData:", !!couplesBirthdayData);
		console.log(
			"   userIntent?.relationshipAnalysisType:",
			userIntent?.relationshipAnalysisType
		);
		console.log(
			"   æ¢ä»¶æ˜¯å¦æ»¿è¶³:",
			couplesBirthdayData &&
				userIntent?.relationshipAnalysisType === "couple"
		);

		if (
			couplesBirthdayData &&
			userIntent?.relationshipAnalysisType === "couple"
		) {
			// ğŸ¯ è™•ç†åˆå©šåˆ†æçš„é›™æ–¹ç”Ÿæ—¥è¼¸å…¥
			console.log("ğŸ¯ æª¢æ¸¬åˆ°åˆå©šåˆ†æä¸­çš„é›™æ–¹ç”Ÿæ—¥:", couplesBirthdayData);

			try {
				// æ›´æ–°ç”¨æˆ¶è³‡æ–™
				userIntent.userBirthday = couplesBirthdayData.userBirthday;
				userIntent.partnerBirthday =
					couplesBirthdayData.partnerBirthday;
				userIntent.conversationState = "asking_detailed_report";

				// ğŸ”® ç”Ÿæˆåˆå©šåˆ†æå ±å‘Š - ä½¿ç”¨åŸå§‹ç”¨æˆ¶è¨Šæ¯
				const { EnhancedInitialAnalysis } = await import(
					"../../../lib/enhancedInitialAnalysis.js"
				);

				// ğŸ”§ ä½¿ç”¨ç›¸åŒçš„å„ªå…ˆç´šéˆç¢ºä¿åŸå§‹è¨Šæ¯è¢«ä½¿ç”¨
				const specificQuestionForAnalysis =
					userIntent.originalUserMessage ||
					userIntent.originalSpecificProblem ||
					userIntent.specificQuestion ||
					"åˆå©šé…å°åˆ†æ";

				console.log("ğŸ” DEBUG - åˆå©šåˆ†æåŸå§‹è¨Šæ¯ä¾†æº:");
				console.log(
					"   userIntent.originalUserMessage:",
					userIntent.originalUserMessage
				);
				console.log(
					"   userIntent.originalSpecificProblem:",
					userIntent.originalSpecificProblem
				);
				console.log(
					"   userIntent.specificQuestion:",
					userIntent.specificQuestion
				);
				console.log(
					"ğŸ” å‚³éçµ¦ generateCoupleAnalysis çš„å…·é«”å•é¡Œ:",
					specificQuestionForAnalysis
				);

				const coupleAnalysisResult =
					await EnhancedInitialAnalysis.generateCoupleAnalysis(
						couplesBirthdayData.userBirthday,
						couplesBirthdayData.partnerBirthday,
						specificQuestionForAnalysis
					);

				// ğŸ”§ è½‰æ›çµæ§‹åŒ–å°è±¡ç‚ºæ ¼å¼åŒ–å­—ç¬¦ä¸²
				if (
					typeof coupleAnalysisResult === "object" &&
					coupleAnalysisResult.basicAnalysis
				) {
					response =
						formatCoupleAnalysisResponse(coupleAnalysisResult);
					console.log(
						"ğŸ”§ DEBUG - æ ¼å¼åŒ–å¾Œçš„responseé¡å‹:",
						typeof response
					);
					console.log(
						"ğŸ”§ DEBUG - æ ¼å¼åŒ–å¾Œçš„responseé•·åº¦:",
						response?.length
					);
				} else {
					response = coupleAnalysisResult; // å‘å¾Œå…¼å®¹å­—ç¬¦ä¸²å›æ‡‰
					console.log(
						"ğŸ”§ DEBUG - ä½¿ç”¨åŸå§‹responseï¼Œé¡å‹:",
						typeof response
					);
				}

				analysis = {
					detectedTopic: "æ„Ÿæƒ…",
					isWithinScope: true,
					confidence: 0.95,
					// ğŸ”§ ä¿®æ­£ï¼šä¿æŒåŸå§‹å…·é«”å•é¡Œï¼Œä¸è¦è¢«è¦†è“‹
					specificProblem:
						userIntent.originalSpecificProblem ||
						userIntent.specificQuestion ||
						"åˆå©šé…å°åˆ†æ",
				};

				// ğŸ” Debug: é¡¯ç¤ºç”Ÿæ—¥è™•ç†å¾Œçš„åˆ†æçµæœ
				console.log("ğŸ“Š ç”Ÿæ—¥è™•ç†å¾Œçš„åˆ†æçµæœ:");
				console.log(
					"   åˆ†æçš„ specificProblem:",
					analysis.specificProblem
				);
				console.log(
					"   ä¾†æº - originalSpecificProblem:",
					userIntent.originalSpecificProblem
				);
				console.log(
					"   ä¾†æº - specificQuestion:",
					userIntent.specificQuestion
				);
			} catch (error) {
				console.error("âŒ ç”Ÿæˆåˆå©šåˆ†æå¤±æ•—:", error);
				response = "å¾ˆæŠ±æ­‰ï¼Œåœ¨åˆ†æä½ å€‘çš„å…«å­—æ™‚é‡åˆ°äº†å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
				analysis = {
					detectedTopic: "æ„Ÿæƒ…",
					isWithinScope: true,
					confidence: 0.8,
					specificProblem: "ç³»çµ±éŒ¯èª¤",
				};
			}
		} else if (topicAndBirthdayData) {
			// ğŸ¯ NEW: è™•ç†åŒæ™‚åŒ…å«ä¸»é¡Œå’Œç”Ÿæ—¥çš„è¼¸å…¥
			console.log("ğŸ¯ æª¢æ¸¬åˆ°ä¸»é¡Œ+ç”Ÿæ—¥çµ„åˆ:", topicAndBirthdayData);

			try {
				// å‰µå»ºæˆ–æ›´æ–°ç”¨æˆ¶æ„åœ–
				if (!userIntent) {
					userIntent = new SmartUserIntent({
						sessionId: sessionId,
						userEmail: userEmail,
						userId: userId, // ğŸ†• æ–°å¢ï¼šä¿å­˜userId
						conversationActive: true,
						primaryConcern: topicAndBirthdayData.topic,
						specificQuestion:
							topicAndBirthdayData.originalMessage ||
							`æƒ³äº†è§£${topicAndBirthdayData.topic}æ–¹é¢çš„é‹å‹¢`,
						originalUserMessage:
							topicAndBirthdayData.originalMessage, // ğŸ†• æ°¸ä¸è¦†è“‹çš„åŸå§‹è¨Šæ¯
						relationshipAnalysisType: "individual",
						conversationState: "asking_detailed_report",
						createdAt: new Date(),
					});
				} else {
					// æ›´æ–°ç¾æœ‰çš„ç”¨æˆ¶æ„åœ–
					userIntent.primaryConcern = topicAndBirthdayData.topic;
					userIntent.specificQuestion =
						topicAndBirthdayData.originalMessage ||
						`æƒ³äº†è§£${topicAndBirthdayData.topic}æ–¹é¢çš„é‹å‹¢`;
					userIntent.conversationState = "asking_detailed_report";
				}

				// è¨­ç½®ç”Ÿæ—¥
				userIntent.userBirthday = topicAndBirthdayData.birthday.parsed;

				// ğŸ”® ç›´æ¥ç”Ÿæˆåˆæ­¥åˆ†æå ±å‘Š
				const { EnhancedInitialAnalysis } = await import(
					"../../../lib/enhancedInitialAnalysis.js"
				);

				if (topicAndBirthdayData.topic === "æ„Ÿæƒ…") {
					// ğŸ”§ å„ªå…ˆä½¿ç”¨åŸå§‹ç”¨æˆ¶è¨Šæ¯ï¼Œè€ŒéAIåˆ†æçš„é€šç”¨æè¿°
					const specificQuestionForAnalysis =
						userIntent.originalUserMessage ||
						topicAndBirthdayData.originalMessage ||
						userIntent.originalSpecificProblem ||
						userIntent.specificQuestion ||
						"ä¸€èˆ¬æ„Ÿæƒ…åˆ†æ";

					console.log("ğŸ” DEBUG - åˆ†æåŸå§‹è¨Šæ¯ä¾†æº:");
					console.log(
						"   userIntent.originalUserMessage:",
						userIntent.originalUserMessage
					);
					console.log(
						"   topicAndBirthdayData.originalMessage:",
						topicAndBirthdayData?.originalMessage
					);
					console.log(
						"   userIntent.originalSpecificProblem:",
						userIntent.originalSpecificProblem
					);
					console.log(
						"   userIntent.specificQuestion:",
						userIntent.specificQuestion
					);
					console.log(
						"ğŸ” å‚³éçµ¦ generateLoveAnalysis çš„å…·é«”å•é¡Œ:",
						specificQuestionForAnalysis
					);
					response =
						await EnhancedInitialAnalysis.generateLoveAnalysis(
							topicAndBirthdayData.birthday.parsed,
							specificQuestionForAnalysis
						);
				} else if (topicAndBirthdayData.topic === "è²¡é‹") {
					response =
						await EnhancedInitialAnalysis.generateFinanceAnalysis(
							topicAndBirthdayData.birthday.parsed,
							userIntent.originalSpecificProblem ||
								userIntent.specificQuestion ||
								topicAndBirthdayData.originalMessage ||
								"è²¡é‹è«®è©¢"
						);
				} else if (topicAndBirthdayData.topic === "å·¥ä½œ") {
					response =
						await EnhancedInitialAnalysis.generateWorkAnalysis(
							topicAndBirthdayData.birthday.parsed,
							userIntent.originalSpecificProblem ||
								userIntent.specificQuestion ||
								topicAndBirthdayData.originalMessage ||
								"å·¥ä½œé‹å‹¢"
						);
				} else if (topicAndBirthdayData.topic === "å¥åº·") {
					response =
						await EnhancedInitialAnalysis.generateHealthAnalysis(
							topicAndBirthdayData.birthday.parsed,
							userIntent.originalSpecificProblem ||
								userIntent.specificQuestion ||
								topicAndBirthdayData.originalMessage ||
								"å¥åº·é‹å‹¢"
						);
				} else {
					// å…¶ä»–é ˜åŸŸä½¿ç”¨é€šç”¨åˆ†æ
					response =
						await EnhancedInitialAnalysis.generatePersonalAnalysis(
							topicAndBirthdayData.birthday.parsed,
							topicAndBirthdayData.topic,
							userIntent.originalSpecificProblem ||
								userIntent.specificQuestion ||
								topicAndBirthdayData.originalMessage ||
								`${topicAndBirthdayData.topic}è«®è©¢`
						);
				}

				// æ·»åŠ è©³ç´°å ±å‘Šé¸é …èœå–® - ç¾åœ¨ä½¿ç”¨ enhancedInitialAnalysis ä¸­çš„æ–¹æ³•
				response += EnhancedInitialAnalysis.getReportRecommendations(
					topicAndBirthdayData.topic
				);

				analysis = {
					isWithinScope: true,
					detectedTopic: topicAndBirthdayData.topic,
					specificProblem: `${topicAndBirthdayData.topic}é‹å‹¢åˆ†æ`,
					confidence: 0.95,
					birthdayProvided: true,
					topicAndBirthdayDetected: true,
				};

				console.log("âœ… ä¸»é¡Œ+ç”Ÿæ—¥åˆ†æç”ŸæˆæˆåŠŸ");
			} catch (error) {
				console.error("âŒ ä¸»é¡Œ+ç”Ÿæ—¥åˆ†æå¤±æ•—:", error);
				// å‚™ç”¨å›æ‡‰
				response = `ğŸ‰ å¤ªå¥½äº†ï¼ä½ æƒ³äº†è§£${topicAndBirthdayData.topic}ï¼Œç”Ÿæ—¥æ˜¯ ${topicAndBirthdayData.birthday.original}ï¼

è®“é¢¨éˆ´ç‚ºä½ åšè©³ç´°çš„${topicAndBirthdayData.topic}åˆ†æï½

æ­£åœ¨ç‚ºä½ è¨ˆç®—å…«å­—å’Œé‹å‹¢...

æ ¹æ“šä½ çš„å‡ºç”Ÿæ—¥æœŸï¼Œæˆ‘æœƒå¾ä»¥ä¸‹è§’åº¦ç‚ºä½ åˆ†æï¼š
ğŸ”® **å…«å­—å‘½ç›¤** - ä½ çš„åŸºæœ¬é‹å‹¢ç‰¹è³ª
â­ **æµå¹´é‹å‹¢** - ä»Šå¹´çš„${topicAndBirthdayData.topic}é‹å‹¢å¦‚ä½•
ğŸ’« **é–‹é‹å»ºè­°** - å°ˆé–€é‡å°${topicAndBirthdayData.topic}çš„é¢¨æ°´èª¿æ•´

ç¨ç­‰ä¸€ä¸‹ï¼Œè®“æˆ‘ç‚ºä½ æº–å‚™å°ˆæ¥­çš„åˆ†æå ±å‘Š... âœ¨`;

				analysis = {
					isWithinScope: true,
					detectedTopic: topicAndBirthdayData.topic,
					specificProblem: `${topicAndBirthdayData.topic}é‹å‹¢åˆ†æ`,
					confidence: 0.8,
					birthdayProvided: true,
					topicAndBirthdayDetected: true,
				};
			}
		} else if (isBreakupChoice && userIntent?.primaryConcern === "æ„Ÿæƒ…") {
			// æª¢æŸ¥ChatHistoryä¸­æ˜¯å¦æœ‰åˆ†æ‰‹ç‹€æ…‹é¸é …
			const chatHistory = await ChatHistory.findOne({
				$or: [{ conversationId: sessionId }, { sessionId: sessionId }],
			});

			const hasBreakupOptions = chatHistory?.messages?.some(
				(msg) =>
					msg.role === "assistant" &&
					(msg.content.includes("A. å‰›åˆ†æ‰‹ï¼Œé‚„å¾ˆé›£é") ||
						msg.content.includes("è«‹é¸æ“‡ä½ çš„æ„Ÿæƒ…ç‹€æ…‹"))
			);

			if (hasBreakupOptions) {
				// ğŸ”§ è™•ç†åˆ†æ‰‹ç‹€æ…‹é¸æ“‡ (A, B, C, D) - åˆ†æ‰‹ç‰¹æ®Šé‚è¼¯å¾ŒçºŒå›æ‡‰
				console.log("ğŸ¯ æª¢æ¸¬åˆ°åˆ†æ‰‹ç‹€æ…‹é¸æ“‡:", message);

				let breakupChoice = message.trim().toUpperCase().charAt(0);
				if (!["A", "B", "C", "D"].includes(breakupChoice)) {
					// å¦‚æœä¸æ˜¯å­—æ¯ï¼Œå˜—è©¦å¾æ–‡å­—ä¸­åˆ¤æ–·
					const text = message.toLowerCase();
					if (text.includes("å‰›åˆ†æ‰‹") || text.includes("é›£é")) {
						breakupChoice = "A";
					} else if (
						text.includes("åˆ†æ‰‹ä¸€æ®µæ™‚é–“") ||
						text.includes("é‡æ–°é–‹å§‹")
					) {
						breakupChoice = "B";
					} else if (
						text.includes("å¾©åˆ") ||
						text.includes("ä¸ç¢ºå®š")
					) {
						breakupChoice = "C";
					} else if (
						text.includes("æ”¾ä¸‹") ||
						text.includes("æ–°å°è±¡")
					) {
						breakupChoice = "D";
					}
				}

				switch (breakupChoice) {
					case "A":
						// A. å‰›åˆ†æ‰‹ï¼Œé‚„å¾ˆé›£é
						response = `é¢¨éˆ´å®Œå…¨ç†è§£ä½ ç¾åœ¨çš„å¿ƒæƒ…ï¼Œå‰›åˆ†æ‰‹çœŸçš„å¾ˆç—›è‹¦... 

çµ¦è‡ªå·±ä¸€äº›æ™‚é–“ç™‚å‚·æ˜¯å¾ˆé‡è¦çš„ï¼Œä¸è¦æ€¥è‘—å£“æŠ‘æƒ…ç·’å“¦ï¼

**ğŸŒ¸ ç¾éšæ®µæœ€é‡è¦çš„å»ºè­°ï¼š**
**æƒ…æ„Ÿä¿®å¾©æœŸ** - å…è¨±è‡ªå·±æ‚²å‚·ï¼Œä½†ä¸è¦æ²‰æººå¤ªä¹…
**èƒ½é‡æ¸…ç†** - æ•´ç†æˆ¿é–“ï¼Œç‰¹åˆ¥æ˜¯æ„Ÿæƒ…è§’è½ï¼ˆè¥¿å—æ–¹ï¼‰
**è‡ªæˆ‘ç…§é¡§** - å¤šæ¥è§¸é™½å…‰ï¼Œé¿å…é•·æœŸå¾…åœ¨é™°æš—ç©ºé–“

**ğŸ’• æ„Ÿæƒ…é¢¨æ°´èª¿æ•´ï¼š**
- æ”¶èµ·åˆç…§ä½†ä¸è¦ä¸Ÿæ‰ï¼Œæ”¾åœ¨æŠ½å±œè£¡
- åœ¨åºŠé ­æ”¾ç²‰æ°´æ™¶ï¼Œå¹«åŠ©ç™‚ç™’å¿ƒå‚·
- å¤šç©¿ç²‰è‰²æˆ–ç™½è‰²ï¼Œæœ‰æ·¨åŒ–è² èƒ½é‡çš„æ•ˆæœ

è¦è¨˜ä½ï¼Œæ¯ä¸€æ¬¡çµæŸéƒ½æ˜¯ç‚ºäº†æ›´å¥½çš„é–‹å§‹ï¼é¢¨éˆ´æœƒé™ªè‘—ä½ èµ°éé€™æ®µè·¯çš„ ğŸ¤—

ç‚ºäº†æä¾›æœ€é©åˆçš„åˆ†æï¼Œè«‹é¸æ“‡ï¼š

å¦‚è¦å¢åŠ å€‹äººèƒ½é‡ï¼Œå¯é¸
**1ï¸âƒ£ å€‹äººæ„Ÿæƒ…åˆ†æ**
- åˆ†æä½ çš„æ¡ƒèŠ±é‹å‹¢å’Œæ„Ÿæƒ…ç‰¹è³ª
- æä¾›æ„Ÿæƒ…é‹å‹¢å»ºè­°å’Œé¢¨æ°´èª¿æ•´
- é©åˆå–®èº«æˆ–æƒ³äº†è§£å€‹äººæ„Ÿæƒ…é‹çš„æœ‹å‹

å¦‚è¦çœ‹æ˜¯å¦è·Ÿä¼´ä¾¶åˆé©ï¼Œå¯é¸
**2ï¸âƒ£ åˆå©šé…å°åˆ†æ** 
- åˆ†æä½ å’Œä¼´ä¾¶çš„å…«å­—å¥‘åˆåº¦
- æä¾›é›™æ–¹æ„Ÿæƒ…èµ°å‘å’Œç™¼å±•å»ºè­°  
- é©åˆæƒ³äº†è§£æ„Ÿæƒ…é…å°åº¦çš„æƒ…ä¾¶

ä½ æƒ³è¦å“ªç¨®åˆ†æå‘¢ï¼Ÿå›è¦†ã€Œå€‹äººåˆ†æã€æˆ–ã€Œåˆå©šåˆ†æã€å³å¯ï½`;
						break;

					case "B":
						// B. åˆ†æ‰‹ä¸€æ®µæ™‚é–“äº†ï¼Œæƒ³é‡æ–°é–‹å§‹
						response = `ğŸŒŸ å¤ªå¥½äº†ï¼èƒ½å¤ æº–å‚™å¥½é‡æ–°é–‹å§‹ï¼Œä»£è¡¨ä½ å·²ç¶“æˆé•·äº†å¾ˆå¤šå‘¢ï¼

ç¾åœ¨æ˜¯æœ€é©åˆé‡æ–°å‡ºç™¼çš„æ™‚å€™ï¼Œé¢¨éˆ´ä¾†å¹«ä½ åšå¥½æº–å‚™ï¼

**ğŸ¯ é‡æ–°é–‹å§‹çš„é»ƒé‡‘æº–å‰‡ï¼š**
**å¿ƒå¢ƒèª¿æ•´** - æ”¾ä¸‹éå»åŒ…è¢±ï¼Œå°ˆæ³¨æœªä¾†å¯èƒ½
**æ¡ƒèŠ±ä½ˆå±€** - æ´»åŒ–æ„Ÿæƒ…èƒ½é‡ï¼Œå¸å¼•å°çš„äºº
**è‡ªä¿¡æå‡** - å¾å…§è€Œå¤–æ•£ç™¼é­…åŠ›

**ğŸ’– æ‹›æ¡ƒèŠ±é¢¨æ°´ç§˜æŠ€ï¼š**
- è¥¿å—æ–¹æ”¾ç½®ç²‰æ°´æ™¶æ¨¹æˆ–ç«ç‘°èŠ±
- åºŠé ­æ«ƒæˆé›™æˆå°æ“ºè¨­ï¼Œè±¡å¾µæ„Ÿæƒ…åœ“æ»¿
- ç©¿æˆ´ç²‰è‰²æˆ–ç´…è‰²å¢å¼·æ¡ƒèŠ±é‹
- ä¿æŒç¬‘å®¹ï¼Œæ­£èƒ½é‡æœ€å¸å¼•äººï¼

ç‚ºäº†æä¾›æœ€é©åˆçš„åˆ†æï¼Œè«‹é¸æ“‡ï¼š

å¦‚è¦å¢åŠ å€‹äººèƒ½é‡ï¼Œå¯é¸
**1ï¸âƒ£ å€‹äººæ„Ÿæƒ…åˆ†æ**
- åˆ†æä½ çš„æ¡ƒèŠ±é‹å‹¢å’Œæ„Ÿæƒ…ç‰¹è³ª
- æä¾›æ„Ÿæƒ…é‹å‹¢å»ºè­°å’Œé¢¨æ°´èª¿æ•´
- é©åˆå–®èº«æˆ–æƒ³äº†è§£å€‹äººæ„Ÿæƒ…é‹çš„æœ‹å‹

å¦‚è¦çœ‹æ˜¯å¦è·Ÿä¼´ä¾¶åˆé©ï¼Œå¯é¸
**2ï¸âƒ£ åˆå©šé…å°åˆ†æ** 
- åˆ†æä½ å’Œä¼´ä¾¶çš„å…«å­—å¥‘åˆåº¦
- æä¾›é›™æ–¹æ„Ÿæƒ…èµ°å‘å’Œç™¼å±•å»ºè­°  
- é©åˆæƒ³äº†è§£æ„Ÿæƒ…é…å°åº¦çš„æƒ…ä¾¶

ä½ æƒ³è¦å“ªç¨®åˆ†æå‘¢ï¼Ÿå›è¦†ã€Œå€‹äººåˆ†æã€æˆ–ã€Œåˆå©šåˆ†æã€å³å¯ï½`;
						break;

					case "C":
						// C. æƒ³å¾©åˆï¼Œä½†ä¸ç¢ºå®š
						response = `ğŸ’­ æƒ³å¾©åˆçš„å¿ƒæƒ…é¢¨éˆ´å¾ˆç†è§£ï¼Œä½†é€™ç¢ºå¯¦éœ€è¦è¬¹æ…è€ƒæ…®å‘¢...

è®“æˆ‘å€‘ä¸€èµ·åˆ†æä¸€ä¸‹å¾©åˆçš„å¯èƒ½æ€§å’Œæœ€ä½³ç­–ç•¥ï¼

**ğŸ¤” å¾©åˆå‰çš„é‡è¦æ€è€ƒï¼š**
**åˆ†æ‰‹åŸå› ** - æ ¹æœ¬å•é¡Œæ˜¯å¦å·²ç¶“è§£æ±ºï¼Ÿ
**æˆé•·ç©ºé–“** - é€™æ®µæ™‚é–“ä½ å€‘éƒ½æœ‰æ”¹è®Šå—ï¼Ÿ
**æœªä¾†é¡˜æ™¯** - å°æ„Ÿæƒ…çš„æœŸå¾…æ˜¯å¦ä¸€è‡´ï¼Ÿ

**ğŸ’• é¢¨æ°´èª¿æ•´å»ºè­°ï¼š**
- åœ¨æ„Ÿæƒ…è§’è½æ”¾ç½®å’Œåˆç¬¦æˆ–æˆå°ç‰©å“
- é¸æ“‡è¾²æ›†åäº”å‰å¾Œé€²è¡Œæºé€šï¼Œæœˆåœ“äººåœ˜åœ“
- ä¿æŒå…§å¿ƒå¹³éœï¼Œå¤šçµ¦è‡ªå·±æ™‚é–“æ€è€ƒ

å¾©åˆä¸æ˜¯å”¯ä¸€çš„é¸æ“‡ï¼Œæœ€é‡è¦çš„æ˜¯ä½ çš„å¹¸ç¦ï¼

ç‚ºäº†æä¾›æœ€é©åˆçš„åˆ†æï¼Œè«‹é¸æ“‡ï¼š

å¦‚è¦å¢åŠ å€‹äººèƒ½é‡ï¼Œå¯é¸
**1ï¸âƒ£ å€‹äººæ„Ÿæƒ…åˆ†æ**
- åˆ†æä½ çš„æ¡ƒèŠ±é‹å‹¢å’Œæ„Ÿæƒ…ç‰¹è³ª
- æä¾›æ„Ÿæƒ…é‹å‹¢å»ºè­°å’Œé¢¨æ°´èª¿æ•´
- é©åˆå–®èº«æˆ–æƒ³äº†è§£å€‹äººæ„Ÿæƒ…é‹çš„æœ‹å‹

å¦‚è¦çœ‹æ˜¯å¦è·Ÿä¼´ä¾¶åˆé©ï¼Œå¯é¸
**2ï¸âƒ£ åˆå©šé…å°åˆ†æ** 
- åˆ†æä½ å’Œä¼´ä¾¶çš„å…«å­—å¥‘åˆåº¦
- æä¾›é›™æ–¹æ„Ÿæƒ…èµ°å‘å’Œç™¼å±•å»ºè­°  
- é©åˆæƒ³äº†è§£æ„Ÿæƒ…é…å°åº¦çš„æƒ…ä¾¶

ä½ æƒ³è¦å“ªç¨®åˆ†æå‘¢ï¼Ÿå›è¦†ã€Œå€‹äººåˆ†æã€æˆ–ã€Œåˆå©šåˆ†æã€å³å¯ï½`;
						break;

					case "D":
						// D. å·²ç¶“æ”¾ä¸‹ï¼Œæƒ³æ‰¾æ–°å°è±¡
						response = `âœ¨ å“‡ï¼ä½ çš„å¿ƒå¢ƒèª¿æ•´å¾—çœŸå¥½ï¼Œèƒ½å¤ æ”¾ä¸‹éå»è¿å‘æœªä¾†ï¼Œé€™ä»½å‹‡æ°£å¾ˆæ£’å‘¢ï¼

ç¾åœ¨å°±æ˜¯ä½ æ¡ƒèŠ±å¤§é–‹çš„æœ€ä½³æ™‚æ©Ÿï¼Œé¢¨éˆ´ä¾†å¹«ä½ å¸å¼•ç†æƒ³å°è±¡ï¼

**ğŸŒ¹ å…¨æ–°é–‹å§‹çš„èƒ½é‡æº–å‚™ï¼š**
**ç©ºé–“æ¸…ç†** - å¾¹åº•æ•´ç†æ„Ÿæƒ…è§’è½ï¼Œæ¸…é™¤èˆŠèƒ½é‡
**å½¢è±¡æå‡** - æ”¹è®Šé«®å‹æˆ–é¢¨æ ¼ï¼Œç…¥ç„¶ä¸€æ–°
**ç¤¾äº¤æ“´å±•** - ä¸»å‹•åƒèˆ‡æ´»å‹•ï¼Œå¢åŠ èªè­˜æ©Ÿæœƒ

**ğŸ’– å¼·åŠ›æ‹›æ¡ƒèŠ±ä½ˆå±€ï¼š**
- æ„Ÿæƒ…å€ï¼ˆè¥¿å—æ–¹ï¼‰æ”¾ç½®ç²‰æ°´æ™¶çƒæˆ–é®®èŠ±
- è‡¥å®¤ä¿æŒæ•´æ½”æ˜äº®ï¼ŒåºŠå–®é¸ç”¨ç²‰è‰²ç³»
- æ¢³å¦å°æ“ºæ”¾é›™æ•¸ç‰©å“ï¼Œè±¡å¾µæˆé›™æˆå°
- éš¨èº«é…æˆ´ç´…ç¹©æˆ–ç²‰æ™¶ï¼Œå¢å¼·å€‹äººé­…åŠ›

æœ€å¥½çš„æ„›æƒ…æœƒåœ¨ä½ æº–å‚™å¥½çš„æ™‚å€™å‡ºç¾ï¼Œç›¸ä¿¡è‡ªå·±å€¼å¾—è¢«å¥½å¥½æ„›ï¼

ç‚ºäº†æä¾›æœ€é©åˆçš„åˆ†æï¼Œè«‹é¸æ“‡ï¼š

å¦‚è¦å¢åŠ å€‹äººèƒ½é‡ï¼Œå¯é¸
**1ï¸âƒ£ å€‹äººæ„Ÿæƒ…åˆ†æ**
- åˆ†æä½ çš„æ¡ƒèŠ±é‹å‹¢å’Œæ„Ÿæƒ…ç‰¹è³ª
- æä¾›æ„Ÿæƒ…é‹å‹¢å»ºè­°å’Œé¢¨æ°´èª¿æ•´
- é©åˆå–®èº«æˆ–æƒ³äº†è§£å€‹äººæ„Ÿæƒ…é‹çš„æœ‹å‹

å¦‚è¦çœ‹æ˜¯å¦è·Ÿä¼´ä¾¶åˆé©ï¼Œå¯é¸
**2ï¸âƒ£ åˆå©šé…å°åˆ†æ** 
- åˆ†æä½ å’Œä¼´ä¾¶çš„å…«å­—å¥‘åˆåº¦
- æä¾›é›™æ–¹æ„Ÿæƒ…èµ°å‘å’Œç™¼å±•å»ºè­°  
- é©åˆæƒ³äº†è§£æ„Ÿæƒ…é…å°åº¦çš„æƒ…ä¾¶

ä½ æƒ³è¦å“ªç¨®åˆ†æå‘¢ï¼Ÿå›è¦†ã€Œå€‹äººåˆ†æã€æˆ–ã€Œåˆå©šåˆ†æã€å³å¯ï½`;
						break;

					default:
						response = `æŠ±æ­‰ï¼Œæˆ‘æ²’æœ‰ç†è§£ä½ çš„é¸æ“‡ ğŸ˜… 

è«‹é‡æ–°é¸æ“‡ä½ çš„æ„Ÿæƒ…ç‹€æ…‹ï¼š

**ğŸ’• è«‹é¸æ“‡ä½ çš„æ„Ÿæƒ…ç‹€æ…‹ï¼š**
- A. å‰›åˆ†æ‰‹ï¼Œé‚„å¾ˆé›£é
- B. åˆ†æ‰‹ä¸€æ®µæ™‚é–“äº†ï¼Œæƒ³é‡æ–°é–‹å§‹  
- C. æƒ³å¾©åˆï¼Œä½†ä¸ç¢ºå®š
- D. å·²ç¶“æ”¾ä¸‹ï¼Œæƒ³æ‰¾æ–°å°è±¡

ç›´æ¥å›è¦†å­—æ¯ Aã€Bã€C æˆ– D å³å¯ï¼`;
						break;
				}

				// è¨˜éŒ„åˆ†æ‰‹ç‹€æ…‹é¸æ“‡
				userIntent.breakupStatus = breakupChoice;
				userIntent.conversationState = "asking_relationship_type"; // è¨­å®šç‚ºè©¢å•é—œä¿‚åˆ†æé¡å‹ç‹€æ…‹
				await userIntent.save();

				analysis = {
					detectedTopic: "æ„Ÿæƒ…",
					isWithinScope: true,
					confidence: 0.95,
					specificProblem: `åˆ†æ‰‹ç‹€æ…‹é¸æ“‡_${breakupChoice}`,
				};
			}
		} else if (isBirthdayInput && userIntent?.primaryConcern) {
			// ç”Ÿæ—¥è¼¸å…¥ - ç”Ÿæˆåˆæ­¥åˆ†æå ±å‘Š (å®Œå…¨è¤‡è£½ smart-chat é‚è¼¯)
			try {
				// è§£æä¸¦æ¨™æº–åŒ–ç”Ÿæ—¥æ ¼å¼
				const cleanedDate = message
					.replace(/[å¹´æœˆæ—¥]/g, "-")
					.replace(/[/]/g, "-");
				const dateMatch = cleanedDate.match(
					/(\d{4})-(\d{1,2})-(\d{1,2})/
				);
				let standardDate;
				if (dateMatch) {
					const [, year, month, day] = dateMatch;
					standardDate = `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
				} else {
					standardDate = message;
				}

				// ğŸ”® ç”Ÿæˆåˆæ­¥åˆ†æå ±å‘Š - èˆ‡ smart-chat å®Œå…¨ç›¸åŒ
				const { EnhancedInitialAnalysis } = await import(
					"../../../lib/enhancedInitialAnalysis.js"
				);

				if (userIntent.primaryConcern === "æ„Ÿæƒ…") {
					if (userIntent.relationshipAnalysisType === "individual") {
						// ğŸ”§ ä½¿ç”¨ç›¸åŒçš„å„ªå…ˆç´šéˆç¢ºä¿åŸå§‹è¨Šæ¯è¢«ä½¿ç”¨
						const specificQuestionForAnalysis =
							userIntent.originalUserMessage ||
							userIntent.originalSpecificProblem ||
							userIntent.specificQuestion ||
							"å€‹äººæ„Ÿæƒ…åˆ†æ";

						console.log("ğŸ” DEBUG - å¤šæ­¥æµç¨‹åˆ†æåŸå§‹è¨Šæ¯ä¾†æº:");
						console.log(
							"   userIntent.originalUserMessage:",
							userIntent.originalUserMessage
						);
						console.log(
							"   userIntent.originalSpecificProblem:",
							userIntent.originalSpecificProblem
						);
						console.log(
							"   userIntent.specificQuestion:",
							userIntent.specificQuestion
						);
						console.log(
							"ğŸ” å‚³éçµ¦ generateLoveAnalysis çš„å…·é«”å•é¡Œ:",
							specificQuestionForAnalysis
						);

						response =
							await EnhancedInitialAnalysis.generateLoveAnalysis(
								new Date(standardDate),
								specificQuestionForAnalysis
							);
					} else if (
						userIntent.relationshipAnalysisType === "couple"
					) {
						// ğŸ”§ ä½¿ç”¨ç›¸åŒçš„å„ªå…ˆç´šéˆç¢ºä¿åŸå§‹è¨Šæ¯è¢«ä½¿ç”¨
						const specificQuestionForAnalysis =
							userIntent.originalUserMessage ||
							userIntent.originalSpecificProblem ||
							userIntent.specificQuestion ||
							"åˆå©šé…å°åˆ†ææº–å‚™";

						response =
							await EnhancedInitialAnalysis.generateLoveAnalysis(
								new Date(standardDate),
								specificQuestionForAnalysis
							);
						// ç‚ºåˆå©šåˆ†ææ·»åŠ å°æ–¹ç”Ÿæ—¥é¸é …
						response += `\n\nğŸ’• **æƒ³åšå®Œæ•´åˆå©šåˆ†æå—ï¼Ÿ**\nå¦‚æœä½ æœ‰ä¼´ä¾¶ï¼Œå¯ä»¥æä¾›å°æ–¹çš„ç”Ÿæ—¥ï¼Œæˆ‘å¯ä»¥ç‚ºä½ å€‘åšå…«å­—é…å°åˆ†æï¼Œçœ‹çœ‹æ„Ÿæƒ…ç›¸å®¹åº¦å“¦ï¼`;
					} else {
						// ğŸ”§ ä½¿ç”¨ç›¸åŒçš„å„ªå…ˆç´šéˆç¢ºä¿åŸå§‹è¨Šæ¯è¢«ä½¿ç”¨
						const specificQuestionForAnalysis =
							userIntent.originalUserMessage ||
							userIntent.originalSpecificProblem ||
							userIntent.specificQuestion ||
							"ä¸€èˆ¬æ„Ÿæƒ…åˆ†æ";

						response =
							await EnhancedInitialAnalysis.generateLoveAnalysis(
								new Date(standardDate),
								specificQuestionForAnalysis
							);
					}
				} else if (userIntent.primaryConcern === "è²¡é‹") {
					response =
						await EnhancedInitialAnalysis.generateFinanceAnalysis(
							new Date(standardDate),
							userIntent.specificQuestion || "è²¡é‹è«®è©¢"
						);
				} else if (userIntent.primaryConcern === "å·¥ä½œ") {
					response =
						await EnhancedInitialAnalysis.generateWorkAnalysis(
							new Date(standardDate),
							userIntent.specificQuestion || "å·¥ä½œé‹å‹¢"
						);
				} else {
					// å…¶ä»–é ˜åŸŸä½¿ç”¨é€šç”¨åˆ†æ
					response =
						await EnhancedInitialAnalysis.generatePersonalAnalysis(
							new Date(standardDate),
							userIntent.primaryConcern,
							userIntent.specificQuestion ||
								`${userIntent.primaryConcern}è«®è©¢`
						);
				}

				// æ·»åŠ è©³ç´°å ±å‘Šé¸é …èœå–®
				response += EnhancedInitialAnalysis.getReportRecommendations(
					userIntent.primaryConcern
				);

				// è¨­ç½®ç‹€æ…‹ç‚ºè©¢å•è©³ç´°å ±å‘Š
				userIntent.conversationState = "asking_detailed_report";
			} catch (error) {
				console.error("ğŸš¨ åˆæ­¥åˆ†æç”Ÿæˆå¤±æ•—:", error);
				// å‚™ç”¨å›æ‡‰
				response = `ğŸ‰ å¤ªå¥½äº†ï¼ä½ çš„ç”Ÿæ—¥æ˜¯ ${message}ï¼Œè®“æˆ‘ç‚ºä½ åšè©³ç´°çš„${userIntent.primaryConcern}åˆ†æï½

æ­£åœ¨ç‚ºä½ è¨ˆç®—å…«å­—å’Œé‹å‹¢...

æ ¹æ“šä½ çš„å‡ºç”Ÿæ—¥æœŸï¼Œæˆ‘æœƒå¾ä»¥ä¸‹è§’åº¦ç‚ºä½ åˆ†æï¼š
ğŸ”® **å…«å­—å‘½ç›¤** - ä½ çš„åŸºæœ¬é‹å‹¢ç‰¹è³ª
â­ **æµå¹´é‹å‹¢** - ä»Šå¹´çš„${userIntent.primaryConcern}é‹å‹¢å¦‚ä½•
ğŸ’« **é–‹é‹å»ºè­°** - å°ˆé–€é‡å°${userIntent.primaryConcern}çš„é¢¨æ°´èª¿æ•´

ç¨ç­‰ä¸€ä¸‹ï¼Œè®“æˆ‘ç‚ºä½ æº–å‚™å°ˆæ¥­çš„åˆ†æå ±å‘Š... âœ¨

(è«‹ç­‰å¾…ç³»çµ±ç‚ºä½ ç”Ÿæˆè©³ç´°çš„${userIntent.primaryConcern}åˆ†æå ±å‘Š)`;
			}

			analysis = {
				isWithinScope: true,
				detectedTopic: userIntent.primaryConcern,
				// ğŸ”§ FIX: ä½¿ç”¨åŸå§‹è©³ç´°å•é¡Œè€Œä¸æ˜¯é€šç”¨æè¿°
				specificProblem:
					userIntent.originalSpecificProblem ||
					(userIntent.relationshipAnalysisType === "individual"
						? "å€‹äººæ„Ÿæƒ…åˆ†æ"
						: userIntent.relationshipAnalysisType === "couple"
							? "åˆå©šé…å°åˆ†æ"
							: `${userIntent.primaryConcern}è«®è©¢`),
				confidence: 0.95,
				birthdayProvided: true,
			};
		} else if (reportType && !message?.trim() && !userBirthday) {
			// ğŸ”§ è™•ç†å ±å‘Šé¡å‹è«‹æ±‚ (åƒ…å ±å‘Šé¡å‹ï¼Œç„¡è¨Šæ¯å’Œç”Ÿæ—¥)
			console.log("ğŸ¯ æª¢æ¸¬åˆ°å ±å‘Šé¡å‹è«‹æ±‚:", reportType);

			if (!userIntent) {
				return NextResponse.json(
					{
						response: "è«‹å…ˆé–‹å§‹ä¸€å€‹å°è©±å†è«‹æ±‚å ±å‘Šã€‚",
						systemType: "smart-chat2",
					},
					{ status: 400 }
				);
			}

			if (reportType === "detailed_concern") {
				// è™•ç†è©³ç´°é—œæ³¨é ˜åŸŸå ±å‘Šè«‹æ±‚
				const concernName = userIntent.primaryConcern || "é‹å‹¢";

				// æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ è³‡æ–™ç”Ÿæˆå ±å‘Š
				if (
					userIntent.relationshipAnalysisType === "couple" &&
					userIntent.userBirthday &&
					userIntent.partnerBirthday
				) {
					// åˆå©šåˆ†æè©³ç´°å ±å‘Š - å…ˆç”Ÿæˆä¸¦ä¿å­˜åˆ°æ•¸æ“šåº«
					try {
						// ğŸ”® ç”Ÿæˆåˆå©šåˆ†ææ•¸æ“š (ä½¿ç”¨ç¾æœ‰çš„ EnhancedInitialAnalysis é‚è¼¯)
						const userDateString = userIntent.userBirthday
							.toISOString()
							.split("T")[0];
						const partnerDateString = userIntent.partnerBirthday
							.toISOString()
							.split("T")[0];

						// ç”ŸæˆåŸºæœ¬çš„åˆå©šåˆ†ææ•¸æ“š (ç°¡åŒ–ç‰ˆï¼Œç”¨æ–¼å ±å‘Šä¿å­˜)
						const basicCoupleAnalysis = {
							compatibility: 75, // Number instead of "75%"
							userElement: "é‡‘",
							partnerElement: "æœ¨",
							advice: "é‡‘æœ¨ç›¸é…éœ€è¦ç£¨åˆï¼Œä½†èƒ½äº’ç›¸ä¿ƒé€²æˆé•·",
							fengShuiAdvice:
								"å±…å®¶å¤šç”¨æ°´å…ƒç´ å”èª¿é‡‘æœ¨ç›¸å‰‹ï¼Œå¦‚è—ç¶ è‰²è£é£¾å“",
							userPersonality: "ç†æ€§ç©©é‡ï¼Œåšäº‹æœ‰æ¢ç†",
							partnerPersonality: "æ´»æ½‘å‰µæ–°ï¼Œå¯Œæœ‰æƒ³åƒåŠ›",
							userLoveStyle: "æ·±æƒ…å°ˆä¸€ï¼Œé‡è¦–æ‰¿è«¾",
							partnerLoveStyle: "ç†±æƒ…è¡¨é”ï¼Œå–œæ­¡æµªæ¼«",
						};

						// ğŸ¯ å‰µå»ºä¸¦ä¿å­˜è©³ç´°åˆå©šå ±å‘Šåˆ°æ•¸æ“šåº« (è¤‡è£½è‡ª Smart-Chat é‚è¼¯)
						const coupleReport = new CoupleReportDoc({
							userId: userId, // Use the authenticated user's ID from session
							sessionId: sessionId,
							language: "zh-CN",
							userProfile: {
								birthday: userIntent.userBirthday,
								gender: "male", // é»˜èªå€¼ï¼Œå¯ä»¥å¾ŒçºŒæ”¹é€²
								element: basicCoupleAnalysis.userElement,
								personality:
									basicCoupleAnalysis.userPersonality,
								loveStyle: basicCoupleAnalysis.userLoveStyle,
							},
							partnerProfile: {
								birthday: userIntent.partnerBirthday,
								gender: "female", // é»˜èªå€¼ï¼Œå¯ä»¥å¾ŒçºŒæ”¹é€²
								element: basicCoupleAnalysis.partnerElement,
								personality:
									basicCoupleAnalysis.partnerPersonality,
								loveStyle: basicCoupleAnalysis.partnerLoveStyle,
							},
							compatibilityAnalysis: {
								overallScore: basicCoupleAnalysis.compatibility,
								relationshipAdvice: basicCoupleAnalysis.advice,
								developmentAdvice:
									"å»ºè­°å¤šåƒèˆ‡å…±åŒæ´»å‹•ï¼Œå¢é€²å½¼æ­¤äº†è§£",
								specificAdvice:
									"å»ºè­°å¤šæºé€šï¼Œç†è§£å½¼æ­¤ä¸åŒçš„è¡¨é”æ–¹å¼",
								communicationAdvice:
									"å»ºè­°å¤šæºé€šï¼Œç†è§£å½¼æ­¤ä¸åŒçš„è¡¨é”æ–¹å¼",
								challenges: "æ€§æ ¼å·®ç•°è¼ƒå¤§ï¼Œéœ€è¦è€å¿ƒç£¨åˆ",
								strengths: "èƒ½å¤ äº’è£œï¼Œå…±åŒæˆé•·",
							},
							yearlyFortune: {
								currentYear:
									"ä»Šå¹´æ„Ÿæƒ…é‹å‹¢æ•´é«”å‘å¥½ï¼Œé©åˆæ·±åŒ–é—œä¿‚",
								bestTiming: "æ˜¥ç§‹å…©å­£æ˜¯æ„Ÿæƒ…ç™¼å±•çš„å¥½æ™‚æ©Ÿ",
								warnings: "å¤å­£éœ€è¦æ³¨æ„æºé€šå•é¡Œï¼Œé¿å…çˆ­åŸ·",
							},
							fengShuiLayout: {
								bedroom: "åºŠé ­æœæ±å—æ–¹ï¼Œä½¿ç”¨ç²‰è‰²æˆ–æ·ºè—è‰²åºŠå“",
								livingRoom: "å®¢å»³æ”¾ç½®æˆå°è£é£¾å“ï¼Œå¢å¼·æ„Ÿæƒ…å’Œè«§",
								colors: "ç²‰è‰²ã€é‡‘è‰²ã€æ·ºç¶ è‰²",
								items: "ç«ç‘°çŸ³è‹±ã€æˆå°çš„æ“ºä»¶ã€é®®èŠ±",
								generalAdvice:
									basicCoupleAnalysis.fengShuiAdvice,
							},
							reportMetadata: {
								concern: "æ„Ÿæƒ…",
								reportType: "detailed_concern",
								generatedAt: new Date(),
								// ğŸ”§ æ–°å¢ï¼šä¿å­˜åŸå§‹å…·é«”å•é¡Œï¼Œç”¨æ–¼å ±å‘Šä¸­çš„é‡å°æ€§å»ºè­°
								originalSpecificProblem:
									userIntent.originalSpecificProblem ||
									userIntent.specificQuestion ||
									"æ„Ÿæƒ…è®Šæ·¡ï¼Œé—œä¿‚ç–é›¢",
							},
						});

						const savedReport = await coupleReport.save();
						console.log(
							"ğŸ”® Smart-Chat2 åˆå©šå ±å‘Šå·²ä¿å­˜ï¼ŒID:",
							savedReport._id
						);

						// ğŸ¯ ä½¿ç”¨å ±å‘Š ID ç”Ÿæˆæ­£ç¢ºçš„ URL (èˆ‡ Smart-Chat ä¸€è‡´)
						reportUrl = `/zh-CN/couple-report?id=${savedReport._id}`;

						// ğŸ” Debug: é¡¯ç¤ºURLç”Ÿæˆä¿¡æ¯
						console.log("ğŸ”— ç”Ÿæˆçš„åˆå©šå ±å‘ŠURL:");
						console.log("   å ±å‘ŠID:", savedReport._id);
						console.log("   å®Œæ•´URL:", reportUrl);

						response = `âœ¨ å¤ªå¥½äº†ï¼ä½ çš„å°ˆå±¬${concernName}è©³ç´°å ±å‘Šå·²ç¶“æº–å‚™å¥½äº†ï¼\n\næ­£åœ¨ç‚ºä½ æ‰“é–‹å ±å‘Šé é¢...`;
					} catch (error) {
						console.error(
							"âŒ Smart-Chat2 ç”Ÿæˆåˆå©šå ±å‘Šå¤±æ•—:",
							error
						);
						response = `æŠ±æ­‰ï¼Œç”Ÿæˆå ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚`;
						reportUrl = null;
					}
				} else if (userIntent.userBirthday) {
					// å€‹äººåˆ†æè©³ç´°å ±å‘Š
					const params = new URLSearchParams({
						birthday: userIntent.userBirthday
							.toISOString()
							.split("T")[0],
						gender: "ç”·", // é»˜èªå€¼ï¼Œå¯ä»¥å¾ŒçºŒæ”¹é€²
						concern: concernName,
						// ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨åŸå§‹å…·é«”å•é¡Œ
						problem:
							userIntent.originalSpecificProblem ||
							userIntent.specificQuestion ||
							`${concernName}åˆ†æ`,
					});
					reportUrl = `/zh-CN/feng-shui-report?${params.toString()}`;

					response = `âœ¨ å¤ªå¥½äº†ï¼ä½ çš„å°ˆå±¬${concernName}è©³ç´°å ±å‘Šå·²ç¶“æº–å‚™å¥½äº†ï¼\n\næ­£åœ¨ç‚ºä½ æ‰“é–‹å ±å‘Šé é¢...`;
				} else {
					// ç¼ºå°‘ç”Ÿæ—¥è³‡æ–™ï¼Œè§¸ç™¼æ¨¡æ…‹æ¡†
					response = `âœ¨ å¤ªå¥½äº†ï¼æˆ‘å°‡ç‚ºä½ ç”Ÿæˆä¸€ä»½å°ˆæ¥­çš„${concernName}è©³ç´°å ±å‘Šã€‚

é€™ä»½å ±å‘Šå°‡åŒ…å«ï¼š
ğŸ¯ æ·±åº¦${concernName}åˆ†æ
ğŸ“ˆ å…·é«”æ”¹å–„å»ºè­°  
ğŸ”® æ™‚æ©ŸæŠŠæ¡æŒ‡å°
ğŸ  ç›¸é—œé¢¨æ°´èª¿æ•´

æ­£åœ¨æº–å‚™ä½ çš„å°ˆå±¬å ±å‘Š...`;
					shouldTriggerModal = true;
				}

				analysis = {
					isWithinScope: true,
					detectedTopic: concernName,
					specificProblem: `ç”¨æˆ¶é¸æ“‡è©³ç´°${concernName}å ±å‘Š`,
					confidence: 0.95,
					reportChoice: true,
				};

				return NextResponse.json({
					response,
					analysis,
					reportUrl,
					shouldTriggerModal,
					systemType: "smart-chat2",
				});
			}
		} else if (
			isChoiceInput &&
			userIntent?.primaryConcern &&
			userIntent?.conversationState !== "asking_detailed_report"
		) {
			// ğŸ”§ è™•ç†ç”¨æˆ¶é¸æ“‡å›æ‡‰ (1ï¸âƒ£2ï¸âƒ£ ç­‰ + æ–‡å­—é¸é …) - åƒ…ç•¶ä¸åœ¨è©¢å•è©³ç´°å ±å‘Šç‹€æ…‹
			let choice = message.match(/[12]/)?.[0];

			// ğŸ”§ è™•ç†æ–‡å­—é¸é …è½‰æ›ç‚ºæ•¸å­—
			if (!choice) {
				const textMessage = message.trim();
				if (/^(å€‹äººåˆ†æ|å€‹äººæ„Ÿæƒ…åˆ†æ|å€‹äºº)$/i.test(textMessage)) {
					choice = "1";
				} else if (
					/^(åˆå©šåˆ†æ|åˆå©šé…å°åˆ†æ|åˆå©š|é…å°)$/i.test(textMessage)
				) {
					choice = "2";
				}
			}

			if (userIntent.primaryConcern === "æ„Ÿæƒ…") {
				if (choice === "1") {
					// ğŸ”§ å®Œå…¨è¤‡è£½ smart-chat å€‹äººåˆ†æå›æ‡‰
					response = `å¥½ï¼æˆ‘æœƒç‚ºä½ é€²è¡Œå€‹äººæ„Ÿæƒ…åˆ†æ ğŸŒ¸

ç‚ºå’—æ›´æº–ç¢ºåˆ†æä½ å˜…æ„Ÿæƒ…é‹å‹¢ï¼Œæˆ‘éœ€è¦ä½ å˜…å‡ºç”Ÿæ—¥æœŸã€‚

è«‹æä¾›ï¼šå‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆä¾‹å¦‚ï¼š1990å¹´5æœˆ15æ—¥ï¼‰`;
					userIntent.relationshipAnalysisType = "individual";

					// ğŸ”§ æ–°å¢ï¼šä¿å­˜åŸå§‹å…·é«”å•é¡Œï¼Œå„ªå…ˆä½¿ç”¨ç”¨æˆ¶åŸå§‹è¨Šæ¯
					if (!userIntent.originalSpecificProblem) {
						userIntent.originalSpecificProblem =
							userIntent.originalUserMessage ||
							userIntent.specificQuestion;
						console.log(
							"ğŸ’¾ ä¿å­˜åŸå§‹å…·é«”å•é¡Œï¼ˆå€‹äººåˆ†æï¼‰:",
							userIntent.originalSpecificProblem
						);
					}

					// ğŸ” Debug: é¡¯ç¤ºç•¶å‰ç‹€æ…‹
					console.log("ğŸ“Š å€‹äººåˆ†æé¸æ“‡å¾Œçš„ç‹€æ…‹:");
					console.log(
						"   specificQuestion:",
						userIntent.specificQuestion
					);
					console.log(
						"   originalSpecificProblem:",
						userIntent.originalSpecificProblem
					);
				} else if (choice === "2") {
					// ğŸ”§ å®Œå…¨è¤‡è£½ smart-chat åˆå©šåˆ†æå›æ‡‰
					response = `ğŸ’• å¥½çš„ï¼ç‚ºäº†é€²è¡Œæº–ç¢ºçš„åˆå©šåˆ†æï¼Œæˆ‘éœ€è¦ä½ å€‘é›™æ–¹çš„ç”Ÿæ—¥è³‡æ–™ã€‚

è«‹å…ˆæä¾›**ä½ çš„ç”Ÿæ—¥**ï¼ˆå¹´æœˆæ—¥ï¼‰ï¼Œä¾‹å¦‚ï¼š1995å¹´3æœˆ15æ—¥

ğŸ’¡ å°è²¼å£«ï¼šä½ ä¹Ÿå¯ä»¥ä¸€æ¬¡æä¾›é›™æ–¹ç”Ÿæ—¥ï¼Œä¾‹å¦‚ï¼šã€Œæˆ‘1995/3/15ï¼Œå¥¹1996/8/20ã€`;
					userIntent.relationshipAnalysisType = "couple";

					// ğŸ”§ æ–°å¢ï¼šä¿å­˜åŸå§‹å…·é«”å•é¡Œï¼Œå„ªå…ˆä½¿ç”¨ç”¨æˆ¶åŸå§‹è¨Šæ¯
					if (!userIntent.originalSpecificProblem) {
						userIntent.originalSpecificProblem =
							userIntent.originalUserMessage ||
							userIntent.specificQuestion;
						console.log(
							"ğŸ’¾ ä¿å­˜åŸå§‹å…·é«”å•é¡Œï¼ˆåˆå©šåˆ†æï¼‰:",
							userIntent.originalSpecificProblem
						);
					}

					// ğŸ” Debug: é¡¯ç¤ºç•¶å‰ç‹€æ…‹
					console.log("ğŸ“Š åˆå©šåˆ†æé¸æ“‡å¾Œçš„ç‹€æ…‹:");
					console.log(
						"   specificQuestion:",
						userIntent.specificQuestion
					);
					console.log(
						"   originalSpecificProblem:",
						userIntent.originalSpecificProblem
					);
				}
			} else {
				// ğŸ”§ æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç¶“æä¾›éå…«å­—è³‡æ–™ - å¾ChatHistoryæŸ¥æ‰¾
				const chatHistory = await ChatHistory.findOne({
					$or: [
						{ conversationId: sessionId },
						{ sessionId: sessionId },
					],
				});

				const hasBaziAnalysis = chatHistory?.messages?.some(
					(msg) =>
						msg.role === "assistant" &&
						(msg.content.includes("å…«å­—") ||
							msg.content.includes("é¢¨éˆ´çœ‹äº†ä½ çš„å…«å­—") ||
							msg.content.includes("ğŸ”® **å…«å­—å‘½ç›¤**"))
				);

				console.log(
					`ğŸ” æª¢æŸ¥å…«å­—åˆ†æç‹€æ…‹: hasBaziAnalysis=${hasBaziAnalysis}, choice=${choice}`
				);

				if (hasBaziAnalysis) {
					// ç”¨æˆ¶å·²ç¶“åšéå…«å­—åˆ†æï¼Œç›´æ¥è§¸ç™¼æ¨¡æ…‹æ¡†
					console.log("âœ… ç”¨æˆ¶å·²æœ‰å…«å­—åˆ†æï¼Œè§¸ç™¼æ¨¡æ…‹æ¡†");
					if (choice === "1") {
						response = `å¥½çš„ï¼æˆ‘ä¾†ç‚ºä½ æº–å‚™è©³ç´°çš„${userIntent.primaryConcern}åˆ†æå ±å‘Š âœ¨

é€™ä»½å ±å‘Šå°‡åŒ…å«ï¼š
ğŸ¯ æ·±åº¦${userIntent.primaryConcern}åˆ†æ
ğŸ“ˆ å…·é«”æ”¹å–„å»ºè­°  
ğŸ”® æ™‚æ©ŸæŠŠæ¡æŒ‡å°
ğŸ  ç›¸é—œé¢¨æ°´èª¿æ•´

æ­£åœ¨æº–å‚™ä½ çš„å°ˆå±¬å ±å‘Š...`;
						shouldTriggerModal = true;
					} else if (choice === "2") {
						response = `å¥½çš„ï¼æˆ‘ä¾†ç‚ºä½ æº–å‚™ç¶œåˆå‘½ç†å ±å‘Š âœ¨

é€™ä»½å ±å‘Šå°‡åŒ…å«ï¼š
ğŸ¯ æ·±åº¦å…«å­—åˆ†æ
ğŸ“ˆ å„é ˜åŸŸé‹å‹¢é æ¸¬
ğŸ”® æ™‚æ©ŸæŠŠæ¡æŒ‡å°
ğŸ  é¢¨æ°´èª¿æ•´å»ºè­°

æ­£åœ¨æº–å‚™ä½ çš„å°ˆå±¬å ±å‘Š...`;
						shouldTriggerModal = true;
					}
				} else {
					// ç”¨æˆ¶å°šæœªæä¾›è³‡æ–™ï¼Œè¦æ±‚ç”Ÿæ—¥
					console.log("âŒ ç”¨æˆ¶å°šæœªæä¾›è³‡æ–™ï¼Œè¦æ±‚ç”Ÿæ—¥");
					response = `å¥½çš„ï¼å‘Šè¨´é¢¨éˆ´ä½ çš„ç”Ÿæ—¥ï¼Œæˆ‘ä¾†ç‚ºä½ åš${userIntent.primaryConcern}åˆ†æï¼š

ğŸ“… **ç”Ÿæ—¥æ ¼å¼ç¯„ä¾‹ï¼š**
â€¢ 1999-03-15
â€¢ 1999/3/15  
â€¢ 1999å¹´3æœˆ15æ—¥

é¢¨éˆ´æœƒå…ˆçµ¦ä½ ä¸€å€‹ç°¡å–®çš„åˆ†æï¼Œå¦‚æœä½ è¦ºå¾—æœ‰å¹«åŠ©ï¼Œé‚„å¯ä»¥åšæ›´è©³ç´°çš„å®Œæ•´å ±å‘Šå“¦ï½ğŸ’•`;
				}
			}

			analysis = {
				isWithinScope: true,
				detectedTopic: userIntent.primaryConcern,
				specificProblem: `ç”¨æˆ¶é¸æ“‡: ${userIntent.primaryConcern}åˆ†æé¸é …${choice}`,
				confidence: 0.9,
				choiceResponse: true,
			};

			// ğŸ”§ æ–°å¢ï¼šä¿å­˜userIntentçš„æ›´æ”¹ï¼ˆåŒ…æ‹¬originalSpecificProblemï¼‰
			await userIntent.save();
		} else if (userIntent?.conversationState === "asking_detailed_report") {
			// ğŸ”§ å„ªå…ˆæª¢æŸ¥æ˜¯å¦ç‚ºå ±å‘Šé¸æ“‡ (1, 2, 3)
			const reportChoice = message.trim();

			if (
				reportChoice === "1" ||
				reportChoice.includes("è©³ç´°å ±å‘Š") ||
				reportChoice.includes("ç¬¬ä¸€") ||
				reportChoice === "2" ||
				reportChoice.includes("ç¶œåˆ") ||
				reportChoice.includes("ç¬¬äºŒ") ||
				reportChoice === "3" ||
				reportChoice.includes("å±…å®¶") ||
				reportChoice.includes("ä½ˆå±€") ||
				reportChoice.includes("ç¬¬ä¸‰")
			) {
				console.log("ğŸ¯ æª¢æ¸¬åˆ°å ±å‘Šé¸æ“‡:", reportChoice);

				if (
					reportChoice === "1" ||
					reportChoice.includes("è©³ç´°å ±å‘Š") ||
					reportChoice.includes("ç¬¬ä¸€")
				) {
					// é¸æ“‡1ï¼šé—œæ³¨é ˜åŸŸè©³ç´°å ±å‘Š - ä½¿ç”¨ handleFortunePayment é‚è¼¯
					userIntent.reportType = "detailed_concern";
					const concernName = userIntent.primaryConcern || "é‹å‹¢";

					// ğŸ”§ ç°¡åŒ–é‚è¼¯ï¼šé»˜èªç‚ºå€‹äººåˆ†æï¼Œåªæœ‰åœ¨æ˜ç¢ºæœ‰ä¼´ä¾¶ç”Ÿæ—¥æ™‚æ‰åšåˆå©šåˆ†æ
					if (
						concernName === "æ„Ÿæƒ…" &&
						userIntent.relationshipAnalysisType === "couple" &&
						userIntent.partnerBirthday &&
						userIntent.userBirthday
					) {
						// æœ‰å®Œæ•´é›™æ–¹ç”Ÿæ—¥çš„åˆå©šåˆ†æ - ä»ä½¿ç”¨åˆå©šåˆ†æ
						shouldTriggerModal = true;
						userIntent.conversationState =
							"collecting_payment_info";
						response = `ğŸ’• å¤ªå¥½äº†ï¼æº–å‚™ç‚ºä½ å€‘è£½ä½œå°ˆå±¬çš„åˆå©šåˆ†æå ±å‘Šï¼

é€™ä»½å ±å‘Šå°‡åŒ…å«ï¼š
ğŸŒ¸ é›™æ–¹å…«å­—æ·±åº¦é…å°åˆ†æ
ğŸ’« æ„Ÿæƒ…ç™¼å±•è¶¨å‹¢é æ¸¬  
ğŸ”® é—œä¿‚å’Œè«§æ”¹å–„å»ºè­°
ğŸ  å¢é€²æ„Ÿæƒ…çš„é¢¨æ°´ä½ˆå±€

è«‹å¡«å¯«ä»˜æ¬¾è³‡è¨Šï¼Œæˆ‘å€‘ç«‹å³é–‹å§‹è£½ä½œä½ å€‘çš„å°ˆå±¬å ±å‘Šï½`;

						// ğŸ”§ ä¿è­·åŸå§‹å•é¡Œï¼šä¿æŒç”¨æˆ¶æœ€åˆçš„å…·é«”å•é¡Œè€Œä¸æ˜¯è¦†è“‹ç‚ºé¸æ“‡å ±å‘Š
						analysis = {
							isWithinScope: true,
							detectedTopic: "æ„Ÿæƒ…",
							specificProblem:
								userIntent.originalSpecificProblem ||
								"ç”¨æˆ¶é¸æ“‡åˆå©šè©³ç´°å ±å‘Š",
							confidence: 0.95,
							reportChoice: true,
							paymentType: "couple", // ğŸ”¥ ä¿®æ”¹ï¼šåˆå©šåˆ†æä½¿ç”¨ couple payment API
						};

						console.log("ğŸ”’ åˆå©šå ±å‘Šé¸æ“‡æ™‚ä¿è­·åŸå§‹å•é¡Œ:");
						console.log(
							"   originalSpecificProblem:",
							userIntent.originalSpecificProblem
						);
						console.log(
							"   åˆ†æä¸­çš„ specificProblem:",
							analysis.specificProblem
						);
					} else {
						// ğŸ”¥ æ‰€æœ‰å…¶ä»–æƒ…æ³éƒ½åšå€‹äººåˆ†æå ±å‘Š - ä½¿ç”¨ handleFortunePayment é‚è¼¯
						shouldTriggerModal = true;
						userIntent.conversationState =
							"collecting_payment_info";

						// ğŸ”§ æ™ºèƒ½æ¨æ–·å¯¦éš›é—œæ³¨é ˜åŸŸ
						let actualConcern = concernName;
						if (userIntent.originalSpecificProblem) {
							const originalProblem =
								userIntent.originalSpecificProblem.toLowerCase();
							if (
								originalProblem.includes("è²¡é‹") ||
								originalProblem.includes("è³ºéŒ¢") ||
								originalProblem.includes("æŠ•è³‡") ||
								originalProblem.includes("ç†è²¡")
							) {
								actualConcern = "è²¡é‹";
							} else if (
								originalProblem.includes("å·¥ä½œ") ||
								originalProblem.includes("äº‹æ¥­") ||
								originalProblem.includes("è·æ¥­") ||
								originalProblem.includes("å‡è·")
							) {
								actualConcern = "å·¥ä½œ";
							} else if (
								originalProblem.includes("å¥åº·") ||
								originalProblem.includes("èº«é«”") ||
								originalProblem.includes("é¤Šç”Ÿ")
							) {
								actualConcern = "å¥åº·";
							} else if (
								originalProblem.includes("äººéš›") ||
								originalProblem.includes("æœ‹å‹") ||
								originalProblem.includes("è²´äºº")
							) {
								actualConcern = "æ„Ÿæƒ…";
							} else if (
								originalProblem.includes("å­å¥³") ||
								originalProblem.includes("å­©å­") ||
								originalProblem.includes("æ•™è‚²")
							) {
								actualConcern = "å­å¥³";
							}
						}

						response = `ğŸŒŸ å¤ªæ£’äº†ï¼æº–å‚™ç‚ºä½ è£½ä½œå°ˆå±¬çš„${actualConcern}è©³ç´°åˆ†æå ±å‘Šï¼

é€™ä»½å ±å‘Šå°‡åŒ…å«ï¼š
ğŸ”® æ·±å…¥çš„å€‹äºº${actualConcern}åˆ†æ
ğŸ“ˆ æœªä¾†é‹å‹¢è¶¨å‹¢é æ¸¬
ğŸ’¡ å…·é«”æ”¹å–„å»ºè­°å’Œæ–¹æ¡ˆ
ğŸ  å°ˆå±¬é¢¨æ°´ä½ˆå±€å»ºè­°

è«‹å¡«å¯«å€‹äººè³‡æ–™ï¼Œæˆ‘å€‘ç«‹å³é–‹å§‹è£½ä½œä½ çš„å°ˆå±¬å ±å‘Šï½`;

						// ğŸ”§ ä¿è­·åŸå§‹å•é¡Œï¼šä½¿ç”¨ç”¨æˆ¶æœ€åˆçš„å…·é«”å•é¡Œè€Œä¸æ˜¯è¦†è“‹ç‚ºé¸æ“‡å ±å‘Š
						analysis = {
							isWithinScope: true,
							detectedTopic: actualConcern,
							specificProblem:
								userIntent.originalSpecificProblem ||
								`ç”¨æˆ¶é¸æ“‡${actualConcern}è©³ç´°å ±å‘Š`,
							confidence: 0.95,
							reportChoice: true,
							paymentType: "fortune", // ğŸ”¥ æ–°å¢ï¼šé¸æ“‡1ä½¿ç”¨ handleFortunePayment é‚è¼¯ (regional pricing)
						};

						console.log("ğŸ”’ å ±å‘Šé¸æ“‡æ™‚ä¿è­·åŸå§‹å•é¡Œ:");
						console.log(
							"   originalSpecificProblem:",
							userIntent.originalSpecificProblem
						);
						console.log(
							"   åˆ†æä¸­çš„ specificProblem:",
							analysis.specificProblem
						);
					}
				} else if (
					reportChoice === "2" ||
					reportChoice.includes("ç¶œåˆ") ||
					reportChoice.includes("ç¬¬äºŒ")
				) {
					// ğŸ”§ æª¢æŸ¥æ˜¯å¦ç‚ºåˆå©šåˆ†ææƒ…å¢ƒ
					if (
						userIntent.relationshipAnalysisType === "couple" &&
						userIntent.partnerBirthday &&
						userIntent.userBirthday
					) {
						// åˆå©šæƒ…å¢ƒä¸‹çš„é¸æ“‡2ï¼šç¶œåˆå‘½ç†å ±å‘Š
						userIntent.reportType = "comprehensive";
						userIntent.conversationState =
							"collecting_payment_info";
						shouldTriggerModal = true;

						response = `ğŸ”® å¾ˆæ£’çš„é¸æ“‡ï¼ç‚ºä½ è£½ä½œç¶œåˆå‘½ç†å ±å‘Šï¼

é€™ä»½å ±å‘Šå°‡åŒ…å«ï¼š
ğŸ“Š å…¨é¢çš„å…«å­—å‘½ç›¤åˆ†æï¼ŒåŒ…å«å„æ–¹é¢é‹å‹¢é æ¸¬
ğŸŒŸ æµå¹´å¤§é‹èµ°å‹¢åˆ†æ
ğŸ¯ äººéš›é—œä¿‚å’Œäº‹æ¥­ç™¼å±•å»ºè­°

è«‹å¡«å¯«ä»˜æ¬¾è³‡è¨Šï¼Œæˆ‘å€‘ç«‹å³é–‹å§‹è£½ä½œä½ çš„å°ˆå±¬å ±å‘Šï½`;

						analysis = {
							isWithinScope: true,
							detectedTopic: "ç¶œåˆé‹å‹¢",
							specificProblem: "ç”¨æˆ¶é¸æ“‡ç¶œåˆå‘½ç†å ±å‘Š",
							confidence: 0.95,
							reportChoice: true,
							paymentType: "comprehensive", // ä½¿ç”¨ç¶œåˆå ±å‘Šä»˜æ¬¾API
						};
					} else {
						// éåˆå©šæƒ…å¢ƒçš„é¸æ“‡2ï¼šç¶œåˆå‘½ç†å ±å‘Š
						userIntent.reportType = "comprehensive";
						userIntent.conversationState =
							"collecting_payment_info";
						shouldTriggerModal = true;

						response = `ğŸ”® å¾ˆæ£’çš„é¸æ“‡ï¼ç¶œåˆå‘½ç†å ±å‘Šæ˜¯æœ€å…¨é¢çš„åˆ†æï¼

é€™ä»½å ±å‘Šå°‡åŒ…å«ï¼š
ğŸ“Š å®Œæ•´å…«å­—å‘½ç›¤è§£æ
ğŸŒŸ å„é ˜åŸŸé‹å‹¢é æ¸¬ï¼ˆæ„Ÿæƒ…ã€å·¥ä½œã€è²¡é‹ã€å¥åº·ç­‰ï¼‰
ğŸ¯ äººç”Ÿé‡è¦æ™‚æ©ŸæŠŠæ¡
ğŸ  å…¨æ–¹ä½é¢¨æ°´ä½ˆå±€å»ºè­°

è«‹å¡«å¯«å€‹äººè³‡æ–™ï¼Œæº–å‚™è£½ä½œä½ çš„å°ˆå±¬ç¶œåˆå‘½ç†å ±å‘Šï½`;

						analysis = {
							isWithinScope: true,
							detectedTopic: "ç¶œåˆé‹å‹¢",
							specificProblem: "ç”¨æˆ¶é¸æ“‡ç¶œåˆå‘½ç†å ±å‘Š",
							confidence: 0.95,
							reportChoice: true,
							paymentType: "comprehensive", // ğŸ”¥ æ–°å¢ï¼šæ¨™è¨˜ä½¿ç”¨ couple payment API
						};
					}
				} else if (
					reportChoice === "3" ||
					reportChoice.includes("å±…å®¶") ||
					reportChoice.includes("ä½ˆå±€") ||
					reportChoice.includes("ç¬¬ä¸‰")
				) {
					// é¸æ“‡3ï¼šå±…å®¶ä½ˆå±€å ±å‘Š
					userIntent.reportType = "home_layout";
					userIntent.conversationState = "collecting_payment_info";
					shouldTriggerModal = true;

					response = `ğŸ  å¾ˆæ£’çš„é¸æ“‡ï¼å±…å®¶ä½ˆå±€å°é‹å‹¢æå‡éå¸¸é‡è¦ã€‚

æˆ‘å°‡ç‚ºä½ å®¢è£½åŒ–ä¸€ä»½å±…å®¶é¢¨æ°´ä½ˆå±€æ–¹æ¡ˆï¼ŒåŒ…å«ï¼š
ğŸ¨ ç©ºé–“é…è‰²å»ºè­°
ğŸ“ å®¶å…·æ“ºæ”¾æŒ‡å°  
ğŸŒ¿ æ¤ç‰©æ“ºè¨­æ–¹æ¡ˆ
ğŸ’ æ‹›è²¡é–‹é‹ä½ˆå±€

è«‹å¡«å¯«å€‹äººè³‡æ–™ï¼Œæˆ‘å€‘é–‹å§‹è£½ä½œä½ çš„å°ˆå±¬ä½ˆå±€æ–¹æ¡ˆï½`;

					analysis = {
						isWithinScope: true,
						detectedTopic: "å±…å®¶ä½ˆå±€",
						specificProblem: "ç”¨æˆ¶é¸æ“‡å±…å®¶ä½ˆå±€å ±å‘Š",
						confidence: 0.95,
						reportChoice: true,
						paymentType: "premium", // ğŸ”¥ æ–°å¢ï¼šæ¨™è¨˜ä½¿ç”¨ premium payment API (payment2)
					};
				}

				// ç›´æ¥è¿”å›çµæœï¼Œä¸é€²è¡Œå…¶ä»–è™•ç†
				return NextResponse.json({
					response: response,
					aiAnalysis: analysis,
					conversationState: userIntent.conversationState,
					systemType: "smart-chat2",
					timestamp: new Date().toISOString(),
					concern:
						userIntent?.primaryConcern || analysis?.detectedTopic,
					emotion: "hopeful",
					shouldTriggerModal: shouldTriggerModal,
					paymentType: analysis?.paymentType, // ğŸ”¥ æ–°å¢ï¼šå‚³éä»˜æ¬¾é¡å‹
					reportUrl: null,
					needsBirthday: false,
					specificQuestion: analysis?.specificProblem,
					// ğŸ”¥ æ·»åŠ  specificProblem åˆ°æ—©æœŸè¿”å›å›æ‡‰ä¸­
					specificProblem:
						analysis?.specificProblem ||
						userIntent?.specificQuestion ||
						message,
					relationshipAnalysisType:
						userIntent?.relationshipAnalysisType,
					isCoupleAnalysis:
						userIntent?.relationshipAnalysisType === "couple",
				});
			}

			// ğŸ”§ å„ªå…ˆæª¢æŸ¥æ ¸å¿ƒä¸»é¡Œåˆ‡æ› - åœ¨enhanced analyzerä¹‹å‰
			const coreTopics = [
				"æ„Ÿæƒ…",
				"è²¡é‹",
				"å·¥ä½œ",
				"å¥åº·",
				"å­å¥³",
				"é¢¨æ°´ä½ˆå±€",
				"å±…å®¶ä½ˆå±€",
			];

			// é¦–å…ˆå˜—è©¦ç›´æ¥é—œéµè©åŒ¹é…ï¼ˆæ›´å¯é ï¼‰
			let detectedTopic = null;
			const topicKeywords = {
				æ„Ÿæƒ…: [
					"æ„Ÿæƒ…",
					"æ„›æƒ…",
					"æˆ€æ„›",
					"æ¡ƒèŠ±",
					"åˆ†æ‰‹",
					"å¾©åˆ",
					"å©šå§»",
					"å–®èº«",
				],
				å·¥ä½œ: [
					"å·¥ä½œ",
					"äº‹æ¥­",
					"è·å ´",
					"å‡è·",
					"è·³æ§½",
					"ç”Ÿæ„",
					"ç¶“ç‡Ÿ",
					"å‰µæ¥­",
				],
				è²¡é‹: ["è²¡é‹", "è²¡å¯Œ", "è³ºéŒ¢", "æŠ•è³‡", "ç†è²¡", "æ”¶å…¥", "é‡‘éŒ¢"],
				å¥åº·: [
					"å¥åº·",
					"èº«é«”",
					"ç–¾ç—…",
					"é¤Šç”Ÿ",
					"èª¿ç†",
					"ç™Œç—‡",
					"ç—…",
					"ç”Ÿç—…",
					"æ‰‹è¡“",
					"é†«ç”Ÿ",
					"é†«é™¢",
					"æ²»ç™‚",
				],
			};

			// ç›´æ¥é—œéµè©æª¢æ¸¬
			for (const [topic, keywords] of Object.entries(topicKeywords)) {
				if (keywords.some((keyword) => message.includes(keyword))) {
					detectedTopic = topic;
					console.log(
						"ğŸ¯ åœ¨å ±å‘Šé¸æ“‡ç‹€æ…‹ä¸‹ç›´æ¥æª¢æ¸¬åˆ°ä¸»é¡Œåˆ‡æ›:",
						detectedTopic
					);
					break;
				}
			}

			// å¦‚æœæª¢æ¸¬åˆ°æ ¸å¿ƒä¸»é¡Œï¼ŒåŸ·è¡Œåˆ‡æ›
			if (detectedTopic && coreTopics.includes(detectedTopic)) {
				console.log(
					"ğŸ”„ åœ¨å ±å‘Šé¸æ“‡ç‹€æ…‹ä¸‹åŸ·è¡Œæ ¸å¿ƒä¸»é¡Œåˆ‡æ›:",
					detectedTopic
				);

				// ğŸ”§ ç„¡è«–æ˜¯é—œéµè©é‚„æ˜¯AIæª¢æ¸¬åˆ°çš„ä¸»é¡Œï¼Œéƒ½ä½¿ç”¨AIåˆ†æç²å–å…·é«”å•é¡Œ
				let specificProblem = `${detectedTopic}åˆ†æ`;
				let confidence = 1.0;
				let analysisType = "topic_switch";
				let aiResponse = "";

				try {
					console.log("ğŸ¤– ä½¿ç”¨AIåˆ†æç²å–å…·é«”å•é¡Œæè¿°");
					const classifier = new AITopicClassifier();
					const aiAnalysis = await classifier.analyzeMessage(
						message,
						sessionId
					);

					if (aiAnalysis && aiAnalysis.specificProblem) {
						specificProblem = aiAnalysis.specificProblem;
						confidence = aiAnalysis.confidence || 0.9;
						analysisType = "keyword_topic_with_ai_problem";
						aiResponse = aiAnalysis.aiResponse || "";
						console.log(
							"âœ… AIåˆ†æç²å–åˆ°å…·é«”å•é¡Œ:",
							specificProblem
						);
					} else {
						console.log("âš ï¸ AIåˆ†ææœªç²å–åˆ°å…·é«”å•é¡Œï¼Œä½¿ç”¨é»˜èªæè¿°");
					}
				} catch (error) {
					console.error("âŒ AIåˆ†æå…·é«”å•é¡Œå¤±æ•—:", error);
				}

				// çµ„åˆAIå›æ‡‰å’Œä¸»é¡Œåˆ‡æ›è¨Šæ¯
				let combinedResponse = "";
				if (aiResponse && aiResponse.trim()) {
					combinedResponse = `${aiResponse}\n\nğŸ’« å·²ç‚ºæ‚¨åˆ‡æ›åˆ°${detectedTopic}åˆ†æï¼è«‹æä¾›æ‚¨çš„å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆä¾‹å¦‚ï¼š1990å¹´5æœˆ15æ—¥ï¼‰ï¼Œæˆ‘å°‡ç‚ºæ‚¨é€²è¡Œå°ˆæ¥­çš„å‘½ç†åˆ†æã€‚âœ¨`;
				} else {
					combinedResponse = `ğŸ’« å·²ç‚ºæ‚¨åˆ‡æ›åˆ°${detectedTopic}åˆ†æï¼è«‹æä¾›æ‚¨çš„å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆä¾‹å¦‚ï¼š1990å¹´5æœˆ15æ—¥ï¼‰ï¼Œæˆ‘å°‡ç‚ºæ‚¨é€²è¡Œå°ˆæ¥­çš„å‘½ç†åˆ†æã€‚âœ¨`;
				}

				// é‡ç½®æœƒè©±ç‹€æ…‹ä¸¦æ›´æ–°ä¸»è¦é—œæ³¨é»
				userIntent.primaryConcern = detectedTopic;
				userIntent.conversationState = "birthday_collection";
				userIntent.reportType = null;

				// æ›´æ–°è³‡æ–™åº«ç‹€æ…‹
				await userIntent.save();

				return NextResponse.json({
					response: combinedResponse,
					conversationState: "birthday_collection",
					systemType: "smart-chat2",
					timestamp: new Date().toISOString(),
					concern: detectedTopic,
					needsBirthday: true,
					specificQuestion: specificProblem,
					aiAnalysis: {
						detectedTopic: detectedTopic,
						isWithinScope: true,
						confidence: confidence,
						analysisType: analysisType,
						specificProblem: specificProblem,
					},
				});
			}

			// ğŸ”§ å¦‚æœé—œéµè©åŒ¹é…å¤±æ•—ï¼Œä½¿ç”¨AIåˆ†ææª¢æ¸¬æ˜¯å¦ç‚ºä¸»é¡Œåˆ‡æ›
			if (!detectedTopic) {
				console.log("ğŸ¤– é—œéµè©åŒ¹é…å¤±æ•—ï¼Œä½¿ç”¨AIåˆ†ææª¢æ¸¬ä¸»é¡Œåˆ‡æ›");
				try {
					const classifier = new AITopicClassifier();
					const aiTopicAnalysis = await classifier.analyzeMessage(
						message,
						sessionId
					);

					if (
						aiTopicAnalysis &&
						aiTopicAnalysis.isWithinScope &&
						aiTopicAnalysis.detectedTopic &&
						aiTopicAnalysis.detectedTopic !== "å…¶ä»–" &&
						coreTopics.includes(aiTopicAnalysis.detectedTopic)
					) {
						console.log(
							"ğŸ¯ AIæª¢æ¸¬åˆ°æ ¸å¿ƒä¸»é¡Œåˆ‡æ›:",
							aiTopicAnalysis.detectedTopic
						);

						// çµ„åˆAIå›æ‡‰å’Œä¸»é¡Œåˆ‡æ›è¨Šæ¯
						let combinedResponse = "";
						if (
							aiTopicAnalysis.aiResponse &&
							aiTopicAnalysis.aiResponse.trim()
						) {
							combinedResponse = `${aiTopicAnalysis.aiResponse}\n\nğŸ’« å·²ç‚ºæ‚¨åˆ‡æ›åˆ°${aiTopicAnalysis.detectedTopic}åˆ†æï¼è«‹æä¾›æ‚¨çš„å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆä¾‹å¦‚ï¼š1990å¹´5æœˆ15æ—¥ï¼‰ï¼Œæˆ‘å°‡ç‚ºæ‚¨é€²è¡Œå°ˆæ¥­çš„å‘½ç†åˆ†æã€‚âœ¨`;
						} else {
							combinedResponse = `ğŸ’« å·²ç‚ºæ‚¨åˆ‡æ›åˆ°${aiTopicAnalysis.detectedTopic}åˆ†æï¼è«‹æä¾›æ‚¨çš„å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆä¾‹å¦‚ï¼š1990å¹´5æœˆ15æ—¥ï¼‰ï¼Œæˆ‘å°‡ç‚ºæ‚¨é€²è¡Œå°ˆæ¥­çš„å‘½ç†åˆ†æã€‚âœ¨`;
						}

						// é‡ç½®æœƒè©±ç‹€æ…‹ä¸¦æ›´æ–°ä¸»è¦é—œæ³¨é»
						userIntent.primaryConcern =
							aiTopicAnalysis.detectedTopic;
						userIntent.conversationState = "birthday_collection";
						userIntent.reportType = null;

						// æ›´æ–°è³‡æ–™åº«ç‹€æ…‹
						await userIntent.save();

						return NextResponse.json({
							response: combinedResponse,
							conversationState: "birthday_collection",
							systemType: "smart-chat2",
							timestamp: new Date().toISOString(),
							concern: aiTopicAnalysis.detectedTopic,
							needsBirthday: true,
							specificQuestion:
								aiTopicAnalysis.specificProblem ||
								`${aiTopicAnalysis.detectedTopic}åˆ†æ`,
							aiAnalysis: {
								detectedTopic: aiTopicAnalysis.detectedTopic,
								isWithinScope: true,
								confidence: aiTopicAnalysis.confidence || 0.9,
								analysisType: "ai_topic_switch",
								specificProblem:
									aiTopicAnalysis.specificProblem,
							},
						});
					}
				} catch (error) {
					console.error("âŒ AIä¸»é¡Œåˆ‡æ›æª¢æ¸¬å¤±æ•—:", error);
				}
			}

			// ğŸ”§ å¦‚æœä¸æ˜¯æ ¸å¿ƒä¸»é¡Œåˆ‡æ›ï¼Œæ‰ä½¿ç”¨enhanced analyzer
			try {
				const EnhancedMessageAnalyzer = require("../../../lib/enhancedMessageAnalyzer.js");
				const enhancedAnalyzer = new EnhancedMessageAnalyzer();
				const enhancedResult =
					await enhancedAnalyzer.analyzeMessage(message);

				if (
					enhancedResult.isEnhanced &&
					enhancedResult.analysisType === "greeting"
				) {
					console.log(
						"ğŸ§  åœ¨å ±å‘Šé¸æ“‡ç‹€æ…‹ä¸‹æª¢æ¸¬åˆ°å•å€™èªï¼Œæä¾›å‹å–„å›æ‡‰"
					);

					return NextResponse.json({
						response: enhancedResult.response,
						aiAnalysis: enhancedResult,
						conversationState: "asking_detailed_report",
						systemType: "smart-chat2",
						timestamp: new Date().toISOString(),
						concern: userIntent?.primaryConcern || "ä¸€èˆ¬",
						emotion: "positive",
						shouldTriggerModal: false,
						reportUrl: null,
						needsBirthday: false,
						specificQuestion: "å•å€™èª",
						isCoupleAnalysis: false,
					});
				}

				// ğŸ”§ æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºæœå‹™è«®è©¢ï¼Œå„ªå…ˆè™•ç†
				if (
					enhancedResult.isEnhanced &&
					enhancedResult.analysisType === "service_explanation"
				) {
					console.log(
						"ğŸ§  åœ¨å ±å‘Šé¸æ“‡ç‹€æ…‹ä¸‹æª¢æ¸¬åˆ°æœå‹™è«®è©¢ï¼Œæä¾›æœå‹™èªªæ˜"
					);

					return NextResponse.json({
						response: enhancedResult.response,
						aiAnalysis: enhancedResult,
						conversationState: userIntent.conversationState,
						systemType: "smart-chat2",
						timestamp: new Date().toISOString(),
						concern: userIntent?.primaryConcern || "æœå‹™è«®è©¢",
						emotion: "positive",
						shouldTriggerModal: false,
						reportUrl: null,
						needsBirthday: false,
						specificQuestion: "æœå‹™è«®è©¢",
						isCoupleAnalysis: false,
					});
				}

				// ğŸ”§ æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºéé¢¨æ°´å‘½ç†è©±é¡Œï¼Œæä¾›å‹•æ…‹AIå›æ‡‰
				if (
					enhancedResult.requiresAIAnalysis ||
					(!enhancedResult.isEnhanced &&
						enhancedResult.analysisType === "general_ai")
				) {
					console.log(
						"ğŸ§  åœ¨å ±å‘Šé¸æ“‡ç‹€æ…‹ä¸‹æª¢æ¸¬åˆ°éæ ¸å¿ƒè©±é¡Œï¼Œä½¿ç”¨AIåˆ†æ"
					);

					// ä½¿ç”¨ AI Topic Classifier é€²è¡Œåˆ†æ
					const classifier = new AITopicClassifier();
					let topicAnalysis = await classifier.analyzeMessage(
						message,
						sessionId
					);

					// å¦‚æœ AI åˆ†æå¤±æ•—ï¼Œä½¿ç”¨ fallback
					if (!topicAnalysis || !topicAnalysis.detectedTopic) {
						topicAnalysis = classifier.getFallbackAnalysis(message);
					}

					// å¦‚æœæª¢æ¸¬åˆ°éæ ¸å¿ƒè©±é¡Œï¼Œæä¾›å‹•æ…‹å›æ‡‰
					if (
						!topicAnalysis.isWithinScope ||
						topicAnalysis.detectedTopic === "å…¶ä»–"
					) {
						console.log(
							"âœ… åœ¨å ±å‘Šé¸æ“‡ç‹€æ…‹ä¸‹æª¢æ¸¬åˆ°å…¶ä»–è©±é¡Œï¼Œæä¾›AIå‹•æ…‹å›æ‡‰"
						);

						const aiResponse =
							await classifier.generateOutOfScopeResponse(
								topicAnalysis,
								message
							);

						return NextResponse.json({
							response: aiResponse,
							aiAnalysis: topicAnalysis,
							conversationState: userIntent.conversationState,
							systemType: "smart-chat2",
							timestamp: new Date().toISOString(),
							concern: userIntent?.primaryConcern || "å…¶ä»–",
							emotion: "neutral",
							shouldTriggerModal: false,
							reportUrl: null,
							needsBirthday: false,
							specificQuestion: message,
							isCoupleAnalysis: false,
						});
					}
				}

				if (
					enhancedResult.isEnhanced &&
					enhancedResult.analysisType === "knowledge_explanation"
				) {
					console.log("ğŸ§  åœ¨å ±å‘Šé¸æ“‡ç‹€æ…‹ä¸‹æª¢æ¸¬åˆ°çŸ¥è­˜è©¢å•ï¼Œå„ªå…ˆè™•ç†");

					// ç”ŸæˆAIå›æ‡‰
					const classifier = new AITopicClassifier();
					const knowledgePrompt = `ç”¨æˆ¶è©¢å•ï¼š${message}

è«‹ä½œç‚ºå°ˆæ¥­çš„é¢¨æ°´å‘½ç†è€å¸«ï¼Œç”¨ä¸è¶…é200å­—ç°¡æ½”å°ˆæ¥­åœ°è§£é‡‹é€™å€‹æ¦‚å¿µã€‚è¦æ±‚ï¼š
1. è§£é‡‹æ¸…æ¥šæ˜“æ‡‚
2. çªå‡ºå¯¦éš›æ‡‰ç”¨åƒ¹å€¼  
3. ä¿æŒå°ˆæ¥­æ¬Šå¨æ€§
4. èªæ°£è¦ªåˆ‡è‡ªç„¶
5. æœ€å¾Œå¯ä»¥æåŠå¦‚æœæƒ³äº†è§£å€‹äººç‹€æ³å¯ä»¥æä¾›ç”Ÿæ—¥åšåˆ†æ

è«‹ç›´æ¥çµ¦å‡ºè§£é‡‹ï¼Œä¸è¦èªª"æˆ‘ä¾†è§£é‡‹"ä¹‹é¡çš„é–‹å ´ç™½ã€‚`;

					response = await classifier.callDeepSeekAPI([
						{
							role: "system",
							content:
								"ä½ æ˜¯å°ˆæ¥­çš„é¢¨æ°´å‘½ç†é¡§å•ï¼Œæ“…é•·ç”¨ç°¡æ½”æ˜“æ‡‚çš„æ–¹å¼è§£é‡‹å‚³çµ±æ¦‚å¿µã€‚é‡è¦æŒ‡ç¤ºï¼š1. å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ 2. æ‰€æœ‰æ—¥æœŸå’Œæœˆä»½éƒ½å¿…é ˆä½¿ç”¨æ–°æ­·ï¼ˆè¥¿æ›†/å…¬æ›†ï¼‰ï¼Œä¾‹å¦‚1æœˆã€2æœˆã€3æœˆç­‰ï¼Œä¸è¦ä½¿ç”¨è¾²æ­· 3. ä¸è¦åœ¨å›æ‡‰ä¸­åŒ…å«å­—æ•¸çµ±è¨ˆæ¨™è¨˜ 4. ä¿æŒå°ˆæ¥­ä¸”è¦ªåˆ‡çš„èªæ°£",
						},
						{
							role: "user",
							content: knowledgePrompt,
						},
					]);

					// ğŸ”§ æå–AIå›æ‡‰å…§å®¹
					if (
						response &&
						response.choices &&
						response.choices[0] &&
						response.choices[0].message
					) {
						response = response.choices[0].message.content;
					}

					analysis = enhancedResult;
				} else if (
					enhancedResult.isEnhanced &&
					enhancedResult.detectedTopic === "å…¶ä»–"
				) {
					console.log(
						"ğŸ”§ åœ¨å ±å‘Šé¸æ“‡ç‹€æ…‹ä¸‹æª¢æ¸¬åˆ°å…¶ä»–è©±é¡Œï¼Œé‡ç½®ç‹€æ…‹ä¸¦è™•ç†"
					);
					// é‡ç½®æœƒè©±ç‹€æ…‹ï¼Œè®“å…¶ä»–è©±é¡Œèƒ½å¤ æ­£å¸¸è™•ç†
					userIntent.conversationState = "ai_analyzing";
					throw new Error("Reset state for other topics");
				} else if (
					enhancedResult.isEnhanced &&
					enhancedResult.analysisType === "emotional_support"
				) {
					console.log(
						"ğŸ’™ åœ¨å ±å‘Šé¸æ“‡ç‹€æ…‹ä¸‹æª¢æ¸¬åˆ°æƒ…ç·’å±æ©Ÿï¼Œå„ªå…ˆæä¾›æ”¯æŒ"
					);
					response = enhancedResult.response;
					analysis = enhancedResult;
				} else {
					// ä¸æ˜¯çŸ¥è­˜è©¢å•ï¼Œç¹¼çºŒè™•ç†å ±å‘Šé¸æ“‡
					throw new Error(
						"Not a knowledge query, continue with report choice"
					);
				}
			} catch (enhanceError) {
				// ğŸ”§ è™•ç†è©³ç´°å ±å‘Šé¸æ“‡ (1, 2, 3)
				const reportChoice = message.trim();

				if (
					reportChoice === "1" ||
					reportChoice.includes("è©³ç´°å ±å‘Š") ||
					reportChoice.includes("ç¬¬ä¸€")
				) {
					// é¸æ“‡1ï¼šé—œæ³¨é ˜åŸŸè©³ç´°å ±å‘Š - ä½¿ç”¨ handleFortunePayment é‚è¼¯
					userIntent.reportType = "detailed_concern";

					const concernName = userIntent.primaryConcern || "é‹å‹¢";

					// ğŸ”§ æª¢æŸ¥æ˜¯å¦ç‚ºåˆå©šåˆ†æï¼Œéœ€è¦ç‰¹æ®Šè™•ç†
					if (
						userIntent.relationshipAnalysisType === "couple" &&
						userIntent.primaryConcern === "æ„Ÿæƒ…"
					) {
						// åˆå©šåˆ†æéœ€è¦å…©å€‹ç”Ÿæ—¥
						if (
							userIntent.userBirthday &&
							userIntent.partnerBirthday
						) {
							shouldTriggerModal = true;
							userIntent.conversationState =
								"collecting_payment_info";
							console.log(
								"âœ… åˆå©šåˆ†æ - ç”¨æˆ¶åŒæ„è©³ç´°å ±å‘Šï¼Œå·²æœ‰å…©å€‹ç”Ÿæ—¥ï¼Œè§¸ç™¼æ¨¡æ…‹æ¡†"
							);
						} else {
							// ç¼ºå°‘ç”Ÿæ—¥è³‡æ–™ï¼Œéœ€è¦é‡æ–°æ”¶é›†
							userIntent.conversationState =
								"birthday_collection";
							response = `ğŸ’• å¥½çš„ï¼ç‚ºäº†é€²è¡Œæº–ç¢ºçš„åˆå©šåˆ†æï¼Œæˆ‘éœ€è¦ä½ å€‘é›™æ–¹çš„ç”Ÿæ—¥è³‡æ–™ã€‚
                        
è«‹å…ˆæä¾›**ä½ çš„ç”Ÿæ—¥**ï¼ˆå¹´æœˆæ—¥ï¼‰ï¼Œä¾‹å¦‚ï¼š1995å¹´3æœˆ15æ—¥

ğŸ’¡ å°è²¼å£«ï¼šä½ ä¹Ÿå¯ä»¥ä¸€æ¬¡æä¾›é›™æ–¹ç”Ÿæ—¥ï¼Œä¾‹å¦‚ï¼šã€Œæˆ‘1995/3/15ï¼Œå¥¹1996/8/20ã€`;
							console.log("âš ï¸ åˆå©šåˆ†æ - ç¼ºå°‘ç”Ÿæ—¥è³‡æ–™ï¼Œé‡æ–°æ”¶é›†");
						}
					} else {
						// å€‹äººåˆ†ææˆ–å…¶ä»–åˆ†æ
						shouldTriggerModal = true;
						userIntent.conversationState =
							"collecting_payment_info";
					}

					if (shouldTriggerModal) {
						response = `âœ¨ å¤ªå¥½äº†ï¼æˆ‘å°‡ç‚ºä½ ç”Ÿæˆä¸€ä»½å°ˆæ¥­çš„${concernName}è©³ç´°å ±å‘Šã€‚

é€™ä»½å ±å‘Šå°‡åŒ…å«ï¼š
ğŸ¯ æ·±åº¦${concernName}åˆ†æ
ğŸ“ˆ å…·é«”æ”¹å–„å»ºè­°  
ğŸ”® æ™‚æ©ŸæŠŠæ¡æŒ‡å°
ğŸ  ç›¸é—œé¢¨æ°´èª¿æ•´

æ­£åœ¨æº–å‚™ä½ çš„å°ˆå±¬å ±å‘Š...`;
					}

					analysis = {
						isWithinScope: true,
						detectedTopic: concernName,
						// ğŸ”§ FIX: ä½¿ç”¨åŸå§‹è©³ç´°å•é¡Œè€Œä¸æ˜¯é€šç”¨æè¿°
						specificProblem:
							userIntent.originalSpecificProblem ||
							`ç”¨æˆ¶é¸æ“‡è©³ç´°${concernName}å ±å‘Š`,
						confidence: 0.95,
						reportChoice: true,
						paymentType:
							userIntent.relationshipAnalysisType === "couple"
								? "couple"
								: "fortune", // ğŸ”¥ æ–°å¢ï¼šåˆå©šä½¿ç”¨coupleï¼Œå€‹äººä½¿ç”¨fortune API
					};
				} else if (
					reportChoice === "2" ||
					reportChoice.includes("ç¶œåˆ") ||
					reportChoice.includes("å‘½ç†") ||
					reportChoice.includes("ç¬¬äºŒ")
				) {
					// é¸æ“‡2ï¼šç¶œåˆå‘½ç†å ±å‘Š - ä½¿ç”¨ $88 couple payment API
					userIntent.reportType = "comprehensive";
					userIntent.conversationState = "collecting_payment_info";

					response = `ğŸŒŸ æ¥µä½³çš„é¸æ“‡ï¼ç¶œåˆå‘½ç†å ±å‘Šæ˜¯æœ€å…¨é¢çš„åˆ†æã€‚

é€™ä»½å®Œæ•´å ±å‘Šå°‡åŒ…å«ï¼š
ğŸ“Š å…«å­—å‘½ç›¤å…¨è§£æ
ğŸ”® å„é ˜åŸŸé‹å‹¢é æ¸¬
ğŸ’« æµå¹´å¤§é‹èµ°å‹¢
ğŸ¯ äººç”Ÿé‡è¦æ™‚æ©Ÿ
ğŸ  å…¨æ–¹ä½é¢¨æ°´å»ºè­°

è«‹å¡«å¯«å€‹äººè³‡æ–™ï¼Œè®“æˆ‘ç‚ºä½ æ‰“é€ å°ˆå±¬çš„å‘½ç†è—åœ–ï½`;

					shouldTriggerModal = true;
					analysis = {
						isWithinScope: true,
						detectedTopic: "ç¶œåˆå‘½ç†",
						specificProblem: "ç”¨æˆ¶é¸æ“‡ç¶œåˆå‘½ç†å ±å‘Š",
						confidence: 0.95,
						reportChoice: true,
						paymentType: "comprehensive", // ğŸ”¥ æ–°å¢ï¼šæ¨™è¨˜ä½¿ç”¨ couple payment API
					};
				} else if (
					reportChoice === "3" ||
					reportChoice.includes("å±…å®¶") ||
					reportChoice.includes("ä½ˆå±€") ||
					reportChoice.includes("ç¬¬ä¸‰")
				) {
					// é¸æ“‡3ï¼šå±…å®¶ä½ˆå±€å ±å‘Š
					userIntent.reportType = "home_layout";
					userIntent.conversationState = "collecting_payment_info";

					response = `ğŸ  å¾ˆæ£’çš„é¸æ“‡ï¼å±…å®¶ä½ˆå±€å°é‹å‹¢æå‡éå¸¸é‡è¦ã€‚

æˆ‘å°‡ç‚ºä½ å®¢è£½åŒ–ä¸€ä»½å±…å®¶é¢¨æ°´ä½ˆå±€æ–¹æ¡ˆï¼ŒåŒ…å«ï¼š
ğŸ¨ ç©ºé–“é…è‰²å»ºè­°
ğŸ“ å®¶å…·æ“ºæ”¾æŒ‡å°  
ğŸŒ¿ æ¤ç‰©æ“ºè¨­æ–¹æ¡ˆ
ğŸ’ æ‹›è²¡é–‹é‹ä½ˆå±€

è«‹å¡«å¯«å€‹äººè³‡æ–™ï¼Œæˆ‘å€‘é–‹å§‹è£½ä½œä½ çš„å°ˆå±¬ä½ˆå±€æ–¹æ¡ˆï½`;

					shouldTriggerModal = true;
					analysis = {
						isWithinScope: true,
						detectedTopic: "å±…å®¶ä½ˆå±€",
						specificProblem: "ç”¨æˆ¶é¸æ“‡å±…å®¶ä½ˆå±€å ±å‘Š",
						confidence: 0.95,
						reportChoice: true,
						paymentType: "premium", // ğŸ”¥ æ–°å¢ï¼šæ¨™è¨˜ä½¿ç”¨ premium payment API (payment2)
					};
				} else {
					// ç„¡æ•ˆé¸æ“‡ï¼Œé‡æ–°æç¤º
					const concernName = userIntent.primaryConcern || "é‹å‹¢";
					response = `è«‹é¸æ“‡ä½ æƒ³è¦çš„åˆ†æé¡å‹ï¼š

**1ï¸âƒ£ ä¸€ä»½é—œæ–¼${concernName}çš„è©³ç´°å ±å‘Š** åƒ¹å€¼$88ï¼Œé™æ™‚å„ªæƒ $38
- æ·±å…¥åˆ†æä½ çš„${concernName}é‹å‹¢ï¼Œæä¾›å…·é«”å»ºè­°å’Œæ”¹å–„æ–¹æ¡ˆ

**2ï¸âƒ£ ä¸€ä»½ç¶œåˆå‘½ç†å ±å‘Š** åƒ¹å€¼$168ï¼Œé™æ™‚å„ªæƒ $88  
- å…¨é¢çš„å…«å­—å‘½ç›¤åˆ†æï¼ŒåŒ…å«å„æ–¹é¢é‹å‹¢é æ¸¬

**3ï¸âƒ£ ä¸€ä»½å±…å®¶ä½ˆå±€å ±å‘Š** åƒ¹å€¼$388ï¼Œé™æ™‚å„ªæƒ $188
- ç”¨å±…å®¶ä½ˆå±€å¢å¼·é‹å‹¢ï¼Œæ‰“é€ å°ˆå±¬é¢¨æ°´ç©ºé–“

è«‹å›è¦†ã€Œ1ã€ã€ã€Œ2ã€æˆ–ã€Œ3ã€ï½`;

					analysis = {
						isWithinScope: true,
						detectedTopic: userIntent.primaryConcern,
						specificProblem: "ç”¨æˆ¶éœ€è¦é‡æ–°é¸æ“‡å ±å‘Šé¡å‹",
						confidence: 0.8,
						choiceResponse: true,
					};
				}
			} // é—œé–‰ catch (enhanceError) å¡Š
		} else if (userIntent?.conversationState === "bazi_topic_selection") {
			// ğŸ”® è™•ç†å…«å­—ä¸»é¡Œé¸æ“‡ç‹€æ…‹
			console.log("ğŸ”® ç”¨æˆ¶åœ¨å…«å­—ä¸»é¡Œé¸æ“‡ç‹€æ…‹ï¼Œåˆ†æä¸»é¡Œé¸æ“‡:", message);

			const classifier = new AITopicClassifier();
			const topicAnalysis = await classifier.analyzeMessage(
				message,
				sessionId
			);

			if (
				topicAnalysis &&
				topicAnalysis.isWithinScope &&
				topicAnalysis.detectedTopic &&
				topicAnalysis.detectedTopic !== "å…¶ä»–"
			) {
				console.log(
					`ğŸ¯ ç”¨æˆ¶é¸æ“‡${topicAnalysis.detectedTopic}ä¸»é¡Œï¼Œç”Ÿæˆè©³ç´°å…«å­—åˆ†æ`
				);

				// å¾æœƒè©±æ­·å²ä¸­ç²å–ä¹‹å‰çš„å…«å­—æ•¸æ“š
				const previousBaziMessage =
					await getLastBaziFromSession(sessionId);

				if (previousBaziMessage) {
					const detailedAnalysis =
						await classifier.generateBaziDetailedAnalysis(
							previousBaziMessage,
							topicAnalysis.detectedTopic,
							topicAnalysis.specificProblem,
							message
						);

					// é‡ç½®å°è©±ç‹€æ…‹
					userIntent.conversationState = "completed";
					await userIntent.save();

					return NextResponse.json({
						response: detailedAnalysis,
						aiAnalysis: {
							isWithinScope: true,
							detectedTopic: topicAnalysis.detectedTopic,
							specificProblem: topicAnalysis.specificProblem,
							analysisType: "bazi_topic_analysis",
							confidence: 0.9,
						},
						conversationState: "completed",
						systemType: "smart-chat2",
						timestamp: new Date().toISOString(),
						concern: topicAnalysis.detectedTopic,
						emotion: "positive",
						shouldTriggerModal: false,
						reportUrl: null,
						needsBirthday: false,
						specificQuestion: topicAnalysis.specificProblem,
						isCoupleAnalysis: false,
					});
				} else {
					// æ‰¾ä¸åˆ°ä¹‹å‰çš„å…«å­—æ•¸æ“šï¼Œé‡æ–°è«‹æ±‚
					response = `ğŸ”® æŠ±æ­‰ï¼Œæˆ‘éœ€è¦ä½ é‡æ–°æä¾›å…«å­—è³‡æ–™æ‰èƒ½ç‚ºä½ åˆ†æ${topicAnalysis.detectedTopic}å‘¢ï¼

è«‹æŒ‰ç…§æ ¼å¼æä¾›ä½ çš„å…«å­—ï¼š
ä¾‹å¦‚ï¼šä¸™å­,ç”²åˆ,ä¸™ç”³,æˆŠå­,æ¸¬${topicAnalysis.detectedTopic}

é€™æ¨£æˆ‘å°±èƒ½ç‚ºä½ åšè©³ç´°çš„${topicAnalysis.detectedTopic}åˆ†æå•¦ï½âœ¨`;

					userIntent.conversationState = "asking_bazi_reentry";
					await userIntent.save();
				}
			} else {
				// ç„¡æ³•è­˜åˆ¥ä¸»é¡Œï¼Œæä¾›å¼•å°
				response = `ğŸ”® æˆ‘æ²’æœ‰å®Œå…¨ç†è§£ä½ æƒ³äº†è§£çš„ä¸»é¡Œå‘¢ï½

è«‹ç›´æ¥å‘Šè¨´æˆ‘ä½ æƒ³äº†è§£çš„é ˜åŸŸï¼Œä¾‹å¦‚ï¼š
â€¢ æˆ‘æƒ³äº†è§£æ„Ÿæƒ…
â€¢ å¹«æˆ‘çœ‹å·¥ä½œé‹
â€¢ åˆ†æè²¡é‹
â€¢ çœ‹çœ‹å¥åº·
â€¢ å­å¥³é‹å‹¢

é€™æ¨£æˆ‘å°±èƒ½ç‚ºä½ åšç²¾æº–çš„å…«å­—åˆ†æå•¦ï¼âœ¨`;
			}

			// æ›´æ–° UserIntent
			await userIntent.save();

			return NextResponse.json({
				response: response,
				aiAnalysis: topicAnalysis || {
					isWithinScope: false,
					detectedTopic: "å…¶ä»–",
					specificProblem: "ä¸»é¡Œé¸æ“‡",
				},
				conversationState: userIntent.conversationState,
				systemType: "smart-chat2",
				timestamp: new Date().toISOString(),
				concern: "å…¶ä»–",
				emotion: "positive",
				shouldTriggerModal: false,
				reportUrl: null,
				needsBirthday: false,
				specificQuestion: "å…«å­—ä¸»é¡Œé¸æ“‡",
				isCoupleAnalysis: false,
			});
		} else {
			// ï¿½ å„ªå…ˆæª¢æ¸¬å…«å­—+ä¸»é¡Œçµ„åˆåˆ†æ (æ–°å¢åŠŸèƒ½)
			const classifier = new AITopicClassifier();
			const baziTopicResult =
				await classifier.detectBaziWithTopicAnalysis(
					message,
					sessionId
				);

			if (baziTopicResult) {
				console.log(
					"ğŸ”® æª¢æ¸¬åˆ°å…«å­—åˆ†æéœ€æ±‚:",
					baziTopicResult.analysisType
				);

				if (baziTopicResult.analysisType === "bazi_topic_analysis") {
					// å…«å­—+ä¸»é¡Œçµ„åˆï¼Œæä¾›è©³ç´°åˆ†æ
					console.log(
						`ğŸ¯ æä¾›${baziTopicResult.detectedTopic}çš„è©³ç´°å…«å­—åˆ†æ`
					);

					return NextResponse.json({
						response: baziTopicResult.response,
						aiAnalysis: {
							isWithinScope: true,
							detectedTopic: baziTopicResult.detectedTopic,
							specificProblem: baziTopicResult.specificProblem,
							analysisType: "bazi_topic_analysis",
							confidence: 0.9,
						},
						conversationState: "completed",
						systemType: "smart-chat2",
						timestamp: new Date().toISOString(),
						concern: baziTopicResult.detectedTopic,
						emotion: "positive",
						shouldTriggerModal: false,
						reportUrl: null,
						needsBirthday: false,
						specificQuestion: baziTopicResult.specificProblem,
						isCoupleAnalysis: false,
					});
				} else if (baziTopicResult.analysisType === "bazi_only") {
					// ç´”å…«å­—è¼¸å…¥ï¼Œæä¾›æœå‹™é¸å–®
					console.log("ğŸ”® ç´”å…«å­—è¼¸å…¥ï¼Œç”Ÿæˆæœå‹™é¸å–®å›æ‡‰");

					const serviceMenuResponse = `ğŸ”® é¢¨éˆ´çœ‹åˆ°ä½ çš„å…«å­—äº†ï¼š${baziTopicResult.baziString}

æˆ‘å¯ä»¥ç‚ºä½ åˆ†æä»¥ä¸‹ä»»ä½•ä¸€å€‹é ˜åŸŸï¼š

ğŸŒ¸ **æ„Ÿæƒ…é‹å‹¢** - æ¡ƒèŠ±é‹ã€åˆå©šé…å°ã€æ„Ÿæƒ…ç™¼å±•
ğŸ’¼ **äº‹æ¥­å·¥ä½œ** - è·å ´é‹å‹¢ã€å‡è·æ©Ÿæœƒã€äº‹æ¥­ç™¼å±•  
ğŸ’° **è²¡é‹åˆ†æ** - æŠ•è³‡ç†è²¡ã€æ”¶å…¥æå‡ã€è²¡é‹èµ°å‘
ğŸŒ¿ **å¥åº·é‹å‹¢** - èº«å¿ƒèª¿ç†ã€å¥åº·ç‹€æ³ã€é¤Šç”Ÿå»ºè­°

ä½ æƒ³äº†è§£å“ªå€‹æ–¹é¢å‘¢ï¼Ÿç›´æ¥å‘Šè¨´æˆ‘ã€Œæˆ‘æƒ³äº†è§£æ„Ÿæƒ…ã€æˆ–ã€Œå¹«æˆ‘çœ‹å·¥ä½œã€å³å¯ï½âœ¨`;

					return NextResponse.json({
						response: serviceMenuResponse,
						aiAnalysis: {
							isWithinScope: true,
							detectedTopic: "å…¶ä»–",
							specificProblem: "å…«å­—è¼¸å…¥",
							analysisType: "bazi_service_menu",
							confidence: 0.9,
						},
						conversationState: "bazi_topic_selection",
						systemType: "smart-chat2",
						timestamp: new Date().toISOString(),
						concern: "å…¶ä»–",
						emotion: "positive",
						shouldTriggerModal: false,
						reportUrl: null,
						needsBirthday: false,
						specificQuestion: "å…«å­—åˆ†ææœå‹™é¸æ“‡",
						isCoupleAnalysis: false,
					});
				}
			}

			// ï¿½ğŸš€ ä½¿ç”¨å¢å¼·ç‰ˆåˆ†æå™¨ - æ”¯æŒå…«å­—ã€æƒ…å¢ƒã€çŸ¥è­˜å•ç­”ç­‰
			let enhancedResult = null; // ğŸ”§ å®šç¾© enhancedResult è®Šé‡
			try {
				const EnhancedMessageAnalyzer = require("../../../lib/enhancedMessageAnalyzer.js");
				const enhancedAnalyzer = new EnhancedMessageAnalyzer();
				enhancedResult = await enhancedAnalyzer.analyzeMessage(message);

				if (enhancedResult.isEnhanced) {
					// ğŸ¯ å„ªå…ˆè™•ç†å•å€™èª
					if (enhancedResult.analysisType === "greeting") {
						console.log("âœ… æª¢æ¸¬åˆ°å•å€™èªï¼Œæä¾›å‹å–„å›æ‡‰");
						return NextResponse.json({
							response: enhancedResult.response,
							aiAnalysis: enhancedResult,
							conversationState: "ai_analyzing",
							systemType: "smart-chat2",
							timestamp: new Date().toISOString(),
							concern: "ä¸€èˆ¬",
							emotion: "positive",
							shouldTriggerModal: false,
							reportUrl: null,
							needsBirthday: false,
							specificQuestion: "å•å€™èª",
							isCoupleAnalysis: false,
						});
					}

					// ä½¿ç”¨å¢å¼·åˆ†æçµæœ + è‡ªç„¶å°è©±ç”Ÿæˆ
					console.log("âœ… ä½¿ç”¨å¢å¼·ç‰ˆåˆ†æçµæœ");
					analysis = enhancedResult;

					// ğŸ”§ ç¢ºä¿ä¸»é¡Œæ˜ å°„åˆ°æœ‰æ•ˆçš„æ•¸æ“šåº«enumå€¼
					if (analysis.detectedTopic) {
						const analyzer = new EnhancedMessageAnalyzer();
						analysis.detectedTopic = analyzer.mapTopicToValidEnum(
							analysis.detectedTopic
						);
					}

					// ğŸ­ ä½¿ç”¨å…§å»ºçš„è‡ªç„¶å°è©±å„ªåŒ–
					if (enhancedResult.analysisType === "contextual") {
						// ç‚ºæƒ…å¢ƒåˆ†ææ·»åŠ æ›´äººæ€§åŒ–çš„èªè¨€
						response = enhanceContextualResponse(
							enhancedResult,
							userIntent,
							message
						);
					} else if (enhancedResult.analysisType === "bazi_direct") {
						// å…«å­—åˆ†æå·²ç¶“å¾ˆå¥½ï¼Œä¿æŒåŸæ¨£
						response = enhancedResult.response;
					} else if (
						enhancedResult.analysisType === "bazi_analysis" &&
						enhancedResult.requiresAIAnalysis
					) {
						// æ–°çš„å…«å­—åˆ†æï¼Œéœ€è¦AIè™•ç†
						console.log("ğŸ”® å…«å­—åˆ†æéœ€è¦ AI è™•ç†");
						const classifier = new AITopicClassifier();

						// ç‚ºå…«å­—åˆ†æç”Ÿæˆå°ˆé–€çš„AIå›æ‡‰
						const baziPrompt = `ç”¨æˆ¶æä¾›å…«å­—ï¼š${message}

è«‹ä»¥é¢¨éˆ´çš„èº«ä»½ï¼Œç”¨å¯æ„›è¦ªåˆ‡çš„èªæ°£ç‚ºç”¨æˆ¶åˆ†æå…«å­—ã€‚å…«å­—è³‡æ–™ï¼š
- å…«å­—ï¼š${enhancedResult.baziData?.baziString || ""}
- ä¸»è¦åˆ†æé ˜åŸŸï¼š${enhancedResult.specificProblem || "å…«å­—åˆ†æ"}

è«‹æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç”Ÿæˆå›æ‡‰ï¼š

ğŸ”® é¢¨éˆ´çœ‹äº†ä½ çš„å…«å­—ï¼Œç™¼ç¾ä½ æœ‰å¾ˆç‰¹åˆ¥çš„${enhancedResult.detectedTopic || "é‹å‹¢"}æ½›è³ªå‘¢ï¼âœ¨

**1. å‘½ç›¤é€Ÿè®€**
å…«å­—ï¼š${enhancedResult.baziData?.baziString || ""}
äº”è¡Œå±¬æ€§ï¼š[åˆ†æäº”è¡Œå±¬æ€§]
[ä¸»è¦åˆ†æé ˜åŸŸ]å®®ä¸»æ˜Ÿï¼š[å°æ‡‰ä¸»æ˜Ÿ]
   - é—œéµæ ¼å±€ï¼š
     [èº«å¼·å¼±åˆ†æ]
     ç”¨ç¥ï¼š[ç”¨ç¥åˆ†æ]
     å¤§é‹ç¯€é»ï¼š[ç•¶å‰å¤§é‹åˆ†æ]

ğŸ’– å“ˆå›‰è¦ªæ„›çš„[äº”è¡Œ]å‘½å¯¶å¯¶ï¼é¢¨éˆ´ä¾†å¹«ä½ åˆ†æ${enhancedResult.detectedTopic || "é‹å‹¢"}å•¦ï½æ ¹æ“šä½ çš„äº”è¡Œç‰¹è³ªï¼Œ[å¹´ä»½]å¹´æœƒæ˜¯[é‹å‹¢ç‰¹é»]çš„ä¸€å¹´å‘¢ï¼(Â´â–½\`Êƒâ™¡Æª)

**2. å¹´åº¦é è­¦**  
âœ¨æˆå°±æ˜Ÿï¼š[æœ€ä½³æ™‚æ©Ÿ]æœ€æ—ºï¼é©åˆ[å…·é«”å»ºè­°]ï¼Œè¨˜å¾—æŠŠæ¡[æ™‚é–“é»]çš„é»ƒé‡‘æœŸï½  
âš ï¸å°äººç…ï¼š[æ³¨æ„æ™‚æœŸ]æœ‰[ç…æ˜Ÿ]ï¼è¦é¿é–‹[é¿å…äº‹é …]ï¼Œ[æ³¨æ„äº‹é …]è¦[å…·é«”å»ºè­°]å–”ï¼(à¹‘â€¢Ì€Ğ´â€¢Ì)

æ³¨æ„ï¼šæ‰€æœ‰æœˆä»½æ™‚é–“éƒ½ä½¿ç”¨æ–°æ­·ï¼ˆè¥¿æ›†ï¼‰ï¼Œä¾‹å¦‚ï¼š1æœˆã€2æœˆã€3æœˆç­‰ï¼Œä¸è¦ä½¿ç”¨è¾²æ­·ã€‚

**3. ä½ çš„${enhancedResult.detectedTopic || "é‹å‹¢"}åˆ†æ**  
æœ€è¿‘æ˜¯ä¸æ˜¯æ„Ÿè¦º[è§€å¯Ÿæè¿°]å‘€ï¼Ÿ(æ­ªé ­) æœªä¾†3å€‹æœˆæœƒæœ‰[é æ¸¬å…§å®¹]ï½è¨˜å¾—ç™¼æ®[å‘½æ ¼å„ªå‹¢]çš„å„ªå‹¢ï¼Œä½†[æ™‚æœŸ]å¾Œè¦[æ³¨æ„äº‹é …]å”·ï¼(à¹‘Â¯â—¡Â¯à¹‘)

**4. é–‹é‹å°ç§˜è¨£**  
ğŸ¡å±…å®¶ï¼šåœ¨[æ–¹ä½]æ”¾[é–‹é‹ç‰©å“]ï¼ˆ[æœ€ä½³æ™‚æ©Ÿ]æœ€æ‹›é‹ï¼ï¼‰  
ğŸ‘›é…ä»¶ï¼šé¸[é¡è‰²][æè³ª][ç‰©å“]ï¼Œè£¡é¢æ”¾[é–‹é‹é…ä»¶]ï½  
ğŸ’«è¡Œå‹•ï¼šæ¯[æ™‚é–“]çš„[æ™‚è¾°]æœ€åˆ©å–”ï¼ï¼ˆå·å·èªªï¼š[å…·é«”å»ºè­°]å¾ˆé©åˆä½ ï¼‰

[äº”è¡Œ]å‘½å¯¶å¯¶è¨˜å¾—è¦å¤šç”¨[å¹¸é‹é¡è‰²]ç³»ç‰©å“å¢å¼·é‹æ°£å‘¢ï½é¢¨éˆ´ç¥ä½ [ç¥ç¦èª]ï¼Ù©(â—•â€¿â—•)Û¶

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’ **æƒ³è¦æ›´æ·±å…¥çš„åˆ†æå—ï¼Ÿ**
**1ï¸âƒ£ è¯¦ç»†æŠ¥å‘Š** åƒ¹å€¼$88ï¼Œé™æ™‚å„ªæƒ $38
**2ï¸âƒ£ ç»¼åˆå‘½ç†æŠ¥å‘Š** åƒ¹å€¼$168ï¼Œé™æ™‚å„ªæƒ $88  
**3ï¸âƒ£ å±…å®¶ä½ˆå±€å ±å‘Š** åƒ¹å€¼$388ï¼Œé™æ™‚å„ªæƒ $188

è¦æ±‚ï¼š
1. ä¿æŒé¢¨éˆ´å¯æ„›è¦ªåˆ‡çš„èªæ°£
2. ä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿå’Œå¯æ„›çš„èªåŠ©è©
3. æä¾›å…·é«”å¯¦ç”¨çš„å»ºè­°
4. ç´„400-500å­—
5. é‡é»åˆ†æç”¨æˆ¶é—œæ³¨çš„é ˜åŸŸï¼ˆ${enhancedResult.detectedTopic || "æ•´é«”é‹å‹¢"}ï¼‰
6. æ‰€æœ‰æ—¥æœŸå’Œæœˆä»½éƒ½å¿…é ˆä½¿ç”¨æ–°æ­·ï¼ˆè¥¿æ›†/å…¬æ›†ï¼‰ï¼Œä¾‹å¦‚1æœˆã€2æœˆã€3æœˆç­‰ï¼Œä¸è¦ä½¿ç”¨è¾²æ­·`;

						try {
							const aiResponse = await classifier.callDeepSeekAPI(
								[
									{
										role: "system",
										content:
											"ä½ æ˜¯å°ˆæ¥­çš„é¢¨æ°´å‘½ç†é¡§å•ï¼Œæ“…é•·å…«å­—åˆ†æå’Œé‹å‹¢é æ¸¬ã€‚é‡è¦æŒ‡ç¤ºï¼š1. å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ 2. æ‰€æœ‰æ—¥æœŸå’Œæœˆä»½éƒ½å¿…é ˆä½¿ç”¨æ–°æ­·ï¼ˆè¥¿æ›†/å…¬æ›†ï¼‰ï¼Œä¾‹å¦‚1æœˆã€2æœˆã€3æœˆç­‰ï¼Œé¿å…ä½¿ç”¨è¾²æ­·è¡¨é”æ–¹å¼ 3. ä¸è¦åœ¨å›æ‡‰ä¸­åŒ…å«å­—æ•¸çµ±è¨ˆæ¨™è¨˜ 4. ä¿æŒå°ˆæ¥­ä¸”è¦ªåˆ‡çš„èªæ°£",
									},
									{
										role: "user",
										content: baziPrompt,
									},
								]
							);

							// ğŸ”§ æå–AIå›æ‡‰å…§å®¹
							if (
								aiResponse &&
								aiResponse.choices &&
								aiResponse.choices[0] &&
								aiResponse.choices[0].message
							) {
								response =
									aiResponse.choices[0].message.content;
							} else {
								response = aiResponse;
							}
							console.log("âœ… å…«å­— AI å›æ‡‰ç”ŸæˆæˆåŠŸ");
						} catch (error) {
							console.error("âŒ å…«å­— AI å›æ‡‰ç”Ÿæˆå¤±æ•—:", error);
							response = `å¾ˆæŠ±æ­‰ï¼Œç³»çµ±æš«æ™‚ç„¡æ³•è™•ç†æ‚¨çš„å…«å­—åˆ†æè«‹æ±‚ã€‚è«‹ç¨å¾Œé‡è©¦æˆ–è¯çµ¡å®¢æœã€‚`;
						}
					} else if (
						enhancedResult.analysisType === "emotional_support"
					) {
						// æƒ…ç·’æ”¯æŒå›æ‡‰ï¼Œç›´æ¥ä½¿ç”¨ä¸åšä¿®æ”¹
						console.log("ğŸ’™ æä¾›æƒ…ç·’æ”¯æŒå›æ‡‰");
						response = enhancedResult.response;
					} else if (
						enhancedResult.analysisType === "birthday_analysis"
					) {
						// ç”Ÿæ—¥åˆ†æå›æ‡‰ï¼Œä½¿ç”¨enhancedResponse
						console.log("ğŸ‚ è™•ç†ç”Ÿæ—¥åˆ†æ");
						response = enhancedResult.enhancedResponse;
					} else if (
						enhancedResult.analysisType ===
							"knowledge_explanation" &&
						enhancedResult.requiresAIAnalysis
					) {
						// çŸ¥è­˜è©¢å•ä½¿ç”¨AIåˆ†æï¼Œä¸ä½¿ç”¨ç¡¬ç·¨ç¢¼å›æ‡‰
						console.log("ğŸ§  çŸ¥è­˜è©¢å•ä½¿ç”¨ AI åˆ†æ");
						const classifier = new AITopicClassifier();

						// ç”Ÿæˆå°ˆé–€é‡å°çŸ¥è­˜è©¢å•çš„AIå›æ‡‰
						const knowledgePrompt = `ç”¨æˆ¶è©¢å•ï¼š${message}

è«‹ä½œç‚ºå°ˆæ¥­çš„é¢¨æ°´å‘½ç†è€å¸«ï¼Œç”¨ä¸è¶…é200å­—ç°¡æ½”å°ˆæ¥­åœ°è§£é‡‹é€™å€‹æ¦‚å¿µã€‚è¦æ±‚ï¼š
1. è§£é‡‹æ¸…æ¥šæ˜“æ‡‚
2. çªå‡ºå¯¦éš›æ‡‰ç”¨åƒ¹å€¼  
3. ä¿æŒå°ˆæ¥­æ¬Šå¨æ€§
4. èªæ°£è¦ªåˆ‡è‡ªç„¶
5. æœ€å¾Œå¯ä»¥æåŠå¦‚æœæƒ³äº†è§£å€‹äººç‹€æ³å¯ä»¥æä¾›ç”Ÿæ—¥åšåˆ†æ

è«‹ç›´æ¥çµ¦å‡ºè§£é‡‹ï¼Œä¸è¦èªª"æˆ‘ä¾†è§£é‡‹"ä¹‹é¡çš„é–‹å ´ç™½ã€‚`;

						response = await classifier.callDeepSeekAPI([
							{
								role: "system",
								content:
									"ä½ æ˜¯å°ˆæ¥­çš„é¢¨æ°´å‘½ç†é¡§å•ï¼Œæ“…é•·ç”¨ç°¡æ½”æ˜“æ‡‚çš„æ–¹å¼è§£é‡‹å‚³çµ±æ¦‚å¿µã€‚é‡è¦æŒ‡ç¤ºï¼š1. å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å›æ‡‰ï¼Œä¸å¯ä½¿ç”¨ç°¡é«”ä¸­æ–‡ 2. ä¸è¦åœ¨å›æ‡‰ä¸­åŒ…å«å­—æ•¸çµ±è¨ˆæ¨™è¨˜ 3. ä¿æŒå°ˆæ¥­ä¸”è¦ªåˆ‡çš„èªæ°£",
							},
							{
								role: "user",
								content: knowledgePrompt,
							},
						]);

						// ğŸ”§ æå–AIå›æ‡‰å…§å®¹
						if (
							response &&
							response.choices &&
							response.choices[0] &&
							response.choices[0].message
						) {
							response = response.choices[0].message.content;
						}

						// ä¿æŒå¢å¼·åˆ†æçš„çµæœä½†æ›´æ–°éŸ¿æ‡‰é¡å‹
						analysis = { ...enhancedResult, response: response };
					} else {
						// å…¶ä»–é¡å‹ä¿æŒåŸæ¨£ï¼Œæª¢æŸ¥ä¸åŒçš„å›æ‡‰å­—æ®µ
						if (enhancedResult.response) {
							response = enhancedResult.response;
						} else if (enhancedResult.enhancedResponse) {
							response = enhancedResult.enhancedResponse;
						} else {
							console.log(
								"âš ï¸ å¢å¼·çµæœæ²’æœ‰responseæˆ–enhancedResponseå­—æ®µ"
							);
							response = "æŠ±æ­‰ï¼Œæˆ‘æ­£åœ¨è™•ç†æ‚¨çš„è«‹æ±‚ï¼Œè«‹ç¨å€™ã€‚";
						}
					}
					console.log("ğŸ­ å·²æ‡‰ç”¨è‡ªç„¶å°è©±å„ªåŒ–");
				} else {
					// ä½¿ç”¨ AI åˆ†æé€²è¡Œç²¾æº–çš„è©±é¡Œæª¢æ¸¬å’Œå•é¡Œç†è§£
					console.log("âš¡ ä½¿ç”¨ AI åˆ†æé€²è¡Œè©±é¡Œæª¢æ¸¬");
					const classifier = new AITopicClassifier();
					analysis = await classifier.analyzeMessage(
						message,
						sessionId
					);

					// å¦‚æœ AI åˆ†æå¤±æ•—ï¼Œæ‰ä½¿ç”¨é—œéµè©åŒ¹é…ä½œç‚ºå¾Œå‚™
					if (!analysis || !analysis.isWithinScope) {
						console.log("âš¡ AI åˆ†æå¤±æ•—ï¼Œä½¿ç”¨é—œéµè©åŒ¹é…å¾Œå‚™");
						analysis = classifier.getFallbackAnalysis(message);
					}

					response = await classifier.generateServiceGuidance(
						analysis,
						message,
						sessionId
					);
				}
			} catch (enhancedError) {
				console.error(
					"ğŸš¨ å¢å¼·åˆ†æå™¨éŒ¯èª¤ï¼Œå›é€€åˆ° AI åˆ†æ:",
					enhancedError
				);
				// ä½¿ç”¨ AI åˆ†æä½œç‚ºä¸»è¦æ–¹æ³•
				const classifier = new AITopicClassifier();
				try {
					analysis = await classifier.analyzeMessage(
						message,
						sessionId
					);
				} catch (aiError) {
					console.error("ğŸš¨ AI åˆ†æä¹Ÿå¤±æ•—ï¼Œä½¿ç”¨é—œéµè©å¾Œå‚™:", aiError);
					analysis = classifier.getFallbackAnalysis(message);
				}

				response = await classifier.generateServiceGuidance(
					analysis,
					message,
					sessionId
				);
			}
		}

		// ä¿å­˜æœƒè©±è¨˜éŒ„
		try {
			if (!userIntent) {
				userIntent = new SmartUserIntent({
					userEmail: userEmail,
					userId: userId, // ğŸ†• æ–°å¢ï¼šä¿å­˜userId
					sessionId: sessionId,
					// ğŸ¯ ç§»é™¤ conversationHistory - æ”¹ç”¨ChatHistoryå­˜å„²
					conversationState: "ai_analyzing",
					specificQuestion: analysis.specificProblem,
					primaryConcern: analysis.isWithinScope
						? analysis.detectedTopic
						: null,
					// ğŸ”§ FIX: ä¿å­˜åŸå§‹è©³ç´°å•é¡Œæè¿°ï¼Œç”¨æ–¼å ±å‘Šç”Ÿæˆ
					originalSpecificProblem: analysis.specificProblem,
					originalUserMessage: message, // ğŸ†• æ°¸ä¸è¦†è“‹çš„åŸå§‹è¨Šæ¯
				});
			} else if (isBirthdayInput) {
				// æ›´æ–°ç‹€æ…‹ç‚ºè©¢å•è©³ç´°å ±å‘Š
				userIntent.conversationState = "asking_detailed_report";

				// ğŸ”§ è§£æä¸¦æ¨™æº–åŒ–ç”Ÿæ—¥æ ¼å¼
				const cleanedDate = message
					.replace(/[å¹´æœˆæ—¥]/g, "-")
					.replace(/[/]/g, "-");
				const dateMatch = cleanedDate.match(
					/(\d{4})-(\d{1,2})-(\d{1,2})/
				);
				if (dateMatch) {
					const [, year, month, day] = dateMatch;
					const standardDate = `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
					userIntent.userBirthday = new Date(standardDate);
				} else {
					userIntent.userBirthday = new Date(message); // å˜—è©¦ç›´æ¥è§£æ
				}

				// ğŸ”§ FIX: ç¢ºä¿åŸå§‹ç”¨æˆ¶è¨Šæ¯è¢«ä¿å­˜ä¸”æ°¸ä¸è¦†è“‹
				if (
					!userIntent.originalUserMessage &&
					topicAndBirthdayData?.originalMessage
				) {
					userIntent.originalUserMessage =
						topicAndBirthdayData.originalMessage;
				}
				if (!userIntent.originalSpecificProblem) {
					userIntent.originalSpecificProblem =
						userIntent.originalUserMessage ||
						topicAndBirthdayData?.originalMessage ||
						userIntent.specificQuestion ||
						"ä¸€èˆ¬è«®è©¢";
				}

				// è¨­ç½®æ­£ç¢ºçš„å•é¡Œæè¿°
				if (
					!userIntent.specificQuestion ||
					userIntent.specificQuestion.includes("ç”Ÿæ—¥åˆ†æ")
				) {
					if (userIntent.relationshipAnalysisType === "individual") {
						userIntent.specificQuestion = "å€‹äººæ„Ÿæƒ…åˆ†æ";
					} else if (
						userIntent.relationshipAnalysisType === "couple"
					) {
						userIntent.specificQuestion = "åˆå©šé…å°åˆ†æ";
					} else {
						userIntent.specificQuestion = `${userIntent.primaryConcern}è«®è©¢`;
					}
				}
			} else if (analysis.isWithinScope) {
				// æ›´æ–°ä¸»è¦é—œæ³¨é» - æ˜ å°„åˆ°æœ‰æ•ˆçš„æ•¸æ“šåº«enumå€¼
				const previousConcern = userIntent.primaryConcern;

				// ä½¿ç”¨å¢å¼·åˆ†æå™¨çš„æ˜ å°„åŠŸèƒ½
				let mappedTopic = analysis.detectedTopic;
				if (analysis.isEnhanced) {
					// å¦‚æœæ˜¯å¢å¼·åˆ†æçµæœï¼Œéœ€è¦æ˜ å°„åˆ°æœ‰æ•ˆçš„enumå€¼
					const EnhancedMessageAnalyzer = require("../../../lib/enhancedMessageAnalyzer.js");
					const analyzer = new EnhancedMessageAnalyzer();
					mappedTopic = analyzer.mapTopicToValidEnum(
						analysis.detectedTopic
					);
				} else {
					// å³ä½¿ä¸æ˜¯å¢å¼·çµæœï¼Œä¹Ÿè¦ç¢ºä¿æ˜ å°„åˆ°æœ‰æ•ˆenumå€¼
					const topicMapping = {
						æ„Ÿæƒ…: "æ„Ÿæƒ…",
						è²¡é‹: "è²¡é‹",
						å·¥ä½œ: "å·¥ä½œ",
						å¥åº·: "å¥åº·",
						å…¶ä»–: "å…¶ä»–", // ğŸ”§ ä¿®å¾©ï¼šä¿æŒå…¶ä»–è©±é¡Œç‚ºå…¶ä»–ï¼Œä¸è¦è½‰æ›ç‚ºæ„Ÿæƒ…
					};
					mappedTopic =
						topicMapping[analysis.detectedTopic] || "å…¶ä»–";
				}

				userIntent.primaryConcern = mappedTopic;
				userIntent.specificQuestion = analysis.specificProblem;

				// ğŸ”§ FIX: ç•¶ç”¨æˆ¶æå‡ºæ–°å•é¡Œæ™‚ï¼Œæ›´æ–° originalSpecificProblem
				// å…è¨±åœ¨ä¸»é¡Œæ”¹è®Šæˆ–æå‡ºæ–°çš„å¯¦è³ªæ€§å•é¡Œæ™‚æ›´æ–°åŸå§‹å•é¡Œ
				const shouldUpdateOriginalProblem =
					analysis.specificProblem &&
					analysis.specificProblem.trim().length > 0 &&
					analysis.confidence > 0.7 && // åªæœ‰é«˜ä¿¡å¿ƒåº¦çš„åˆ†ææ‰æ›´æ–°
					!analysis.specificProblem.includes("ç”¨æˆ¶é¸æ“‡") && // ä¸æ˜¯é¸é …é¸æ“‡
					!analysis.specificProblem.includes("æ— æ³•ç¡®å®š") && // ä¸æ˜¯ä¸æ˜ç¢ºè¼¸å…¥
					!analysis.specificProblem.includes("æ•°å­—") && // ä¸æ˜¯æ•¸å­—è¼¸å…¥
					(!userIntent.originalSpecificProblem || // å°šæœªè¨­ç½®åŸå§‹å•é¡Œ
						previousConcern !== mappedTopic || // ä¸»é¡Œå·²æ”¹è®Š
						(userIntent.originalSpecificProblem &&
							userIntent.originalSpecificProblem.includes(
								"ä»Šå¤©å¤©æ°£å¾ˆå¥½"
							))); // åŸå§‹å•é¡Œæ˜¯ç„¡é—œè©±é¡Œï¼Œæ‡‰è©²æ›´æ–°

				if (shouldUpdateOriginalProblem) {
					userIntent.originalSpecificProblem =
						analysis.specificProblem;
					console.log(
						`ğŸ†• æ›´æ–° originalSpecificProblem: ${analysis.specificProblem}`
					);
					console.log(
						`   åŸå› : ${
							!userIntent.originalSpecificProblem
								? "åˆæ¬¡è¨­ç½®"
								: previousConcern !== mappedTopic
									? "ä¸»é¡Œæ”¹è®Š"
									: "æ›´æ–°ç„¡é—œè©±é¡Œ"
						}`
					);
				} else {
					console.log(
						`ğŸ”’ ä¿è­·åŸå§‹å•é¡Œï¼Œä¸è¦†è“‹: ${userIntent.originalSpecificProblem}`
					);
					console.log(
						`   ç•¶å‰åˆ†æçµæœ: ${analysis.specificProblem} (ä¿¡å¿ƒåº¦: ${analysis.confidence})`
					);
				}

				// ğŸ”§ é‡è¦ä¿®å¾©ï¼šç•¶å¾ä¸€å€‹è©±é¡Œåˆ‡æ›åˆ°å¦ä¸€å€‹è©±é¡Œæ™‚ï¼Œé‡ç½®åŸå§‹å•é¡Œ
				if (
					previousConcern && // ä¹‹å‰æœ‰é—œæ³¨é ˜åŸŸ
					previousConcern !== mappedTopic // ä¸»é¡Œç™¼ç”Ÿè®ŠåŒ–
				) {
					console.log(
						`ğŸ”„ ä¸»é¡Œå¾ ${previousConcern} åˆ‡æ›åˆ° ${mappedTopic}ï¼Œé‡ç½®åŸå§‹å•é¡Œå’Œé—œä¿‚åˆ†æé¡å‹`
					);
					userIntent.originalSpecificProblem =
						analysis.specificProblem; // é‡ç½®åŸå§‹å•é¡Œ
					userIntent.relationshipAnalysisType = "individual";
					userIntent.partnerBirthday = null; // æ¸…é™¤ä¼´ä¾¶ç”Ÿæ—¥
					userIntent.conversationState = "concern_detected"; // é‡ç½®å°è©±ç‹€æ…‹
				} else if (
					previousConcern === "æ„Ÿæƒ…" &&
					analysis.detectedTopic !== "æ„Ÿæƒ…"
				) {
					console.log(`ğŸ”„ å¾æ„Ÿæƒ…åˆ‡æ›åˆ°å…¶ä»–é ˜åŸŸï¼Œé‡ç½®é—œä¿‚åˆ†æé¡å‹`);
					userIntent.relationshipAnalysisType = "individual";
					userIntent.partnerBirthday = null; // æ¸…é™¤ä¼´ä¾¶ç”Ÿæ—¥
					userIntent.conversationState = "concern_detected"; // é‡ç½®å°è©±ç‹€æ…‹
				}

				// ğŸ”§ é¡å¤–æª¢æŸ¥ï¼šå¦‚æœåŸå§‹å•é¡Œæ˜é¡¯ä¸ç›¸é—œï¼Œå¼·åˆ¶æ›´æ–°
				const isOriginalProblemUnrelated =
					userIntent.originalSpecificProblem &&
					analysis.specificProblem &&
					userIntent.originalSpecificProblem !==
						analysis.specificProblem &&
					// å¤©æ°£å•é¡Œä¸æ‡‰è©²å‡ºç¾åœ¨å…¶ä»–åˆ†æä¸­
					(userIntent.originalSpecificProblem.includes("å¤©æ°£") ||
						userIntent.originalSpecificProblem.includes("åƒä»€éº¼") ||
						// æ„Ÿæƒ…å•é¡Œä¸æ‡‰è©²å‡ºç¾åœ¨å·¥ä½œåˆ†æä¸­
						(mappedTopic === "å·¥ä½œ" &&
							userIntent.originalSpecificProblem.includes(
								"å¥³æœ‹å‹"
							)) ||
						(mappedTopic === "å·¥ä½œ" &&
							userIntent.originalSpecificProblem.includes(
								"æ„Ÿæƒ…"
							)) ||
						// å·¥ä½œå•é¡Œä¸æ‡‰è©²å‡ºç¾åœ¨æ„Ÿæƒ…åˆ†æä¸­
						(mappedTopic === "æ„Ÿæƒ…" &&
							userIntent.originalSpecificProblem.includes(
								"å·¥ä½œ"
							)) ||
						(mappedTopic === "æ„Ÿæƒ…" &&
							userIntent.originalSpecificProblem.includes(
								"å‡è·"
							)));

				if (isOriginalProblemUnrelated) {
					console.log(
						`ğŸ”„ æª¢æ¸¬åˆ°åŸå§‹å•é¡Œä¸ç›¸é—œï¼Œå¼·åˆ¶æ›´æ–°: "${userIntent.originalSpecificProblem}" â†’ "${analysis.specificProblem}"`
					);
					userIntent.originalSpecificProblem =
						analysis.specificProblem;
				}
			}

			// ğŸ¯ ç§»é™¤å°è©±æ­·å²å­˜å„²åˆ°SmartUserIntent - æ”¹ç‚ºåªå­˜åˆ°ChatHistory
			// SmartUserIntentç¾åœ¨åªå­˜å„²æ¥­å‹™é‚è¼¯ç‹€æ…‹ï¼Œä¸å­˜å„²å°è©±å…§å®¹

			// ä¿å­˜ AI åˆ†æçµæœåˆ° SmartUserIntent
			userIntent.aiAnalysis = {
				...analysis,
				originalMessage: message, // ğŸ”§ ä¿å­˜åŸå§‹ç”¨æˆ¶è¨Šæ¯
				lastAnalyzed: new Date(),
			};

			await userIntent.save();

			// ğŸ” DEBUG - æª¢æŸ¥responseé¡å‹beforeä¿å­˜åˆ°ChatHistory
			console.log("ğŸ” DEBUG - ä¿å­˜å‰responseæª¢æŸ¥:");
			console.log("   responseé¡å‹:", typeof response);
			console.log(
				"   responseæ˜¯å¦ç‚ºobject:",
				typeof response === "object"
			);
			console.log(
				"   responseé è¦½:",
				typeof response === "string"
					? response.substring(0, 100)
					: "[OBJECT]"
			);

			// ğŸ†• ä¿å­˜å°è©±åˆ°ChatHistoryæ¨¡å‹ (ä¸»è¦å­˜å„²)
			await saveToChatHistory(
				sessionId,
				userId,
				message,
				response,
				analysis,
				userIntent
			);
		} catch (dbError) {
			console.error("ğŸš¨ æ•¸æ“šåº«ä¿å­˜å¤±æ•—:", dbError);
		}

		// ğŸ”§ è™•ç†æ¨¡æ…‹æ¡†æäº¤ï¼ˆç”Ÿæ—¥+æ€§åˆ¥+å ±å‘Šé¡å‹ï¼‰

		// æª¢æŸ¥æ˜¯å¦ç‚ºæ¨¡æ…‹æ¡†æäº¤
		if (userBirthday && gender && !message?.trim()) {
			console.log("ğŸ¯ æª¢æ¸¬åˆ°æ¨¡æ…‹æ¡†æäº¤:", {
				userBirthday,
				gender,
				reportType,
			});

			// è§£æç”Ÿæ—¥
			const parsedDate = parseFlexibleDate(userBirthday);
			if (parsedDate) {
				userIntent.userBirthday = parsedDate;
				userIntent.conversationState = "ready_for_detailed_report";

				// ä¿æŒåŸæœ‰çš„é—œæ³¨é ˜åŸŸï¼Œä¸è¦è¢«è¦†è“‹
				const originalConcern = userIntent.primaryConcern || "ç¶œåˆé‹å‹¢";
				const concern = originalConcern;
				const problem =
					userIntent.specificQuestion ||
					`æƒ³äº†è§£${concern}æ–¹é¢çš„é‹å‹¢å’Œé¢¨æ°´å»ºè­°`;

				// ğŸ”§ æª¢æŸ¥æ˜¯å¦ç‚ºåˆå©šåˆ†æ
				if (
					userIntent.relationshipAnalysisType === "couple" &&
					userIntent.partnerBirthday
				) {
					// åˆå©šåˆ†æï¼šç”Ÿæˆåˆå©šå ±å‘ŠURL
					const params = new URLSearchParams({
						userBirthday: userBirthday,
						partnerBirthday: userIntent.partnerBirthday
							.toISOString()
							.split("T")[0],
						userGender: gender,
						concern: concern,
						// ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨åŸå§‹å…·é«”å•é¡Œ
						problem:
							userIntent.originalSpecificProblem ||
							userIntent.specificQuestion ||
							problem,
						analysisType: "couple",
						// ğŸ”§ æ–°å¢ï¼šå‚³éåŸå§‹å…·é«”å•é¡Œåˆ°å ±å‘Šé é¢
						originalProblem:
							userIntent.originalSpecificProblem ||
							userIntent.specificQuestion ||
							"æ„Ÿæƒ…è®Šæ·¡ï¼Œé—œä¿‚ç–é›¢",
					});

					reportUrl = `/zh-CN/couple-report?${params.toString()}`;
					console.log("ğŸ’• Smart-Chat2 ç”Ÿæˆåˆå©šå ±å‘ŠURL:", reportUrl);
				} else {
					// å€‹äººåˆ†æï¼šç”Ÿæˆå€‹äººå ±å‘ŠURL
					const params = new URLSearchParams({
						birthday: userBirthday,
						gender: gender,
						concern: concern,
						// ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨åŸå§‹å…·é«”å•é¡Œ
						problem:
							userIntent.originalSpecificProblem ||
							userIntent.specificQuestion ||
							problem,
					});

					reportUrl = `/zh-CN/feng-shui-report?${params.toString()}`;
					console.log("ğŸ“Š Smart-Chat2 ç”Ÿæˆè©³ç´°å ±å‘ŠURL:", reportUrl);
				}

				return NextResponse.json({
					response:
						"âœ¨ å°ˆå±¬é¢¨æ°´åˆ†æå ±å‘Šå·²ç”Ÿæˆï¼æ­£åœ¨ç‚ºä½ æ‰“é–‹å ±å‘Šé é¢...",
					concern: concern,
					emotion: "hopeful",
					conversationState: "ready_for_detailed_report",
					hasReport: true,
					shouldTriggerModal: false,
					reportUrl: reportUrl,
					needsBirthday: false,
					specificQuestion: problem,
					systemType: "smart-chat2",
				});
			}
		}

		// ğŸ” DEBUG: æª¢æŸ¥ specificProblem çš„å€¼
		console.log("ğŸ” API å›æ‡‰æº–å‚™éšæ®µ - specificProblem æª¢æŸ¥:");
		console.log("   analysis?.specificProblem:", analysis?.specificProblem);
		console.log(
			"   userIntent?.specificQuestion:",
			userIntent?.specificQuestion
		);
		console.log("   message:", message);
		console.log(
			"   æœ€çµ‚ specificProblem å€¼:",
			analysis?.specificProblem || userIntent?.specificQuestion || message
		);

		return NextResponse.json({
			response: response,
			aiAnalysis: analysis,
			conversationState: userIntent?.conversationState || "ai_analyzed",
			systemType: "smart-chat2",
			timestamp: new Date().toISOString(),
			// ğŸ”§ æ·»åŠ  Smart-Chat å…¼å®¹çš„å­—æ®µ
			concern: userIntent?.primaryConcern || analysis?.detectedTopic,
			emotion: "neutral",
			shouldTriggerModal: shouldTriggerModal,
			reportUrl: reportUrl,
			reportType: userIntent?.reportType,
			needsBirthday: !userIntent?.userBirthday,
			specificQuestion: userIntent?.specificQuestion,
			// ğŸ”¥ ä¿®æ­£ï¼šæ·»åŠ  specificProblem åˆ°å›æ‡‰ä¸­ï¼Œç¢ºä¿å‰ç«¯å¯ä»¥æ¥æ”¶åˆ°å…·é«”å•é¡Œæè¿°
			specificProblem:
				analysis?.specificProblem ||
				userIntent?.specificQuestion ||
				message,
			relationshipAnalysisType: userIntent?.relationshipAnalysisType,
			isCoupleAnalysis: userIntent?.relationshipAnalysisType === "couple",
			// ğŸ¯ Add couple birthdays detection flag for frontend
			hasCouplesBirthdays: couplesBirthdayData ? true : false,
		});
	} catch (error) {
		console.error("ğŸš¨ Smart-Chat2 éŒ¯èª¤:", error);

		return NextResponse.json(
			{
				response:
					"æŠ±æ­‰ï¼Œç³»çµ±æš«æ™‚é‡åˆ°å•é¡Œã€‚ä¸éæˆ‘é‚„æ˜¯å¾ˆæƒ³å¹«ä½ ï¼ä¸å¦‚å‘Šè¨´æˆ‘ä½ çš„ç”Ÿæ—¥ï¼Œè®“æˆ‘ç‚ºä½ åšå€‹ç°¡å–®çš„é‹å‹¢åˆ†æï¼Ÿ ğŸ“… æ ¼å¼ï¼š1990-05-15",
				error: "ç³»çµ±éŒ¯èª¤",
				systemType: "smart-chat2",
			},
			{ status: 500 }
		);
	}
}

// ğŸ†• æ–°å¢ï¼šä¿å­˜å°è©±åˆ°ChatHistoryæ¨¡å‹çš„è¼”åŠ©å‡½æ•¸
async function saveToChatHistory(
	sessionId,
	userId,
	userMessage,
	assistantResponse,
	aiAnalysis,
	userIntent
) {
	try {
		// æŸ¥æ‰¾æˆ–å‰µå»ºChatHistoryè¨˜éŒ„
		let chatHistory = await ChatHistory.findOne({
			conversationId: sessionId,
			userId: userId,
		});

		if (!chatHistory) {
			// å‰µå»ºæ–°çš„å°è©±è¨˜éŒ„
			chatHistory = new ChatHistory({
				conversationId: sessionId,
				sessionId: sessionId,
				userId: userId,
				userEmail: userIntent?.userEmail || "anonymous",
				title: generateConversationTitle(
					userIntent?.primaryConcern,
					userMessage
				),
				primaryConcern: userIntent?.primaryConcern || "å…¶ä»–",
				conversationState: userIntent?.conversationState || "initial",
				messages: [],
				context: {
					topics: userIntent?.primaryConcern
						? [userIntent.primaryConcern]
						: [],
					lastTopic: userIntent?.primaryConcern,
					conversationSummary: "",
					emotionalState: aiAnalysis?.emotionalState,
				},
				userData: {
					userBirthday: userIntent?.userBirthday,
					partnerBirthday: userIntent?.partnerBirthday,
					gender: userIntent?.gender,
					partnerGender: userIntent?.partnerGender,
					relationshipType: userIntent?.relationshipAnalysisType,
				},
			});
		}

		// æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯
		if (userMessage) {
			chatHistory.addMessage("user", userMessage);
		}

		// æ·»åŠ åŠ©æ‰‹å›æ‡‰
		if (assistantResponse) {
			// ğŸ”§ Safety: ç¢ºä¿å›æ‡‰æ˜¯å­—ç¬¦ä¸²æ ¼å¼
			let formattedResponse = assistantResponse;
			if (
				typeof assistantResponse === "object" &&
				assistantResponse.basicAnalysis
			) {
				console.log("ğŸ”§ SAFETY - åœ¨ChatHistoryä¸­æ ¼å¼åŒ–å°è±¡å›æ‡‰");
				formattedResponse =
					formatCoupleAnalysisResponse(assistantResponse);
			}
			chatHistory.addMessage("assistant", formattedResponse, aiAnalysis);
		}

		// æ›´æ–°ä¸Šä¸‹æ–‡
		if (aiAnalysis && aiAnalysis.detectedTopic) {
			chatHistory.updateContext(
				aiAnalysis.detectedTopic,
				aiAnalysis.emotionalState
			);
		}

		// æ›´æ–°å°è©±ç‹€æ…‹
		if (userIntent?.conversationState) {
			chatHistory.conversationState = userIntent.conversationState;
		}

		// ä¿å­˜åˆ°æ•¸æ“šåº«
		await chatHistory.save();

		console.log(`ğŸ’¾ å°è©±å·²ä¿å­˜åˆ°ChatHistory: ${sessionId}`);
		return chatHistory;
	} catch (error) {
		console.error("âŒ ä¿å­˜ChatHistoryå¤±æ•—:", error);
		return null;
	}
}

// ğŸ†• æ–°å¢ï¼šç”Ÿæˆå°è©±æ¨™é¡Œçš„è¼”åŠ©å‡½æ•¸ - é¡¯ç¤ºå¯¦éš›ç”¨æˆ¶å•é¡Œ
function generateConversationTitle(primaryConcern, lastMessage) {
	// å„ªå…ˆä½¿ç”¨å¯¦éš›çš„ç”¨æˆ¶å•é¡Œä½œç‚ºæ¨™é¡Œ
	if (lastMessage && typeof lastMessage === "string" && lastMessage.trim()) {
		// æ¸…ç†å’Œæˆªå–ç”¨æˆ¶å•é¡Œï¼Œç”¨ä½œæ¨™é¡Œ
		const cleanedMessage = lastMessage.replace(/\s+/g, " ").trim();

		// å¦‚æœæ¶ˆæ¯å¤ªé•·ï¼Œæˆªå–å‰40å€‹å­—ç¬¦ä¸¦åŠ ä¸Šçœç•¥è™Ÿ
		if (cleanedMessage.length > 40) {
			return cleanedMessage.substring(0, 40) + "...";
		}

		return cleanedMessage;
	}

	// å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å‚³çµ±çš„åˆ†é¡æ¨™é¡Œ
	const concernTitles = {
		æ„Ÿæƒ…: "æ„Ÿæƒ…è«®è©¢",
		å·¥ä½œ: "å·¥ä½œé‹å‹¢",
		è²¡é‹: "è²¡é‹åˆ†æ",
		å¥åº·: "å¥åº·é‹å‹¢",
	};

	if (primaryConcern && concernTitles[primaryConcern]) {
		return concernTitles[primaryConcern];
	}

	return "é¢¨æ°´è«®è©¢";
}

// ğŸ­ å…§å»ºè‡ªç„¶å°è©±å„ªåŒ–å‡½æ•¸
function enhanceContextualResponse(enhancedResult, userIntent, message) {
	const { contextData } = enhancedResult;
	if (!contextData) return enhancedResult.response;

	const { problem, birthday, problemType } = contextData;

	// æå–å¹´é½¡ä¿¡æ¯
	const birthYear = birthday.match(/(\d{4})/)?.[1];
	const age = birthYear ? new Date().getFullYear() - parseInt(birthYear) : 25;

	// æƒ…æ„Ÿæ”¯æŒèªå¥
	const supportMessages = {
		work_problem:
			"å¤±æ¥­çœŸçš„å¾ˆè®“äººç„¦æ…®å‘¢... æŠ±æŠ±ä½ ï¼ğŸ¤— ä¸éé€™ä¹Ÿè¨±æ˜¯æ–°æ©Ÿæœƒçš„é–‹å§‹å“¦ï¼",
		relationship_issue: "æ„Ÿæƒ…çš„äº‹æƒ…ç¸½æ˜¯æœ€è®“äººç‰½æ›... æˆ‘ç†è§£ä½ çš„å¿ƒæƒ… ğŸ’œ",
		financial_concern:
			"ç¶“æ¿Ÿå£“åŠ›ç¢ºå¯¦å¾ˆå¤§ï¼Œä¸éå›°é›£æ˜¯æš«æ™‚çš„ï¼è®“æˆ‘å¹«ä½ çœ‹çœ‹è½‰æ©Ÿåœ¨å“ªè£¡ ğŸ’ª",
		health_worry: "èº«é«”å¥åº·æœ€é‡è¦ï¼Œè¦å¥½å¥½ç…§é¡§è‡ªå·±å‘¢ ğŸŒ¿",
		general_concern: "è½èµ·ä¾†ä½ é‡åˆ°äº†ä¸€äº›æŒ‘æˆ°ï¼Œè®“é¢¨éˆ´ä¾†å¹«ä½ åˆ†æä¸€ä¸‹ï¼",
	};

	const supportMessage =
		supportMessages[problemType] || supportMessages["general_concern"];

	let response = `${supportMessage}\n\nå¾ä½ çš„ç”Ÿæ—¥ **${birthday}** ä¾†çœ‹ï¼Œä½ ç¾åœ¨${age}æ­²ï¼Œæ­£å€¼äººç”Ÿçš„é‡è¦éšæ®µï¼\n\n`;

	// æ ¹æ“šå•é¡Œé¡å‹æä¾›å»ºè­°
	if (problemType === "work_problem") {
		response += `ğŸ¯ **é—œæ–¼å·¥ä½œå•é¡Œï¼š**
é€™å€‹å¹´é½¡é‡åˆ°è·æ¥­è½‰æ›å¾ˆæ­£å¸¸ï¼Œå…¶å¯¦æ˜¯å€‹é‡æ–°å®šä½çš„å¥½æ©Ÿæœƒï¼
â€¢ ä½ çš„å¹´ç´€æ­£é©åˆå­¸ç¿’æ–°æŠ€èƒ½æˆ–è½‰æ›è·‘é“
â€¢ å»ºè­°è€ƒæ…®ç·šä¸Šå·¥ä½œæˆ–æ–°èˆˆç”¢æ¥­
â€¢ é¢è©¦ç©¿è‘—å»ºè­°ï¼šæ·±è—è‰²æˆ–ç°è‰²å¢åŠ å°ˆæ¥­æ„Ÿ`;
	} else if (problemType === "relationship_issue") {
		response += `ğŸ’• **é—œæ–¼æ„Ÿæƒ…å•é¡Œï¼š**
${age}æ­²çš„æ„Ÿæƒ…ç¶“æ­·éƒ½æ˜¯æˆé•·çš„é¤Šåˆ†ï¼Œåˆ¥å¤ªæ“”å¿ƒï¼
â€¢ é€™å€‹éšæ®µé‡é»æ˜¯æå‡è‡ªå·±ï¼Œå¥½çš„æ„Ÿæƒ…è‡ªç„¶æœƒä¾†
â€¢ å¤šåƒèˆ‡èˆˆè¶£æ´»å‹•ï¼Œå®¹æ˜“é‡åˆ°åˆé©çš„äºº
â€¢ å¿ƒæ…‹èª¿æ•´ï¼šä¿æŒé–‹æ”¾ä½†ä¸æ€¥èº`;
	} else if (problemType === "financial_concern") {
		response += `ğŸ’° **é—œæ–¼è²¡å‹™å•é¡Œï¼š**
ç¶“æ¿Ÿå›°é›£æ˜¯æš«æ™‚çš„ï¼Œé‡è¦çš„æ˜¯å»ºç«‹æ­£ç¢ºçš„ç†è²¡è§€å¿µï¼
â€¢ å„ªå…ˆè™•ç†å¿…è¦æ”¯å‡ºï¼Œæ¸›å°‘ä¸å¿…è¦æ¶ˆè²»
â€¢ è€ƒæ…®ç™¼å±•å‰¯æ¥­æˆ–æå‡æŠ€èƒ½å¢åŠ æ”¶å…¥
â€¢ æŠ•è³‡è‡ªå·±æ°¸é æ˜¯æœ€å¥½çš„æŠ•è³‡`;
	} else {
		response += `ğŸŒŸ é¢å°é€™å€‹å•é¡Œï¼Œé‡è¦çš„æ˜¯ä¿æŒæ­£é¢å¿ƒæ…‹å’Œç©æ¥µè¡Œå‹•ï¼`;
	}

	response += `\n\nğŸ’« æ¯å€‹å›°é›£éƒ½æ˜¯æˆé•·çš„æ©Ÿæœƒï¼\n\nğŸ”® **å°ˆæ¥­å»ºè­°ï¼š**
æƒ³è¦æ›´è©³ç´°çš„åˆ†æå’Œè§£æ±ºæ–¹æ¡ˆå—ï¼Ÿåªéœ€è¦å‘Šè¨´æˆ‘ä½ çš„æ€§åˆ¥ï¼Œå°±èƒ½ç‚ºä½ ç”Ÿæˆå°ˆå±¬çš„æŒ‡å°å ±å‘Šï¼`;

	return response;
}
