// Set API timeout to 60 seconds for this route
export const maxDuration = 60;

export async function POST(req) {
	try {
		const { userInfo } = await req.json();

		if (!userInfo) {
			return Response.json(
				{ error: "Missing user information" },
				{ status: 400 }
			);
		}

		const { concern, birthday, gender, time } = userInfo;

		// Enhanced prompt for comprehensive Season analysis based on ÂÖ´Â≠ó
		const prompt = `‰Ω†ÊòØÂ∞àÊ•≠ÁöÑÂÖ´Â≠óÂëΩÁêÜÂàÜÊûêÂ∏´„ÄÇË´ãÊ†πÊìöÁî®Êà∂ÁöÑÂÖ´Â≠ó‰ø°ÊÅØÈÄ≤Ë°åÂÄã‰∫∫ÂåñÁöÑÈóúÈçµÂ≠£ÁØÄÂàÜÊûêÔºö

Áî®Êà∂ÂÖ´Â≠ó‰ø°ÊÅØÔºö
- ÁîüÊó•Ôºö${birthday}
- ÊÄßÂà•Ôºö${gender}
- ÊôÇÈñìÔºö${time}
- ÈóúÊ≥®È†òÂüüÔºö${concern}

Ë´ãÈáùÂ∞çÁî®Êà∂ÁöÑÂÖ∑È´îÂÖ´Â≠óÂíå${concern}ÈóúÊ≥®È†òÂüüÔºåÊèê‰æõÂÄã‰∫∫ÂåñÁöÑÈóúÈçµÂ≠£ÁØÄÂàÜÊûêÔºö

„ÄêÈóúÈçµÂ≠£ÁØÄÂàÜÊûê„Äë

#### **Êò•Â≠£ÔºàÂØÖÂçØËæ∞ÊúàÔºåÊú®Êó∫Ôºâ**Ôºö
Ê†πÊìöÁî®Êà∂ÂÖ´Â≠óÂàÜÊûêÊò•Â≠£Êú®Êó∫Â∞çÂÖ∂${concern}ÁöÑÂÖ∑È´îÂΩ±Èüø„ÄÇÈúÄÂåÖÂê´Ôºö
- ÂÖ´Â≠ó‰∏≠Êú®ÁöÑ‰ΩúÁî®ÔºàÂç∞Êòü„ÄÅÊØîÂä´„ÄÅÈ£üÂÇ∑Á≠âÔºâ
- Â∞ç${concern}ÁöÑÊ≠£Èù¢ÂΩ±ÈüøÂíåÈ¢®Èö™
- ÂÖ∑È´îÂª∫Ë≠∞ÂíåÊ≥®ÊÑè‰∫ãÈ†ÖÔºàËá≥Â∞ë3Ê¢ùÂÖ∑È´îË°åÂãïÂª∫Ë≠∞Ôºâ
- Ëæ∞ÊúàÁöÑÁâπÊÆäÊÄßÂàÜÊûê

#### **Â§èÂ≠£ÔºàÂ∑≥ÂçàÊú™ÊúàÔºåÁÅ´ÂúüÊ•µÊó∫Ôºâ**Ôºö
ÂàÜÊûêÁÅ´ÂúüÊ•µÊó∫ÊúüÂ∞çÁî®Êà∂${concern}ÁöÑÂΩ±Èüø„ÄÇÈúÄÂåÖÂê´Ôºö
- ÁÅ´Êó∫Â∞çÁî®Êà∂ÂÖ´Â≠óÁöÑÊ≤ñÂÖãÊÉÖÊ≥Å
- ${concern}ÊñπÈù¢ÁöÑÂç±Èö™ÂíåÊ©üÈÅá
- Ê•µËá¥Èò≤Ë≠∑Êé™ÊñΩÔºàËá≥Â∞ë3Ê¢ùÂÖ∑È´îÊé™ÊñΩÔºâ
- Êú™ÊúàÂúüÊó∫ÁöÑÁâπÊÆäÂΩ±Èüø

#### **ÁßãÂ≠£ÔºàÁî≥ÈÖâÊàåÊúàÔºåÈáëÊó∫Ôºâ**Ôºö
ÂàÜÊûêÈáëÊó∫ÊúüÁöÑÂΩ±ÈüøÔºåÂàÜÊúàË©≥Ëø∞Ôºö
- Áî≥ÊúàÔºàÈáëÊ∞¥ÔºâÁöÑÂΩ±ÈüøÂíåÂª∫Ë≠∞
- ÈÖâÊúàÔºàÁ¥îÈáëÔºâÁöÑÊúÄ‰Ω≥ÊôÇÊ©ü
- ÊàåÊúàÔºàÂúüÈáëÔºâÁöÑÊ≥®ÊÑè‰∫ãÈ†Ö
- Â∞ç${concern}ÁöÑÂÖ∑È´îÊìç‰ΩúÊåáÂ∞éÔºàËá≥Â∞ë3Ê¢ùÂª∫Ë≠∞Ôºâ

#### **ÂÜ¨Â≠£Ôºà‰∫•Â≠ê‰∏ëÊúàÔºåÊ∞¥Êó∫Ôºâ**Ôºö
**ÈáçÈªûÂàÜÊûê**Ê∞¥Êó∫Ë™øÂÄôÊúüÁöÑ‰ΩúÁî®ÔºåÈúÄË©≥Á¥∞Ë™™ÊòéÔºö
- ‰∫•Â≠êÊúàÊ∞¥Êó∫ÁöÑË™øÂÄô‰ΩúÁî®Â∞ç${concern}ÁöÑÂÖ∑È´îÂπ´Âä©
- ‰∏ëÊúàÂúüÈáëÂ∫´ÁöÑÁâπÊÆäÊÄßÂíåÊ©üÈÅá
- Â∞ç${concern}ÁöÑ‰øÆÂæ©ÂíåË¶èÂäÉÂª∫Ë≠∞ÔºàËá≥Â∞ë3Ê¢ùÂÖ∑È´îÂª∫Ë≠∞Ôºâ
- ‰æÜÂπ¥Ê∫ñÂÇôÂ∑•‰ΩúÁöÑÂÖ∑È´îÊåáÂ∞é
- Ë™øÂÄôÂ∞çÊï¥È´îÂëΩÂ±ÄÁöÑÊîπÂñÑ‰ΩúÁî®

ÂèÉËÄÉÊ†ºÂºèÂíåÈ¢®Ê†ºÔºö

Ë≤°ÈÅãÁ§∫‰æãÔºö
Êò•Â≠£ÔºàÂØÖÂçØËæ∞ÊúàÔºåÊú®Êó∫ÔºâÔºöÂç∞ÊòüÊó∫ÔºåÂà©Â≠∏Áøí„ÄÅËÄÉË≠â„ÄÅÁ∂≠Áπ´ÂÆ¢Êà∂/‰∏äÂè∏Èóú‰øÇ‰ª•‰øùËÅ∑‰ΩçÔºàË≠∑Ê≠£Ë≤°Ôºâ„ÄÇ‰ΩÜÊú®ÁîüÁÅ´ÔºåÈáéÂøÉÊòìËÜ®ËÑπÔºåÂö¥Á¶ÅÊäïË≥á„ÄÅÂêàÂ§•„ÄÇËæ∞ÊúàÊøïÂúüÁ®çÁ∑©Áá•„ÄÇ

Â§èÂ≠£ÔºàÂ∑≥ÂçàÊú™ÊúàÔºåÁÅ´ÂúüÊ•µÊó∫ÔºâÔºöÂá∂Èö™Â∑îÂ≥∞ÊúüÔºÅÂ∑≥ÂçàÊúàÔºàÁÅ´ÔºâÊáâÊµÅÂπ¥Âä´Ë≤°ÔºåÁ†¥Ë≤°È¢®Èö™ÊúÄÈ´òÔºÅÂãôÂøÖÔºöÊ•µÂ∫¶ÁØÄÂÑâ„ÄÅÂè™ÂÅöÂøÖË¶ÅÊîØÂá∫„ÄÅÂÖ®Âäõ‰øùÂ∑•‰Ωú„ÄÅÊùúÁµï‰ªª‰ΩïÊäïÊ©ü/ÂêàÂ§•/ÂÄüË≤∏„ÄÇÊú™ÊúàÔºàÂúüÔºâÊú™ÊàåÂàëÂä†ÂäáÔºåÊ≥®ÊÑèÂÖ¨Âè∏/Âπ≥Âè∞ÂÖßÈÉ®ÂïèÈ°åÊàñÂ£ìÂäõ„ÄÇ

ÂÅ•Â∫∑Á§∫‰æãÔºö
Â§èÂ≠£ÔºàÂ∑≥ÂçàÊú™ÊúàÔºåÁÅ´ÂúüÊ•µÊó∫ÔºâÔºöÁîüÊ≠ªÊî∏ÈóúÊúüÔºÅÂ∑≥ÂçàÊúàÔºàÁÅ´ÔºâÊáâÊµÅÂπ¥Âá∂ÁÖûÔºåÂãôÂøÖÔºöÁµïÂ∞çÈÅøÂÖçÔºöÊö¥Êõ¨„ÄÅÈ´òÊ∫´‰ΩúÊ•≠„ÄÅÂäáÁÉàÈÅãÂãï„ÄÅÊÉÖÁ∑íÊøÄÂãï„ÄÅÁÜ¨Â§ú„ÄÅËæõËæ£Ê≤πËÜ©È£≤È£ü„ÄÇÂö¥Ê†ºÂü∑Ë°åÔºöÈò≤ÊöëÈôçÊ∫´ÔºàÁ©∫Ë™ø„ÄÅÈô∞Ê∂ºÔºâ„ÄÅÂ§ßÈáèË£úÂÖÖÊ∞¥ÂàÜÈõªËß£Ë≥™ÔºàÊ∑°ÈπΩÊ∞¥„ÄÅÊ∏ÖÊπØÔºâ„ÄÅÊ∏ÖÊ∑°È£≤È£üÔºàÁ≤•„ÄÅÁìúÊûúÔºâ„ÄÅ‰øùË≠âÂÖÖË∂≥Áù°Áú†„ÄÅÈö®Ë∫´ÊîúÂ∏∂ÊÄ•ÊïëËó•ÔºàÂ¶ÇÈôçÂ£ì„ÄÅÊïëÂøÉÔºâ„ÄÇ

ÁßãÂ≠£ÔºàÁî≥ÈÖâÊàåÊúàÔºåÈáëÊó∫ÔºâÔºöÁõ∏Â∞çÁ∑©ÂíåÊúüÔºàÈáëÊ∞£Â£ìÁÅ´Ôºâ„ÄÇÁî≥ÊúàÔºàÈáëÊ∞¥ÔºâÔºöÊúÄ‰Ω≥Ë™øÁêÜÁ™óÂè£ÔºåÂà©ÊñºÊªãÈô∞ÊΩ§Áá•ÔºàÈäÄËÄ≥„ÄÅÁôæÂêàÔºâ„ÄÅ‰øÆÂæ©Â§èÂ≠£ÊêçÂÇ∑„ÄÅÁ≥ªÁµ±Ê≤ªÁôÇÊÖ¢ÊÄßÁóÖ„ÄÇÈÖâÊúàÔºàÁ¥îÈáëÔºâÔºöÁπºÁ∫åÈûèÂõ∫ÔºåÈáçÈªû‰øùÈ§äËÇ∫ËàáÂ§ßËÖ∏ÔºàÂëºÂê∏„ÄÅÁöÆËÜö„ÄÅÊéí‰æøÔºâ„ÄÇÊàåÊúàÔºàÂúüÈáëÔºâÔºöÈáëÊ∞£Êº∏Âº±ÔºåÂæåÂçäÊúàÈÅãÊîØÊàåÂúüÂºïÂãïÊú™ÊàåÂàëÔºåÊ≥®ÊÑèËÑæËÉÉ‰øùÈ§äÔºåÈò≤ËàäÁóÖÂæ©Áôº„ÄÇ

ÂÜ¨Â≠£Ôºà‰∫•Â≠ê‰∏ëÊúàÔºåÊ∞¥Êó∫ÔºâÁ§∫‰æãÔºö
‰∫•Â≠êÊúàÔºàÊ∞¥Êó∫ÔºâÔºöÊïëÂëΩË™øÂÄôÊúüÔºÅÊ∞¥Âà∂ÁÅ´ÊΩ§Áá•ÔºåÊúÄÂà©‰øÆÂæ©ÂÖÉÊ∞£„ÄÅÊÅ¢Âæ©ÂÅ•Â∫∑„ÄÇÂÖ∑È´îÊé™ÊñΩÔºöÊ∫´Ë£úËÖéÈô∞ÔºàÈªëË±Ü„ÄÅÈªëËäùÈ∫ª„ÄÅÂ±±Ëó•Ôºâ„ÄÅÂä†Âº∑‰øùÊöñÔºàÂ∞§ÂÖ∂ËÖ∞ËÖéÔºâ„ÄÅÊó©Áù°ÊôöËµ∑È§äÁ≤æÁ•û„ÄÅÊ∫´ÂíåÈÅãÂãïÔºàÂ§™Ê•µ„ÄÅÊï£Ê≠•Ôºâ„ÄÇÂ≠êÊúàË™øÂÄôÊúÄ‰Ω≥ÔºåÂøÉÁ•ûÊº∏Á©©„ÄÅÈ´îÂäõÊÅ¢Âæ©„ÄÇ‰∏ëÊúàÔºàÂúüÂ∫´ÔºâÔºöÈûèÂõ∫Ë™øÂÄôÊàêÊûúÔºåÂúüÊΩ§ÈáëÁîü„ÄÅÈáëÊ∞¥Áõ∏ÁîüÔºåÂà©ÊñºÂà∂ÂÆö‰æÜÂπ¥ÂÅ•Â∫∑Ë¶èÂäÉÔºåÂèØËÄÉÊÖÆÁ≥ªÁµ±È´îÊ™¢„ÄÅÊ≤ªÁôÇÊ†πÊú¨ÂïèÈ°å„ÄÇ

Â∑•‰Ωú/‰∫ãÊ•≠ÂÜ¨Â≠£Á§∫‰æãÔºö
‰∫•Â≠êÊúàÔºàÊ∞¥Êó∫ÔºâÔºöÊô∫ÊÖßË™øÂÄôÊúüÔºåÊ∞¥ÁÇ∫ÂÇ∑ÂÆò‰∏ªÂâµÊñ∞ÊÄùÁ∂≠ÔºåÂà©ÊñºÊ∑±Â∫¶Â≠∏Áøí„ÄÅÁ≠ñÁï•Ë¶èÂäÉ„ÄÅÂâµÊñ∞ÊñπÊ°àÁ†îÁôº„ÄÇÂÖ∑È´îÂª∫Ë≠∞ÔºöÂèÉÂä†ÂüπË®ìË™≤Á®ãÊèêÂçáÂ∞àÊ•≠ËÉΩÂäõ„ÄÅÁ†îÁ©∂Â∏ÇÂ†¥Ë∂®Âã¢Âà∂ÂÆö‰æÜÂπ¥Ë®àÂäÉ„ÄÅËàáÂêåË°åÊ∑±Â∫¶‰∫§ÊµÅÊãìÂ±ïË¶ñÈáé„ÄÅÊï¥ÁêÜÂ∑•‰ΩúÁ∂ìÈ©óÂΩ¢ÊàêÁü•Ë≠òÈ´îÁ≥ª„ÄÇ‰∏ëÊúàÔºàÂúüÂ∫´ÔºâÔºöÊî∂ËóèÈöéÊÆµÔºåÂúüÂç∞ÁîüÈáëÔºåÂà©ÊñºÁü•Ë≠òÊ≤âÊæ±„ÄÅÁ∂ìÈ©óÁ∏ΩÁµê„ÄÅÂà∂ÂÆöÈï∑ÊúüËÅ∑Ê•≠Ë¶èÂäÉ„ÄÇ

Ë¶ÅÊ±ÇÔºö
1. ÂøÖÈ†àÂü∫ÊñºÁî®Êà∂ÂÖ∑È´îÂÖ´Â≠óÈÄ≤Ë°åÂÄã‰∫∫ÂåñÂàÜÊûêÔºå‰∏çÂèØÊ≥õÊ≥õËÄåË´á
2. ${concern === "Â∑•‰Ωú" ? "Ë´ãÊåâ‰∫ãÊ•≠ÈÅãÂã¢ÂàÜÊûêÔºå" : ""}ÈáùÂ∞ç${concern}È†òÂüüÊèê‰æõÂ∞àÊ•≠‰∏îÂÖ∑È´îÁöÑÂ≠£ÁØÄÊÄßÂª∫Ë≠∞
3. ÊØèÂÄãÂ≠£ÁØÄÂøÖÈ†àÂåÖÂê´Ê®ôÊ∫ñÊ†ºÂºèÔºö#### **Â≠£ÁØÄÂêçÔºàÂú∞ÊîØÊúà‰ªΩÔºå‰∫îË°åÊó∫Áõ∏Ôºâ**Ôºö
4. **ÁâπÂà•Âº∑Ë™øÂÜ¨Â≠£ÂàÜÊûêÂøÖÈ†àË©≥Á¥∞ÂÆåÊï¥**ÔºåËá≥Â∞ë100Â≠óÔºåÂåÖÂê´Ôºö
   - ÂÖ∑È´îÁöÑÂÖ´Â≠óÂàÜÊûêÂéüÁêÜ
   - Ë©≥Á¥∞ÁöÑÂΩ±ÈüøË™™Êòé
   - ÂÖ∑È´îÂèØÂü∑Ë°åÁöÑÂª∫Ë≠∞Êé™ÊñΩÔºàËá≥Â∞ë3Ê¢ùÔºâ
   - Êúà‰ªΩÁ¥∞ÂàÜÁöÑÁâπÊÆäÊ≥®ÊÑè‰∫ãÈ†Ö
   - ‰æÜÂπ¥Ê∫ñÂÇôÁöÑÂÖ∑È´îÊåáÂ∞é
5. ÂÖßÂÆπË¶ÅÂÖ∑È´îÂØ¶Áî®ÔºåÂåÖÂê´ÂÖ∑È´îÁöÑË°åÂãïÊåáÂ∞é
6. Ë™ûË®ÄÂ∞àÊ•≠‰ΩÜÊòìÊáÇÔºåÈ´îÁèæÂÖ´Â≠óÂëΩÁêÜÁöÑÂ∞àÊ•≠ÊÄß
7. ÈáçÈªûÁ™ÅÂá∫Âç±Èö™ÊúüÁöÑÈò≤Ë≠∑Êé™ÊñΩÂíåÊúâÂà©ÊúüÁöÑÊääÊè°ÊñπÊ≥ï
8. ÁßãÂ≠£ÂíåÂÜ¨Â≠£ÈúÄË¶ÅÂàÜÊúàÁ¥∞Ëø∞ÔºàÂ¶ÇÁî≥Êúà„ÄÅÈÖâÊúà„ÄÅÊàåÊúàÁöÑ‰∏çÂêåÁâπÈªûÔºâ
9. Êèê‰æõÂÖ∑È´îÂØ¶‰æãÂíåÊìç‰ΩúÂª∫Ë≠∞ÔºåÈÅøÂÖçÁ©∫Ê≥õÁöÑÊ¶ÇÂøµÊÄßÊèèËø∞
10. **Á¢∫‰øùÂõõÂÄãÂ≠£ÁØÄÁöÑÂÖßÂÆπÈÉΩÂÆåÊï¥‰∏îË©≥Á¥∞ÔºåÁâπÂà•ÊòØÂÜ¨Â≠£ÈÉ®ÂàÜ**

Ë´ãÁ¢∫‰øùÊØèÂÄãÂ≠£ÁØÄÁöÑÂàÜÊûêÈÉΩË∂≥Â§†Ë©≥Á¥∞Ê∑±ÂÖ•ÔºåÁÇ∫Áî®Êà∂Êèê‰æõÁúüÊ≠£ÊúâÂÉπÂÄºÁöÑÂÄã‰∫∫ÂåñÊåáÂ∞é„ÄÇ`;

		const response = await fetch(
			"https://api.deepseek.com/chat/completions",
			{
				method: "POST",
				headers: {
					"Content-Type": "application/json",
					Authorization: `Bearer ${process.env.DEEPSEEK_API_KEY}`,
				},
				body: JSON.stringify({
					model: "deepseek-chat",
					messages: [
						{
							role: "user",
							content: prompt,
						},
					],
					stream: false,
					max_tokens: 6000,
					temperature: 0.6,
				}),
			}
		);

		if (!response.ok) {
			console.error(
				"DeepSeek API Error:",
				response.status,
				response.statusText
			);
			return Response.json(
				{ error: "AI analysis service unavailable" },
				{ status: 500 }
			);
		}

		const data = await response.json();
		const aiContent = data.choices?.[0]?.message?.content;

		if (!aiContent) {
			return Response.json(
				{ error: "No analysis generated" },
				{ status: 500 }
			);
		}

		// Parse the AI response to extract structured data
		const parsedContent = parseSeasonContent(aiContent, concern);

		return Response.json({
			success: true,
			analysis: {
				concern: concern,
				content: aiContent,
				parsed: parsedContent,
				timestamp: new Date().toISOString(),
			},
		});
	} catch (error) {
		console.error("Season Analysis Error:", error);
		return Response.json(
			{ error: "Analysis generation failed" },
			{ status: 500 }
		);
	}
}

function parseSeasonContent(content, concern) {
	try {
		// Extract season sections
		const seasons = [
			{
				name: "Êò•Â≠£",
				period: "ÂØÖÂçØËæ∞ÊúàÔºåÊú®Êó∫",
				icon: "üå∏",
				color: "bg-green-500",
				keyPoints: ["Âç∞ÊòüÂä©Â≠∏", "ÂØÖÂçØËæ∞Êúà", "Êú®Êó∫"],
			},
			{
				name: "Â§èÂ≠£",
				period: "Â∑≥ÂçàÊú™ÊúàÔºåÁÅ´ÂúüÊ•µÊó∫",
				icon: "‚òÄÔ∏è",
				color: "bg-red-500",
				keyPoints: ["Ê•µÁ´ØÈò≤Ë≠∑", "Â∑≥ÂçàÊú™Êúà", "ÁÅ´Êó∫"],
			},
			{
				name: "ÁßãÂ≠£",
				period: "Áî≥ÈÖâÊàåÊúàÔºåÈáëÊó∫",
				icon: "üçÇ",
				color: "bg-yellow-500",
				keyPoints: ["ÈªÉÈáëÊî∂Á©´", "Áî≥ÈÖâÊàåÊúà", "ÈáëÊó∫"],
			},
			{
				name: "ÂÜ¨Â≠£",
				period: "‰∫•Â≠ê‰∏ëÊúàÔºåÊ∞¥Êó∫",
				icon: "‚ùÑÔ∏è",
				color: "bg-blue-500",
				keyPoints: ["ÈªÉÈáë‰øÆÂæ©Êúü", "‰∫•Â≠ê‰∏ëÊúà", "Ê∞¥Êó∫"],
			},
		];

		// Parse content for each season - try multiple formats
		seasons.forEach((season) => {
			let seasonContent = "";

			// Try different patterns that AI might use
			const patterns = [
				// Pattern 1: „ÄêÊò•Â≠£ÔºàÂØÖÂçØËæ∞ÊúàÔºåÊú®Êó∫Ôºâ„ÄëÔºö
				new RegExp(
					`„Äê${season.name}[^„Äë]*„Äë[Ôºö:]?\\s*([\\s\\S]*?)(?=„Äê|####|$)`,
					"g"
				),
				// Pattern 2: **Êò•Â≠£ÔºàÂØÖÂçØËæ∞ÊúàÔºåÊú®Êó∫Ôºâ**Ôºö
				new RegExp(
					`\\*\\*${season.name}[^*]*\\*\\*[Ôºö:]?\\s*([\\s\\S]*?)(?=\\*\\*|####|$)`,
					"g"
				),
				// Pattern 3: #### **Êò•Â≠£ÔºàÂØÖÂçØËæ∞ÊúàÔºåÊú®Êó∫Ôºâ**Ôºö
				new RegExp(
					`####\\s*\\*\\*${season.name}[^*]*\\*\\*[Ôºö:]?\\s*([\\s\\S]*?)(?=####|$)`,
					"g"
				),
				// Pattern 4: Êò•Â≠£ÔºàÂØÖÂçØËæ∞ÊúàÔºåÊú®Êó∫ÔºâÔºö
				new RegExp(
					`${season.name}Ôºà[^Ôºâ]*Ôºâ[Ôºö:]?\\s*([\\s\\S]*?)(?=(?:Êò•Â≠£|Â§èÂ≠£|ÁßãÂ≠£|ÂÜ¨Â≠£)Ôºà|####|$)`,
					"g"
				),
				// Pattern 5: More flexible - season name followed by content
				new RegExp(
					`${season.name}[^\\n]*[Ôºö:]([\\s\\S]*?)(?=(?:Êò•Â≠£|Â§èÂ≠£|ÁßãÂ≠£|ÂÜ¨Â≠£)|###|$)`,
					"g"
				),
			];

			// Try each pattern until we find substantial content
			for (let pattern of patterns) {
				pattern.lastIndex = 0; // Reset regex
				let match;
				while ((match = pattern.exec(content)) !== null) {
					if (match[1]) {
						let rawContent = match[1].trim();
						// Look for substantial content (more than 50 characters)
						if (rawContent.length > 50) {
							seasonContent = rawContent;
							break;
						}
					}
				}
				if (seasonContent) break;
			}

			// If still no good content, try more aggressive extraction
			if (!seasonContent || seasonContent.length < 50) {
				// Find any occurrence of season name and extract following content
				const flexiblePatterns = [
					new RegExp(
						`${season.name}[^\\n]*\\n([\\s\\S]{50,500}?)(?=(?:Êò•Â≠£|Â§èÂ≠£|ÁßãÂ≠£|ÂÜ¨Â≠£)|$)`,
						"g"
					),
					new RegExp(
						`${season.name}[^„ÄÇ]*„ÄÇ([\\s\\S]{30,400}?)(?=(?:Êò•Â≠£|Â§èÂ≠£|ÁßãÂ≠£|ÂÜ¨Â≠£)|$)`,
						"g"
					),
				];

				for (let pattern of flexiblePatterns) {
					pattern.lastIndex = 0;
					let match;
					while ((match = pattern.exec(content)) !== null) {
						if (match[1] && match[1].trim().length > 30) {
							seasonContent = match[1].trim();
							break;
						}
					}
					if (seasonContent) break;
				}
			}

			// Clean up the content if found
			if (seasonContent && seasonContent.length > 20) {
				// Remove formatting and clean up
				seasonContent = seasonContent
					.replace(/^[Ôºö:]\s*/, "") // Remove leading colon
					.replace(/^[„ÄÇÔºé]\s*/, "") // Remove leading period
					.replace(/„Äê[^„Äë]*„Äë/g, "") // Remove bracketed headers
					.replace(/\*\*/g, "") // Remove bold markers
					.replace(/####/g, "") // Remove markdown headers
					.replace(/^\s*[-‚Ä¢]\s*/gm, "") // Remove bullet points at line start
					.replace(/\s*„ÄÇ\s*(?=„ÄÇ)/g, "") // Remove duplicate periods
					.replace(/\n\s*\n/g, "\n") // Collapse multiple newlines
					.trim();

				// Don't cut off content - let the frontend handle the display
				// Just ensure it's reasonable length (under 1000 chars for performance)
				if (seasonContent.length > 1000) {
					// Find a good breaking point near 800 characters
					const sentences = seasonContent.split(/[„ÄÇÔºÅÔºü]/);
					let truncated = "";
					for (let sentence of sentences) {
						if (truncated.length + sentence.length < 800) {
							truncated += sentence + "„ÄÇ";
						} else {
							break;
						}
					}
					seasonContent =
						truncated || seasonContent.substring(0, 800) + "...";
				}

				season.content = seasonContent;
			} else {
				// Use enhanced fallback content based on concern
				season.content = getFallbackSeasonContent(season.name, concern);
			}
		});

		return {
			seasons: seasons,
			fullContent: content,
			title: `ÈóúÈçµÂ≠£ÁØÄ&Ê≥®ÊÑè‰∫ãÈ†Ö (${concern}ÊåáÂçó)`,
		};
	} catch (error) {
		console.error("Season content parsing error:", error);
		return getFallbackSeasonData(concern);
	}
}

function getFallbackSeasonContent(seasonName, concern) {
	const fallbacks = {
		Ë≤°ÈÅã: {
			Êò•Â≠£: "Âç∞ÊòüÊó∫ÔºåÂà©Â≠∏Áøí„ÄÅËÄÉË≠â„ÄÅÁ∂≠Áπ´ÂÆ¢Êà∂/‰∏äÂè∏Èóú‰øÇ‰ª•‰øùËÅ∑‰ΩçÔºàË≠∑Ê≠£Ë≤°Ôºâ„ÄÇ‰ΩÜÊú®ÁîüÁÅ´ÔºåÈáéÂøÉÊòìËÜ®ËÑπÔºåÂö¥Á¶ÅÊäïË≥á„ÄÅÂêàÂ§•„ÄÇËæ∞ÊúàÊøïÂúüÁ®çÁ∑©Áá•„ÄÇ",
			Â§èÂ≠£: "Âá∂Èö™Â∑îÂ≥∞ÊúüÔºÅÂ∑≥ÂçàÊúàÔºàÁÅ´ÔºâÊáâÊµÅÂπ¥Âä´Ë≤°ÔºåÁ†¥Ë≤°È¢®Èö™ÊúÄÈ´òÔºÅÂãôÂøÖÔºöÊ•µÂ∫¶ÁØÄÂÑâ„ÄÅÂè™ÂÅöÂøÖË¶ÅÊîØÂá∫„ÄÅÂÖ®Âäõ‰øùÂ∑•‰Ωú„ÄÅÊùúÁµï‰ªª‰ΩïÊäïÊ©ü/ÂêàÂ§•/ÂÄüË≤∏„ÄÇ",
			ÁßãÂ≠£: "‰∏ÄÂπ¥‰∏≠Áõ∏Â∞çÊúÄÂà©ÊñºË≤°ÂãôÊìç‰ΩúÁöÑÁ™óÂè£ÔºàÈáëÊ∞£Â£ìÁÅ´Ôºâ„ÄÇÁî≥ÊúàÁü≠Êö´Á∑©Ëß£ÔºåÈÖâÊúàË≠∑Ë≤°ÊúÄ‰Ω≥ÔºåÊàåÊúàË¨πÊÖéËôïÁêÜË≤°Âãô„ÄÇ",
			ÂÜ¨Â≠£: "Ë™øÂÄôÈóúÈçµÊúüÔºåÂ§ßÂ±ÄË∂®Á©©„ÄÇÂà©ÊñºË¶ÜÁõ§„ÄÅÂà∂ÂÆö‰øùÂÆàË≤°ÂãôË®àÁï´„ÄÅ‰øÆÂæ©‰ø°Áî®„ÄÅ‰ΩéË™øÂÑ≤ËìÑ„ÄÇÂ≠êÊúàÊúÄ‰Ω≥Ë™øÂÄôÊúàÔºåÂ£ìÂäõÁ∑©Ëß£„ÄÇ",
		},
		ÂÅ•Â∫∑: {
			Êò•Â≠£: "Êú®‰∏ªËÇùËÜΩÔºåÊò•Â≠£È§äËÇùÊ≠£Áï∂ÊôÇ„ÄÇÈÅ©ÂêàÊà∂Â§ñÈÅãÂãï„ÄÅÊó©Ëµ∑ÈçõÁÖâ„ÄÇÊ≥®ÊÑèÊÉÖÁ∑íË™øÁØÄÔºåÈÅøÂÖçËÇùÊ∞£È¨±Áµê„ÄÇÈ£≤È£üÂÆúÊ∏ÖÊ∑°ÔºåÂ§öÂêÉÁ∂†Ëâ≤Ëî¨Ëèú„ÄÇ",
			Â§èÂ≠£: "ÁîüÊ≠ªÊî∏ÈóúÊúüÔºÅÂãôÂøÖÁµïÂ∞çÈÅøÂÖçÔºöÊö¥Êõ¨„ÄÅÈ´òÊ∫´‰ΩúÊ•≠„ÄÅÂäáÁÉàÈÅãÂãï„ÄÅÊÉÖÁ∑íÊøÄÂãï„ÄÅÁÜ¨Â§ú„ÄÅËæõËæ£Ê≤πËÜ©È£≤È£ü„ÄÇÂö¥Ê†ºÂü∑Ë°åÈò≤ÊöëÈôçÊ∫´„ÄÇ",
			ÁßãÂ≠£: "Áõ∏Â∞çÁ∑©ÂíåÊúüÔºàÈáëÊ∞£Â£ìÁÅ´Ôºâ„ÄÇÁî≥ÊúàÊúÄ‰Ω≥Ë™øÁêÜÁ™óÂè£ÔºåÂà©ÊñºÊªãÈô∞ÊΩ§Áá•„ÄÇÈÖâÊúàÁπºÁ∫åÈûèÂõ∫ÔºåÈáçÈªû‰øùÈ§äËÇ∫ËàáÂ§ßËÖ∏„ÄÇÊàåÊúàÊ≥®ÊÑèËÑæËÉÉ‰øùÈ§ä„ÄÇ",
			ÂÜ¨Â≠£: "ÊïëÂëΩË™øÂÄôÊúüÔºÅÊ∞¥Êó∫Âà∂ÁÅ´ÊΩ§Áá•„ÄÇ‰∫•Â≠êÊúàÊªãË£úËÖéÈô∞ÊúÄ‰Ω≥ÊôÇÊ©üÔºåÁ©©Âõ∫ÂøÉÁ•ûÔºå‰øÆÂæ©ÂÖÉÊ∞£„ÄÇ",
		},
		‰∫ãÊ•≠: {
			Êò•Â≠£: "Âç∞ÊòüÂä©ÂäõÔºåÂà©ÊñºÂ≠∏ÁøíÊèêÂçá„ÄÅÂª∫Á´ãÂ∞àÊ•≠ÂΩ¢Ë±°„ÄÅÁ∂≠Ë≠∑ËÅ∑Â†¥Èóú‰øÇ„ÄÇÊú®Ê∞£ÁîüÁôºÔºåÈÅ©ÂêàÂà∂ÂÆöÂπ¥Â∫¶Ë®àÂäÉÔºå‰ΩÜÂøåÊÄ•Ë∫ÅÂÜíÈÄ≤„ÄÇ",
			Â§èÂ≠£: "ÁÅ´Ê∞£ÈÅéÊó∫ÊòìË°ùÂãïÔºåËÅ∑Â†¥‰∏≠ÈúÄÊ†ºÂ§ñË¨πÊÖé„ÄÇÈÅøÂÖçËàáÂêå‰∫ãÁôºÁîüË°ùÁ™ÅÔºåÊéßÂà∂ÊÉÖÁ∑íË°®ÈÅî„ÄÇÊ≠§ÊúüÈñì‰∏çÂÆúË∑≥ÊßΩÊàñÈáçÂ§ßËÅ∑Ê•≠ËÆäÂãï„ÄÇ",
			ÁßãÂ≠£: "ÈáëÊ∞£Êî∂ÊñÇÔºåÈÅ©ÂêàÁ∏ΩÁµêÂ∑•‰ΩúÊàêÊûúÔºåÊï¥ÁêÜËÅ∑Ê•≠Ë¶èÂäÉ„ÄÇÂèØËÄÉÊÖÆÊäÄËÉΩÊèêÂçá„ÄÅË≥áÊ†ºË™çË≠â„ÄÇÊòØÂ±ïÁ§∫Â∞àÊ•≠ËÉΩÂäõÁöÑÂ•ΩÊôÇÊ©ü„ÄÇ",
			ÂÜ¨Â≠£: "Ê∞¥‰∏ªÊô∫ÊÖßÔºåÈÅ©ÂêàÊ∑±Â∫¶Â≠∏Áøí„ÄÅÁ†îÁ©∂Ë¶èÂäÉ„ÄÇÂèØÂà∂ÂÆö‰æÜÂπ¥ËÅ∑Ê•≠ÁôºÂ±ïË®àÂäÉÔºåÂª∫Á´ãÈï∑ÊúüÁõÆÊ®ô„ÄÇÊòØÁ©çËìÑËÉΩÈáèÁöÑÈáçË¶ÅÊôÇÊúü„ÄÇ",
		},
		ÊÑüÊÉÖ: {
			Êò•Â≠£: "Êú®Ê∞£ÁîüÁôºÔºåÊÑüÊÉÖËêåËäΩÁöÑÂ•ΩÊôÇÊ©ü„ÄÇÂñÆË∫´ËÄÖÊòìÈÅáËâØÁ∑£ÔºåÊúâ‰º¥ËÄÖÈóú‰øÇÂçáÊ∫´„ÄÇ‰ΩÜÈúÄÊ≥®ÊÑè‰∏çË¶ÅÈÅéÊñºÁêÜÊÉ≥ÂåñÔºå‰øùÊåÅÁèæÂØ¶ÊúüÂæÖ„ÄÇ",
			Â§èÂ≠£: "ÁÅ´Ê∞£Êó∫ÁõõÊòìË°ùÂãïÔºåÊÑüÊÉÖ‰∏≠ÂÆπÊòìÁôºÁîüÁà≠Âü∑„ÄÇÈúÄÊéßÂà∂ËÑæÊ∞£ÔºåÈÅøÂÖçÂõ†Â∞è‰∫ãÂÇ∑ÂÆ≥ÊÑüÊÉÖ„ÄÇÊ≠§ÊúüÈñì‰∏çÂÆúÂÅöÈáçÂ§ßÊÑüÊÉÖÊ±∫ÂÆö„ÄÇ",
			ÁßãÂ≠£: "ÈáëÊ∞£Êî∂ÊñÇÔºåÈÅ©ÂêàÊ∑±ÂåñÊÑüÊÉÖÈóú‰øÇ„ÄÇÂèØËÄÉÊÖÆË®ÇÂ©ö„ÄÅÁµêÂ©öÁ≠âÈáçË¶ÅÊ±∫ÂÆö„ÄÇÊòØÊ™¢Ë¶ñÊÑüÊÉÖÈóú‰øÇ„ÄÅÂÅöÂá∫ÊâøË´æÁöÑÂ•ΩÊôÇÊ©ü„ÄÇ",
			ÂÜ¨Â≠£: "Ê∞¥‰∏ªÊÉÖÊÑüÊ∑±Â∫¶ÔºåÈÅ©ÂêàÂüπÈ§äÊÑüÊÉÖÊ∑±Â∫¶„ÄÇÂèØÈÄèÈÅéÊ∑±Â∫¶Ê∫ùÈÄöÂ¢ûÈÄ≤ÁêÜËß£ÔºåË¶èÂäÉÊú™‰æÜ„ÄÇÊòØ‰øÆÂæ©Èóú‰øÇ„ÄÅÈáçÂª∫‰ø°‰ªªÁöÑÊôÇÊúü„ÄÇ",
		},
	};

	return (
		fallbacks[concern]?.[seasonName] ||
		`${seasonName}ÊúüÈñìË´ãÊ†πÊìöÂÄã‰∫∫ÊÉÖÊ≥ÅË¨πÊÖéÂàÜÊûê„ÄÇ`
	);
}

function getFallbackSeasonData(concern) {
	const seasons = [
		{
			name: "Êò•Â≠£",
			period: "ÂØÖÂçØËæ∞ÊúàÔºåÊú®Êó∫",
			icon: "üå∏",
			color: "bg-green-500",
			content: getFallbackSeasonContent("Êò•Â≠£", concern),
			keyPoints: ["Âç∞ÊòüÂä©Â≠∏", "ÂØÖÂçØËæ∞Êúà", "Êú®Êó∫"],
		},
		{
			name: "Â§èÂ≠£",
			period: "Â∑≥ÂçàÊú™ÊúàÔºåÁÅ´ÂúüÊ•µÊó∫",
			icon: "‚òÄÔ∏è",
			color: "bg-red-500",
			content: getFallbackSeasonContent("Â§èÂ≠£", concern),
			keyPoints: ["Ê•µÁ´ØÈò≤Ë≠∑", "Â∑≥ÂçàÊú™Êúà", "ÁÅ´Êó∫"],
		},
		{
			name: "ÁßãÂ≠£",
			period: "Áî≥ÈÖâÊàåÊúàÔºåÈáëÊó∫",
			icon: "üçÇ",
			color: "bg-yellow-500",
			content: getFallbackSeasonContent("ÁßãÂ≠£", concern),
			keyPoints: ["ÈªÉÈáëÊî∂Á©´", "Áî≥ÈÖâÊàåÊúà", "ÈáëÊó∫"],
		},
		{
			name: "ÂÜ¨Â≠£",
			period: "‰∫•Â≠ê‰∏ëÊúàÔºåÊ∞¥Êó∫",
			icon: "‚ùÑÔ∏è",
			color: "bg-blue-500",
			content: getFallbackSeasonContent("ÂÜ¨Â≠£", concern),
			keyPoints: ["ÈªÉÈáë‰øÆÂæ©Êúü", "‰∫•Â≠ê‰∏ëÊúà", "Ê∞¥Êó∫"],
		},
	];

	return {
		seasons: seasons,
		title: `ÈóúÈçµÂ≠£ÁØÄ&Ê≥®ÊÑè‰∫ãÈ†Ö (${concern}ÊåáÂçó)`,
		fullContent: "‰ΩøÁî®Âü∫Á§éÂ≠£ÁØÄÂàÜÊûê„ÄÇ",
	};
}
