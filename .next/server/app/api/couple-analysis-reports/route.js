(()=>{var e={};e.id=5863,e.ids=[5863],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},56037:e=>{"use strict";e.exports=require("mongoose")},56364:(e,t,r)=>{"use strict";r.d(t,{A:()=>l,X:()=>o});var i=r(56037),s=r.n(i);let n=process.env.MONGODB_URI;if(!n)throw Error("Please define the MONGODB_URI environment variable inside .env");let a=global.mongoose;async function o(){if(a.conn)return a.conn;a.promise||(a.promise=s().connect(n,{serverSelectionTimeoutMS:3e4,socketTimeoutMS:3e4}).then(e=>e).catch(e=>{throw e}));try{a.conn=await a.promise}catch(e){throw a.promise=null,e}return a.conn}a||(a=global.mongoose={conn:null,promise:null});let l=o},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63046:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});var i=r(56037),s=r.n(i);let n=new(s()).Schema({userId:{type:String,required:!0,index:!0},sessionId:{type:String,required:!0,index:!0},language:{type:String,required:!0,default:"zh-CN"},isDeleted:{type:Number,default:0,index:!0},userProfile:{birthday:{type:Date,required:!0},gender:{type:String,enum:["male","female"],required:!0},element:String,personality:String,loveStyle:String,baziPillars:[String],dayMasterElement:String},partnerProfile:{birthday:{type:Date,required:!0},gender:{type:String,enum:["male","female"],required:!0},element:String,personality:String,loveStyle:String,baziPillars:[String],dayMasterElement:String},compatibilityAnalysis:{overallScore:{type:Number,required:!0,min:0,max:100},compatibilityLevel:String,elementInteraction:String,relationshipAdvice:String,developmentAdvice:String,specificAdvice:String,strengthsAndChallenges:{strengths:[String],challenges:[String]}},problemAnalysis:{originalProblem:String,problemCategory:String,categoryType:{type:String,enum:["emotion_cooling","special_situation","taboo_breaking"]},keyIssues:[String],rootCauses:[String]},solutions:{emotionCooling:{chartDiagnosis:{diagnosis:String,keyFindings:[String],recommendations:[String]},emergencyFengShui:{urgentActions:[String],placements:[String],colors:[String]},restartChemistry:{methods:[String],timing:String,activities:[String]}},specialSituation:{starChartGuidance:{guidance:String,favorablePeriods:[String],strategies:[String]},fengShuiTransformation:{transformations:[String],environmentChanges:[String],energyAdjustments:[String]},relationshipMethod:{methods:[String],communication:[String],principles:[String]}},tabooBreaking:{keyAnalysis:{analysis:String,taboos:[String],patterns:[String]},targetedSuggestions:{suggestions:[String],scripts:[String],timing:[String]},restartChemistry:{methods:[String],healingProcess:[String],preventiveMeasures:[String]}}},yearlyFortune:{currentYear:String,bestTiming:String,warnings:String,monthlyGuidance:[{month:String,fortune:String,advice:String}]},fengShuiLayout:{bedroom:String,livingRoom:String,colors:String,items:String,generalAdvice:String,specificPlacements:[{area:String,item:String,placement:String,purpose:String}]},analysisDetails:{wuxingAnalysis:{userElements:{strong:[String],weak:[String],balanced:[String]},partnerElements:{strong:[String],weak:[String],balanced:[String]},interaction:String},usefulGods:[String],tabooElements:[String],luckyDirections:[String],luckyNumbers:[Number]},reportMetadata:{concern:{type:String,default:"感情"},reportType:{type:String,default:"couple_analysis"},analysisDepth:{type:String,enum:["basic","standard","comprehensive"],default:"comprehensive"},version:{type:String,default:"2.0"},generatedAt:{type:Date,default:Date.now},updatedAt:Date,deletedAt:Date}},{timestamps:!0,indexes:[{userId:1,isDeleted:1},{sessionId:1},{createdAt:-1},{"reportMetadata.generatedAt":-1},{"problemAnalysis.categoryType":1},{"compatibilityAnalysis.overallScore":-1}]});n.methods.getFormattedReport=function(){return{title:"增強版合婚配對分析報告",reportId:this._id,userElement:this.userProfile.element,partnerElement:this.partnerProfile.element,compatibility:this.compatibilityAnalysis.overallScore,problemCategory:this.problemAnalysis.categoryType,solutionType:this.getSolutionType(),reportDate:this.reportMetadata.generatedAt,version:this.reportMetadata.version}},n.methods.getSolutionType=function(){switch(this.problemAnalysis.categoryType){case"emotion_cooling":return"感情降溫類解決方案";case"special_situation":return"特殊情境類解決方案";case"taboo_breaking":return"禁忌破解話術解決方案";default:return"綜合解決方案"}},n.statics.findByUserId=function(e,t={}){let r=t.sort||{createdAt:-1},i=t.limit||10;return this.find({userId:e,isDeleted:0}).sort(r).limit(i)},n.statics.getReportStats=async function(e){return await this.aggregate([{$match:{userId:e,isDeleted:0}},{$group:{_id:"$problemAnalysis.categoryType",count:{$sum:1},avgScore:{$avg:"$compatibilityAnalysis.overallScore"},latestReport:{$max:"$createdAt"}}}])},n.pre("save",function(e){this.isModified()&&!this.isNew&&(this.reportMetadata.updatedAt=new Date),e()});let a=s().models.CoupleAnalysisReport||s().model("CoupleAnalysisReport",n)},78335:()=>{},91390:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>S,routeModule:()=>p,serverHooks:()=>m,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>d});var i={};r.r(i),r.d(i,{GET:()=>g,POST:()=>c});var s=r(96559),n=r(48088),a=r(37719),o=r(32190),l=r(56364),u=r(63046);async function c(e){try{await (0,l.A)();let t=await e.json();if(console.log("\uD83D\uDCDD Creating new couple analysis report:",{userId:t.userId,sessionId:t.sessionId,reportType:t.reportType}),!t.userId||!t.sessionId)return o.NextResponse.json({success:!1,error:"userId and sessionId are required"},{status:400});if(!t.userProfile?.birthday||!t.partnerProfile?.birthday)return o.NextResponse.json({success:!1,error:"Both user and partner birthdays are required"},{status:400});let r=new u.A({userId:t.userId,sessionId:t.sessionId,language:t.language||"zh-CN",userProfile:{birthday:new Date(t.userProfile.birthday),gender:t.userProfile.gender||"male",element:t.userProfile.element,personality:t.userProfile.personality,loveStyle:t.userProfile.loveStyle,baziPillars:t.userProfile.baziPillars||[],dayMasterElement:t.userProfile.dayMasterElement},partnerProfile:{birthday:new Date(t.partnerProfile.birthday),gender:t.partnerProfile.gender||"female",element:t.partnerProfile.element,personality:t.partnerProfile.personality,loveStyle:t.partnerProfile.loveStyle,baziPillars:t.partnerProfile.baziPillars||[],dayMasterElement:t.partnerProfile.dayMasterElement},compatibilityAnalysis:{overallScore:t.compatibilityAnalysis?.overallScore||75,compatibilityLevel:t.compatibilityAnalysis?.compatibilityLevel,elementInteraction:t.compatibilityAnalysis?.elementInteraction,relationshipAdvice:t.compatibilityAnalysis?.relationshipAdvice,developmentAdvice:t.compatibilityAnalysis?.developmentAdvice,specificAdvice:t.compatibilityAnalysis?.specificAdvice,strengthsAndChallenges:t.compatibilityAnalysis?.strengthsAndChallenges},problemAnalysis:{originalProblem:t.problemAnalysis?.originalProblem,problemCategory:t.problemAnalysis?.problemCategory,categoryType:t.problemAnalysis?.categoryType,keyIssues:t.problemAnalysis?.keyIssues||[],rootCauses:t.problemAnalysis?.rootCauses||[]},solutions:{emotionCooling:{chartDiagnosis:t.solutions?.emotionCooling?.chartDiagnosis,emergencyFengShui:t.solutions?.emotionCooling?.emergencyFengShui,restartChemistry:t.solutions?.emotionCooling?.restartChemistry},specialSituation:{starChartGuidance:t.solutions?.specialSituation?.starChartGuidance,fengShuiTransformation:t.solutions?.specialSituation?.fengShuiTransformation,relationshipMethod:t.solutions?.specialSituation?.relationshipMethod},tabooBreaking:{keyAnalysis:t.solutions?.tabooBreaking?.keyAnalysis,targetedSuggestions:t.solutions?.tabooBreaking?.targetedSuggestions,restartChemistry:t.solutions?.tabooBreaking?.restartChemistry}},yearlyFortune:{currentYear:t.yearlyFortune?.currentYear,bestTiming:t.yearlyFortune?.bestTiming,warnings:t.yearlyFortune?.warnings,monthlyGuidance:t.yearlyFortune?.monthlyGuidance||[]},fengShuiLayout:{bedroom:t.fengShuiLayout?.bedroom,livingRoom:t.fengShuiLayout?.livingRoom,colors:t.fengShuiLayout?.colors,items:t.fengShuiLayout?.items,generalAdvice:t.fengShuiLayout?.generalAdvice,specificPlacements:t.fengShuiLayout?.specificPlacements||[]},analysisDetails:{wuxingAnalysis:t.analysisDetails?.wuxingAnalysis,usefulGods:t.analysisDetails?.usefulGods||[],tabooElements:t.analysisDetails?.tabooElements||[],luckyDirections:t.analysisDetails?.luckyDirections||[],luckyNumbers:t.analysisDetails?.luckyNumbers||[]},reportMetadata:{concern:t.reportMetadata?.concern||"感情",reportType:t.reportMetadata?.reportType||"couple_analysis",analysisDepth:t.reportMetadata?.analysisDepth||"comprehensive",generatedAt:new Date,version:"2.0"}}),i=await r.save();return console.log("✅ Couple analysis report saved successfully!"),console.log("\uD83D\uDCC4 Report ID:",i._id),console.log("\uD83D\uDC65 Users:",{user:t.userProfile.gender,partner:t.partnerProfile.gender}),console.log("\uD83C\uDFAF Problem Category:",t.problemAnalysis?.categoryType),console.log("\uD83D\uDCAF Compatibility Score:",i.compatibilityAnalysis.overallScore),o.NextResponse.json({success:!0,reportId:i._id.toString(),message:"Couple analysis report created successfully",data:{reportId:i._id,compatibilityScore:i.compatibilityAnalysis.overallScore,problemCategory:i.problemAnalysis.categoryType,createdAt:i.createdAt}})}catch(e){if(console.error("❌ Failed to save couple analysis report:",e),"ValidationError"===e.name)return console.error("Validation errors:",e.errors),o.NextResponse.json({success:!1,error:"Validation failed",details:Object.keys(e.errors).map(t=>({field:t,message:e.errors[t].message}))},{status:400});return o.NextResponse.json({success:!1,error:"Failed to save couple analysis report",message:e.message},{status:500})}}async function g(e){try{await (0,l.A)();let{searchParams:t}=new URL(e.url),r=t.get("userId"),i=t.get("sessionId"),s=parseInt(t.get("page"))||1,n=parseInt(t.get("limit"))||10,a=(s-1)*n,c={};r&&(c.userId=r),i&&(c.sessionId=i),console.log("\uD83D\uDD0D Fetching couple analysis reports:",{query:c,page:s,limit:n});let g=await u.A.find(c).sort({createdAt:-1}).skip(a).limit(n).select("_id userId sessionId compatibilityAnalysis.overallScore problemAnalysis.categoryType reportMetadata createdAt"),p=await u.A.countDocuments(c);return console.log(`📊 Found ${g.length} reports (${p} total)`),o.NextResponse.json({success:!0,reports:g,pagination:{page:s,limit:n,totalReports:p,totalPages:Math.ceil(p/n),hasNextPage:s<Math.ceil(p/n),hasPrevPage:s>1}})}catch(e){return console.error("❌ Failed to fetch couple analysis reports:",e),o.NextResponse.json({success:!1,error:"Failed to fetch reports",message:e.message},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/couple-analysis-reports/route",pathname:"/api/couple-analysis-reports",filename:"route",bundlePath:"app/api/couple-analysis-reports/route"},resolvedPagePath:"/Users/michaelng/Desktop/HarmoniqFengShui/FengShuiLayout/src/app/api/couple-analysis-reports/route.js",nextConfigOutput:"",userland:i}),{workAsyncStorage:y,workUnitAsyncStorage:d,serverHooks:m}=p;function S(){return(0,a.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:d})}},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[7719,580],()=>r(91390));module.exports=i})();