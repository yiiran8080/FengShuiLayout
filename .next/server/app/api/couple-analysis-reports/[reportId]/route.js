(()=>{var e={};e.id=3053,e.ids=[3053],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12518:e=>{"use strict";e.exports=require("mongodb")},16441:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>m,serverHooks:()=>f,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>S});var s={};r.r(s),r.d(s,{DELETE:()=>g,GET:()=>p,PUT:()=>d});var n=r(96559),i=r(48088),o=r(37719),a=r(32190),l=r(56364),u=r(63046),c=r(12518);async function p(e,{params:t}){try{await (0,l.A)();let{reportId:e}=await t;if(!e)return a.NextResponse.json({success:!1,error:"Report ID is required"},{status:400});if(console.log("\uD83D\uDD0D Fetching couple analysis report:",e),!c.ObjectId.isValid(e))return a.NextResponse.json({success:!1,error:"Invalid report ID format"},{status:400});let r=await u.A.findById(e);if(!r)return console.log("❌ Report not found:",e),a.NextResponse.json({success:!1,error:"Report not found"},{status:404});return console.log("✅ Report found successfully!"),console.log("\uD83D\uDCCA Report details:",{id:r._id,userId:r.userId,sessionId:r.sessionId,compatibilityScore:r.compatibilityAnalysis?.overallScore,problemCategory:r.problemAnalysis?.categoryType,createdAt:r.createdAt}),a.NextResponse.json({success:!0,report:r})}catch(e){return console.error("❌ Failed to fetch couple analysis report:",e),a.NextResponse.json({success:!1,error:"Failed to fetch report",message:e.message},{status:500})}}async function d(e,{params:t}){try{await (0,l.A)();let{reportId:r}=await t,s=await e.json();if(!r)return a.NextResponse.json({success:!1,error:"Report ID is required"},{status:400});if(console.log("\uD83D\uDCDD Updating couple analysis report:",r),!c.ObjectId.isValid(r))return a.NextResponse.json({success:!1,error:"Invalid report ID format"},{status:400});let n=await u.A.findByIdAndUpdate(r,{...s,"reportMetadata.updatedAt":new Date},{new:!0,runValidators:!0});if(!n)return a.NextResponse.json({success:!1,error:"Report not found"},{status:404});return console.log("✅ Report updated successfully!"),a.NextResponse.json({success:!0,report:n,message:"Report updated successfully"})}catch(e){if(console.error("❌ Failed to update couple analysis report:",e),"ValidationError"===e.name)return a.NextResponse.json({success:!1,error:"Validation failed",details:Object.keys(e.errors).map(t=>({field:t,message:e.errors[t].message}))},{status:400});return a.NextResponse.json({success:!1,error:"Failed to update report",message:e.message},{status:500})}}async function g(e,{params:t}){try{await (0,l.A)();let{reportId:e}=await t;if(!e)return a.NextResponse.json({success:!1,error:"Report ID is required"},{status:400});if(console.log("\uD83D\uDDD1️ Soft deleting couple analysis report:",e),!c.ObjectId.isValid(e))return a.NextResponse.json({success:!1,error:"Invalid report ID format"},{status:400});let r=await u.A.findByIdAndUpdate(e,{isDeleted:1,"reportMetadata.deletedAt":new Date},{new:!0});if(!r)return a.NextResponse.json({success:!1,error:"Report not found"},{status:404});return console.log("✅ Report soft deleted successfully!"),a.NextResponse.json({success:!0,message:"Report deleted successfully",reportId:r._id})}catch(e){return console.error("❌ Failed to delete couple analysis report:",e),a.NextResponse.json({success:!1,error:"Failed to delete report",message:e.message},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/couple-analysis-reports/[reportId]/route",pathname:"/api/couple-analysis-reports/[reportId]",filename:"route",bundlePath:"app/api/couple-analysis-reports/[reportId]/route"},resolvedPagePath:"/Users/michaelng/Desktop/HarmoniqFengShui/FengShuiLayout/src/app/api/couple-analysis-reports/[reportId]/route.js",nextConfigOutput:"",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:S,serverHooks:f}=m;function h(){return(0,o.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:S})}},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},56037:e=>{"use strict";e.exports=require("mongoose")},56364:(e,t,r)=>{"use strict";r.d(t,{A:()=>l,X:()=>a});var s=r(56037),n=r.n(s);let i=process.env.MONGODB_URI;if(!i)throw Error("Please define the MONGODB_URI environment variable inside .env");let o=global.mongoose;async function a(){if(o.conn)return o.conn;o.promise||(o.promise=n().connect(i,{serverSelectionTimeoutMS:3e4,socketTimeoutMS:3e4}).then(e=>e).catch(e=>{throw e}));try{o.conn=await o.promise}catch(e){throw o.promise=null,e}return o.conn}o||(o=global.mongoose={conn:null,promise:null});let l=a},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63046:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var s=r(56037),n=r.n(s);let i=new(n()).Schema({userId:{type:String,required:!0,index:!0},sessionId:{type:String,required:!0,index:!0},language:{type:String,required:!0,default:"zh-CN"},isDeleted:{type:Number,default:0,index:!0},userProfile:{birthday:{type:Date,required:!0},gender:{type:String,enum:["male","female"],required:!0},element:String,personality:String,loveStyle:String,baziPillars:[String],dayMasterElement:String},partnerProfile:{birthday:{type:Date,required:!0},gender:{type:String,enum:["male","female"],required:!0},element:String,personality:String,loveStyle:String,baziPillars:[String],dayMasterElement:String},compatibilityAnalysis:{overallScore:{type:Number,required:!0,min:0,max:100},compatibilityLevel:String,elementInteraction:String,relationshipAdvice:String,developmentAdvice:String,specificAdvice:String,strengthsAndChallenges:{strengths:[String],challenges:[String]}},problemAnalysis:{originalProblem:String,problemCategory:String,categoryType:{type:String,enum:["emotion_cooling","special_situation","taboo_breaking"]},keyIssues:[String],rootCauses:[String]},solutions:{emotionCooling:{chartDiagnosis:{diagnosis:String,keyFindings:[String],recommendations:[String]},emergencyFengShui:{urgentActions:[String],placements:[String],colors:[String]},restartChemistry:{methods:[String],timing:String,activities:[String]}},specialSituation:{starChartGuidance:{guidance:String,favorablePeriods:[String],strategies:[String]},fengShuiTransformation:{transformations:[String],environmentChanges:[String],energyAdjustments:[String]},relationshipMethod:{methods:[String],communication:[String],principles:[String]}},tabooBreaking:{keyAnalysis:{analysis:String,taboos:[String],patterns:[String]},targetedSuggestions:{suggestions:[String],scripts:[String],timing:[String]},restartChemistry:{methods:[String],healingProcess:[String],preventiveMeasures:[String]}}},yearlyFortune:{currentYear:String,bestTiming:String,warnings:String,monthlyGuidance:[{month:String,fortune:String,advice:String}]},fengShuiLayout:{bedroom:String,livingRoom:String,colors:String,items:String,generalAdvice:String,specificPlacements:[{area:String,item:String,placement:String,purpose:String}]},analysisDetails:{wuxingAnalysis:{userElements:{strong:[String],weak:[String],balanced:[String]},partnerElements:{strong:[String],weak:[String],balanced:[String]},interaction:String},usefulGods:[String],tabooElements:[String],luckyDirections:[String],luckyNumbers:[Number]},reportMetadata:{concern:{type:String,default:"感情"},reportType:{type:String,default:"couple_analysis"},analysisDepth:{type:String,enum:["basic","standard","comprehensive"],default:"comprehensive"},version:{type:String,default:"2.0"},generatedAt:{type:Date,default:Date.now},updatedAt:Date,deletedAt:Date}},{timestamps:!0,indexes:[{userId:1,isDeleted:1},{sessionId:1},{createdAt:-1},{"reportMetadata.generatedAt":-1},{"problemAnalysis.categoryType":1},{"compatibilityAnalysis.overallScore":-1}]});i.methods.getFormattedReport=function(){return{title:"增強版合婚配對分析報告",reportId:this._id,userElement:this.userProfile.element,partnerElement:this.partnerProfile.element,compatibility:this.compatibilityAnalysis.overallScore,problemCategory:this.problemAnalysis.categoryType,solutionType:this.getSolutionType(),reportDate:this.reportMetadata.generatedAt,version:this.reportMetadata.version}},i.methods.getSolutionType=function(){switch(this.problemAnalysis.categoryType){case"emotion_cooling":return"感情降溫類解決方案";case"special_situation":return"特殊情境類解決方案";case"taboo_breaking":return"禁忌破解話術解決方案";default:return"綜合解決方案"}},i.statics.findByUserId=function(e,t={}){let r=t.sort||{createdAt:-1},s=t.limit||10;return this.find({userId:e,isDeleted:0}).sort(r).limit(s)},i.statics.getReportStats=async function(e){return await this.aggregate([{$match:{userId:e,isDeleted:0}},{$group:{_id:"$problemAnalysis.categoryType",count:{$sum:1},avgScore:{$avg:"$compatibilityAnalysis.overallScore"},latestReport:{$max:"$createdAt"}}}])},i.pre("save",function(e){this.isModified()&&!this.isNew&&(this.reportMetadata.updatedAt=new Date),e()});let o=n().models.CoupleAnalysisReport||n().model("CoupleAnalysisReport",i)},78335:()=>{},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[7719,580],()=>r(16441));module.exports=s})();