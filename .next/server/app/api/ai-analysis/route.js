(()=>{var e={};e.id=6803,e.ids=[6803],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},29879:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>g,routeModule:()=>c,serverHooks:()=>u,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>y});var r={};s.r(r),s.d(r,{POST:()=>l});var a=s(96559),n=s(48088),o=s(37719),i=s(32190);async function l(e){let t;console.log("\uD83D\uDD25 AI Analysis API called at:",new Date().toISOString());try{t=await e.json()}catch(e){return console.error("❌ Failed to parse request body:",e),i.NextResponse.json({success:!1,message:"Invalid request body"},{status:400})}let{prompt:s,userInfo:r,concern:a,problem:n}=t,o=a||r?.concern;console.log("\uD83D\uDCDD Request data:",{concern:o,userBirthday:r?.birthDateTime,gender:r?.gender});try{console.log("\uD83D\uDE80 Calling DeepSeek API for LiuNian analysis...");let e=Date.now(),t=await fetch("https://api.deepseek.com/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${process.env.DEEPSEEK_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({model:"deepseek-chat",messages:[{role:"system",content:`你是一位资深八字命理师，精通流年分析与十神互动。请严格按照用户要求的JSON格式生成流年关键词报告。

重要要求：
1. 必须基于用户的实际出生时间计算八字
2. 必须根据用户选择的关注领域（${o}）生成相应内容  
3. 必须返回严格的JSON格式，包含keywords数组和analysis字符串
4. 关键词要专业且具体，描述要包含专业术语
5. 分析要结合2025年流年特点
6. 所有字符串都必须用双引号包围，确保JSON格式正确
7. 描述文字中不能有未转义的引号或特殊字符
8. 禁止使用其他格式如"核心论述"等，只能使用keywords和analysis结构

严格返回格式（不要添加任何额外文字或markdown标记）：
{
  "keywords": [
    {"id": 1, "text": "关键词1", "description": "专业描述内容"},
    {"id": 2, "text": "关键词2", "description": "专业描述内容"},
    {"id": 3, "text": "关键词3", "description": "专业描述内容"}
  ],
  "analysis": "流年分析总结"
}`},{role:"user",content:s}],max_tokens:1e3,temperature:.7,stream:!1})}),a=Date.now()-e;if(console.log(`⏱️ DeepSeek API took: ${a}ms`),!t.ok)throw console.error("❌ DeepSeek API error:",t.status),Error(`DeepSeek API error: ${t.status}`);console.log("\uD83D\uDCE5 Parsing DeepSeek response...");let n=(await t.json()).choices[0].message.content;console.log("✅ AI Content received, length:",n.length),console.log("\uD83D\uDCCB Raw AI content:",n.substring(0,200)+"...");try{let e=n.match(/\{[\s\S]*\}/);e&&(n=e[0]);let t=JSON.parse(n);if(console.log("✅ JSON validation successful"),t.keywords&&Array.isArray(t.keywords)&&t.analysis&&"string"==typeof t.analysis&&t.keywords.length>0){if(t.keywords.every(e=>e.text&&e.description&&"string"==typeof e.text&&"string"==typeof e.description))console.log("✅ JSON structure validated");else throw Error("Invalid keyword structure - missing text or description fields")}else throw Error("Invalid JSON structure - missing keywords array or analysis string")}catch(t){console.error("❌ JSON validation failed:",t.message),console.log("\uD83D\uDD04 Falling back to personalized content...");let e=d(o,r);n=JSON.stringify(e)}return console.log("\uD83D\uDCE4 Sending response..."),i.NextResponse.json({success:!0,content:n,message:`AI analysis generated successfully in ${a}ms`})}catch(t){console.error("\uD83D\uDCA5 AI Analysis API Error:",t),console.log("\uD83D\uDD04 Using personalized fallback response...");let e=d(o,r);return i.NextResponse.json({success:!0,content:e,message:"Using personalized fallback analysis (API error: "+t.message+")",fallback:!0})}}function d(e,t){let s=t?.birthDateTime||"",r=t?.gender||"male";console.log("\uD83C\uDFAF generatePersonalizedFallback called with:",{concern:e,birthDateTime:s,gender:r});let a=s?new Date(s).getFullYear():2e3,n=2025-a,o=n<35?"青年":n<55?"中年":"長者",i="female"===r||"女"===r?"女性":"男性",l={1984:{year:"甲子",element:"海中金",dayMaster:"甲木"},1990:{year:"庚午",element:"路旁土",dayMaster:"庚金"},1996:{year:"丙子",element:"澗下水",dayMaster:"丙火"},2e3:{year:"庚辰",element:"白臘金",dayMaster:"庚金"},1995:{year:"乙亥",element:"山頭火",dayMaster:"乙木"}}[a]||{year:"庚子",element:"壁上土",dayMaster:"庚金"};return"健康"===e?JSON.stringify({keywords:[{id:1,text:"滋陰降火",description:`${l.dayMaster}日主遇2025乙巳年，火旺易耗陰液，${i}${o}需重點滋陰降火調理`},{id:2,text:"養心安神",description:`${l.element}命格配流年，心火偏旺，${i}宜早睡養陰血，保持心情平和`},{id:3,text:"潤肺護膚",description:`${a}年生人逢流年克金，易致肺燥，${o}需多親近水木環境養護`}],analysis:`2025年流年疊加大運，${i}健康呈現「${l.dayMaster}火旺傷陰，調候養生」之象。`}):"財運"===e?JSON.stringify({keywords:[{id:1,text:`${o}進財`,description:`${l.dayMaster}日主配2025年流年，${i}${o}階段財運逐步上升，投資理財需謹慎`},{id:2,text:"理財考驗",description:`${l.element}命格遇流年，需防範投資風險，${o}宜保守理財為上策`},{id:3,text:"秋冬轉機",description:`根據${a}年${l.year}特質，下半年財運轉佳，適合${i}積極把握機會`}],analysis:`2025年流年疊加大運，${i}財運呈現「${l.dayMaster}生財有道，謹慎經營」之象。`}):"事業"===e?JSON.stringify({keywords:[{id:1,text:`${o}發展`,description:`${l.dayMaster}日主在2025年，${i}事業運勢穩中有升，適合專業深耕`},{id:2,text:"職場挑戰",description:`${l.element}命格特質，${o}階段面臨同業競爭，需要提升個人競爭力`},{id:3,text:"貴人相助",description:`${a}年生人在2025年，適合透過人脈網絡拓展事業版圖`}],analysis:`2025年流年疊加大運，${i}事業呈現「${l.dayMaster}穩中求進，順勢而為」之象。`}):JSON.stringify({keywords:[{id:1,text:`${o}運勢`,description:`${l.dayMaster}日主配2025年流年，${i}${e}方面呈現穩定發展趨勢`},{id:2,text:"流年考驗",description:`${l.element}命格特質，${o}需要謹慎應對各種挑戰`},{id:3,text:"調候平衡",description:`根據${a}年出生特質，宜保持身心平衡，順應自然`}],analysis:`2025年流年疊加大運，${i}${e}呈現「${l.dayMaster}調候有序，漸入佳境」之象。`})}let c=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/ai-analysis/route",pathname:"/api/ai-analysis",filename:"route",bundlePath:"app/api/ai-analysis/route"},resolvedPagePath:"/Users/michaelng/Desktop/HarmoniqFengShui/FengShuiLayout/src/app/api/ai-analysis/route.js",nextConfigOutput:"",userland:r}),{workAsyncStorage:p,workUnitAsyncStorage:y,serverHooks:u}=c;function g(){return(0,o.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:y})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[7719,580],()=>s(29879));module.exports=r})();