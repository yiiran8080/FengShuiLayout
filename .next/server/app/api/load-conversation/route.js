(()=>{var e={};e.id=4850,e.ids=[4850],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},41556:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>y,routeModule:()=>l,serverHooks:()=>g,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>m});var r={};s.r(r),s.d(r,{GET:()=>c});var n=s(96559),i=s(48088),a=s(37719),o=s(32190),u=s(56364),d=s(41926);async function c(e){try{await (0,u.A)();let{searchParams:t}=new URL(e.url),s=t.get("sessionId"),r=t.get("conversationId"),n=t.get("userEmail"),i=s||r;if(!i)return o.NextResponse.json({error:"會話ID不能為空 (sessionId 或 conversationId)"},{status:400});console.log("\uD83D\uDCD6 從ChatHistory載入會話:",i);let a=await d.A.findOne({$or:[{conversationId:i},{sessionId:i}],...n&&{userEmail:n}}).lean();if(!a)return o.NextResponse.json({error:"找不到該會話記錄"},{status:404});let c=(a.messages||[]).map((e,t)=>({id:e._id||`msg-${t}`,type:"chathistory",role:e.role,content:e.content,timestamp:e.timestamp,aiAnalysis:e.aiAnalysis,source:"ChatHistory"}));return o.NextResponse.json({success:!0,conversation:c,metadata:{sessionId:i,userEmail:a.userEmail,userId:a.userId,title:a.title,primaryConcern:a.primaryConcern,conversationState:a.conversationState,createdAt:a.createdAt,updatedAt:a.updatedAt,stats:{totalMessages:c.length,lastActivity:a.updatedAt},context:a.context,userData:a.userData}})}catch(e){return console.error("❌ 載入會話失敗:",e),o.NextResponse.json({error:"載入會話失敗",details:e.message},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/load-conversation/route",pathname:"/api/load-conversation",filename:"route",bundlePath:"app/api/load-conversation/route"},resolvedPagePath:"/Users/michaelng/Desktop/HarmoniqFengShui/FengShuiLayout/src/app/api/load-conversation/route.js",nextConfigOutput:"",userland:r}),{workAsyncStorage:p,workUnitAsyncStorage:m,serverHooks:g}=l;function y(){return(0,a.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:m})}},41926:(e,t,s)=>{"use strict";s.d(t,{A:()=>a});var r=s(56037),n=s.n(r);n().models.ChatHistory&&delete n().models.ChatHistory;let i=new(n()).Schema({conversationId:{type:String,required:!0,index:!0},sessionId:{type:String,required:!0,index:!0},userId:{type:String,required:!0,index:!0},userEmail:{type:String,required:!1},title:{type:String,required:!0},primaryConcern:{type:String,enum:["工作","感情","財運","子女","人際關係","健康","因緣","風水佈局","其他"],required:!1},conversationState:{type:String,enum:["initial","ai_analyzing","birthday_collection","asking_detailed_report","ready_for_detailed_report","collecting_payment_info","completed"],default:"initial"},messages:[{messageId:{type:String,required:!0},role:{type:String,enum:["user","assistant"],required:!0},content:{type:String,required:!0},timestamp:{type:Date,default:Date.now},aiAnalysis:{detectedTopic:String,isWithinScope:Boolean,confidence:Number,specificProblem:String},systemType:{type:String,default:"smart-chat2"}}],stats:{totalMessages:{type:Number,default:0},lastActivity:{type:Date,default:Date.now},userEngagement:{type:Number,min:0,max:1,default:.5}},context:{topics:[String],lastTopic:String,conversationSummary:String,emotionalState:String},userData:{userBirthday:Date,partnerBirthday:Date,gender:String,partnerGender:String,relationshipType:String},isActive:{type:Boolean,default:!0},isArchived:{type:Boolean,default:!1}},{timestamps:!0,indexes:[{userId:1,conversationId:1},{userId:1,isActive:1},{sessionId:1},{"stats.lastActivity":-1},{createdAt:-1}]});i.methods.addMessage=function(e,t,s=null){let r=`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return this.messages.push({messageId:r,role:e,content:t,timestamp:new Date,aiAnalysis:s,systemType:"smart-chat2"}),this.stats.totalMessages=this.messages.length,this.stats.lastActivity=new Date,r},i.methods.updateContext=function(e,t=null){e&&!this.context.topics.includes(e)&&this.context.topics.push(e),e&&(this.context.lastTopic=e),t&&(this.context.emotionalState=t)},i.methods.generateSummary=function(){let e=this.stats.totalMessages,t=this.primaryConcern||"一般諮詢";return 0===e?`剛開始的${t}對話`:e<5?`${t}初步討論（${e}輪）`:`${t}深入討論（${e}輪）`};let a=n().models.ChatHistory||n().model("ChatHistory",i)},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},56037:e=>{"use strict";e.exports=require("mongoose")},56364:(e,t,s)=>{"use strict";s.d(t,{A:()=>u,X:()=>o});var r=s(56037),n=s.n(r);let i=process.env.MONGODB_URI;if(!i)throw Error("Please define the MONGODB_URI environment variable inside .env");let a=global.mongoose;async function o(){if(a.conn)return a.conn;a.promise||(a.promise=n().connect(i,{serverSelectionTimeoutMS:3e4,socketTimeoutMS:3e4}).then(e=>e).catch(e=>{throw e}));try{a.conn=await a.promise}catch(e){throw a.promise=null,e}return a.conn}a||(a=global.mongoose={conn:null,promise:null});let u=o},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[7719,580],()=>s(41556));module.exports=r})();