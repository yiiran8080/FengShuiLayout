(()=>{var e={};e.id=9062,e.ids=[9062],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55237:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>p,routeModule:()=>m,serverHooks:()=>h,workAsyncStorage:()=>u,workUnitAsyncStorage:()=>d});var n={};r.r(n),r.d(n,{POST:()=>l});var s=r(96559),a=r(48088),o=r(37719),i=r(32190);let c=e=>{let t=new Date(e),r=t.getFullYear(),n=t.getMonth()+1;t.getDate();let s=t.getHours(),a=["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"],o=["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"],i=a[(r-4)%10]+o[(r-4)%12],c=(n+1)%12,l=a[((r-4)*12+n-1)%10]+o[c],m=Math.floor((t-new Date("1900-01-01"))/864e5),u=(m+9)%10,d=(m+11)%12,h=Math.floor((s+1)/2)%12;return{year:i,month:l,day:a[u]+o[d],hour:a[(12*u+h)%10]+o[h],dayMaster:a[u],dayBranch:o[d],monthBranch:o[c]}};async function l(e){try{let{femaleUser:t,maleUser:r,femaleBazi:n,maleBazi:s,femalePillars:a,malePillars:o,requestType:l}=await e.json();if(!t?.birthDateTime||!r?.birthDateTime)return i.NextResponse.json({error:"Missing birth date information"},{status:400});let m=c(t.birthDateTime),u=c(r.birthDateTime),d=`作為專業命理師，請針對這對情侶進行簡要的「盤面診斷」分析。

基本資料：
女方生辰：${t.birthDateTime}
女方八字：${m.year} ${m.month} ${m.day} ${m.hour}
女方日主：${m.dayMaster}，日支：${m.dayBranch}，生於${m.monthBranch}月

男方生辰：${r.birthDateTime}  
男方八字：${u.year} ${u.month} ${u.day} ${u.hour}
男方日主：${u.dayMaster}，日支：${u.dayBranch}，生於${u.monthBranch}月

請提供三段簡潔分析，每段約100字：

女方分析：
以「${m.dayMaster}${m.monthBranch}月」為標題，簡要分析她的核心性格特徵、主要情感需求、在感情中的典型行為模式。重點突出最關鍵的性格特質和感情表達方式。

男方分析：
以「${u.dayMaster}${u.monthBranch}月」為標題，簡要分析他的性格特點、情感表達方式、在關係中的反應模式。聚焦最重要的性格傾向和溝通風格。

關鍵合盤徵象：
簡要分析雙方最主要的互動問題，解釋核心衝突點，提供1-2個最重要的調整建議。重點描述他們最容易出現的感情循環問題。

請用簡潔明瞭的中文，每段控制在100字左右，避免過於冗長的描述。`,h=await fetch("https://api.deepseek.com/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.DEEPSEEK_API_KEY}`},body:JSON.stringify({model:"deepseek-chat",messages:[{role:"user",content:d}],max_tokens:2e3,temperature:.7})});if(!h.ok)throw Error(`DeepSeek API error: ${h.status}`);let p=(await h.json()).choices[0].message.content,y=function(e,t,r){let n={female:{title:`命局：${t.dayMaster}${t.monthBranch}月`,content:""},male:{title:`命局：${r.dayMaster}${r.monthBranch}月`,content:""},keySymptoms:""};try{let s=e.split("\n").filter(e=>e.trim()),a=null,o=[];for(let e of s){let t=e.trim();if(t.includes("女方分析")||t.includes("女方")&&!a){a&&o.length>0&&("keySymptoms"===a?n.keySymptoms=o.join(" "):n[a].content=o.join(" ")),a="female",o=[];let e=t.match(/命局：([^：\n]+)/);e&&(n.female.title=e[1]);continue}if(t.includes("男方分析")||t.includes("男方")&&"female"===a){a&&o.length>0&&("keySymptoms"===a?n.keySymptoms=o.join(" "):n[a].content=o.join(" ")),a="male",o=[];let e=t.match(/命局：([^：\n]+)/);e&&(n.male.title=e[1]);continue}if(t.includes("關鍵合盤")||t.includes("合盤徵象")){a&&o.length>0&&("keySymptoms"===a?n.keySymptoms=o.join(" "):n[a].content=o.join(" ")),a="keySymptoms",o=[];continue}if(t.startsWith("命局：")&&("female"===a||"male"===a)){let e=t.replace("命局：","").trim();"female"===a?n.female.title=e:"male"===a&&(n.male.title=e);continue}t&&function(e){let t=e.trim();return!(!t||t.startsWith("**")||t.startsWith("#")||t.startsWith("---")||/^\d+\.\s*\*\*/.test(t)||/^\*\*\d+\./.test(t)||/^\d+\.\s*$/.test(t)||/^\d+\.\s*$/.test(t)||/^\*+\s*$/.test(t)||/^[\d\*\-\+]+$/.test(t)||t.includes("以上診斷基於")||t.includes("命理如鏡")||t.includes("願此分析")||t.includes("基於雙方八字結構")||t.includes("著重問題根源")||t.includes("可行性調整")||t.includes("請提供")||t.includes("格式如下")||t.includes("請確保分析")||t.includes("女方分析")||t.includes("男方分析")||t.includes("關鍵合盤")||t.includes("合盤徵象")||/^\d+\.\s*\*\*/.test(t))&&!(t.length<15)}(t)&&a&&o.push(t)}a&&o.length>0&&("keySymptoms"===a?n.keySymptoms=o.join(" "):n[a].content=o.join(" ")),n.female.content||(n.female.content=`${t.dayMaster}命生於${t.monthBranch}月，當前大運流年2025乙巳年影響下，情感表達模式具有獨特特徵，需要特別關注溝通方式的調整。`),n.male.content||(n.male.content=`${r.dayMaster}命生於${r.monthBranch}月，性格傾向和情感需求在當前時運影響下呈現特定模式，對感情關係的處理方式需要相互理解。`),n.keySymptoms||(n.keySymptoms=`根據雙方八字合盤分析，主要關注點在於五行互動和性格差異如何影響情感溝通，建議通過相互理解和調整溝通方式來改善關係品質。`)}catch(e){console.error("Error parsing chart diagnosis:",e)}return n}(p,m,u);return i.NextResponse.json(y)}catch(e){return console.error("Chart diagnosis error:",e),i.NextResponse.json({female:{title:"命局：計算中",content:"正在分析您的命局特徵和情感模式..."},male:{title:"命局：計算中",content:"正在分析伴侶的命局特徵和性格傾向..."},keySymptoms:"正在分析關鍵合盤徵象，包括五行互動和情感循環模式..."})}}let m=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/chart-diagnosis/route",pathname:"/api/chart-diagnosis",filename:"route",bundlePath:"app/api/chart-diagnosis/route"},resolvedPagePath:"/Users/michaelng/Desktop/HarmoniqFengShui/FengShuiLayout/src/app/api/chart-diagnosis/route.js",nextConfigOutput:"",userland:n}),{workAsyncStorage:u,workUnitAsyncStorage:d,serverHooks:h}=m;function p(){return(0,o.patchFetch)({workAsyncStorage:u,workUnitAsyncStorage:d})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[7719,580],()=>r(55237));module.exports=n})();