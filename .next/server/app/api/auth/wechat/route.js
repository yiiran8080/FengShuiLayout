(()=>{var e={};e.id=4913,e.ids=[4913],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},68471:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>P,routeModule:()=>l,serverHooks:()=>x,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>f});var a={};t.r(a),t.d(a,{GET:()=>p});var s=t(96559),n=t(48088),o=t(37719),i=t(32190),c=t(55511),u=t.n(c);async function p(e){let{searchParams:r}=new URL(e.url),t=r.get("code");r.get("state");try{if(!t)return function(){let e=u().randomBytes(16).toString("hex"),r=encodeURIComponent(`${process.env.NEXTAUTH_URL}/api/auth/wechat`),t=new URL("https://open.weixin.qq.com/connect/oauth2/authorize");return t.searchParams.set("appid",process.env.WECHAT_APP_ID),t.searchParams.set("redirect_uri",r),t.searchParams.set("response_type","code"),t.searchParams.set("scope","snsapi_userinfo"),t.searchParams.set("state",e),i.NextResponse.redirect(`${t.toString()}#wechat_redirect`)}();let e=await h(t);if(!e.access_token)throw Error("Failed to get access token from WeChat");let r=await d(e.access_token,e.openid),a=await m(r),s=await w(a),n=new URL("/",process.env.NEXTAUTH_URL);return n.searchParams.set("token",s),i.NextResponse.redirect(n)}catch(r){console.error("WeChat login error:",r);let e=new URL("/login",process.env.NEXTAUTH_URL);return e.searchParams.set("error","wechat_login_failed"),i.NextResponse.redirect(e)}}async function h(e){let r=new URL("https://api.weixin.qq.com/sns/oauth2/access_token");r.searchParams.set("appid",process.env.WECHAT_APP_ID),r.searchParams.set("secret",process.env.WECHAT_APP_SECRET),r.searchParams.set("code",e),r.searchParams.set("grant_type","authorization_code");let t=await fetch(r.toString()),a=await t.json();if(a.errcode)throw Error(`WeChat API error: ${a.errmsg}`);return a}async function d(e,r){let t=new URL("https://api.weixin.qq.com/sns/userinfo");t.searchParams.set("access_token",e),t.searchParams.set("openid",r),t.searchParams.set("lang","zh_CN");let a=await fetch(t.toString()),s=await a.json();if(s.errcode)throw Error(`WeChat user info error: ${s.errmsg}`);return s}async function m(e){return{id:e.openid,name:e.nickname,avatar:e.headimgurl,wechatOpenId:e.openid,wechatUnionId:e.unionid,gender:1===e.sex?"male":2===e.sex?"female":"unknown",city:e.city,province:e.province,country:e.country,createdAt:new Date,lastLoginAt:new Date}}async function w(e){let r={userId:e.id,name:e.name,avatar:e.avatar,exp:Math.floor(Date.now()/1e3)+2592e3};return Buffer.from(JSON.stringify(r)).toString("base64")}let l=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/auth/wechat/route",pathname:"/api/auth/wechat",filename:"route",bundlePath:"app/api/auth/wechat/route"},resolvedPagePath:"/Users/michaelng/Desktop/HarmoniqFengShui/FengShuiLayout/src/app/api/auth/wechat/route.js",nextConfigOutput:"",userland:a}),{workAsyncStorage:g,workUnitAsyncStorage:f,serverHooks:x}=l;function P(){return(0,o.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:f})}},78335:()=>{},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[7719,580],()=>t(68471));module.exports=a})();