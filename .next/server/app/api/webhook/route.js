(()=>{var e={};e.id=717,e.ids=[717],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},6745:(e,t,r)=>{"use strict";r.d(t,{A:()=>i});var n=r(56037),o=r.n(n);let a=new(o()).Schema({userId:{type:String,required:!0,unique:!0},password:{type:String,required:!1},provider:{type:String,default:"credentials",required:!1},name:{type:String,required:!1},gender:{type:String,enum:["female","male"],required:!0,default:"female"},birthDateTime:{type:Date,required:!0,default:new Date(1996,2,12,22)},email:{type:String,required:!1},isLock:{type:Boolean,required:!0,default:!0},genStatus:{type:String,enum:["none","waiting","done"],required:!1},emailVerified:{type:Boolean,default:!1},verificationToken:{type:String,required:!1},freeReportStats:{totalGenerated:{type:Number,default:0},lastGeneratedAt:{type:Date,default:null},firstGeneratedAt:{type:Date,default:null},favoriteRoomType:{type:String,default:null},favoriteDirection:{type:String,default:null}},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});a.virtual("freeReportActivities",{ref:"FreeReportActivity",localField:"userId",foreignField:"userId"}),a.virtual("projects",{ref:"Project",localField:"userId",foreignField:"owner"}),a.set("toJSON",{virtuals:!0}),a.set("toObject",{virtuals:!0}),o().models.User&&delete o().models.User,o().modelSchemas&&o().modelSchemas.User&&delete o().modelSchemas.User;let i=o().model("User",a)},8719:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{isRequestAPICallableInsideAfter:function(){return u},throwForSearchParamsAccessInUseCache:function(){return s},throwWithStaticGenerationBailoutError:function(){return a},throwWithStaticGenerationBailoutErrorWithDynamicError:function(){return i}});let n=r(80023),o=r(3295);function a(e,t){throw Object.defineProperty(new n.StaticGenBailoutError(`Route ${e} couldn't be rendered statically because it used ${t}. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`),"__NEXT_ERROR_CODE",{value:"E576",enumerable:!1,configurable:!0})}function i(e,t){throw Object.defineProperty(new n.StaticGenBailoutError(`Route ${e} with \`dynamic = "error"\` couldn't be rendered statically because it used ${t}. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`),"__NEXT_ERROR_CODE",{value:"E543",enumerable:!1,configurable:!0})}function s(e){throw Object.defineProperty(Error(`Route ${e} used "searchParams" inside "use cache". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use "searchParams" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`),"__NEXT_ERROR_CODE",{value:"E634",enumerable:!1,configurable:!0})}function u(){let e=o.afterTaskAsyncStorage.getStore();return(null==e?void 0:e.rootTaskSpawnPhase)==="action"}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},16104:(e,t,r)=>{"use strict";r.d(t,{_:()=>n});let n=new(r(97877)).A(process.env.STRIPE_SECRET_KEY)},20277:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>k,routeModule:()=>w,serverHooks:()=>v,workAsyncStorage:()=>S,workUnitAsyncStorage:()=>b});var n={};r.r(n),r.d(n,{POST:()=>h});var o=r(96559),a=r(48088),i=r(37719),s=r(44999),u=r(16104),c=r(56364),l=r(6745),d=r(56037),p=r.n(d);let f=new(p()).Schema({sessionId:{type:String,required:!0},isFullfilled:{type:Boolean,default:!1},paymentType:{type:String,enum:["regular","fortune","expert188","expert88","couple"],default:"regular"},concern:{type:String,enum:["financial","love","health","career"],required:function(){return"fortune"===this.paymentType}},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),m=p().models.CheckoutSession||p().model("CheckoutSession",f),y=process.env.WHSEC;async function h(e){let t;let r=await e.text(),n=(await (0,s.b3)()).get("stripe-signature");try{if(t=u._.webhooks.constructEvent(r,n,y),console.log("Webhook received:",t.type,"ID:",t.id),"checkout.session.completed"===t.type||"checkout.session.async_payment_succeeded"===t.type)try{await Promise.race([g(t.data.object),new Promise((e,t)=>setTimeout(()=>t(Error("Webhook timeout")),25e3))]),console.log("Webhook processed successfully for:",t.data.object.id)}catch(e){console.error("Webhook fulfillment error:",e.message)}}catch(e){return console.error("Webhook signature verification failed:",e.message),new Response(`Webhook error: ${e.message}`,{status:400})}return new Response("Success!",{status:200})}async function g(e){let t=e.id;try{await (0,c.A)();let r=await m.findOne({sessionId:t});if(r&&r.isFullfilled){console.log("Session already fulfilled:",t);return}let n=await u._.checkout.sessions.retrieve(t,{expand:["line_items"]});if(console.log("Processing payment:",{sessionId:t,paymentStatus:n.payment_status,paymentType:e.metadata?.paymentType||e.metadata?.type}),"unpaid"!==n.payment_status){let r=e.metadata?.paymentType||e.metadata?.type;if("fortune"===r)console.log("Fortune payment completed:",{sessionId:t,concern:e.metadata?.concern}),await m.findOneAndUpdate({sessionId:t},{sessionId:t,isFullfilled:!0,paymentType:"fortune",concern:e.metadata?.concern,completedAt:new Date},{upsert:!0,new:!0});else if("couple"===r)console.log("Couple payment completed:",t),await m.findOneAndUpdate({sessionId:t},{sessionId:t,isFullfilled:!0,paymentType:"couple"},{upsert:!0,new:!0});else{let n=e.metadata.userId;if(!n){console.error("No userId found in metadata for non-fortune payment");return}let o=await l.A.findOne({userId:n});o&&(o.isLock=!1,o.genStatus="waiting",o.lastPaymentSessionId=t,o.lastPaymentAt=new Date,await o.save(),console.log("\uD83C\uDD95 User status updated for fresh content generation:",{userId:n,sessionId:t,genStatus:"waiting"})),await m.findOneAndUpdate({sessionId:t},{sessionId:t,isFullfilled:!0,paymentType:r||"regular",completedAt:new Date},{upsert:!0,new:!0})}console.log("Webhook fulfillment completed for:",t)}}catch(e){throw console.error("Error in fulfillCheckout:",e.message),e}}let w=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/webhook/route",pathname:"/api/webhook",filename:"route",bundlePath:"app/api/webhook/route"},resolvedPagePath:"/Users/michaelng/Desktop/HarmoniqFengShui/FengShuiLayout/src/app/api/webhook/route.js",nextConfigOutput:"",userland:n}),{workAsyncStorage:S,workUnitAsyncStorage:b,serverHooks:v}=w;function k(){return(0,i.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:b})}},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},43763:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"ReflectAdapter",{enumerable:!0,get:function(){return r}});class r{static get(e,t,r){let n=Reflect.get(e,t,r);return"function"==typeof n?n.bind(e):n}static set(e,t,r,n){return Reflect.set(e,t,r,n)}static has(e,t){return Reflect.has(e,t)}static deleteProperty(e,t){return Reflect.deleteProperty(e,t)}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56037:e=>{"use strict";e.exports=require("mongoose")},56364:(e,t,r)=>{"use strict";r.d(t,{A:()=>u,X:()=>s});var n=r(56037),o=r.n(n);let a=process.env.MONGODB_URI;if(!a)throw Error("Please define the MONGODB_URI environment variable inside .env");let i=global.mongoose;async function s(){if(i.conn)return i.conn;i.promise||(i.promise=o().connect(a,{serverSelectionTimeoutMS:3e4,socketTimeoutMS:3e4}).then(e=>e).catch(e=>{throw e}));try{i.conn=await i.promise}catch(e){throw i.promise=null,e}return i.conn}i||(i=global.mongoose={conn:null,promise:null});let u=s},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{},96559:(e,t,r)=>{"use strict";e.exports=r(44870)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[7719,7380,7877],()=>r(20277));module.exports=n})();