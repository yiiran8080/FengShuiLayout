(()=>{var e={};e.id=3204,e.ids=[3204],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4573:e=>{"use strict";e.exports=require("node:buffer")},6745:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var n=r(56037),a=r.n(n);let s=new(a()).Schema({userId:{type:String,required:!0,unique:!0},gender:{type:String,enum:["female","male"],required:!0,default:"female"},birthDateTime:{type:Date,required:!0,default:new Date(1996,2,12,22)},email:{type:String,required:!1},isLock:{type:Boolean,required:!0,default:!0},genStatus:{type:String,enum:["none","waiting","done"],required:!1},freeReportStats:{totalGenerated:{type:Number,default:0},lastGeneratedAt:{type:Date,default:null},firstGeneratedAt:{type:Date,default:null},favoriteRoomType:{type:String,default:null},favoriteDirection:{type:String,default:null}},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});s.virtual("freeReportActivities",{ref:"FreeReportActivity",localField:"userId",foreignField:"userId"}),s.virtual("projects",{ref:"Project",localField:"userId",foreignField:"owner"}),s.set("toJSON",{virtuals:!0}),s.set("toObject",{virtuals:!0});let o=a().models.User||a().model("User",s)},8476:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>A,routeModule:()=>m,serverHooks:()=>w,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>y});var n={};r.r(n),r.d(n,{GET:()=>g,POST:()=>p});var a=r(96559),s=r(48088),o=r(37719),i=r(32190),u=r(14807),l=r(56364),d=r(6745),c=r(96739);async function p(e){try{let t=await (0,u.j2)(),{roomType:r,direction:n,userInfo:a,hasUploadedImage:s,imageFileName:o,analysisResult:p,locale:g,timeSpentOnPage:m,referrer:f,sessionId:y,isAnonymous:w}=await e.json(),A=t?.user?.email||t?.user?.userId||null,S=t?.user?.email||null;console.log("\uD83D\uDCCA Tracking request received:",{userId:A||"anonymous",roomType:r,direction:n,isAnonymous:!A});let h=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",v=e.headers.get("user-agent")||"unknown";await (0,l.A)(),console.log("\uD83D\uDCC1 Database connected");let D=new c.A({userId:A||null,email:S||null,sessionId:y,roomType:r,direction:n,userInfo:{gender:a?.gender||"female",birthDateTime:a?.birthDateTime?new Date(a.birthDateTime):new Date},hasUploadedImage:!!s,imageFileName:o,analysisResult:p,generatedAt:new Date,ipAddress:h,userAgent:v,locale:g||"zh-TW",timeSpentOnPage:m,referrer:f,status:"success",isAnonymous:!A});if(await D.save(),console.log("✅ Activity saved:",D._id),A){let e=await d.A.findOne({userId:A});if(console.log("\uD83D\uDC64 Found user:",!!e),e){e.freeReportStats||(e.freeReportStats={});let t=e.freeReportStats.totalGenerated||0;e.freeReportStats.totalGenerated=t+1,e.freeReportStats.lastGeneratedAt=new Date,e.freeReportStats.firstGeneratedAt||(e.freeReportStats.firstGeneratedAt=new Date),e.freeReportStats.favoriteRoomType=r,e.freeReportStats.favoriteDirection=n,e.updatedAt=new Date,console.log("\uD83D\uDCC8 Updating user stats. New total:",e.freeReportStats.totalGenerated)}else e=new d.A({userId:A,email:S,gender:a?.gender||"female",birthDateTime:a?.birthDateTime?new Date(a.birthDateTime):new Date(1996,2,12,22),freeReportStats:{totalGenerated:1,firstGeneratedAt:new Date,lastGeneratedAt:new Date,favoriteRoomType:r,favoriteDirection:n}}),console.log("\uD83C\uDD95 Creating new user");await e.save(),console.log("\uD83D\uDCBE User saved successfully")}return i.NextResponse.json({success:!0,activityId:D._id,totalGenerated:A&&(await d.A.findOne({userId:A}))?.freeReportStats?.totalGenerated,message:"Free report generation tracked successfully",isAnonymous:!A})}catch(e){return console.error("❌ Error tracking free report generation:",e),i.NextResponse.json({error:"Failed to track free report generation",details:e.message,type:e.name},{status:500})}}async function g(e){try{let t=await (0,u.j2)(),{searchParams:r}=new URL(e.url),n=r.get("userId")||t?.user?.email;if(!n)return i.NextResponse.json({error:"User ID required"},{status:400});await (0,l.A)();let a=await d.A.findOne({userId:n}),s=await c.A.find({userId:n}).sort({generatedAt:-1}).limit(10).select("roomType direction generatedAt status locale hasUploadedImage");return i.NextResponse.json({userStats:a?.freeReportStats||{totalGenerated:0},recentActivities:s,totalActivities:s.length})}catch(e){return console.error("Error getting free report stats:",e),i.NextResponse.json({error:"Failed to get free report statistics"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/track-free-report-generation/route",pathname:"/api/track-free-report-generation",filename:"route",bundlePath:"app/api/track-free-report-generation/route"},resolvedPagePath:"/Users/michaelng/Desktop/HarmoniqFengShui/FengShuiLayout/src/app/api/track-free-report-generation/route.js",nextConfigOutput:"",userland:n}),{workAsyncStorage:f,workUnitAsyncStorage:y,serverHooks:w}=m;function A(){return(0,o.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:y})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14807:(e,t,r)=>{"use strict";r.d(t,{j2:()=>p,Y9:()=>l});var n=r(30091),a=r(56056),s=r(18068),o=r(56364),i=r(6745);async function u(e,t){try{await (0,o.A)();let r=await i.A.findOne({userId:e});if(!r){let r=new i.A({userId:e,email:t,gender:"female",birthDateTime:new Date(1996,2,12,22),isLock:!0,genStatus:"none"});return await r.save(),console.log("New user created:",e),r}return r}catch(e){throw console.error("Error creating user:",e),e}}let{handlers:l,signIn:d,signOut:c,auth:p}=(0,n.Ay)({trustHost:!0,providers:[(0,a.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,s.A)({clientId:process.env.APPLE_ID,clientSecret:process.env.APPLE_CLIENT_SECRET})],secret:process.env.NEXTAUTH_SECRET,callbacks:{async signIn({user:e,account:t,profile:r}){try{let t=e.email;if(!t)return!1;return await u(t,e.email),!0}catch(e){return console.error("Error in signIn callback:",e),!1}},jwt:async({token:e,user:t,account:r})=>(r&&t&&(e.accessToken=r.access_token,e.id=t.id),e),session:async({session:e,token:t})=>(t&&e.user&&(e.user={...e.user,id:t.sub,userId:e.user.email}),e)},pages:{}})},19121:e=>{"use strict";e.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},56037:e=>{"use strict";e.exports=require("mongoose")},56364:(e,t,r)=>{"use strict";r.d(t,{A:()=>i});var n=r(56037),a=r.n(n);let s=process.env.MONGODB_URI;if(!s)throw Error("Please define the MONGODB_URI environment variable inside .env");let o=global.mongoose;o||(o=global.mongoose={conn:null,promise:null});let i=async function(){if(o.conn)return o.conn;o.promise||(o.promise=a().connect(s,{serverSelectionTimeoutMS:3e4,socketTimeoutMS:3e4}).then(e=>(console.log("MongoDB connected successfully"),e)).catch(e=>{throw console.error("MongoDB connection error:",e),e}));try{o.conn=await o.promise}catch(e){throw console.error("MongoDB connection failed:",e),o.promise=null,e}return o.conn}},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},96487:()=>{},96739:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var n=r(56037),a=r.n(n);let s=new(a()).Schema({userId:{type:String,required:!1,index:!0},email:{type:String,required:!1,index:!0},sessionId:{type:String,required:!1},isAnonymous:{type:Boolean,default:!1,index:!0},roomType:{type:String,required:!0,enum:["bedroom","living_room","dining_room","kitchen","bathroom","study_room","balcony","storage_room"]},direction:{type:String,required:!0,enum:["north","northEast","east","southEast","south","southWest","west","northWest","center"]},userInfo:{gender:{type:String,enum:["female","male"],required:!0},birthDateTime:{type:Date,required:!0}},hasUploadedImage:{type:Boolean,default:!1},imageFileName:{type:String,required:!1},analysisResult:{type:a().Schema.Types.Mixed,required:!1},generatedAt:{type:Date,default:Date.now,index:!0},ipAddress:{type:String,required:!1},userAgent:{type:String,required:!1},locale:{type:String,enum:["zh-TW","zh-CN"],default:"zh-TW"},timeSpentOnPage:{type:Number,required:!1},referrer:{type:String,required:!1},status:{type:String,enum:["success","failed","partial"],default:"success"},errorMessage:{type:String,required:!1}});s.index({userId:1,generatedAt:-1}),s.index({generatedAt:-1}),s.index({email:1,generatedAt:-1}),s.index({isAnonymous:1,generatedAt:-1}),a().models.FreeReportActivity&&delete a().models.FreeReportActivity;let o=a().model("FreeReportActivity",s)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[7719,4999,928,580,807],()=>r(8476));module.exports=n})();