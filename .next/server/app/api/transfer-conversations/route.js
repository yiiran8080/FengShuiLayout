(()=>{var e={};e.id=2388,e.ids=[2388],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},41926:(e,t,s)=>{"use strict";s.d(t,{A:()=>o});var r=s(56037),n=s.n(r);n().models.ChatHistory&&delete n().models.ChatHistory;let i=new(n()).Schema({conversationId:{type:String,required:!0,index:!0},sessionId:{type:String,required:!0,index:!0},userId:{type:String,required:!0,index:!0},userEmail:{type:String,required:!1},title:{type:String,required:!0},primaryConcern:{type:String,enum:["工作","感情","財運","子女","人際關係","健康","因緣","風水佈局","其他"],required:!1},conversationState:{type:String,enum:["initial","ai_analyzing","birthday_collection","asking_detailed_report","ready_for_detailed_report","collecting_payment_info","completed"],default:"initial"},messages:[{messageId:{type:String,required:!0},role:{type:String,enum:["user","assistant"],required:!0},content:{type:String,required:!0},timestamp:{type:Date,default:Date.now},aiAnalysis:{detectedTopic:String,isWithinScope:Boolean,confidence:Number,specificProblem:String},systemType:{type:String,default:"smart-chat2"}}],stats:{totalMessages:{type:Number,default:0},lastActivity:{type:Date,default:Date.now},userEngagement:{type:Number,min:0,max:1,default:.5}},context:{topics:[String],lastTopic:String,conversationSummary:String,emotionalState:String},userData:{userBirthday:Date,partnerBirthday:Date,gender:String,partnerGender:String,relationshipType:String},isActive:{type:Boolean,default:!0},isArchived:{type:Boolean,default:!1}},{timestamps:!0,indexes:[{userId:1,conversationId:1},{userId:1,isActive:1},{sessionId:1},{"stats.lastActivity":-1},{createdAt:-1}]});i.methods.addMessage=function(e,t,s=null){let r=`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return this.messages.push({messageId:r,role:e,content:t,timestamp:new Date,aiAnalysis:s,systemType:"smart-chat2"}),this.stats.totalMessages=this.messages.length,this.stats.lastActivity=new Date,r},i.methods.updateContext=function(e,t=null){e&&!this.context.topics.includes(e)&&this.context.topics.push(e),e&&(this.context.lastTopic=e),t&&(this.context.emotionalState=t)},i.methods.generateSummary=function(){let e=this.stats.totalMessages,t=this.primaryConcern||"一般諮詢";return 0===e?`剛開始的${t}對話`:e<5?`${t}初步討論（${e}輪）`:`${t}深入討論（${e}輪）`};let o=n().models.ChatHistory||n().model("ChatHistory",i)},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},56037:e=>{"use strict";e.exports=require("mongoose")},56364:(e,t,s)=>{"use strict";s.d(t,{A:()=>u,X:()=>a});var r=s(56037),n=s.n(r);let i=process.env.MONGODB_URI;if(!i)throw Error("Please define the MONGODB_URI environment variable inside .env");let o=global.mongoose;async function a(){if(o.conn)return o.conn;o.promise||(o.promise=n().connect(i,{serverSelectionTimeoutMS:3e4,socketTimeoutMS:3e4}).then(e=>e).catch(e=>{throw e}));try{o.conn=await o.promise}catch(e){throw o.promise=null,e}return o.conn}o||(o=global.mongoose={conn:null,promise:null});let u=a},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},77625:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>y,routeModule:()=>c,serverHooks:()=>g,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>m});var r={};s.r(r),s.d(r,{POST:()=>l});var n=s(96559),i=s(48088),o=s(37719),a=s(32190),u=s(56364),d=s(41926);async function l(e){try{await (0,u.A)();let{oldUserId:t,newUserId:s}=await e.json();if(!t||!s)return a.NextResponse.json({error:"oldUserId 和 newUserId 都是必需的"},{status:400});if((await d.A.find({userId:s,userEmail:s})).length>0)return console.log("⚠️ 用戶已有對話記錄，跳過轉移避免重複"),a.NextResponse.json({success:!0,transferredCount:0,message:"用戶已有對話記錄，跳過轉移避免重複"});let r=await d.A.find({userId:t,userEmail:{$in:["anonymous",null]}});if(0===r.length)return console.log("\uD83D\uDCED 沒有找到需要轉移的匿名對話記錄"),a.NextResponse.json({success:!0,transferredCount:0,message:"沒有需要轉移的對話記錄"});console.log(`🔄 找到 ${r.length} 個匿名對話需要轉移`);let n=await d.A.updateMany({userId:t,userEmail:{$in:["anonymous",null]}},{$set:{userId:s,userEmail:s}});return console.log(`✅ 成功轉移 ${n.modifiedCount} 個對話記錄`),a.NextResponse.json({success:!0,transferredCount:n.modifiedCount,message:`成功轉移 ${n.modifiedCount} 個對話記錄到用戶 ${s}`})}catch(e){return console.error("❌ 轉移對話記錄失敗:",e),a.NextResponse.json({error:"轉移對話記錄失敗",details:e.message},{status:500})}}let c=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/transfer-conversations/route",pathname:"/api/transfer-conversations",filename:"route",bundlePath:"app/api/transfer-conversations/route"},resolvedPagePath:"/Users/michaelng/Desktop/HarmoniqFengShui/FengShuiLayout/src/app/api/transfer-conversations/route.js",nextConfigOutput:"",userland:r}),{workAsyncStorage:p,workUnitAsyncStorage:m,serverHooks:g}=c;function y(){return(0,o.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:m})}},78335:()=>{},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[7719,580],()=>s(77625));module.exports=r})();