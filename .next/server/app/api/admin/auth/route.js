(()=>{var e={};e.id=7404,e.ids=[7404],e.modules={10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},20367:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>l,routeModule:()=>o,serverHooks:()=>c,workAsyncStorage:()=>u,workUnitAsyncStorage:()=>d});var n=r(96559),s=r(48088),i=r(37719),a=r(96440);let o=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/admin/auth/route",pathname:"/api/admin/auth",filename:"route",bundlePath:"app/api/admin/auth/route"},resolvedPagePath:"/Users/michaelng/Desktop/HarmoniqFengShui/FengShuiLayout/src/app/api/admin/auth/route.js",nextConfigOutput:"",userland:a}),{workAsyncStorage:u,workUnitAsyncStorage:d,serverHooks:c}=o;function l(){return(0,i.patchFetch)({workAsyncStorage:u,workUnitAsyncStorage:d})}},20845:(e,t,r)=>{"use strict";r.d(t,{Rx:()=>d,XQ:()=>c,wL:()=>l});var n=r(56037),s=r.n(n);let i=new(s()).Schema({username:{type:String,required:!0,unique:!0},password:{type:String,required:!0},email:{type:String,required:!0},role:{type:String,enum:["admin","super_admin"],default:"admin"},lastLogin:{type:Date},isActive:{type:Boolean,default:!0},loginAttempts:{type:Number,default:0},lockUntil:{type:Date}},{timestamps:!0});i.virtual("isLocked").get(function(){return!!(this.lockUntil&&this.lockUntil>Date.now())});let a=new(s()).Schema({userId:{type:String,required:!0,index:!0},sessionId:{type:String,index:!0},activityType:{type:String,enum:["login","chat_start","chat_message","topic_selection","birthday_input","payment_initiate","payment_complete","report_generate","report_view","page_visit","logout","error_occurred"],required:!0},activityData:{type:s().Schema.Types.Mixed},metadata:{ipAddress:String,userAgent:String,deviceType:String,browser:String,platform:String,referrer:String,language:String,timezone:String},duration:{type:Number},success:{type:Boolean,default:!0},errorDetails:{type:String}},{timestamps:!0,indexes:[{userId:1,createdAt:-1},{activityType:1,createdAt:-1},{sessionId:1,createdAt:-1}]}),o=new(s()).Schema({date:{type:Date,required:!0,unique:!0},metrics:{dailyActiveUsers:{type:Number,default:0},newUsers:{type:Number,default:0},totalConversations:{type:Number,default:0},completedConsultations:{type:Number,default:0},paymentTransactions:{type:Number,default:0},totalRevenue:{type:Number,default:0},averageSessionDuration:{type:Number,default:0},topConcerns:[{concern:String,count:Number}],userTypeDistribution:{新手用戶:{type:Number,default:0},回頭客:{type:Number,default:0},專業用戶:{type:Number,default:0}},deviceStats:{mobile:{type:Number,default:0},desktop:{type:Number,default:0},tablet:{type:Number,default:0}},errorRate:{type:Number,default:0},responseTime:{type:Number,default:0}}},{timestamps:!0}),u=new(s()).Schema({adminId:{type:String,required:!0,index:!0},action:{type:String,enum:["user_view","user_edit","conversation_view","conversation_moderate","system_setting_change","user_block","user_unblock","data_export","broadcast_message","report_generate","payment_refund","content_edit"],required:!0},targetType:{type:String,enum:["user","conversation","system","content"]},targetId:{type:String},details:{type:s().Schema.Types.Mixed},ipAddress:{type:String}},{timestamps:!0,indexes:[{adminId:1,createdAt:-1},{action:1,createdAt:-1}]}),d=s().models.AdminUser||s().model("AdminUser",i),c=s().models.UserActivity||s().model("UserActivity",a);s().models.SystemMetrics||s().model("SystemMetrics",o);let l=s().models.AdminActionLog||s().model("AdminActionLog",u)},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},56037:e=>{"use strict";e.exports=require("mongoose")},56364:(e,t,r)=>{"use strict";r.d(t,{A:()=>u,X:()=>o});var n=r(56037),s=r.n(n);let i=process.env.MONGODB_URI;if(!i)throw Error("Please define the MONGODB_URI environment variable inside .env");let a=global.mongoose;async function o(){if(a.conn)return a.conn;a.promise||(a.promise=s().connect(i,{serverSelectionTimeoutMS:3e4,socketTimeoutMS:3e4}).then(e=>e).catch(e=>{throw e}));try{a.conn=await a.promise}catch(e){throw a.promise=null,e}return a.conn}a||(a=global.mongoose={conn:null,promise:null});let u=o},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},96440:(e,t,r)=>{"use strict";r.r(t),r.d(t,{POST:()=>d,logAdminAction:()=>y,verifyAdminToken:()=>p});var n=r(85663),s=r(43205),i=r.n(s),a=r(20845),o=r(56364);let u=process.env.ADMIN_JWT_SECRET||"your-super-secret-admin-key-change-this";async function d(e){try{await (0,o.A)();let{username:t,password:r,action:n}=await e.json();if("checkSetup"===n)return await m();if(!t||!r||!n)return Response.json({error:"Missing required fields"},{status:400});if("login"===n)return await c(t,r,e);if("createAdmin"===n)return await l(t,r,e);return Response.json({error:"Invalid action"},{status:400})}catch(e){return console.error("Admin auth error:",e),Response.json({error:"Internal server error"},{status:500})}}async function c(e,t,r){try{let s=await a.Rx.findOne({username:e,isActive:!0});if(!s)return Response.json({error:"無效的用戶名或密碼"},{status:401});if(s.isLocked)return Response.json({error:"帳戶已被鎖定，請稍後再試",lockUntil:s.lockUntil},{status:423});if(!await n.Ay.compare(t,s.password)){if(s.loginAttempts+=1,s.loginAttempts>=5)return s.lockUntil=Date.now()+18e5,await s.save(),Response.json({error:"登入失敗次數過多，帳戶已被鎖定30分鐘",lockUntil:s.lockUntil},{status:423});return await s.save(),Response.json({error:`無效的用戶名或密碼，剩餘嘗試次數: ${5-s.loginAttempts}`},{status:401})}s.loginAttempts=0,s.lockUntil=void 0,s.lastLogin=new Date,await s.save();let o=i().sign({adminId:s._id,username:s.username,role:s.role},u,{expiresIn:"8h"});return await y(s._id,"login",null,null,{loginTime:new Date,ipAddress:function(e){let t=e.headers.get("x-forwarded-for"),r=e.headers.get("x-real-ip");return t?t.split(",")[0].trim():r||"unknown"}(r)}),Response.json({success:!0,token:o,admin:{id:s._id,username:s.username,email:s.email,role:s.role,lastLogin:s.lastLogin}})}catch(e){return console.error("Login error:",e),Response.json({error:"登入過程發生錯誤"},{status:500})}}async function l(e,t,r){try{if(await a.Rx.findOne({}))return Response.json({error:"管理員帳戶已存在"},{status:403});if(!e||!t)return Response.json({error:"用戶名和密碼為必填項"},{status:400});if(t.length<8)return Response.json({error:"密碼長度至少8個字符"},{status:400});let r=await n.Ay.hash(t,12),s=new a.Rx({username:e,password:r,email:`${e}@fengshui-admin.local`,role:"super_admin"});return await s.save(),Response.json({success:!0,message:"管理員帳戶創建成功",admin:{id:s._id,username:s.username,role:s.role}})}catch(e){return console.error("Create admin error:",e),Response.json({error:"創建管理員帳戶失敗"},{status:500})}}async function p(e){try{let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return{error:"Missing or invalid authorization header",status:401};let r=t.substring(7),n=i().verify(r,u);await (0,o.A)();let s=await a.Rx.findById(n.adminId);if(!s||!s.isActive)return{error:"Invalid or inactive admin account",status:401};return{admin:n}}catch(e){return console.error("Token verification error:",e),{error:"Invalid token",status:401}}}async function m(){try{let e=await a.Rx.findOne({});return Response.json({hasAdmin:!!e,message:e?"管理員帳戶已存在":"需要創建管理員帳戶"})}catch(e){return console.error("Check setup error:",e),Response.json({error:"檢查設定失敗"},{status:500})}}async function y(e,t,r,n,s){try{let i=new a.wL({adminId:e,action:t,targetType:r,targetId:n,details:s,ipAddress:s?.ipAddress});await i.save()}catch(e){console.error("Error logging admin action:",e)}}},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[7719,5663,8291],()=>r(20367));module.exports=n})();