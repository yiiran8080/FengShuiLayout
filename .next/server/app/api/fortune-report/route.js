(()=>{var e={};e.id=7540,e.ids=[7540],e.modules={1379:(e,r,t)=>{"use strict";t.d(r,{A:()=>o});var s=t(56037),n=t.n(s);let a=new(n()).Schema({sessionId:{type:String,required:!0,unique:!0,index:!0},userId:{type:String,required:!1,index:!0},userEmail:{type:String,required:!1},paymentStatus:{type:String,enum:["pending","paid","expired"],default:"paid"},paymentAmount:{type:Number,required:!0},paymentCurrency:{type:String,default:"USD"},userInputs:{birthday:{type:String,required:!0},gender:{type:String,required:!0},concern:{type:String,required:!0},problem:{type:String,required:!0},partnerBirthday:{type:String,required:!1}},reportGenerated:{type:Boolean,default:!1},reportGeneratedAt:{type:Date,required:!1},reportContent:{fiveElementAnalysis:{type:n().Schema.Types.Mixed,required:!1},zodiacAnalysis:{type:n().Schema.Types.Mixed,required:!1},liuNianKeyWordAnalysis:{type:n().Schema.Types.Mixed,required:!1},mingJuAnalysis:{type:n().Schema.Types.Mixed,required:!1},ganZhiAnalysis:{type:n().Schema.Types.Mixed,required:!1},jiXiongAnalysis:{type:n().Schema.Types.Mixed,required:!1},seasonAnalysis:{type:n().Schema.Types.Mixed,required:!1},coreSuggestionAnalysis:{type:n().Schema.Types.Mixed,required:!1},specificSuggestionAnalysis:{type:n().Schema.Types.Mixed,required:!1},questionFocusAnalysis:{type:n().Schema.Types.Mixed,required:!1},coupleAnalysis:{type:n().Schema.Types.Mixed,required:!1}},accessCount:{type:Number,default:0},lastAccessedAt:{type:Date,default:Date.now},reportType:{type:String,default:"fortune"},reportVersion:{type:String,default:"1.0"},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});a.pre("save",function(e){this.updatedAt=Date.now(),e()}),a.index({sessionId:1}),a.index({userId:1}),a.index({userEmail:1}),a.index({createdAt:-1}),a.index({reportGenerated:1});let o=n().models.FortuneReport||n().model("FortuneReport",a)},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},16104:(e,r,t)=>{"use strict";t.d(r,{_:()=>s});let s=new(t(97877)).A(process.env.STRIPE_SECRET_KEY)},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},45720:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>x,routeModule:()=>y,serverHooks:()=>g,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>h});var s={};t.r(s),t.d(s,{POST:()=>c,PUT:()=>l});var n=t(96559),a=t(48088),o=t(37719),i=t(32190),u=t(56364),p=t(1379),d=t(16104);async function c(e){try{let{sessionId:r}=await e.json();if(!r)return i.NextResponse.json({error:"Session ID is required",status:1},{status:400});await (0,u.A)();let t=await d._.checkout.sessions.retrieve(r);if("paid"!==t.payment_status)return i.NextResponse.json({error:"Payment not completed",status:1,paymentRequired:!0});let s=await p.A.findOne({sessionId:r});if(s){let n=new URL(e.url),a={birthday:n.searchParams.get("birthday")||"",gender:n.searchParams.get("gender")||"",concern:n.searchParams.get("concern")||"",problem:n.searchParams.get("problem")||"",partnerBirthday:n.searchParams.get("partnerBirthday")||""},o=a.birthday||a.concern||a.problem;if(console.log("Found existing report:",{sessionId:r,reportGenerated:s.reportGenerated,currentInputs:s.userInputs,newUrlParams:a,hasNewInputs:o,hasValidCurrentInputs:!!(s.userInputs?.birthday&&s.userInputs?.concern&&s.userInputs?.problem)}),o&&!s.reportGenerated){let e=t.metadata||{};s.userInputs={birthday:a.birthday||s.userInputs?.birthday||e.birthday||"",gender:a.gender||s.userInputs?.gender||e.gender||"",concern:a.concern||s.userInputs?.concern||e.concern||"",problem:a.problem||s.userInputs?.problem||e.specificProblem||e.problem||"",partnerBirthday:a.partnerBirthday||s.userInputs?.partnerBirthday||e.partnerBirthday||""},console.log("Updated user inputs:",s.userInputs)}return s.accessCount+=1,s.lastAccessedAt=new Date,await s.save(),i.NextResponse.json({status:0,reportExists:!0,reportGenerated:s.reportGenerated,data:{sessionId:r,payment_status:t.payment_status,reportContent:s.reportContent,userInputs:s.userInputs,reportGeneratedAt:s.reportGeneratedAt,accessCount:s.accessCount,canGenerateNew:!0}})}{let n=t.metadata||{},a=new URL(e.url),o={birthday:a.searchParams.get("birthday")||"",gender:a.searchParams.get("gender")||"",concern:a.searchParams.get("concern")||"",problem:a.searchParams.get("problem")||"",partnerBirthday:a.searchParams.get("partnerBirthday")||""},u={birthday:o.birthday||n.birthday||"",gender:o.gender||n.gender||"",concern:o.concern||n.concern||"",problem:o.problem||n.specificProblem||n.problem||"",partnerBirthday:o.partnerBirthday||n.partnerBirthday||""};return console.log("Creating new report with inputs:",{sessionId:r,urlParams:o,metadata:n,finalUserInputs:u,hasRequiredInputs:!!(u.birthday&&u.concern&&u.problem)}),s=new p.A({sessionId:r,userId:t.customer_details?.email||n.userId||null,userEmail:t.customer_details?.email||n.userEmail||null,paymentAmount:t.amount_total,paymentCurrency:t.currency,userInputs:u,reportGenerated:!1,accessCount:1,lastAccessedAt:new Date}),await s.save(),i.NextResponse.json({status:0,reportExists:!1,reportGenerated:!1,data:{sessionId:r,payment_status:t.payment_status,reportContent:null,userInputs:s.userInputs,canGenerateNew:!0}})}}catch(e){return console.error("Fortune report check error:",e),i.NextResponse.json({error:"檢查報告失敗: "+e.message,status:1},{status:500})}}async function l(e){try{let{sessionId:r,reportContent:t}=await e.json();if(!r||!t)return i.NextResponse.json({error:"Session ID and report content are required",status:1},{status:400});await (0,u.A)();let s=await p.A.findOne({sessionId:r});if(!s)return i.NextResponse.json({error:"Report not found",status:1},{status:404});return s.reportContent=t,s.reportGenerated=!0,s.reportGeneratedAt=new Date,await s.save(),i.NextResponse.json({status:0,message:"Report saved successfully",data:{sessionId:r,reportGenerated:!0,reportGeneratedAt:s.reportGeneratedAt}})}catch(e){return console.error("Fortune report update error:",e),i.NextResponse.json({error:"更新報告失敗: "+e.message,status:1},{status:500})}}let y=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/fortune-report/route",pathname:"/api/fortune-report",filename:"route",bundlePath:"app/api/fortune-report/route"},resolvedPagePath:"/Users/michaelng/Desktop/HarmoniqFengShui/FengShuiLayout/src/app/api/fortune-report/route.js",nextConfigOutput:"",userland:s}),{workAsyncStorage:m,workUnitAsyncStorage:h,serverHooks:g}=y;function x(){return(0,o.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:h})}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56037:e=>{"use strict";e.exports=require("mongoose")},56364:(e,r,t)=>{"use strict";t.d(r,{A:()=>u,X:()=>i});var s=t(56037),n=t.n(s);let a=process.env.MONGODB_URI;if(!a)throw Error("Please define the MONGODB_URI environment variable inside .env");let o=global.mongoose;async function i(){if(o.conn)return o.conn;o.promise||(o.promise=n().connect(a,{serverSelectionTimeoutMS:3e4,socketTimeoutMS:3e4}).then(e=>e).catch(e=>{throw e}));try{o.conn=await o.promise}catch(e){throw o.promise=null,e}return o.conn}o||(o=global.mongoose={conn:null,promise:null});let u=i},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[7719,580,7877],()=>t(45720));module.exports=s})();