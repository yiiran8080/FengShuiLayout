<!doctype html>
<html>
	<head>
		<title>Complete Couple Report Viewer</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 20px;
				line-height: 1.6;
			}
			.header {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 20px;
				border-radius: 10px;
				margin-bottom: 20px;
			}
			.summary-card {
				background: #f8f9fa;
				border: 1px solid #dee2e6;
				border-radius: 8px;
				padding: 15px;
				margin-bottom: 15px;
			}
			.component-section {
				border: 1px solid #ddd;
				border-radius: 8px;
				margin: 15px 0;
				overflow: hidden;
			}
			.component-header {
				background: #e9ecef;
				padding: 10px 15px;
				font-weight: bold;
				cursor: pointer;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.component-header:hover {
				background: #dee2e6;
			}
			.component-content {
				padding: 15px;
				display: none;
				max-height: 400px;
				overflow-y: auto;
			}
			.component-content.active {
				display: block;
			}
			.score-badge {
				background: #28a745;
				color: white;
				padding: 5px 10px;
				border-radius: 20px;
				font-weight: bold;
			}
			.missing-badge {
				background: #dc3545;
				color: white;
				padding: 3px 8px;
				border-radius: 15px;
				font-size: 0.8em;
			}
			.present-badge {
				background: #28a745;
				color: white;
				padding: 3px 8px;
				border-radius: 15px;
				font-size: 0.8em;
			}
			.metadata-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 10px;
			}
			.metadata-item {
				background: white;
				padding: 10px;
				border-radius: 5px;
				border-left: 4px solid #007bff;
			}
			pre {
				background: #f8f9fa;
				padding: 10px;
				border-radius: 5px;
				overflow-x: auto;
				font-size: 12px;
			}
			button {
				margin: 5px;
				padding: 10px 15px;
				background: #007bff;
				color: white;
				border: none;
				border-radius: 5px;
				cursor: pointer;
			}
			button:hover {
				background: #0056b3;
			}
			.loading {
				color: #666;
				font-style: italic;
			}
			.error {
				color: #dc3545;
				background: #f8d7da;
				padding: 10px;
				border-radius: 5px;
				border: 1px solid #f5c6cb;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>üîç Complete Couple Report Viewer</h1>
			<p>View all 6 components combined into one comprehensive report</p>
		</div>

		<div>
			<input
				type="text"
				id="sessionInput"
				placeholder="couple_1999_09_03_2010_04_04"
				style="width: 300px; padding: 10px; margin: 5px"
			/>
			<button onclick="loadCompleteReport()">
				üìä Load Complete Report
			</button>
			<button onclick="loadRawData()">üóÑÔ∏è Load Raw Database Data</button>
			<button onclick="clearDisplay()">üßπ Clear</button>
		</div>

		<div id="content">
			<p class="loading">
				Enter session ID above and click "Load Complete Report" to view
				the combined couple analysis data
			</p>
		</div>

		<script>
			const API_BASE = window.location.origin;

			function getSessionId() {
				const input = document.getElementById("sessionInput");
				const sessionId =
					input.value.trim() || "couple_1999_09_03_2010_04_04";
				return sessionId;
			}

			function clearDisplay() {
				document.getElementById("content").innerHTML =
					'<p class="loading">Click "Load Complete Report" to view the combined couple analysis data</p>';
			}

			function showError(message) {
				document.getElementById("content").innerHTML =
					`<div class="error">‚ùå Error: ${message}</div>`;
			}

			function toggleComponent(componentId) {
				const content = document.getElementById(componentId);
				const header = content.previousElementSibling;
				const arrow = header.querySelector(".arrow");

				if (content.classList.contains("active")) {
					content.classList.remove("active");
					arrow.textContent = "‚ñ∂";
				} else {
					content.classList.add("active");
					arrow.textContent = "‚ñº";
				}
			}

			async function loadCompleteReport() {
				try {
					const sessionId = getSessionId();
					document.getElementById("content").innerHTML =
						`<p class="loading">Loading combined report for session: ${sessionId}...</p>`;

					const response = await fetch(
						`${API_BASE}/api/couple-complete-report?sessionId=${sessionId}`
					);
					const data = await response.json();

					if (!response.ok || !data.success) {
						showError(
							data.error || "Failed to load complete report"
						);
						return;
					}

					displayCompleteReport(data);
				} catch (error) {
					showError(error.message);
				}
			}

			function displayCompleteReport(data) {
				const { summary, report, rawComponents } = data;

				let html = `
                <div class="summary-card">
                    <h2>üìä Report Summary</h2>
                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <strong>Compatibility Score</strong><br>
                            <span class="score-badge">${summary.compatibilityScore}</span>
                        </div>
                        <div class="metadata-item">
                            <strong>Compatibility Level</strong><br>
                            ${summary.compatibilityLevel}
                        </div>
                        <div class="metadata-item">
                            <strong>Elements</strong><br>
                            ${summary.user1Element} + ${summary.user2Element}
                        </div>
                        <div class="metadata-item">
                            <strong>Components Present</strong><br>
                            <span class="present-badge">${summary.componentsPresent.length}/6</span>
                        </div>
                    </div>
                </div>
                
                <div class="summary-card">
                    <h3>üë• Couple Information</h3>
                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <strong>User 1</strong><br>
                            ${report.metadata.birthday} (${report.metadata.gender})
                        </div>
                        <div class="metadata-item">
                            <strong>User 2</strong><br>
                            ${report.metadata.birthday2} (${report.metadata.gender2})
                        </div>
                        <div class="metadata-item">
                            <strong>Analysis Type</strong><br>
                            ${report.metadata.problem}
                        </div>
                        <div class="metadata-item">
                            <strong>Report Generated</strong><br>
                            ${new Date(report.metadata.reportGeneratedAt).toLocaleString()}
                        </div>
                    </div>
                </div>
            `;

				// Component sections
				const components = [
					{
						key: "annualAnalysis",
						title: "üìÖ Annual Analysis",
						data: report.annualAnalysis,
					},
					{
						key: "mingJuAnalysis",
						title: "üéã MingJu Analysis",
						data: report.mingJuAnalysis,
					},
					{
						key: "godExplanation",
						title: "‚ö° God Explanation",
						data: report.godExplanation,
					},
					{
						key: "seasonAnalysis",
						title: "üå∏ Season Analysis",
						data: report.seasonAnalysis,
					},
					{
						key: "coreSuggestions",
						title: "üíï Core Suggestions",
						data: report.coreSuggestions,
					},
					{
						key: "problemSolution",
						title: "üîß Problem Solution",
						data: report.problemSolution,
					},
				];

				components.forEach((comp) => {
					const isPresent = comp.data !== null;
					const badge = isPresent
						? '<span class="present-badge">‚úÖ</span>'
						: '<span class="missing-badge">‚ùå</span>';
					const contentSize = isPresent
						? (JSON.stringify(comp.data).length / 1024).toFixed(1) +
							" KB"
						: "No data";

					html += `
                    <div class="component-section">
                        <div class="component-header" onclick="toggleComponent('${comp.key}Content')">
                            <span>${comp.title} ${badge} (${contentSize})</span>
                            <span class="arrow">‚ñ∂</span>
                        </div>
                        <div id="${comp.key}Content" class="component-content">
                `;

					if (isPresent) {
						html += `<pre>${JSON.stringify(comp.data, null, 2)}</pre>`;
					} else {
						html +=
							'<p style="color: #666; font-style: italic;">This component data is not available in the database.</p>';
					}

					html += "</div></div>";
				});

				// Raw components info
				html += `
                <div class="summary-card">
                    <h3>üóÑÔ∏è Raw Database Components</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px;">
            `;

				rawComponents.forEach((comp) => {
					html += `
                    <div class="metadata-item">
                        <strong>${comp.componentName}</strong><br>
                        Size: ${(comp.contentSize / 1024).toFixed(1)} KB<br>
                        Saved: ${new Date(comp.savedAt).toLocaleString()}
                    </div>
                `;
				});

				html += "</div></div>";

				document.getElementById("content").innerHTML = html;
			}

			async function loadRawData() {
				try {
					const sessionId = getSessionId();
					document.getElementById("content").innerHTML =
						`<p class="loading">Loading raw database data for session: ${sessionId}...</p>`;

					const response = await fetch(
						`${API_BASE}/api/couple-content?sessionId=${sessionId}`
					);
					const data = await response.json();

					if (!response.ok || !data.success) {
						showError(data.error || "Failed to load raw data");
						return;
					}

					const html = `
                    <div class="summary-card">
                        <h2>üóÑÔ∏è Raw Database Data</h2>
                        <p><strong>Session:</strong> ${data.sessionId}</p>
                        <p><strong>Components Found:</strong> ${data.componentCount}</p>
                        <p><strong>Last Saved:</strong> ${new Date(data.lastSaved).toLocaleString()}</p>
                    </div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

					document.getElementById("content").innerHTML = html;
				} catch (error) {
					showError(error.message);
				}
			}
		</script>
	</body>
</html>
